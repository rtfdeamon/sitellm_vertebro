<!--
  Lightweight chat widget demonstrating SSE streaming from /api/v1/llm/chat.
  Copy this file into another app and change the EventSource URL as needed.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LLM Chat Widget</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171a21;
      --border: #2a2f3a;
      --text: #e8eaf0;
      --muted: #a3a9b8;
      --accent: #4f7cff;
      --error: #ff5d5d;
      --ok: #32d296;
    }
    [data-theme='light'] {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --border: #dfe3eb;
      --text: #0f1115;
      --muted: #5a6473;
      --accent: #2f6bff;
      --error: #d32f2f;
      --ok: #2e7d32;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    body.embed { background: transparent; }
    .widget-launcher {
      position: fixed;
      right: 24px;
      bottom: 24px;
      display: none;
      align-items: center;
      gap: 12px;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 16px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      z-index: 9999;
    }
    body.embed .widget-launcher { display: inline-flex; }
    .widget-launcher:hover { transform: translateY(-2px); box-shadow: 0 22px 50px rgba(0,0,0,0.45); }
    .launcher-avatar {
      background: var(--accent);
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
    }
    .launcher-text { display: flex; flex-direction: column; line-height: 1.15; }
    .launcher-text strong { font-size: 14px; letter-spacing: 0.04em; }
    .launcher-text span { font-size: 12px; color: var(--muted); }
    .chat-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(6, 10, 22, 0.65);
      backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 9998;
    }
    .chat-backdrop.open { opacity: 1; pointer-events: auto; }
    .chat-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 10000;
    }
    .chat-modal.open { display: flex; }
    .chat-window {
      width: min(420px, calc(100vw - 32px));
      max-height: calc(100vh - 48px);
      background: var(--panel);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 28px 80px rgba(5, 10, 24, 0.55);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }
    .chat-title { font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; font-size: 13px; }
    .chat-subtitle { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .chat-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .chat-close:hover { background: rgba(96, 165, 250, 0.12); color: var(--accent); }
    .chat-body { flex: 1 1 auto; display: flex; flex-direction: column; overflow: hidden; }
    .container { max-width: 860px; margin: 0 auto; padding: 16px; }
    .chat-body .container { flex: 1 1 auto; display: flex; flex-direction: column; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    .toolbar .spacer { flex: 1 1 auto; }
    .toolbar input[type=text] { background: var(--panel); border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 6px; flex: 1 1 280px; }
    .toolbar button { background: var(--panel); border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 6px; cursor: pointer; }
    .toolbar button:hover { border-color: var(--accent); }
    .status { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: var(--muted); }
    .dot.ok { background: var(--ok); }
    .dot.bad { background: var(--error); }
    #messages { border: 1px solid var(--border); background: var(--panel); border-radius: 8px; padding: 12px; height: 360px; overflow-y: auto; margin-bottom: 12px; }
    .msg { margin: 8px 0; line-height: 1.55; }
    .msg .role { font-size: 12px; color: var(--muted); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .msg .time { opacity: 0.85; font-variant-numeric: tabular-nums; }
    .msg.user { color: #9cc9ff; }
    .msg.assistant { color: #b8e994; }
    .msg.debug { color: #facc15; }
    .msg .msg-body { white-space: pre-wrap; }
    .msg-attachments { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .msg-attachments .attachment-item { display: inline-flex; flex-direction: column; gap: 4px; background: rgba(96, 165, 250, 0.12); padding: 6px 8px; border-radius: 10px; max-width: 200px; }
    .msg-attachments .attachment-file a { display: inline-flex; align-items: center; gap: 6px; color: #bfdbfe; font-size: 12px; text-decoration: none; }
    .msg-attachments .attachment-file a::before { content: '\1F4CE'; }
    .msg-attachments .attachment-image { background: rgba(59, 130, 246, 0.12); }
    .msg-attachments .attachment-image img { display: block; max-width: 180px; border-radius: 8px; }
    .msg-attachments .attachment-caption { font-size: 11px; color: var(--muted); }
    form { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: start; }
    textarea { background: var(--panel); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 8px; min-height: 56px; resize: vertical; }
    .btn { background: var(--accent); border: none; color: white; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
    .btn.secondary { background: var(--panel); border: 1px solid var(--border); color: var(--text); }
    .muted { color: var(--muted); font-size: 12px; }
    .project-panel { border: 1px solid var(--border); background: var(--panel); border-radius: 8px; padding: 12px; margin-bottom: 12px; display: grid; gap: 12px; }
    .project-panel label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }
    .project-panel select, .project-panel textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 8px 10px; }
    .project-panel select { min-height: 36px; }
    .project-panel textarea { min-height: 80px; resize: vertical; }
    .project-panel .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .project-panel .row > * { flex: 0 0 auto; }
    .project-panel .grow { flex: 1 1 auto; }
    .project-panel .actions { display: flex; gap: 8px; align-items: center; }
    .project-panel .checkbox { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: var(--text); }
    .project-panel .checkbox input { width: 16px; height: 16px; }
    body.embed .toolbar,
    body.embed .project-panel,
    body.embed #saveCfg,
    body.embed #themeToggle,
    body.embed #baseUrl,
    body.embed #refreshProjects,
    body.embed #projectDebugHint,
    body.embed #savePrompt,
    body.embed #promptStatus { display: none !important; }
    body.embed form { grid-template-columns: 1fr auto; }
    body.embed form > .btn.secondary { order: 3; }
    body.embed #messages { flex: 1 1 auto; height: auto; }
    body.embed .container { padding: 14px; flex: 1 1 auto; }
    body:not(.embed) .widget-launcher,
    body:not(.embed) .chat-backdrop { display: none !important; }
    body:not(.embed) .chat-modal { position: static; display: block; padding: 0; }
    body:not(.embed) .chat-window { width: 100%; max-height: none; background: none; border: none; box-shadow: none; border-radius: 0; }
    body:not(.embed) .chat-header { display: none; }
    body:not(.embed) .chat-body { flex: none; }
    @media (max-width: 480px) {
      .widget-launcher { right: 16px; bottom: 16px; padding: 9px 14px; }
      .chat-modal { padding: 12px; }
      .chat-window { width: 100%; max-height: calc(100vh - 24px); }
    }
  </style>
</head>
<body>
  <div class="widget-launcher" id="widgetLauncher" aria-label="Открыть чат">
    <div class="launcher-avatar">AI</div>
    <div class="launcher-text">
      <strong>AI‑помощник</strong>
      <span>Спросите меня</span>
    </div>
  </div>
  <div class="chat-backdrop" id="chatBackdrop"></div>
  <div class="chat-modal" id="chatModal">
    <div class="chat-window">
      <div class="chat-header">
        <div>
          <div class="chat-title">AI‑помощник</div>
          <div class="chat-subtitle">Готов ответить на ваши вопросы</div>
        </div>
        <button class="chat-close" id="chatClose" aria-label="Закрыть">×</button>
      </div>
      <div class="chat-body">
        <div class="container">
          <div class="toolbar">
            <strong>LLM Chat Widget</strong>
            <span class="spacer"></span>
            <input type="text" id="baseUrl" placeholder="API base (optional), e.g. http://host:18000" />
            <button id="saveCfg" class="btn secondary">Save</button>
            <button id="themeToggle" class="btn secondary" title="Toggle theme">Theme</button>
            <span id="health" class="status"><span class="dot" id="healthDot"></span><span id="healthText">unknown</span></span>
          </div>

          <div id="banner" style="display:none; border:1px solid var(--error); color:#fff; background:#3a1f1f; padding:8px 10px; border-radius:6px; margin:10px 0;">
            <span id="bannerText">Connection error</span>
            <button id="bannerClose" class="btn secondary" style="float:right;">Dismiss</button>
          </div>

          <div class="project-panel">
            <div>
              <label for="projectSelect">Project</label>
              <div class="row">
                <select id="projectSelect" class="grow"></select>
                <button id="refreshProjects" class="btn secondary" type="button">Reload</button>
              </div>
              <div class="muted" id="projectInfo"></div>
            </div>
            <div class="row" style="align-items:center;">
              <label class="checkbox">
                <input type="checkbox" id="projectDebug">
                <span>Отладка</span>
              </label>
              <span class="muted" id="projectDebugHint">Показывать расширенные события в чате</span>
            </div>
            <div>
              <label for="startPrompt">Стартовый промт</label>
              <textarea id="startPrompt" placeholder="Стартовый промт проекта"></textarea>
              <div class="actions">
                <button id="savePrompt" class="btn secondary" type="button">Save prompt</button>
                <span id="promptStatus" class="muted"></span>
              </div>
            </div>
          </div>

          <div id="messages"></div>
          <form id="chat-form">
            <textarea id="question" placeholder="Ask a question (Shift+Enter = newline)" autocomplete="off"></textarea>
            <button type="button" id="stop" class="btn secondary" disabled>Stop</button>
            <button type="submit" id="sendBtn" class="btn">Send</button>
            <div class="muted">Enter to send • Shift+Enter for newline • <a href="#" id="clear">Clear</a></div>
          </form>
        </div>
      </div>
    </div>
  </div>
<script>
const form = document.getElementById('chat-form');
const input = document.getElementById('question');
const messages = document.getElementById('messages');
const stopBtn = document.getElementById('stop');
const clearLink = document.getElementById('clear');
const baseUrlInput = document.getElementById('baseUrl');
const saveCfgBtn = document.getElementById('saveCfg');
const healthDot = document.getElementById('healthDot');
const healthText = document.getElementById('healthText');
const sendBtn = document.getElementById('sendBtn');
const banner = document.getElementById('banner');
const bannerText = document.getElementById('bannerText');
const bannerClose = document.getElementById('bannerClose');
const themeToggle = document.getElementById('themeToggle');
const projectSelect = document.getElementById('projectSelect');
const refreshProjectsBtn = document.getElementById('refreshProjects');
const projectInfo = document.getElementById('projectInfo');
const startPromptInput = document.getElementById('startPrompt');
const savePromptBtn = document.getElementById('savePrompt');
const promptStatus = document.getElementById('promptStatus');
const debugCheckbox = document.getElementById('projectDebug');
const debugHint = document.getElementById('projectDebugHint');
const widgetLauncher = document.getElementById('widgetLauncher');
const chatModal = document.getElementById('chatModal');
const chatBackdrop = document.getElementById('chatBackdrop');
const chatClose = document.getElementById('chatClose');

const SESSION_STORAGE_KEY = 'chat_session_base';
let currentSessionBase = (() => {
  try {
    const stored = localStorage.getItem(SESSION_STORAGE_KEY) || '';
    return stored.trim().toLowerCase();
  } catch {
    return '';
  }
})();

function generateSessionId() {
  try {
    if (window.crypto && typeof window.crypto.randomUUID === 'function') {
      return window.crypto.randomUUID().toLowerCase();
    }
  } catch {}
  const suffix = Math.random().toString(36).slice(2, 10);
  return `${Date.now().toString(36)}${suffix}`.toLowerCase();
}

function ensureSessionId() {
  if (currentSessionBase) return currentSessionBase;
  currentSessionBase = generateSessionId();
  try { localStorage.setItem(SESSION_STORAGE_KEY, currentSessionBase); } catch {}
  return currentSessionBase;
}

function updateSessionBase(sessionValue) {
  if (!sessionValue) return;
  let base = String(sessionValue);
  if (base.includes('::')) {
    const parts = base.split('::');
    base = parts[parts.length - 1] || parts[0];
  }
  base = base.trim().toLowerCase();
  if (!base || base === currentSessionBase) return;
  currentSessionBase = base;
  try { localStorage.setItem(SESSION_STORAGE_KEY, currentSessionBase); } catch {}
}

let currentES = null;
let streaming = false;
let tokenChars = 0;
let projectsCache = {};

const urlParams = new URLSearchParams(window.location.search);
const urlProject = (urlParams.get('project') || '').trim().toLowerCase();
let currentProject = urlProject || (localStorage.getItem('chat_project') || '').trim().toLowerCase();
const isEmbed = window.self !== window.top || urlParams.get('embed') === '1';

if (isEmbed) {
  document.body.classList.add('embed');
}

function openChat() {
  chatModal.classList.add('open');
  chatBackdrop.classList.add('open');
  setTimeout(() => { input?.focus(); }, 150);
}

function closeChat() {
  if (!document.body.classList.contains('embed')) return;
  chatModal.classList.remove('open');
  chatBackdrop.classList.remove('open');
}

if (widgetLauncher) widgetLauncher.addEventListener('click', openChat);
if (chatClose) chatClose.addEventListener('click', closeChat);
if (chatBackdrop) chatBackdrop.addEventListener('click', closeChat);
document.addEventListener('keydown', (evt) => {
  if (evt.key === 'Escape') closeChat();
});

// Load saved base URL
baseUrlInput.value = localStorage.getItem('chat_base_url') || '';

function setTheme(theme) {
  const next = theme === 'light' ? 'light' : 'dark';
  document.documentElement.dataset.theme = next;
  try { localStorage.setItem('chat_theme', next); } catch {}
}

function toggleTheme() {
  const current = document.documentElement.dataset.theme || 'dark';
  setTheme(current === 'dark' ? 'light' : 'dark');
}

themeToggle.addEventListener('click', toggleTheme);

function setHealth(ok, text) {
  healthDot.classList.remove('ok', 'bad');
  if (ok === true) healthDot.classList.add('ok');
  else if (ok === false) healthDot.classList.add('bad');
  healthText.textContent = text;
}

async function pingHealth() {
  const base = baseUrlInput.value.trim();
  const url = base ? `${base.replace(/\/$/, '')}/api/v1/health` : '/api/v1/health';
  try {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    const message = data?.status || 'ok';
    setHealth(true, message);
  } catch (error) {
    console.error(error);
    setHealth(false, 'offline');
  }
}

function saveConfig() {
  const base = baseUrlInput.value.trim();
  try { localStorage.setItem('chat_base_url', base); } catch {}
  pingHealth();
}

saveCfgBtn.addEventListener('click', saveConfig);

const SESSION_KEY = 'chat_session_id';
let currentSession = localStorage.getItem(SESSION_KEY) || '';

function ensureSession() {
  if (!currentSession) {
    currentSession = `${ensureSessionId()}::${generateSessionId()}`;
    try { localStorage.setItem(SESSION_KEY, currentSession); } catch {}
  }
  return currentSession;
}

function newSession() {
  currentSession = `${ensureSessionId()}::${generateSessionId()}`;
  try { localStorage.setItem(SESSION_KEY, currentSession); } catch {}
  return currentSession;
}

function appendMessage(text, role = 'assistant', meta = {}) {
  const wrapper = document.createElement('div');
  wrapper.className = `msg ${role}`;
  const head = document.createElement('div');
  head.className = 'role';
  const t = new Date();
  const hh = String(t.getHours()).padStart(2, '0');
  const mm = String(t.getMinutes()).padStart(2, '0');
  head.innerHTML = `<span>${role}</span><span class="time">${hh}:${mm}</span>`;
  wrapper.appendChild(head);
  const body = document.createElement('div');
  body.className = 'msg-body';
  body.textContent = text;
  wrapper.appendChild(body);
  if (meta.attachments?.length) {
    const attachmentsRoot = document.createElement('div');
    attachmentsRoot.className = 'msg-attachments';
    meta.attachments.forEach((att) => {
      const attEl = document.createElement('div');
      attEl.className = 'attachment-item';
      if (att.content_type?.startsWith('image/')) {
        attEl.classList.add('attachment-image');
        const img = document.createElement('img');
        img.src = att.url;
        img.alt = att.description || att.name || 'image';
        attEl.appendChild(img);
        if (att.description) {
          const caption = document.createElement('div');
          caption.className = 'attachment-caption';
          caption.textContent = att.description;
          attEl.appendChild(caption);
        }
      } else {
        attEl.classList.add('attachment-file');
        const link = document.createElement('a');
        link.href = att.url;
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = att.name || 'Attachment';
        attEl.appendChild(link);
        if (att.description) {
          const caption = document.createElement('div');
          caption.className = 'attachment-caption';
          caption.textContent = att.description;
          attEl.appendChild(caption);
        }
      }
      attachmentsRoot.appendChild(attEl);
    });
    wrapper.appendChild(attachmentsRoot);
  }
  messages.appendChild(wrapper);
  messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
}

function addSystemMessage(text) {
  appendMessage(text, 'system');
}

function clearMessages() {
  messages.innerHTML = '';
  try { localStorage.removeItem('chat_history'); } catch {}
}

clearLink.addEventListener('click', (event) => {
  event.preventDefault();
  clearMessages();
});

function saveHistory() {
  try {
    localStorage.setItem('chat_history', messages.innerHTML);
  } catch {}
}

(function restoreHistory() {
  try {
    const history = localStorage.getItem('chat_history');
    if (history) {
      messages.innerHTML = history;
    }
  } catch {}
})();

function setStreamingState(value) {
  streaming = Boolean(value);
  stopBtn.disabled = !streaming;
  sendBtn.disabled = streaming;
  input.readOnly = streaming;
}

async function loadProjects() {
  const base = baseUrlInput.value.trim();
  const url = base ? `${base.replace(/\/$/, '')}/api/v1/admin/projects/names` : '/api/v1/admin/projects/names';
  try {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('Failed to load projects');
    const data = await resp.json();
    projectsCache = data.projects || [];
    projectSelect.innerHTML = '';
    projectsCache.forEach((name) => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      projectSelect.appendChild(option);
    });
    if (currentProject && projectsCache.includes(currentProject)) {
      projectSelect.value = currentProject;
    } else if (projectsCache.length) {
      currentProject = projectsCache[0];
      projectSelect.value = currentProject;
    }
    updateProjectInfo();
  } catch (error) {
    console.error(error);
  }
}

function updateProjectInfo() {
  const selected = projectSelect.value || '';
  currentProject = selected;
  try { localStorage.setItem('chat_project', currentProject); } catch {}
  projectInfo.textContent = currentProject ? `Текущий проект: ${currentProject}` : 'Проект не выбран';
}

projectSelect.addEventListener('change', () => {
  updateProjectInfo();
});
refreshProjectsBtn.addEventListener('click', loadProjects);

debugCheckbox.addEventListener('change', () => {
  const hint = debugCheckbox.checked ? 'Расширенные события включены' : 'Показывать расширенные события в чате';
  debugHint.textContent = hint;
});

savePromptBtn.addEventListener('click', async () => {
  const base = baseUrlInput.value.trim();
  const url = base ? `${base.replace(/\/$/, '')}/api/v1/admin/projects/${encodeURIComponent(currentProject)}` : `/api/v1/admin/projects/${encodeURIComponent(currentProject)}`;
  const payload = {
    name: currentProject,
    llm_prompt: startPromptInput.value,
  };
  promptStatus.textContent = 'Saving…';
  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (!resp.ok) throw new Error('Failed');
    promptStatus.textContent = 'Saved';
    setTimeout(() => (promptStatus.textContent = ''), 3000);
  } catch (error) {
    console.error(error);
    promptStatus.textContent = 'Error';
  }
});

function bannerError(message) {
  bannerText.textContent = message;
  banner.style.display = 'block';
}

bannerClose.addEventListener('click', () => {
  banner.style.display = 'none';
});

async function sendQuestion(question) {
  const base = baseUrlInput.value.trim();
  const endpointBase = base ? base.replace(/\/$/, '') : '';
  const params = new URLSearchParams();
  params.set('question', question);
  if (currentProject) params.set('project', currentProject);
  const sessionId = ensureSession();
  params.set('session_id', sessionId);
  if (debugCheckbox.checked) params.set('debug', '1');
  const url = `${endpointBase || ''}/api/v1/llm/chat?${params.toString()}`;

  if (currentES) {
    currentES.close();
    currentES = null;
  }

  const chunks = [];
  tokenChars = 0;
  setStreamingState(true);

  try {
    currentES = new EventSource(url, { withCredentials: false });
  } catch (error) {
    bannerError('SSE not supported by this browser.');
    setStreamingState(false);
    return;
  }

  currentES.addEventListener('message', (event) => {
    try {
      const data = JSON.parse(event.data);
      if (data?.text) {
        chunks.push(data.text);
        tokenChars += data.text.length;
        appendMessage(data.text, data.role || 'assistant', data.meta || {});
        saveHistory();
      }
      if (data?.meta?.session_id) {
        updateSessionBase(data.meta.session_id);
      }
    } catch (error) {
      console.error('stream parse error', error, event.data);
    }
  });

  currentES.addEventListener('debug', (event) => {
    if (!debugCheckbox.checked) return;
    try {
      const data = JSON.parse(event.data);
      appendMessage(JSON.stringify(data, null, 2), 'debug');
      saveHistory();
    } catch (error) {
      console.error('debug parse error', error);
    }
  });

  currentES.addEventListener('attachment', (event) => {
    try {
      const data = JSON.parse(event.data);
      appendMessage(data.description || data.name || 'attachment', 'assistant', { attachments: [data] });
      saveHistory();
    } catch (error) {
      console.error('attachment parse error', error);
    }
  });

  currentES.addEventListener('end', () => {
    setStreamingState(false);
    currentES?.close();
  });

  currentES.addEventListener('error', (event) => {
    console.error('sse error', event);
    bannerError('Streaming error, see console.');
    setStreamingState(false);
    currentES?.close();
  });
}

form.addEventListener('submit', async (event) => {
  event.preventDefault();
  if (isEmbed && !chatModal.classList.contains('open')) {
    openChat();
  }
  const question = input.value.trim();
  if (!question) return;
  appendMessage(question, 'user');
  saveHistory();
  input.value = '';
  sendBtn.disabled = true;
  try {
    await sendQuestion(question);
  } finally {
    sendBtn.disabled = false;
  }
});

stopBtn.addEventListener('click', () => {
  if (
    currentES &&
    typeof currentES.close === 'function'
  ) {
    currentES.close();
  }
  setStreamingState(false);
});

saveCfgBtn.addEventListener('click', saveConfig);

setTheme(localStorage.getItem('chat_theme') || 'dark');

window.addEventListener('load', () => {
  ensureSessionId();
  if (!isEmbed) {
    chatModal.classList.add('open');
  }
  loadProjects().finally(() => {
    if (currentProject) {
      projectSelect.value = currentProject;
      updateProjectInfo();
    }
  });
  pingHealth();
  setInterval(pingHealth, 15000);
});
</script>
</body>
</html>
