<!--
  Lightweight chat widget demonstrating SSE streaming from /api/v1/llm/chat.
  Copy this file into another app and change the EventSource URL as needed.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LLM Chat Widget</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171a21;
      --border: #2a2f3a;
      --text: #e8eaf0;
      --muted: #a3a9b8;
      --accent: #4f7cff;
      --error: #ff5d5d;
      --ok: #32d296;
    }
    [data-theme='light'] {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --border: #dfe3eb;
      --text: #0f1115;
      --muted: #5a6473;
      --accent: #2f6bff;
      --error: #d32f2f;
      --ok: #2e7d32;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    body.embed { background: transparent; }
    .widget-launcher {
      position: fixed;
      right: 24px;
      bottom: 24px;
      display: none;
      align-items: center;
      gap: 12px;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 16px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      z-index: 9999;
    }
    body.embed .widget-launcher { display: inline-flex; }
    .widget-launcher:hover { transform: translateY(-2px); box-shadow: 0 22px 50px rgba(0,0,0,0.45); }
    .launcher-avatar {
      background: var(--accent);
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
    }
    .launcher-text { display: flex; flex-direction: column; line-height: 1.15; }
    .launcher-text strong { font-size: 14px; letter-spacing: 0.04em; }
    .launcher-text span { font-size: 12px; color: var(--muted); }
    .chat-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(6, 10, 22, 0.65);
      backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 9998;
    }
    .chat-backdrop.open { opacity: 1; pointer-events: auto; }
    .chat-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 10000;
    }
    .chat-modal.open { display: flex; }
    .chat-window {
      width: min(420px, calc(100vw - 32px));
      max-height: calc(100vh - 48px);
      background: var(--panel);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 28px 80px rgba(5, 10, 24, 0.55);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }
    .chat-title { font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; font-size: 13px; }
    .chat-subtitle { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .chat-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .chat-close:hover { background: rgba(96, 165, 250, 0.12); color: var(--accent); }
    .chat-body { flex: 1 1 auto; display: flex; flex-direction: column; overflow: hidden; }
    .container { max-width: 860px; margin: 0 auto; padding: 16px; }
    .chat-body .container { flex: 1 1 auto; display: flex; flex-direction: column; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    .toolbar .spacer { flex: 1 1 auto; }
    .toolbar input[type=text] { background: var(--panel); border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 6px; flex: 1 1 280px; }
    .toolbar select { background: var(--panel); border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 6px; min-width: 120px; }
    .toolbar button { background: var(--panel); border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 6px; cursor: pointer; }
    .toolbar button:hover { border-color: var(--accent); }
    .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
    .status { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: var(--muted); }
    .dot.ok { background: var(--ok); }
    .dot.bad { background: var(--error); }
    #messages { border: 1px solid var(--border); background: var(--panel); border-radius: 8px; padding: 12px; height: 360px; overflow-y: auto; margin-bottom: 12px; }
    .msg { margin: 8px 0; line-height: 1.55; }
    .msg .role { font-size: 12px; color: var(--muted); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .msg .time { opacity: 0.85; font-variant-numeric: tabular-nums; }
    .msg.user { color: #9cc9ff; }
    .msg.assistant { color: #b8e994; }
    .msg.debug { color: #facc15; }
    .msg .msg-body { white-space: pre-wrap; }
    .msg-attachments { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .msg-attachments .attachment-item { display: inline-flex; flex-direction: column; gap: 4px; background: rgba(96, 165, 250, 0.12); padding: 6px 8px; border-radius: 10px; max-width: 200px; }
    .msg-attachments .attachment-file a { display: inline-flex; align-items: center; gap: 6px; color: #bfdbfe; font-size: 12px; text-decoration: none; }
    .msg-attachments .attachment-file a::before { content: '\1F4CE'; }
    .msg-attachments .attachment-image { background: rgba(59, 130, 246, 0.12); }
    .msg-attachments .attachment-image img { display: block; max-width: 180px; border-radius: 8px; }
    .msg-attachments .attachment-caption { font-size: 11px; color: var(--muted); }
    form { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: start; }
    textarea { background: var(--panel); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 8px; min-height: 56px; resize: vertical; }
    .btn { background: var(--accent); border: none; color: white; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
    .btn.secondary { background: var(--panel); border: 1px solid var(--border); color: var(--text); }
    .muted { color: var(--muted); font-size: 12px; }
    .project-panel { border: 1px solid var(--border); background: var(--panel); border-radius: 8px; padding: 12px; margin-bottom: 12px; display: grid; gap: 12px; }
    .project-panel label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }
    .project-panel select, .project-panel textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 8px 10px; }
    .project-panel select { min-height: 36px; }
    .project-panel textarea { min-height: 80px; resize: vertical; }
    .project-panel .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .project-panel .row > * { flex: 0 0 auto; }
    .project-panel .grow { flex: 1 1 auto; }
    .project-panel .actions { display: flex; gap: 8px; align-items: center; }
    .project-panel .checkbox { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: var(--text); }
    .project-panel .checkbox input { width: 16px; height: 16px; }
    body.embed .toolbar,
    body.embed .project-panel,
    body.embed #saveCfg,
    body.embed #themeToggle,
    body.embed #baseUrl,
    body.embed #refreshProjects,
    body.embed #projectDebugHint,
    body.embed #savePrompt,
    body.embed #promptStatus { display: none !important; }
    body.embed form { grid-template-columns: 1fr auto; }
    body.embed form > .btn.secondary { order: 3; }
    body.embed #messages { flex: 1 1 auto; height: auto; }
    body.embed .container { padding: 14px; flex: 1 1 auto; }
    body:not(.embed) .widget-launcher,
    body:not(.embed) .chat-backdrop { display: none !important; }
    body:not(.embed) .chat-modal { position: static; display: block; padding: 0; }
    body:not(.embed) .chat-window { width: 100%; max-height: none; background: none; border: none; box-shadow: none; border-radius: 0; }
    body:not(.embed) .chat-header { display: none; }
    body:not(.embed) .chat-body { flex: none; }
    @media (max-width: 480px) {
      .widget-launcher { right: 16px; bottom: 16px; padding: 9px 14px; }
      .chat-modal { padding: 12px; }
      .chat-window { width: 100%; max-height: calc(100vh - 24px); }
    }
  </style>
</head>
<body>
  <div class="widget-launcher" id="widgetLauncher" aria-label="Open chat" data-i18n-aria-label="launcherAria">
    <div class="launcher-avatar">AI</div>
    <div class="launcher-text">
      <strong data-i18n="launcherTitle">AI Assistant</strong>
      <span data-i18n="launcherSubtitle">Ask me anything</span>
    </div>
  </div>
  <div class="chat-backdrop" id="chatBackdrop"></div>
  <div class="chat-modal" id="chatModal">
    <div class="chat-window">
      <div class="chat-header">
        <div>
          <div class="chat-title" data-i18n="chatTitle">AI Assistant</div>
          <div class="chat-subtitle" data-i18n="chatSubtitle">Ready to help with your questions</div>
        </div>
        <button class="chat-close" id="chatClose" aria-label="Close" data-i18n-aria-label="chatClose">×</button>
      </div>
      <div class="chat-body">
        <div class="container">
          <div class="toolbar">
            <strong data-i18n="toolbarTitle">LLM Chat Widget</strong>
            <span class="spacer"></span>
            <input type="text" id="baseUrl" placeholder="API base (optional), e.g. http://host:18000" data-i18n-placeholder="basePlaceholder" />
            <button id="saveCfg" class="btn secondary" data-i18n="saveButton">Save</button>
            <button id="themeToggle" class="btn secondary" title="Toggle theme" data-i18n="themeButton">Theme</button>
            <select id="languageSelect" aria-label="Language" data-i18n-aria-label="languageLabel"></select>
            <span id="health" class="status"><span class="dot" id="healthDot"></span><span id="healthText" data-status-key="unknown">unknown</span></span>
          </div>

          <div id="banner" style="display:none; border:1px solid var(--error); color:#fff; background:#3a1f1f; padding:8px 10px; border-radius:6px; margin:10px 0;" data-active="false">
            <span id="bannerText" data-i18n="bannerConnectionError">Connection error</span>
            <button id="bannerClose" class="btn secondary" style="float:right;" data-i18n="bannerDismiss">Dismiss</button>
          </div>

          <div class="project-panel">
            <div>
              <label for="projectSelect" data-i18n="projectLabel">Project</label>
              <div class="row">
                <select id="projectSelect" class="grow"></select>
                <button id="refreshProjects" class="btn secondary" type="button" data-i18n="reloadProjects">Reload</button>
              </div>
              <div class="muted" id="projectInfo">No project selected</div>
            </div>
            <div class="row" style="align-items:center;">
              <label class="checkbox">
                <input type="checkbox" id="projectDebug">
                <span data-i18n="debugLabel">Debug</span>
              </label>
              <span class="muted" id="projectDebugHint">Show extended events in chat</span>
            </div>
            <div>
              <label for="startPrompt" data-i18n="startPromptLabel">Initial prompt</label>
              <textarea id="startPrompt" placeholder="Project initial prompt" data-i18n-placeholder="startPromptPlaceholder"></textarea>
              <div class="actions">
                <button id="savePrompt" class="btn secondary" type="button" data-i18n="savePrompt">Save prompt</button>
                <span id="promptStatus" class="muted"></span>
              </div>
            </div>
          </div>

          <div id="messages"></div>
          <form id="chat-form">
            <textarea id="question" placeholder="Ask a question (Shift+Enter = newline)" autocomplete="off" data-i18n-placeholder="questionPlaceholder"></textarea>
            <button type="button" id="stop" class="btn secondary" disabled data-i18n="stopButton">Stop</button>
            <button type="submit" id="sendBtn" class="btn" data-i18n="sendButton">Send</button>
            <div class="muted" id="inputHint"><span id="hintSend">Enter to send</span><span>&nbsp;•&nbsp;</span><span id="hintNewline">Shift+Enter for newline</span><span>&nbsp;•&nbsp;</span><a href="#" id="clear">Clear</a></div>
          </form>
        </div>
      </div>
    </div>
  </div>
<script>
const form = document.getElementById('chat-form');
const input = document.getElementById('question');
const messages = document.getElementById('messages');
const stopBtn = document.getElementById('stop');
const clearLink = document.getElementById('clear');
const baseUrlInput = document.getElementById('baseUrl');
const saveCfgBtn = document.getElementById('saveCfg');
const healthDot = document.getElementById('healthDot');
const healthText = document.getElementById('healthText');
const sendBtn = document.getElementById('sendBtn');
const banner = document.getElementById('banner');
const bannerText = document.getElementById('bannerText');
const bannerClose = document.getElementById('bannerClose');
const themeToggle = document.getElementById('themeToggle');
const projectSelect = document.getElementById('projectSelect');
const refreshProjectsBtn = document.getElementById('refreshProjects');
const projectInfo = document.getElementById('projectInfo');
const startPromptInput = document.getElementById('startPrompt');
const savePromptBtn = document.getElementById('savePrompt');
const promptStatus = document.getElementById('promptStatus');
const debugCheckbox = document.getElementById('projectDebug');
const debugHint = document.getElementById('projectDebugHint');
const languageSelect = document.getElementById('languageSelect');
const hintSend = document.getElementById('hintSend');
const hintNewline = document.getElementById('hintNewline');
const inputHint = document.getElementById('inputHint');
const widgetLauncher = document.getElementById('widgetLauncher');
const chatModal = document.getElementById('chatModal');
const chatBackdrop = document.getElementById('chatBackdrop');
const chatClose = document.getElementById('chatClose');

const urlParams = new URLSearchParams(window.location.search);
const urlProject = (urlParams.get('project') || '').trim().toLowerCase();
let currentProject = urlProject || (localStorage.getItem('chat_project') || '').trim().toLowerCase();
const isEmbed = window.self !== window.top || urlParams.get('embed') === '1';

const LANGUAGE_STORAGE_KEY = 'chat_language';
const FALLBACK_LANGUAGE = 'en';
const LANGUAGES = {
  en: {
    name: 'English',
    dir: 'ltr',
    strings: {
      launcherTitle: 'AI Assistant',
      launcherSubtitle: 'Ask me anything',
      launcherAria: 'Open chat',
      chatTitle: 'AI Assistant',
      chatSubtitle: 'Ready to help with your questions',
      chatClose: 'Close',
      toolbarTitle: 'LLM Chat Widget',
      basePlaceholder: 'API base (optional), e.g. http://host:18000',
      saveButton: 'Save',
      themeButton: 'Theme',
      languageLabel: 'Language',
      statusUnknown: 'unknown',
      statusOk: 'online',
      statusOffline: 'offline',
      bannerConnectionError: 'Connection error',
      bannerDismiss: 'Dismiss',
      projectLabel: 'Project',
      reloadProjects: 'Reload',
      projectInfoNone: 'No project selected',
      projectInfoSelected: 'Current project: {project}',
      debugLabel: 'Debug',
      debugHintOff: 'Show extended events in chat',
      debugHintOn: 'Extended events enabled',
      startPromptLabel: 'Initial prompt',
      startPromptPlaceholder: 'Project initial prompt',
      savePrompt: 'Save prompt',
      questionPlaceholder: 'Ask a question (Shift+Enter = newline)',
      stopButton: 'Stop',
      sendButton: 'Send',
      inputHintSend: 'Enter to send',
      inputHintNewline: 'Shift+Enter for newline',
      clearLink: 'Clear',
      errorLoadProjects: 'Failed to load projects',
      statusSaving: 'Saving…',
      statusSaved: 'Saved',
      statusError: 'Error',
      errorStreaming: 'Streaming error, see console.',
      errorNoSSE: 'SSE not supported by this browser.',
      attachmentLabel: 'Attachment',
      roleUser: 'user',
      roleAssistant: 'assistant',
      roleSystem: 'system',
      roleDebug: 'debug'
    }
  },
  es: {
    name: 'Español',
    dir: 'ltr',
    strings: {
      launcherTitle: 'Asistente de IA',
      launcherSubtitle: 'Pregunta lo que quieras',
      launcherAria: 'Abrir chat',
      chatTitle: 'Asistente de IA',
      chatSubtitle: 'Listo para ayudarte con tus preguntas',
      chatClose: 'Cerrar',
      toolbarTitle: 'Widget de chat LLM',
      basePlaceholder: 'Base de API (opcional), p. ej. http://host:18000',
      saveButton: 'Guardar',
      themeButton: 'Tema',
      languageLabel: 'Idioma',
      statusUnknown: 'desconocido',
      statusOk: 'en línea',
      statusOffline: 'sin conexión',
      bannerConnectionError: 'Error de conexión',
      bannerDismiss: 'Cerrar',
      projectLabel: 'Proyecto',
      reloadProjects: 'Actualizar',
      projectInfoNone: 'Ningún proyecto seleccionado',
      projectInfoSelected: 'Proyecto actual: {project}',
      debugLabel: 'Depuración',
      debugHintOff: 'Mostrar eventos ampliados en el chat',
      debugHintOn: 'Eventos ampliados activados',
      startPromptLabel: 'Mensaje inicial',
      startPromptPlaceholder: 'Mensaje inicial del proyecto',
      savePrompt: 'Guardar mensaje',
      questionPlaceholder: 'Haz una pregunta (Mayús+Enter = nueva línea)',
      stopButton: 'Detener',
      sendButton: 'Enviar',
      inputHintSend: 'Enter para enviar',
      inputHintNewline: 'Mayús+Enter para nueva línea',
      clearLink: 'Limpiar',
      errorLoadProjects: 'No se pudieron cargar los proyectos',
      statusSaving: 'Guardando…',
      statusSaved: 'Guardado',
      statusError: 'Error',
      errorStreaming: 'Error de streaming, revisa la consola.',
      errorNoSSE: 'Este navegador no admite SSE.',
      attachmentLabel: 'Adjunto',
      roleUser: 'usuario',
      roleAssistant: 'asistente',
      roleSystem: 'sistema',
      roleDebug: 'depuración'
    }
  },
  de: {
    name: 'Deutsch',
    dir: 'ltr',
    strings: {
      launcherTitle: 'KI-Assistent',
      launcherSubtitle: 'Frag mich alles',
      launcherAria: 'Chat öffnen',
      chatTitle: 'KI-Assistent',
      chatSubtitle: 'Bereit, deine Fragen zu beantworten',
      chatClose: 'Schließen',
      toolbarTitle: 'LLM-Chat-Widget',
      basePlaceholder: 'API-Basis (optional), z. B. http://host:18000',
      saveButton: 'Speichern',
      themeButton: 'Thema',
      languageLabel: 'Sprache',
      statusUnknown: 'unbekannt',
      statusOk: 'online',
      statusOffline: 'offline',
      bannerConnectionError: 'Verbindungsfehler',
      bannerDismiss: 'Schließen',
      projectLabel: 'Projekt',
      reloadProjects: 'Aktualisieren',
      projectInfoNone: 'Kein Projekt ausgewählt',
      projectInfoSelected: 'Aktuelles Projekt: {project}',
      debugLabel: 'Debug',
      debugHintOff: 'Erweiterte Ereignisse im Chat anzeigen',
      debugHintOn: 'Erweiterte Ereignisse aktiviert',
      startPromptLabel: 'Start-Prompt',
      startPromptPlaceholder: 'Start-Prompt des Projekts',
      savePrompt: 'Prompt speichern',
      questionPlaceholder: 'Stelle eine Frage (Shift+Enter = neue Zeile)',
      stopButton: 'Stopp',
      sendButton: 'Senden',
      inputHintSend: 'Enter zum Senden',
      inputHintNewline: 'Shift+Enter für neue Zeile',
      clearLink: 'Löschen',
      errorLoadProjects: 'Projekte konnten nicht geladen werden',
      statusSaving: 'Wird gespeichert…',
      statusSaved: 'Gespeichert',
      statusError: 'Fehler',
      errorStreaming: 'Streaming-Fehler, siehe Konsole.',
      errorNoSSE: 'Dieser Browser unterstützt kein SSE.',
      attachmentLabel: 'Anhang',
      roleUser: 'benutzer',
      roleAssistant: 'assistent',
      roleSystem: 'system',
      roleDebug: 'debug'
    }
  },
  fr: {
    name: 'Français',
    dir: 'ltr',
    strings: {
      launcherTitle: 'Assistant IA',
      launcherSubtitle: 'Posez-moi vos questions',
      launcherAria: 'Ouvrir le chat',
      chatTitle: 'Assistant IA',
      chatSubtitle: 'Prêt à répondre à vos questions',
      chatClose: 'Fermer',
      toolbarTitle: 'Widget de chat LLM',
      basePlaceholder: 'Base API (facultatif), ex. http://host:18000',
      saveButton: 'Enregistrer',
      themeButton: 'Thème',
      languageLabel: 'Langue',
      statusUnknown: 'inconnu',
      statusOk: 'en ligne',
      statusOffline: 'hors ligne',
      bannerConnectionError: 'Erreur de connexion',
      bannerDismiss: 'Fermer',
      projectLabel: 'Projet',
      reloadProjects: 'Actualiser',
      projectInfoNone: 'Aucun projet sélectionné',
      projectInfoSelected: 'Projet actuel : {project}',
      debugLabel: 'Debug',
      debugHintOff: 'Afficher les événements étendus dans le chat',
      debugHintOn: 'Événements étendus activés',
      startPromptLabel: 'Invite initiale',
      startPromptPlaceholder: 'Invite initiale du projet',
      savePrompt: 'Enregistrer l\'invite',
      questionPlaceholder: 'Posez une question (Maj+Entrée = nouvelle ligne)',
      stopButton: 'Arrêter',
      sendButton: 'Envoyer',
      inputHintSend: 'Entrée pour envoyer',
      inputHintNewline: 'Maj+Entrée pour nouvelle ligne',
      clearLink: 'Effacer',
      errorLoadProjects: 'Impossible de charger les projets',
      statusSaving: 'Enregistrement…',
      statusSaved: 'Enregistré',
      statusError: 'Erreur',
      errorStreaming: 'Erreur de streaming, voir la console.',
      errorNoSSE: 'Ce navigateur ne prend pas en charge SSE.',
      attachmentLabel: 'Pièce jointe',
      roleUser: 'utilisateur',
      roleAssistant: 'assistant',
      roleSystem: 'système',
      roleDebug: 'debug'
    }
  },
  it: {
    name: 'Italiano',
    dir: 'ltr',
    strings: {
      launcherTitle: 'Assistente IA',
      launcherSubtitle: 'Chiedimi qualsiasi cosa',
      launcherAria: 'Apri chat',
      chatTitle: 'Assistente IA',
      chatSubtitle: 'Pronto ad aiutarti con le tue domande',
      chatClose: 'Chiudi',
      toolbarTitle: 'Widget chat LLM',
      basePlaceholder: 'Base API (opzionale), es. http://host:18000',
      saveButton: 'Salva',
      themeButton: 'Tema',
      languageLabel: 'Lingua',
      statusUnknown: 'sconosciuto',
      statusOk: 'online',
      statusOffline: 'offline',
      bannerConnectionError: 'Errore di connessione',
      bannerDismiss: 'Chiudi',
      projectLabel: 'Progetto',
      reloadProjects: 'Aggiorna',
      projectInfoNone: 'Nessun progetto selezionato',
      projectInfoSelected: 'Progetto corrente: {project}',
      debugLabel: 'Debug',
      debugHintOff: 'Mostra eventi estesi nella chat',
      debugHintOn: 'Eventi estesi attivati',
      startPromptLabel: 'Prompt iniziale',
      startPromptPlaceholder: 'Prompt iniziale del progetto',
      savePrompt: 'Salva prompt',
      questionPlaceholder: 'Fai una domanda (Shift+Invio = nuova riga)',
      stopButton: 'Ferma',
      sendButton: 'Invia',
      inputHintSend: 'Invio per inviare',
      inputHintNewline: 'Shift+Invio per nuova riga',
      clearLink: 'Cancella',
      errorLoadProjects: 'Impossibile caricare i progetti',
      statusSaving: 'Salvataggio…',
      statusSaved: 'Salvato',
      statusError: 'Errore',
      errorStreaming: 'Errore di streaming, controlla la console.',
      errorNoSSE: 'Questo browser non supporta SSE.',
      attachmentLabel: 'Allegato',
      roleUser: 'utente',
      roleAssistant: 'assistente',
      roleSystem: 'sistema',
      roleDebug: 'debug'
    }
  },
  pt: {
    name: 'Português',
    dir: 'ltr',
    strings: {
      launcherTitle: 'Assistente IA',
      launcherSubtitle: 'Pergunte qualquer coisa',
      launcherAria: 'Abrir chat',
      chatTitle: 'Assistente IA',
      chatSubtitle: 'Pronto para ajudar com suas dúvidas',
      chatClose: 'Fechar',
      toolbarTitle: 'Widget de chat LLM',
      basePlaceholder: 'Base da API (opcional), ex. http://host:18000',
      saveButton: 'Salvar',
      themeButton: 'Tema',
      languageLabel: 'Idioma',
      statusUnknown: 'desconhecido',
      statusOk: 'online',
      statusOffline: 'offline',
      bannerConnectionError: 'Erro de conexão',
      bannerDismiss: 'Fechar',
      projectLabel: 'Projeto',
      reloadProjects: 'Recarregar',
      projectInfoNone: 'Nenhum projeto selecionado',
      projectInfoSelected: 'Projeto atual: {project}',
      debugLabel: 'Depuração',
      debugHintOff: 'Mostrar eventos estendidos no chat',
      debugHintOn: 'Eventos estendidos ativados',
      startPromptLabel: 'Prompt inicial',
      startPromptPlaceholder: 'Prompt inicial do projeto',
      savePrompt: 'Salvar prompt',
      questionPlaceholder: 'Faça uma pergunta (Shift+Enter = nova linha)',
      stopButton: 'Parar',
      sendButton: 'Enviar',
      inputHintSend: 'Enter para enviar',
      inputHintNewline: 'Shift+Enter para nova linha',
      clearLink: 'Limpar',
      errorLoadProjects: 'Falha ao carregar projetos',
      statusSaving: 'Salvando…',
      statusSaved: 'Salvo',
      statusError: 'Erro',
      errorStreaming: 'Erro de streaming, veja o console.',
      errorNoSSE: 'Este navegador não suporta SSE.',
      attachmentLabel: 'Anexo',
      roleUser: 'usuário',
      roleAssistant: 'assistente',
      roleSystem: 'sistema',
      roleDebug: 'depuração'
    }
  },
  ru: {
    name: 'Русский',
    dir: 'ltr',
    strings: {
      launcherTitle: 'AI‑помощник',
      launcherSubtitle: 'Спросите меня о чём угодно',
      launcherAria: 'Открыть чат',
      chatTitle: 'AI‑помощник',
      chatSubtitle: 'Готов ответить на ваши вопросы',
      chatClose: 'Закрыть',
      toolbarTitle: 'LLM чат‑виджет',
      basePlaceholder: 'База API (опционально), например http://host:18000',
      saveButton: 'Сохранить',
      themeButton: 'Тема',
      languageLabel: 'Язык',
      statusUnknown: 'неизвестно',
      statusOk: 'в сети',
      statusOffline: 'не в сети',
      bannerConnectionError: 'Ошибка подключения',
      bannerDismiss: 'Закрыть',
      projectLabel: 'Проект',
      reloadProjects: 'Обновить',
      projectInfoNone: 'Проект не выбран',
      projectInfoSelected: 'Текущий проект: {project}',
      debugLabel: 'Отладка',
      debugHintOff: 'Показывать расширенные события в чате',
      debugHintOn: 'Расширенные события включены',
      startPromptLabel: 'Стартовый промт',
      startPromptPlaceholder: 'Стартовый промт проекта',
      savePrompt: 'Сохранить промт',
      questionPlaceholder: 'Задайте вопрос (Shift+Enter = новая строка)',
      stopButton: 'Стоп',
      sendButton: 'Отправить',
      inputHintSend: 'Enter — отправить',
      inputHintNewline: 'Shift+Enter — новая строка',
      clearLink: 'Очистить',
      errorLoadProjects: 'Не удалось загрузить проекты',
      statusSaving: 'Сохранение…',
      statusSaved: 'Сохранено',
      statusError: 'Ошибка',
      errorStreaming: 'Ошибка потоковой передачи, смотрите консоль.',
      errorNoSSE: 'Этот браузер не поддерживает SSE.',
      attachmentLabel: 'Вложение',
      roleUser: 'пользователь',
      roleAssistant: 'ассистент',
      roleSystem: 'система',
      roleDebug: 'отладка'
    }
  },
  zh: {
    name: '中文',
    dir: 'ltr',
    strings: {
      launcherTitle: 'AI 助手',
      launcherSubtitle: '随时向我提问',
      launcherAria: '打开聊天',
      chatTitle: 'AI 助手',
      chatSubtitle: '随时为您解答问题',
      chatClose: '关闭',
      toolbarTitle: 'LLM 聊天组件',
      basePlaceholder: 'API 地址（可选），例如 http://host:18000',
      saveButton: '保存',
      themeButton: '主题',
      languageLabel: '语言',
      statusUnknown: '未知',
      statusOk: '在线',
      statusOffline: '离线',
      bannerConnectionError: '连接错误',
      bannerDismiss: '关闭',
      projectLabel: '项目',
      reloadProjects: '刷新',
      projectInfoNone: '未选择项目',
      projectInfoSelected: '当前项目：{project}',
      debugLabel: '调试',
      debugHintOff: '在聊天中显示扩展事件',
      debugHintOn: '已启用扩展事件',
      startPromptLabel: '初始提示',
      startPromptPlaceholder: '项目初始提示',
      savePrompt: '保存提示',
      questionPlaceholder: '提问（Shift+Enter = 换行）',
      stopButton: '停止',
      sendButton: '发送',
      inputHintSend: '回车发送',
      inputHintNewline: 'Shift+Enter 换行',
      clearLink: '清除',
      errorLoadProjects: '项目加载失败',
      statusSaving: '保存中…',
      statusSaved: '已保存',
      statusError: '错误',
      errorStreaming: '流式传输错误，请查看控制台。',
      errorNoSSE: '此浏览器不支持 SSE。',
      attachmentLabel: '附件',
      roleUser: '用户',
      roleAssistant: '助手',
      roleSystem: '系统',
      roleDebug: '调试'
    }
  },
  ja: {
    name: '日本語',
    dir: 'ltr',
    strings: {
      launcherTitle: 'AIアシスタント',
      launcherSubtitle: '何でも聞いてください',
      launcherAria: 'チャットを開く',
      chatTitle: 'AIアシスタント',
      chatSubtitle: 'ご質問にお答えします',
      chatClose: '閉じる',
      toolbarTitle: 'LLMチャットウィジェット',
      basePlaceholder: 'APIベース（任意）、例: http://host:18000',
      saveButton: '保存',
      themeButton: 'テーマ',
      languageLabel: '言語',
      statusUnknown: '不明',
      statusOk: 'オンライン',
      statusOffline: 'オフライン',
      bannerConnectionError: '接続エラー',
      bannerDismiss: '閉じる',
      projectLabel: 'プロジェクト',
      reloadProjects: '再読み込み',
      projectInfoNone: 'プロジェクトが選択されていません',
      projectInfoSelected: '現在のプロジェクト: {project}',
      debugLabel: 'デバッグ',
      debugHintOff: 'チャットで拡張イベントを表示する',
      debugHintOn: '拡張イベントが有効です',
      startPromptLabel: '初期プロンプト',
      startPromptPlaceholder: 'プロジェクトの初期プロンプト',
      savePrompt: 'プロンプトを保存',
      questionPlaceholder: '質問を入力 (Shift+Enter で改行)',
      stopButton: '停止',
      sendButton: '送信',
      inputHintSend: 'Enter で送信',
      inputHintNewline: 'Shift+Enter で改行',
      clearLink: 'クリア',
      errorLoadProjects: 'プロジェクトを読み込めませんでした',
      statusSaving: '保存中…',
      statusSaved: '保存しました',
      statusError: 'エラー',
      errorStreaming: 'ストリーミングエラー。コンソールを確認してください。',
      errorNoSSE: 'このブラウザは SSE をサポートしていません。',
      attachmentLabel: '添付ファイル',
      roleUser: 'ユーザー',
      roleAssistant: 'アシスタント',
      roleSystem: 'システム',
      roleDebug: 'デバッグ'
    }
  },
  ar: {
    name: 'العربية',
    dir: 'rtl',
    strings: {
      launcherTitle: 'مساعد الذكاء الاصطناعي',
      launcherSubtitle: 'اطرح أي سؤال',
      launcherAria: 'فتح المحادثة',
      chatTitle: 'مساعد الذكاء الاصطناعي',
      chatSubtitle: 'جاهز للإجابة عن أسئلتك',
      chatClose: 'إغلاق',
      toolbarTitle: 'أداة محادثة LLM',
      basePlaceholder: 'عنوان الـ API (اختياري)، مثل http://host:18000',
      saveButton: 'حفظ',
      themeButton: 'السمة',
      languageLabel: 'اللغة',
      statusUnknown: 'غير معروف',
      statusOk: 'متصل',
      statusOffline: 'غير متصل',
      bannerConnectionError: 'خطأ في الاتصال',
      bannerDismiss: 'إغلاق',
      projectLabel: 'المشروع',
      reloadProjects: 'تحديث',
      projectInfoNone: 'لم يتم اختيار مشروع',
      projectInfoSelected: 'المشروع الحالي: {project}',
      debugLabel: 'تصحيح',
      debugHintOff: 'إظهار الأحداث الموسعة في الدردشة',
      debugHintOn: 'تم تفعيل الأحداث الموسعة',
      startPromptLabel: 'المطالبة الابتدائية',
      startPromptPlaceholder: 'المطالبة الابتدائية للمشروع',
      savePrompt: 'حفظ المطالبة',
      questionPlaceholder: 'اكتب سؤالك (Shift+Enter = سطر جديد)',
      stopButton: 'إيقاف',
      sendButton: 'إرسال',
      inputHintSend: 'Enter للإرسال',
      inputHintNewline: 'Shift+Enter لسطر جديد',
      clearLink: 'مسح',
      errorLoadProjects: 'تعذر تحميل المشاريع',
      statusSaving: 'جارٍ الحفظ…',
      statusSaved: 'تم الحفظ',
      statusError: 'خطأ',
      errorStreaming: 'خطأ في البث، راجع وحدة التحكم.',
      errorNoSSE: 'هذا المتصفح لا يدعم SSE.',
      attachmentLabel: 'مرفق',
      roleUser: 'مستخدم',
      roleAssistant: 'مساعد',
      roleSystem: 'نظام',
      roleDebug: 'تصحيح'
    }
  }
};

let currentLanguage = (() => {
  try {
    const stored = localStorage.getItem(LANGUAGE_STORAGE_KEY);
    if (stored && LANGUAGES[stored]) {
      return stored;
    }
  } catch {}
  return FALLBACK_LANGUAGE;
})();

function t(key) {
  const lang = LANGUAGES[currentLanguage] || LANGUAGES[FALLBACK_LANGUAGE];
  return lang.strings[key] ?? LANGUAGES[FALLBACK_LANGUAGE].strings[key] ?? key;
}

function translateRole(role) {
  const normalized = String(role || '').toLowerCase();
  const map = {
    user: 'roleUser',
    assistant: 'roleAssistant',
    system: 'roleSystem',
    debug: 'roleDebug'
  };
  const key = map[normalized];
  return key ? t(key) : normalized;
}

function translateStatus(key) {
  const normalized = String(key || '').toLowerCase();
  const map = {
    unknown: 'statusUnknown',
    ok: 'statusOk',
    online: 'statusOk',
    offline: 'statusOffline'
  };
  const target = map[normalized];
  if (target) return t(target);
  return key;
}

function populateLanguageOptions() {
  if (!languageSelect) return;
  languageSelect.innerHTML = '';
  Object.entries(LANGUAGES).forEach(([code, cfg]) => {
    const option = document.createElement('option');
    option.value = code;
    option.textContent = cfg.name;
    languageSelect.appendChild(option);
  });
  languageSelect.value = currentLanguage;
}

function applyLanguage(lang) {
  if (!LANGUAGES[lang]) lang = FALLBACK_LANGUAGE;
  currentLanguage = lang;
  try { localStorage.setItem(LANGUAGE_STORAGE_KEY, currentLanguage); } catch {}
  const cfg = LANGUAGES[currentLanguage];
  document.documentElement.lang = currentLanguage;
  document.documentElement.dir = cfg.dir || 'ltr';
  if (languageSelect) {
    languageSelect.value = currentLanguage;
  }

  document.querySelectorAll('[data-i18n]').forEach((node) => {
    const key = node.dataset.i18n;
    node.textContent = t(key);
  });

  document.querySelectorAll('[data-i18n-placeholder]').forEach((node) => {
    const key = node.dataset.i18nPlaceholder;
    node.setAttribute('placeholder', t(key));
  });

  document.querySelectorAll('[data-i18n-aria-label]').forEach((node) => {
    const key = node.dataset.i18nAriaLabel;
    node.setAttribute('aria-label', t(key));
  });

  if (healthText) {
    const statusKey = healthText.dataset.statusKey || 'unknown';
    healthText.textContent = translateStatus(statusKey);
  }

  if (debugHint) {
    debugHint.textContent = debugCheckbox.checked ? t('debugHintOn') : t('debugHintOff');
  }

  if (projectInfo) {
    projectInfo.textContent = currentProject ? t('projectInfoSelected').replace('{project}', currentProject) : t('projectInfoNone');
  }

  if (hintSend) hintSend.textContent = t('inputHintSend');
  if (hintNewline) hintNewline.textContent = t('inputHintNewline');
  if (clearLink) clearLink.textContent = t('clearLink');

  if (banner && banner.dataset.active !== 'true' && bannerText) {
    bannerText.textContent = t('bannerConnectionError');
  }

  document.querySelectorAll('[data-role-key]').forEach((node) => {
    node.textContent = translateRole(node.dataset.roleKey);
  });
}

if (languageSelect) {
  populateLanguageOptions();
  languageSelect.addEventListener('change', (event) => {
    applyLanguage(event.target.value);
  });
}

applyLanguage(currentLanguage);


const SESSION_STORAGE_KEY = 'chat_session_base';
let currentSessionBase = (() => {
  try {
    const stored = localStorage.getItem(SESSION_STORAGE_KEY) || '';
    return stored.trim().toLowerCase();
  } catch {
    return '';
  }
})();

function generateSessionId() {
  try {
    if (window.crypto && typeof window.crypto.randomUUID === 'function') {
      return window.crypto.randomUUID().toLowerCase();
    }
  } catch {}
  const suffix = Math.random().toString(36).slice(2, 10);
  return `${Date.now().toString(36)}${suffix}`.toLowerCase();
}

function ensureSessionId() {
  if (currentSessionBase) return currentSessionBase;
  currentSessionBase = generateSessionId();
  try { localStorage.setItem(SESSION_STORAGE_KEY, currentSessionBase); } catch {}
  return currentSessionBase;
}

function updateSessionBase(sessionValue) {
  if (!sessionValue) return;
  let base = String(sessionValue);
  if (base.includes('::')) {
    const parts = base.split('::');
    base = parts[parts.length - 1] || parts[0];
  }
  base = base.trim().toLowerCase();
  if (!base || base === currentSessionBase) return;
  currentSessionBase = base;
  try { localStorage.setItem(SESSION_STORAGE_KEY, currentSessionBase); } catch {}
}

let currentES = null;
let streaming = false;
let tokenChars = 0;
let streamingMessageEl = null;
let projectsCache = {};

if (isEmbed) {
  document.body.classList.add('embed');
}

function openChat() {
  chatModal.classList.add('open');
  chatBackdrop.classList.add('open');
  setTimeout(() => { input?.focus(); }, 150);
}

function closeChat() {
  if (!document.body.classList.contains('embed')) return;
  chatModal.classList.remove('open');
  chatBackdrop.classList.remove('open');
}

if (widgetLauncher) widgetLauncher.addEventListener('click', openChat);
if (chatClose) chatClose.addEventListener('click', closeChat);
if (chatBackdrop) chatBackdrop.addEventListener('click', closeChat);
document.addEventListener('keydown', (evt) => {
  if (evt.key === 'Escape') closeChat();
});

// Load saved base URL
baseUrlInput.value = localStorage.getItem('chat_base_url') || '';

function setTheme(theme) {
  const next = theme === 'light' ? 'light' : 'dark';
  document.documentElement.dataset.theme = next;
  try { localStorage.setItem('chat_theme', next); } catch {}
}

function toggleTheme() {
  const current = document.documentElement.dataset.theme || 'dark';
  setTheme(current === 'dark' ? 'light' : 'dark');
}

themeToggle.addEventListener('click', toggleTheme);

function setHealth(ok, statusKey) {
  healthDot.classList.remove('ok', 'bad');
  if (ok === true) healthDot.classList.add('ok');
  else if (ok === false) healthDot.classList.add('bad');
  const key = typeof statusKey === 'string' && statusKey ? statusKey : 'unknown';
  if (healthText) {
    healthText.dataset.statusKey = key;
    healthText.textContent = translateStatus(key);
  }
}

async function pingHealth() {
  const base = baseUrlInput.value.trim();
  const url = base ? `${base.replace(/\/$/, '')}/health` : '/health';
  try {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    const message = data?.status || 'ok';
    setHealth(true, message);
  } catch (error) {
    console.error(error);
    setHealth(false, 'offline');
  }
}

function saveConfig() {
  const base = baseUrlInput.value.trim();
  try { localStorage.setItem('chat_base_url', base); } catch {}
  pingHealth();
}

saveCfgBtn.addEventListener('click', saveConfig);

const SESSION_KEY = 'chat_session_id';
let currentSession = localStorage.getItem(SESSION_KEY) || '';

function ensureSession() {
  if (!currentSession) {
    currentSession = `${ensureSessionId()}::${generateSessionId()}`;
    try { localStorage.setItem(SESSION_KEY, currentSession); } catch {}
  }
  return currentSession;
}

function newSession() {
  currentSession = `${ensureSessionId()}::${generateSessionId()}`;
  try { localStorage.setItem(SESSION_KEY, currentSession); } catch {}
  return currentSession;
}

function appendMessage(text, role = 'assistant', meta = {}) {
  const wrapper = document.createElement('div');
  wrapper.className = `msg ${role}`;
  const head = document.createElement('div');
  head.className = 'role';
  const t = new Date();
  const hh = String(t.getHours()).padStart(2, '0');
  const mm = String(t.getMinutes()).padStart(2, '0');
  const roleSpan = document.createElement('span');
  roleSpan.dataset.roleKey = role;
  roleSpan.textContent = translateRole(role);
  const timeSpan = document.createElement('span');
  timeSpan.className = 'time';
  timeSpan.textContent = `${hh}:${mm}`;
  head.appendChild(roleSpan);
  head.appendChild(timeSpan);
  wrapper.appendChild(head);
  const body = document.createElement('div');
  body.className = 'msg-body';
  body.textContent = text;
  wrapper.appendChild(body);
  if (meta.attachments?.length) {
    const attachmentsRoot = document.createElement('div');
    attachmentsRoot.className = 'msg-attachments';
    meta.attachments.forEach((att) => {
      const attEl = document.createElement('div');
      attEl.className = 'attachment-item';
      if (att.content_type?.startsWith('image/')) {
        attEl.classList.add('attachment-image');
        const img = document.createElement('img');
        img.src = att.url;
        img.alt = att.description || att.name || t('attachmentLabel');
        attEl.appendChild(img);
        if (att.description) {
          const caption = document.createElement('div');
          caption.className = 'attachment-caption';
          caption.textContent = att.description;
          attEl.appendChild(caption);
        }
      } else {
        attEl.classList.add('attachment-file');
        const link = document.createElement('a');
        link.href = att.url;
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = att.name || t('attachmentLabel');
        attEl.appendChild(link);
        if (att.description) {
          const caption = document.createElement('div');
          caption.className = 'attachment-caption';
          caption.textContent = att.description;
          attEl.appendChild(caption);
        }
      }
      attachmentsRoot.appendChild(attEl);
    });
    wrapper.appendChild(attachmentsRoot);
  }
  messages.appendChild(wrapper);
  messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
  return wrapper;
}

function addSystemMessage(text) {
  appendMessage(text, 'system');
}

function clearMessages() {
  messages.innerHTML = '';
  try { localStorage.removeItem('chat_history'); } catch {}
}

clearLink.addEventListener('click', (event) => {
  event.preventDefault();
  clearMessages();
});

function saveHistory() {
  try {
    localStorage.setItem('chat_history', messages.innerHTML);
  } catch {}
}

(function restoreHistory() {
  try {
    const history = localStorage.getItem('chat_history');
    if (history) {
      messages.innerHTML = history;
      applyLanguage(currentLanguage);
    }
  } catch {}
})();

function setStreamingState(value) {
  streaming = Boolean(value);
  stopBtn.disabled = !streaming;
  sendBtn.disabled = streaming;
  input.readOnly = streaming;
}

async function loadProjects() {
  const base = baseUrlInput.value.trim();
  const url = base ? `${base.replace(/\/$/, '')}/api/v1/admin/projects/names` : '/api/v1/admin/projects/names';
  try {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('Failed to load projects');
    const data = await resp.json();
    projectsCache = data.projects || [];
    projectSelect.innerHTML = '';
    projectsCache.forEach((name) => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      projectSelect.appendChild(option);
    });
    if (currentProject && projectsCache.includes(currentProject)) {
      projectSelect.value = currentProject;
    } else if (projectsCache.length) {
      currentProject = projectsCache[0];
      projectSelect.value = currentProject;
    }
    updateProjectInfo();
  } catch (error) {
    console.error(error);
    bannerError(t('errorLoadProjects'));
  }
}

function updateProjectInfo() {
  const selected = projectSelect.value || '';
  currentProject = selected;
  try { localStorage.setItem('chat_project', currentProject); } catch {}
  if (projectInfo) {
    projectInfo.textContent = currentProject ? t('projectInfoSelected').replace('{project}', currentProject) : t('projectInfoNone');
  }
}

projectSelect.addEventListener('change', () => {
  updateProjectInfo();
});
refreshProjectsBtn.addEventListener('click', loadProjects);

debugCheckbox.addEventListener('change', () => {
  const hint = debugCheckbox.checked ? t('debugHintOn') : t('debugHintOff');
  debugHint.textContent = hint;
});

savePromptBtn.addEventListener('click', async () => {
  const base = baseUrlInput.value.trim();
  const url = base ? `${base.replace(/\/$/, '')}/api/v1/admin/projects/${encodeURIComponent(currentProject)}` : `/api/v1/admin/projects/${encodeURIComponent(currentProject)}`;
  const payload = {
    name: currentProject,
    llm_prompt: startPromptInput.value,
  };
  promptStatus.textContent = t('statusSaving');
  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (!resp.ok) throw new Error('Failed');
    promptStatus.textContent = t('statusSaved');
    setTimeout(() => (promptStatus.textContent = ''), 3000);
  } catch (error) {
    console.error(error);
    promptStatus.textContent = t('statusError');
  }
});

function bannerError(message) {
  banner.dataset.active = 'true';
  bannerText.textContent = message || t('bannerConnectionError');
  banner.style.display = 'block';
}

bannerClose.addEventListener('click', () => {
  banner.style.display = 'none';
  banner.dataset.active = 'false';
  bannerText.textContent = t('bannerConnectionError');
});

async function sendQuestion(question) {
  const base = baseUrlInput.value.trim();
  const endpointBase = base ? base.replace(/\/$/, '') : '';
  const params = new URLSearchParams();
  params.set('question', question);
  if (currentProject) params.set('project', currentProject);
  const sessionId = ensureSession();
  params.set('session_id', sessionId);
  if (debugCheckbox.checked) params.set('debug', '1');
  const url = `${endpointBase || ''}/api/v1/llm/chat?${params.toString()}`;

  if (currentES) {
    currentES.close();
    currentES = null;
  }

  const chunks = [];
  tokenChars = 0;
  streamingMessageEl = null;
  setStreamingState(true);

  try {
    currentES = new EventSource(url, { withCredentials: false });
  } catch (error) {
    bannerError(t('errorNoSSE'));
    setStreamingState(false);
    return;
  }

  currentES.addEventListener('message', (event) => {
    try {
      const data = JSON.parse(event.data);
      if (typeof data?.text === 'string') {
        chunks.push(data.text);
        tokenChars += data.text.length;
        if (!streamingMessageEl) {
          streamingMessageEl = appendMessage('', data.role || 'assistant', data.meta || {});
        }
        const body = streamingMessageEl?.querySelector('.msg-body');
        if (body) {
          body.textContent += data.text;
        }
        saveHistory();
      }
      if (data?.meta?.session_id) {
        updateSessionBase(data.meta.session_id);
      }
    } catch (error) {
      console.error('stream parse error', error, event.data);
    }
  });

  currentES.addEventListener('meta', (event) => {
    try {
      const meta = JSON.parse(event.data);
      if (meta?.session_id) {
        updateSessionBase(meta.session_id);
      }
    } catch (error) {
      console.error('meta parse error', error, event.data);
    }
  });

  currentES.addEventListener('debug', (event) => {
    if (!debugCheckbox.checked) return;
    try {
      const data = JSON.parse(event.data);
      appendMessage(JSON.stringify(data, null, 2), 'debug');
      saveHistory();
    } catch (error) {
      console.error('debug parse error', error);
    }
  });

  currentES.addEventListener('attachment', (event) => {
    try {
      const data = JSON.parse(event.data);
      appendMessage(data.description || data.name || t('attachmentLabel'), 'assistant', { attachments: [data] });
      saveHistory();
    } catch (error) {
      console.error('attachment parse error', error);
    }
  });

  currentES.addEventListener('end', () => {
    setStreamingState(false);
    currentES?.close();
  });

  currentES.addEventListener('error', (event) => {
    console.error('sse error', event);
    bannerError(t('errorStreaming'));
    setStreamingState(false);
    currentES?.close();
    streamingMessageEl = null;
  });
}

form.addEventListener('submit', async (event) => {
  event.preventDefault();
  if (isEmbed && !chatModal.classList.contains('open')) {
    openChat();
  }
  const question = input.value.trim();
  if (!question) return;
  appendMessage(question, 'user');
  saveHistory();
  input.value = '';
  sendBtn.disabled = true;
  try {
    await sendQuestion(question);
  } finally {
    sendBtn.disabled = false;
  }
});

stopBtn.addEventListener('click', () => {
  if (
    currentES &&
    typeof currentES.close === 'function'
  ) {
    currentES.close();
  }
  setStreamingState(false);
  streamingMessageEl = null;
});

saveCfgBtn.addEventListener('click', saveConfig);

setTheme(localStorage.getItem('chat_theme') || 'dark');

window.addEventListener('load', () => {
  ensureSessionId();
  if (!isEmbed) {
    chatModal.classList.add('open');
  }
  loadProjects().finally(() => {
    if (currentProject) {
      projectSelect.value = currentProject;
      updateProjectInfo();
    }
  });
  pingHealth();
  setInterval(pingHealth, 15000);
});
</script>
</body>
</html>
