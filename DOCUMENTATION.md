# SiteLLM Vertebro - Полная документация проекта

## Оглавление

1. [Обзор проекта](#обзор-проекта)
2. [Архитектура](#архитектура)
3. [Компоненты системы](#компоненты-системы)
4. [Backend API](#backend-api)
5. [Админ-панель](#админ-панель)
6. [Интеграции](#интеграции)
7. [Конфигурация](#конфигурация)
8. [Развертывание](#развертывание)

---

## Обзор проекта

**SiteLLM Vertebro** — это комплексная платформа для создания AI-ассистентов с использованием технологии RAG (Retrieval-Augmented Generation). Платформа предоставляет полное решение для построения чат-ботов на базе собственных баз знаний.

### Основные возможности

- **Веб-краулинг**: Автоматический сбор контента с веб-сайтов
- **База знаний**: Управление документами, Q&A парами, изображениями
- **Векторный поиск**: Семантический поиск с использованием Qdrant
- **LLM интеграция**: Поддержка Ollama с кластеризацией серверов
- **Мультиканальность**: Telegram, VK, Max боты + встраиваемый виджет
- **Интеграции**: Bitrix24 CRM, IMAP/SMTP почта
- **Многопроектность**: Изолированные базы знаний для разных проектов
- **Админ-панель**: Веб-интерфейс для управления всеми аспектами системы
- **Мониторинг**: Реалтайм мониторинг ресурсов, логов, статистики

---

## Архитектура

### Паттерн архитектуры

**Модульный монолит** с возможностью микросервисной декомпозиции:
- Единое FastAPI приложение с несколькими роутерами
- Разделенные базы данных (MongoDB, Redis, Qdrant)
- Фоновые воркеры (Celery) в отдельных процессах
- Независимые боты для мессенджеров

### RAG Pipeline

```
Запрос пользователя
  → Векторный поиск (семантический)
  → BM25 поиск (ключевые слова)
  → RRF Fusion (объединение результатов)
  → Опциональный reranking
  → Инъекция контекста в промпт
  → Генерация ответа LLM
  → Стриминг ответа через SSE
```

### Технологический стек

#### Backend
- **Python 3.10-3.12**
- **FastAPI 0.115+** - асинхронный веб-фреймворк
- **Uvicorn** - ASGI сервер
- **Celery 5.5+** - очередь задач с beat-планировщиком
- **Motor 3.7+** - асинхронный драйвер MongoDB
- **Redis 5.0+** - кэш, брокер, векторное хранилище

#### LLM и эмбеддинги
- **Ollama** - основной runtime для LLM с поддержкой кластера
- **Sentence Transformers 2.7+** - текстовые эмбеддинги
- **LangChain 0.3+** - оркестрация LLM
- Модель по умолчанию: `Vikhrmodels/Vikhr-YandexGPT-5-Lite-8B-it`
- Эмбеддинги: `ai-forever/sbert_large_nlu_ru`

#### Хранилище данных
- **MongoDB 5+** - документы, метаданные, история
- **GridFS** - бинарные файлы
- **Redis** - кэш, векторы, pub/sub
- **Qdrant** - специализированная векторная БД

#### Краулер и обработка
- **aiohttp** - асинхронный HTTP
- **BeautifulSoup4** - парсинг HTML
- **Playwright** - опционально для JS-сайтов
- **PyPDF**, **docx2txt**, **openpyxl** - обработка документов

#### Frontend
- **Vanilla JavaScript** - без фреймворков
- **Server-Sent Events (SSE)** - реалтайм стриминг
- **Web Speech API** - голосовой аватар
- **Canvas API** - графики статистики

---

## Компоненты системы

### 1. Backend сервисы

#### FastAPI приложение (`app.py` - 6876 строк)
- HTTP сервер и фабрика приложения
- Монтирование роутеров и статических файлов
- Middleware для аутентификации, CORS, метрик
- Управление жизненным циклом (startup/shutdown)
- Healthcheck и метрики
- Раздача админ-панели и виджета

**Основные эндпоинты:**
- `/health`, `/healthz` - проверка здоровья
- `/status` - системный статус
- `/admin` - админ-панель (статический UI)
- `/widget` - встраиваемый виджет
- `/api/v1/llm/chat` - SSE стриминг чат
- `/metrics` - Prometheus метрики

#### API Router (`api.py` - 3588 строк)
- Публичные чат-эндпоинты
- Управление краулером
- Управление базой знаний
- Админские эндпоинты для проектов/настроек
- Режим чтения (book-like контент)
- Обучение голосовых моделей
- Mail connector
- Интеграции (Bitrix, Email)

**~120 REST эндпоинтов** в категориях:
- LLM запросы
- Управление знаниями
- Q&A пары
- Краулер
- Проекты
- Боты (Telegram, VK, Max)
- Ollama управление
- Статистика
- Бэкапы
- Обратная связь

#### Worker (`worker.py` - 866 строк)
Celery воркер для фоновых задач:
- Обновление векторных эмбеддингов
- Бэкап/восстановление
- Обучение голосовых моделей
- Периодические отчеты о статусе
- Планируемое обслуживание

**Celery Beat расписание:**
```python
{
    "update-vector-store-biweekly": {
        "schedule": crontab(day_of_week=[3, 6])  # Среда, Суббота
    },
    "status-report-every-30s": {
        "schedule": 30.0
    },
    "backup-scheduler": {
        "schedule": 300.0  # 5 минут
    }
}
```

### 2. Слой данных

#### MongoDB (`mongo.py` - 2796 строк)
Асинхронные операции с MongoDB:

**Коллекции:**
- `contexts` - история диалогов
- `contextPresets` - системные промпты
- `documents` - база знаний
- `projects` - мультитенантные проекты
- `app_settings` - настройки приложения
- `knowledge_qa` - Q&A пары
- `unanswered_questions` - неотвеченные вопросы
- `feedback_tasks` - обратная связь
- `ollama_servers` - конфигурация кластера Ollama
- `voice_samples` - образцы голоса
- `voice_training_jobs` - задачи обучения голоса
- `backup_jobs` - история бэкапов
- `reading_pages` - страницы для режима чтения
- `request_stats` - аналитика

**GridFS** для файлового хранилища (PDF, DOCX, изображения, аудио)

#### Векторное хранилище (`vectors.py`)
- Клиент Qdrant для векторных эмбеддингов
- Парсинг и чанкинг документов
- Извлечение текста из PDF, DOCX, XLS, XLSX, DOC
- Генерация и хранение эмбеддингов

#### Redis
Три основных применения:
1. Брокер и бэкенд результатов Celery
2. Кэш приложения (результаты поиска)
3. Управление состоянием краулера
4. Хранение сессий

**Паттерны ключей:**
- `vector:{sha1_hash}` - кэшированные результаты поиска
- `crawl:*` - состояния задач краулера
- `admin_session:{token}` - сессии администраторов

### 3. Подсистема краулера (`/crawler`)

#### `run_crawl.py` (90KB)
Асинхронный веб-краулер:
- BFS-обход сайта
- Опциональный рендеринг через Playwright для JS-сайтов
- Извлечение и очистка HTML/PDF текста
- Дедупликация URL
- Режим чтения книг (сегментация контента на страницы)
- Отчеты о прогрессе через Redis pub/sub

**Конфигурируемые параметры:**
- Начальный URL
- Максимальная глубина обхода
- Максимальное количество страниц
- Режим рендеринга JS (auto/always/never)
- Специальные режимы сбора (книги, Medex ссылки)

### 4. Система поиска (`/retrieval`)

#### `search.py` - Гибридный поиск
- **Векторный поиск** - семантическая близость (Qdrant)
- **BM25 поиск** - ключевые слова
- **RRF (Reciprocal Rank Fusion)** - объединение результатов
- Кэширование через Redis

#### `rerank.py` - Перерангирование
- Опциональный cross-encoder reranking
- Повышает релевантность результатов поиска
- Модель: `sbert_cross_ru`

#### `embedder.py` - Эмбеддинги
- Обертка HuggingFace embeddings
- Поддержка локальных и удаленных моделей
- Модель по умолчанию: `ai-forever/sbert_large_nlu_ru`

### 5. LLM интеграция (`/backend`)

#### `llm_client.py`
Абстракция для LLM инференса:
- Поддержка Ollama, YaLLM, llama.cpp
- Стриминг токенов
- Обработка ошибок и ретраи

#### `ollama.py` & `ollama_cluster.py`
Управление серверами Ollama:
- **Кластер с балансировкой нагрузки**
- Мониторинг здоровья (каждые 30с)
- Обработка отказов с cooldown периодами
- Автоматическая загрузка отсутствующих моделей
- Метрики (латентность, количество запросов)

**Особенности кластера:**
- Round-robin с выбором по латентности
- Cooldown после 3 ошибок (15с по умолчанию)
- Динамическое добавление/удаление серверов
- Отслеживание запросов в полете

### 6. Frontend интерфейсы

#### Админ-панель (`/admin`)
Одностраничное приложение (SPA):
- **index.html** - 63KB главный файл
- **10 языков UI**: EN, ES, DE, FR, IT, PT, RU, ZH, JA, AR
- **600+ ключей переводов** в i18n-static.js

**Компоненты:**
- Управление проектами
- Управление краулером
- Браузер базы знаний
- Просмотрщик логов (последние 3 дня)
- Карточки статуса (DB, сервисы, ресурсы)
- Управление интеграциями
- Интерфейс бэкапа/восстановления
- Обучение голосовых моделей
- Статистика активности

#### Виджет чата (`/widget`)
Встраиваемый чат-интерфейс:
- **index.html** - 154KB
- SSE стриминг для реалтайм ответов
- Поддержка голосового аватара (`voice-avatar.js` - 120KB)
- Режим чтения книг
- Адаптивный дизайн для мобильных
- Загрузчик виджета (`widget-loader.js`)

### 7. Боты для мессенджеров

#### Telegram Bot (`/tg_bot`)
- Построен на Aiogram 3.5+
- Обработка диалогов
- Пересылка вложений
- Подтверждения mail connector
- Действия интеграции Bitrix
- Поддержка нескольких проектов (TelegramHub)

#### VK Bot (`/vk_bot`)
- Интеграция VK API
- Обработка сообщений
- Мультипроектность (VKHub)

#### Max Bot (`/max_bot`)
- Интеграция Max (Mail.ru Agent)
- Аналогичная архитектура

### 8. Интеграции (`/integrations`)

#### `bitrix.py` - Bitrix24 CRM
- Интеграция через вебхук
- Доступ к сущностям CRM (лиды, контакты, сделки)
- Обработка ошибок с `BitrixError`
- Таймаут 10с по умолчанию

#### `mail.py` - Email connector
- **IMAP**: Получение недавних сообщений
- **SMTP**: Отправка писем с поддержкой reply-to
- SSL/TLS для обоих протоколов
- Парсинг писем с multipart
- Суммаризация сообщений

---

## Backend API

### Публичные эндпоинты

#### LLM запросы
```
POST /llm/ask                    - Запрос без стриминга
GET  /llm/chat                   - SSE стриминг чат
GET  /llm/project-config         - Конфигурация проекта
POST /llm/bitrix/confirm         - Подтверждение действия Bitrix24
POST /llm/bitrix/cancel          - Отмена действия Bitrix24
POST /llm/mail/confirm           - Подтверждение email действия
POST /llm/mail/cancel            - Отмена email действия
```

### Админские эндпоинты

#### Управление базой знаний
```
GET    /api/v1/admin/knowledge                    - Список документов
POST   /api/v1/admin/knowledge                    - Добавить по URL
POST   /api/v1/admin/knowledge/upload             - Загрузить файлы
DELETE /api/v1/admin/knowledge                    - Массовое удаление
GET    /api/v1/admin/knowledge/documents/{id}     - Скачать документ
GET    /api/v1/admin/knowledge/documents/{id}/metadata - Метаданные
PUT    /api/v1/admin/knowledge/documents/{id}     - Обновить метаданные
DELETE /api/v1/admin/knowledge/{file_id}          - Удалить документ
POST   /api/v1/admin/knowledge/deduplicate        - Удалить дубликаты
POST   /api/v1/admin/knowledge/reindex            - Переиндексировать
GET    /api/v1/admin/knowledge/priority           - Приоритетные источники
POST   /api/v1/admin/knowledge/priority           - Установить приоритет
```

#### Q&A управление
```
GET    /api/v1/admin/knowledge/qa                 - Список Q&A
POST   /api/v1/admin/knowledge/qa                 - Создать Q&A
POST   /api/v1/admin/knowledge/qa/upload          - Загрузить из Excel
PUT    /api/v1/admin/knowledge/qa/{pair_id}       - Обновить Q&A
DELETE /api/v1/admin/knowledge/qa/{pair_id}       - Удалить Q&A
POST   /api/v1/admin/knowledge/qa/reorder         - Переупорядочить
```

#### Краулер
```
POST /api/v1/crawler/run            - Запустить краулинг
GET  /api/v1/crawler/status         - Статус краулера
POST /api/v1/crawler/reset          - Сбросить состояние
POST /api/v1/crawler/deduplicate    - Удалить дубликаты URL
POST /api/v1/crawler/stop           - Остановить краулер
```

#### Управление проектами
```
GET    /api/v1/admin/projects                        - Список проектов
POST   /api/v1/admin/projects                        - Создать проект
DELETE /api/v1/admin/projects/{domain}               - Удалить проект
GET    /api/v1/admin/projects/names                  - Имена проектов
GET    /api/v1/admin/projects/storage                - Использование хранилища
POST   /api/v1/admin/projects/prompt                 - Тест промпта
GET    /api/v1/admin/projects/{domain}/test          - Тест конфигурации
```

#### Управление ботами

**Telegram:**
```
GET  /api/v1/admin/telegram                         - Статус
POST /api/v1/admin/telegram/config                  - Конфигурация
POST /api/v1/admin/telegram/start                   - Запустить
POST /api/v1/admin/telegram/stop                    - Остановить

# Попроектные эндпоинты
GET  /api/v1/admin/projects/{project}/telegram
POST /api/v1/admin/projects/{project}/telegram/config
POST /api/v1/admin/projects/{project}/telegram/start
POST /api/v1/admin/projects/{project}/telegram/stop
```

**VK и Max** - аналогичная структура эндпоинтов

#### Управление Ollama
```
GET    /api/v1/admin/ollama/catalog               - Каталог моделей
GET    /api/v1/admin/ollama/servers               - Список серверов
POST   /api/v1/admin/ollama/servers               - Добавить сервер
DELETE /api/v1/admin/ollama/servers/{name}        - Удалить сервер
POST   /api/v1/admin/ollama/install               - Установить модель
GET    /api/v1/admin/llm/models                   - Установленные модели
GET    /api/v1/admin/llm/availability             - Доступность LLM
```

#### Бэкапы
```
GET  /api/v1/backup/status          - Статус и история
POST /api/v1/backup/settings        - Настроить бэкапы
POST /api/v1/backup/run             - Запустить бэкап
POST /api/v1/backup/restore         - Восстановить
```

#### Статистика
```
GET /api/v1/admin/stats/requests        - Статистика запросов
GET /api/v1/admin/stats/requests/export - Экспорт в CSV
```

### Аутентификация

**HTTP Basic Authentication Middleware**

**Защищенные пути:**
- `/admin`
- `/api/v1/admin`
- `/api/v1/backup`
- `/api/v1/crawler`
- `/api/intelligent-processing`

**Механизм аутентификации:**
1. Session Cookie: `admin_session` (HttpOnly, SameSite=Lax, 24ч TTL)
2. HTTP Basic Auth: резерв при отсутствии сессии

**Типы пользователей:**
- **Super Admin**: из env переменных `ADMIN_USER`/`ADMIN_PASSWORD`
  - Полный доступ ко всем проектам и системным функциям
- **Project Admin**: из MongoDB коллекции `projects`
  - Доступ только к своим проектам

**Хранение паролей:**
- Super admin: SHA256 digest в памяти из env
- Project admins: SHA256 hexdigest в MongoDB
- Сравнение через `hmac.compare_digest()` для защиты от timing-атак

---

## Админ-панель

### Разделы и страницы

#### 1. База знаний (5 вкладок)

**Overview** - Обзор и поиск
- Выбор проекта
- Текстовый поиск
- Управление лимитом результатов
- Приоритет источников (drag & drop)

**Upload** - Загрузка документов
- Ручная загрузка (URL, описание)
- Загрузка файлов (drag & drop)
- Автогенерация описаний с помощью AI
- Ввод сырого текста

**Documents** - Управление документами
- 3 категории: Тексты, Документы, Изображения
- Просмотр в таблицах
- Редактирование метаданных
- Скачивание файлов
- Удаление
- Массовые операции (дубликаты, очистка)

**Q&A** - Вопросы и ответы
- Импорт из Excel
- Ручное добавление
- Управление приоритетом
- CRUD операции

**Unanswered** - Неотвеченные вопросы
- Отслеживание вопросов без ответов
- Метрики и статистика
- Экспорт в CSV
- Очистка
- Автоудаление (старше 30 дней)

#### 2. Обзорный баннер (4 карточки статуса)

**Карточка проекта**
- Текущий проект
- Домен, модель, настройки
- Разбивка хранилища
- Анимация активности

**Карточка краулинга**
- Статус (Сканирование, В очереди, Готово, Ошибки)
- Счетчики страниц
- Последний URL
- Время последнего запуска
- Анимация активности

**Карточка LLM**
- Статус доступности
- Количество документов
- Превью недавних промптов
- Использованные источники знаний
- Предупреждения о подключении

**Карточка сборки**
- Процент заполнения векторного хранилища
- Количество документов MongoDB
- Количество точек Qdrant
- Анимация активности

#### 3. Управление краулером

**Панель запуска:**
- Начальный URL (с валидацией)
- Максимальная глубина
- Максимум страниц
- Сбор книг (режим чтения)
- Сбор Medex ссылок
- Старт/Стоп/Сброс
- Удаление дубликатов URL

**Прогресс в реальном времени:**
- Визуальный прогресс-бар
- Текст статуса
- Счетчики страниц
- Заметки и предупреждения
- Отображение последнего URL

**Логи краулера:**
- Живой стриминг логов
- Копирование в буфер
- Обновление по требованию
- Фильтрация
- Автообновление (5с интервал)

#### 4. Управление проектами

**Переключатель проектов:**
- Выпадающий список всех проектов
- Добавление проекта (модалка)
- Обновление списка
- Автовыбор последнего проекта

**Форма конфигурации проекта:**

**Базовая информация:**
- Идентификатор (английский, lowercase)
- Название (отображаемое)
- Домен (опционально)
- LLM модель (автодополнение из Ollama)

**Конфигурация промпта:**
- Начальный промпт (системные инструкции)
- AI-генерация промптов (3 роли):
  1. Дружелюбный эксперт
  2. Формальный консультант
  3. Активный менеджер
- Генерация на основе домена

**Переключатели поведения:**
- Эмоции/эмодзи в ответах (вкл по умолчанию)
- Голосовой ассистент (анимированный, вкл)
- Голосовая модель (опционально)
- Подписи к изображениям (LLM, вкл)
- Показывать источники ответов (выкл)
- Сервисная заметка перед ответом (вкл)
- Детальная отладка после ответа (выкл)

**Учетные данные администратора:**
- Логин админа
- Пароль админа (смена или установка)
- Индикатор статуса пароля

**Отображение хранилища:**
- Размер текстов (промпты)
- Размер файлов (бинарные)
- Размер контекстов
- Размер ключей Redis

**Действия:**
- Сохранить проект
- Сохранить только промпт
- Тест сервисов (MongoDB, Redis, Qdrant)

**Опасная зона (только Super Admin):**
- Удаление проекта
- Показ объема данных
- Диалог подтверждения

#### 5. Интеграции

**Telegram Bot:**
- Токен бота (скрытый)
- Автозапуск при старте
- Статус (Работает/Остановлен)
- Сохранить/Запустить/Остановить
- Последняя ошибка

**MAX Bot и VK Bot** - аналогичный интерфейс

**Bitrix24:**
- URL вебхука
- Включить/Выключить
- Система подсказок:
  - Не настроен
  - Настроен но выключен
  - Активен и включен

**Mail Connector:**
- IMAP конфигурация (хост, порт, SSL)
- SMTP конфигурация (хост, порт, STARTTLS)
- Учетные данные (логин, пароль)
- Отправитель (From адрес)
- Подпись email
- Включить/Выключить
- Система подсказок

#### 6. Бэкапы (только Super Admin)

**Конфигурация расписания:**
- Включить ежедневный бэкап
- Время запуска (HH:MM)
- Часовой пояс (14 российских + UTC)
- Удаленная папка (Yandex.Disk)
- OAuth токен (сохранить/очистить)

**Ручные действия:**
- Создать бэкап сейчас
- Обновить статус
- Восстановить из пути
- Кнопка восстановления

**Журнал операций:**
- Список недавних операций
- Детали задачи (тип, статус, путь, время, ошибки)
- Использовать путь для восстановления
- Копировать путь

#### 7. Управление LLM

**Конфигурация Ollama:**
- Base URL сервера Ollama
- Имя модели
- Сохранить/Ping тест
- Отображение статуса (модель, бэкенд, устройство)

**Каталог Ollama:**
- Установленные модели (с удалением)
- Популярные модели (с установкой)
- Очередь установки
- Доступность каталога (локальный CLI vs удаленные серверы)

**Серверы Ollama (управление кластером):**
- Список серверов
- Детали сервера:
  - Имя
  - URL
  - Включен/Выключен
  - Статус (здоров/ошибка/неизвестно)
  - Латентность (мс)
  - Запросов в час
  - Запросов в полете
  - Последнее обновление
- Добавить сервер
- Удалить сервер
- Статистика (Всего/Включено/Доступно)

#### 8. Статистика и мониторинг

**График активности пользователей:**
- Период: последние 14 дней
- Интерактивный график:
  - Линия с градиентной заливкой
  - Подсказки при наведении
  - Подсветка точек
  - Анимированные переходы
- Итоги (всего запросов, среднее в день)
- Экспорт в CSV

**Карточка статуса краулера:**
- Счетчики (В очереди, В процессе, Готово, Ошибки)
- Последний краулинг
- Текущий проект
- Недавние URL (раскрываемый список)

**Карточка здоровья сервисов:**
- MongoDB: работает/не работает + подсказка с ошибкой
- Redis: работает/не работает
- Qdrant: работает/не работает
- Общий статус: деградирован/здоров/неизвестно

**Карточка ресурсов:**
- CPU (приложение): использование %
- CPU (система): использование %
- RAM: Использовано/Всего МБ с процентом
- RSS: Resident set size в МБ
- GPU: информация (если доступно)
- Python: версия

#### 9. Интеллектуальная обработка

**Knowledge Service:**
- Включить/Выключить сервис
- Режим запуска (ручной/автоматический)
- Промпт обработки (кастомные инструкции)
- Сохранить настройки / Запустить / Обновить статус
- Отображение статуса:
  - Состояние сервиса
  - Режим
  - Статус (активен/остановлен/ожидание)
  - Размер очереди
  - Время простоя
  - Последний запуск
  - Сообщения об ошибках

### Интернационализация (i18n)

**Поддерживаемые языки:**
- English (en) - по умолчанию
- Russian (ru) - полная поддержка
- Дополнительно: ES, DE, FR для некоторых ключей

**Система переводов:**
- 600+ ключей в `i18n-static.js`
- Динамический контент переводится при смене языка
- Категории:
  - Текстовые метки и кнопки
  - Плейсхолдеры
  - Заголовки (тултипы)
  - Alt текст
  - ARIA метки

**Смена языка:**
- Мгновенное обновление без перезагрузки
- Сохранение выбора
- Перерисовка графиков с новыми метками
- Регенерация динамических подсказок

### JavaScript архитектура модулей

**Основные модули:**

1. **projects.js** (1349 строк) - CRUD проектов, валидация форм, управление виджетами
2. **crawler.js** (623 строки) - старт/стоп краулера, отслеживание прогресса, мониторинг
3. **stats.js** (482 строки) - рендеринг графиков на Canvas, анимация, экспорт CSV
4. **backup.js** (530 строк) - конфигурация расписания, управление токенами, задачи бэкапа
5. **index.js** (38000+ строк) - бутстрап приложения, управление состоянием, обмен событиями

**Модули интеграций:**
- **telegram.js**, **max.js**, **vk.js** - управление ботами
- **bitrix.js**, **mail.js** - внешние интеграции

**Утилиты:**
- **i18n.js** - система переводов
- **auth.js** - обработка аутентификации
- **voice.js** - логика обучения голоса
- **ollama.js** - каталог и управление серверами

---

## Интеграции

### 1. Bitrix24 CRM

**Возможности:**
- Вызовы API через вебхук
- Доступ к сущностям CRM (лиды, контакты, сделки, компании)
- Обработка ошибок
- Таймаут 10с

**Конфигурация проекта:**
- `bitrix_enabled`: bool
- `bitrix_webhook_url`: str

### 2. IMAP/SMTP Mail

**Возможности:**
- **IMAP**: получение недавних сообщений (непрочитанные/все)
- **SMTP**: отправка писем с reply-to, in-reply-to
- SSL/TLS для обоих протоколов
- Парсинг multi-part писем
- Суммаризация сообщений

**Конфигурация проекта:**
- `mail_enabled`, `mail_imap_host/port/ssl`
- `mail_smtp_host/port/tls`
- `mail_username`, `mail_password`
- `mail_from`, `mail_signature`

### 3. Telegram Bot

**Возможности:**
- Aiogram 3.5+ бот
- Поддержка нескольких проектов (TelegramHub)
- Управление сессиями
- Вложения (документы, изображения)
- "God mode" для создания проектов админом
- Подтверждения Bitrix/Mail интеграций

**Конфигурация:**
- `telegram_token`: str
- `telegram_auto_start`: bool

### 4. VK и Max Bots

Аналогичная архитектура с хабами для мультипроектности.

### 5. Ollama LLM Provider

**Возможности:**
- Управление кластером с балансировкой
- Мониторинг здоровья (каждые 30с)
- Обработка отказов
- Автозагрузка отсутствующих моделей
- Метрики (латентность, запросы)

**Особенности:**
- Round-robin с выбором по латентности
- Cooldown после 3 ошибок (15с)
- Динамическое добавление/удаление серверов
- Стриминг ответов

### 6. Yandex.Disk Backup

**Возможности:**
- Автоматический бэкап MongoDB
- Планируемые бэкапы (время/часовой пояс)
- Восстановление из бэкапов
- `mongodump`/`mongorestore`

**Конфигурация:**
- `enabled`, `hour`, `minute`, `timezone`
- `ya_disk_folder`: str
- OAuth токен

---

## Конфигурация

### Переменные окружения

#### Сервер приложения
```bash
APP_HOST=0.0.0.0                    # Адрес хоста
APP_PORT=8000                       # Порт приложения
APP_ENABLE_TLS=0                    # Включить TLS (1=да)
APP_SSL_CERT=/certs/server.crt      # SSL сертификат
APP_SSL_KEY=/certs/server.key       # SSL ключ
```

#### MongoDB
```bash
MONGO_HOST=localhost                # Хост MongoDB
MONGO_PORT=27017                    # Порт
MONGO_USERNAME=root                 # Имя пользователя
MONGO_PASSWORD=password             # Пароль
MONGO_DATABASE=smarthelperdb        # База данных
MONGO_URI=mongodb://...             # Полный URI
```

#### Redis
```bash
REDIS_HOST=localhost                # Хост Redis
REDIS_PORT=6379                     # Порт
REDIS_PASSWORD=required             # Пароль (обязательно)
REDIS_URL=redis://localhost:6379/0  # Полный URL
```

#### Qdrant
```bash
QDRANT_URL=http://qdrant:6333       # URL Qdrant
QDRANT_COLLECTION=documents         # Коллекция
QDRANT_HTTP_PORT=6333               # HTTP порт
QDRANT_GRPC_PORT=6334               # gRPC порт
```

#### LLM и модели
```bash
LLM_MODEL=Vikhrmodels/Vikhr-YandexGPT-5-Lite-8B-it
OLLAMA_BASE_URL=http://ollama:11434
EMB_MODEL_NAME=ai-forever/sbert_large_nlu_ru
RERANK_MODEL_NAME=sbert_cross_ru
USE_GPU=false                       # Использовать GPU
```

#### Краулер
```bash
CRAWL_START_URL=https://example.com
CRAWL_MAX_PAGES=500                 # Макс страниц
CRAWL_MAX_DEPTH=3                   # Макс глубина
CRAWL_TIMEOUT=10                    # Таймаут HTTP (с)
CRAWL_JS_RENDER=auto                # Рендеринг JS (auto/always/never)
```

#### Аутентификация
```bash
ADMIN_USERNAME=admin                # Логин супер-админа
ADMIN_PASSWORD=admin                # Пароль (или sha256:...)
```

#### Telegram Bot
```bash
BOT_TOKEN=your_token_here           # Токен бота
TELEGRAM_ADMIN_ID=123456            # ID админа
TELEGRAM_API_BASE=http://app:8000   # API база
```

### Значения по умолчанию

**Приложение:**
- Host: `0.0.0.0`, Port: `8000`
- TLS: отключен
- CORS: разрешить все (`*`)

**Базы данных:**
- MongoDB: `localhost:27017`, БД `smarthelperdb`
- Redis: `localhost:6379`
- Qdrant: `http://qdrant:6333`, коллекция `documents`

**Модели:**
- LLM: `Vikhrmodels/Vikhr-YandexGPT-5-Lite-8B-it`
- Embeddings: `ai-forever/sbert_large_nlu_ru`
- Rerank: `sbert_cross_ru`
- GPU: отключен

**Краулер:**
- Макс страниц: `500`
- Макс глубина: `3`
- Таймаут: `10с`
- JS рендеринг: `auto`

### Поддерживаемые LLM модели

**Ollama (основной):**
1. `yandex/YandexGPT-5-Lite-8B-instruct-GGUF:latest` (4.5 GB)
2. `mistral:7b` (4.1 GB)
3. `llama3.1:8b` (4.9 GB)
4. `qwen2.5:14b` (8.6 GB)
5. `phi3:mini` (2.7 GB)

**HuggingFace:**
- Эмбеддинги и reranking модели

**Внешние сервисы:**
- Через `MODEL_BASE_URL` и `MODEL_API_KEY`

---

## Развертывание

### Локальная разработка

```bash
# Установка зависимостей
uv sync

# Запуск сервисов
uvicorn app:app --reload
celery -A worker worker --beat
```

### Docker Compose (CPU)

```bash
# Стандартное развертывание
docker compose up -d
```

### Docker Compose (GPU)

```bash
# GPU-ускоренное развертывание
docker compose -f compose.yaml -f compose.gpu.yaml up -d
```

### Docker Compose профили

```bash
# Включить Ollama в стек
docker compose --profile local-ollama up -d
```

### Продакшн развертывание

**Скрипты автоматизации:**
- `scripts/bootstrap.sh` - начальная настройка сервера
- `scripts/rollout.sh` - обновление и перезапуск
- `deploy_project.sh` - полная автоматизация развертывания
- `deploy_project.ps1` - PowerShell для Windows

**GitHub Actions:**
- `.github/workflows/deploy.yml` - автоматическое развертывание при пуше в main

### Архитектуры развертывания

**Один сервер:**
- Все сервисы в Docker Compose
- Ollama локально или на хосте

**Несколько серверов:**
- Кластер Ollama с несколькими удаленными серверами
- MongoDB replica set (внешний)
- Redis cluster (внешний)
- Qdrant распределенное развертывание

**Гибридная:**
- Основные сервисы в облаке
- Ollama на выделенных GPU-серверах

### Зависимости сервисов

```
MongoDB ← App, Celery Worker
Redis ← App, Celery Worker, Celery Beat
Qdrant ← App
Ollama ← App, Celery Worker (опционально)
App ← Telegram Bot
```

### Health Checks

Все сервисы включают проверки здоровья:
- MongoDB: `mongosh --eval "db.adminCommand('ping')"`
- Redis: `redis-cli ping`
- App: `/healthz`, `/health`, проверка процесса
- Celery: проверка процессов worker и beat

### Опции масштабирования

- **Горизонтальное**: несколько реплик worker
- **Вертикальное**: увеличение ресурсов на контейнер
- **Шардинг моделей**: несколько Ollama серверов с разными моделями
- **Read replicas**: MongoDB replica set для тяжелых чтений

---

## Ключевые рабочие процессы

### 1. Пайплайн сбора знаний

1. Админ запускает краулинг через UI → `POST /api/v1/crawler/start`
2. Краулер асинхронно получает страницы → сохраняет в MongoDB/GridFS
3. Worker обнаруживает новые документы → генерирует эмбеддинги
4. Эмбеддинги сохраняются в Qdrant/Redis
5. Обновления статуса через Redis pub/sub

### 2. Поток запроса чата

1. Пользователь отправляет сообщение → `POST /api/v1/llm/ask`
2. Загрузка истории диалога из MongoDB
3. Выполнение гибридного поиска (вектор + BM25)
4. Применение RRF fusion и опционального reranking
5. Построение промпта с контекстом
6. Стриминг ответа LLM через SSE
7. Сохранение диалога и аналитики в MongoDB

### 3. Рабочий процесс бэкапа

1. Планируемая задача проверяет настройки бэкапа
2. Создание задачи бэкапа в MongoDB
3. Celery задача выполняет `mongodump`
4. Загрузка на Yandex.Disk
5. Запись успеха/неудачи

---

## Архитектурные особенности

### Сильные стороны

✅ **Модульная архитектура** с четким разделением ответственности
✅ **Комплексное решение** RAG "из коробки"
✅ **Мультитенантность** с изоляцией проектов
✅ **Гибридный поиск** (семантика + ключевые слова)
✅ **Кластеризация LLM** с балансировкой и отказоустойчивостью
✅ **Реалтайм мониторинг** ресурсов и сервисов
✅ **Богатый UI** с 10 языками и 600+ переводами
✅ **Множество интеграций** (боты, CRM, почта)
✅ **Автоматизация** (бэкапы, краулинг, обновление векторов)
✅ **Production-ready** с healthchecks, метриками, логами

### Области для улучшения

⚠️ **Монолитность** - большие файлы (app.py 7K строк, index.js 38K строк)
⚠️ **Тестирование** - недостаточное покрытие тестами
⚠️ **Документация** - неполная документация API
⚠️ **Безопасность** - базовая аутентификация (нет OAuth2/JWT)
⚠️ **Валидация** - недостаточная валидация входных данных

---

## Заключение

**SiteLLM Vertebro** — это **production-ready, enterprise-grade RAG платформа** с комплексными возможностями для построения domain-specific AI ассистентов.

Архитектура хорошо продумана для масштабируемости, поддерживаемости и расширяемости. Проект включает все необходимое для полного цикла работы с RAG: от сбора данных до предоставления ответов через множество каналов.

**Основные преимущества:**
- Готовое решение без необходимости интеграции множества инструментов
- Мощная админ-панель для нетехнических пользователей
- Гибкая конфигурация под различные сценарии использования
- Поддержка локальных LLM (приватность данных)
- Возможность масштабирования от одного сервера до кластера

**Идеально подходит для:**
- Корпоративных AI ассистентов на базе внутренних знаний
- Клиентской поддержки с доступом к базе знаний
- Образовательных платформ с интеллектуальным поиском
- Любых проектов, требующих RAG с мультиканальностью
