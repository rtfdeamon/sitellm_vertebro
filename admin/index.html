<!--
  Crawler Control Panel
  - Start crawler (URL / depth / pages)
  - Live crawler counters
  - Services health (Mongo/Redis/Qdrant)
  - LLM runtime (model, backend, device)
  - App process metrics (CPU/Mem)
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crawler Admin</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    fieldset { border: 1px solid #ccc; border-radius: 8px; padding: 12px; margin-bottom: 14px; }
    legend { padding: 0 6px; color: #555; }
    label { display: inline-block; margin: 6px 8px 6px 0; }
    input { padding: 6px 8px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px; }
    .card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; }
    .ok { color: #2e7d32; }
    .bad { color: #d32f2f; }
    .muted { color: #777; font-size: 12px; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.55); display: none; align-items: center; justify-content: center; z-index: 2100; }
    .modal-backdrop.show { display: flex; }
    .modal { background: #fff; border-radius: 12px; border: 1px solid #dfe3eb; width: min(680px, 90vw); max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 18px 48px rgba(15,17,21,0.4); }
    .modal-header, .modal-footer { padding: 14px 18px; border-bottom: 1px solid #dfe3eb; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .modal-footer { border-top: 1px solid #dfe3eb; border-bottom: none; }
    .modal-body { padding: 14px 18px; overflow-y: auto; display: grid; gap: 12px; }
    .modal-body label { display: grid; gap: 6px; font-size: 13px; }
    .modal-body input, .modal-body textarea { width: 100%; padding: 8px 10px; border: 1px solid #dfe3eb; border-radius: 6px; font-family: inherit; }
    .modal-body textarea { min-height: 160px; resize: vertical; }
    .modal-close { background: transparent; border: none; color: #555; font-size: 20px; cursor: pointer; padding: 0; }
    button { padding: 8px 12px; }
    code { background: #f6f7fb; padding: 2px 4px; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #e0e0e0; text-align: left; vertical-align: top; }
    tbody tr:hover { background: #f6f7fb; }
    .nowrap { white-space: nowrap; }
  </style>
  </head>
  <body>
  <h1>Crawler Control Panel</h1>

  <fieldset>
    <legend>Start Crawl</legend>
    <form id="crawler-form">
      <label>Start URL: <input type="url" id="url" placeholder="https://example.com" required></label>
      <label>Depth: <input type="number" id="depth" min="1" value="2"></label>
      <label>Pages: <input type="number" id="pages" min="1" value="100"></label>
      <button type="submit">Запустить</button>
      <button type="button" id="stopBtn">Остановить</button>
      <span id="launchMsg" class="muted"></span>
    </form>
  </fieldset>

  <div class="grid">
    <div class="card">
      <b>Crawler</b>
      <div>Queued: <span id="queued">0</span></div>
      <div>In progress: <span id="in_progress">0</span></div>
      <div>Done: <span id="done">0</span></div>
      <div>Failed: <span id="failed">0</span></div>
      <div class="muted" id="last_crawl">Last: –</div>
      <div>
        <details>
          <summary>Последние URL</summary>
          <ol id="recent_urls" style="margin-top:6px;"></ol>
        </details>
      </div>
    </div>
    <div class="card">
      <b>Project</b>
      <div style="margin-bottom:8px;">
        <label>Текущий проект
          <select id="projectSelect" style="width:100%;"></select>
        </label>
        <span class="muted" id="projectStatus"></span>
      </div>
      <form id="projectForm" style="display:flex; flex-wrap:wrap; gap:10px;">
        <label style="flex:1 1 200px;">Идентификатор (ENG)
          <input type="text" id="projectName" placeholder="mmvs" required>
        </label>
        <label style="flex:1 1 200px;">Название
          <input type="text" id="projectTitle" placeholder="Название проекта">
        </label>
        <label style="flex:1 1 200px;">Домен (необязательно)
          <input type="text" id="projectDomain" placeholder="https://example.com">
        </label>
        <label style="flex:1 1 200px;">LLM модель
          <select id="projectModel" style="width:100%;"></select>
        </label>
        <label style="flex:1 1 100%;">Стартовый промпт
          <textarea id="projectPrompt" rows="3" placeholder="Укажите инструкцию для модели" style="width:100%; resize:vertical;"></textarea>
        </label>
        <div style="display:flex; gap:10px; align-items:center;">
          <button type="submit">Сохранить</button>
          <button type="button" id="projectDelete">Удалить</button>
          <button type="button" id="projectTest">Тест</button>
        </div>
      </form>
    </div>
    <div class="card">
      <b>Services</b>
      <div>Mongo: <span id="mongo" class="bad">down</span></div>
      <div>Redis: <span id="redis" class="bad">down</span></div>
      <div>Qdrant: <span id="qdrant" class="bad">down</span></div>
      <div>Status: <span id="overall">degraded</span></div>
    </div>
    <div class="card">
      <b>LLM</b>
      <div>Model: <code id="model">–</code></div>
      <div>Backend: <span id="backend">–</span></div>
      <div>Device: <span id="device">–</span></div>
      <div style="margin-top:6px;">
        <label>Ollama Base:
          <input type="text" id="ollamaBase" placeholder="http://host.docker.internal:11434" style="width:100%">
        </label>
        <label style="display:block; margin-top:6px;">Model name:
          <input type="text" id="ollamaModel" placeholder="yandex/YandexGPT-5-Lite-8B-instruct-GGUF:latest" style="width:100%">
        </label>
        <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" id="saveLLM">Save</button>
          <button type="button" id="pingLLM">Ping</button>
          <span id="pingRes" class="muted"></span>
        </div>
      </div>
    </div>
    <div class="card">
      <b>App</b>
      <div>CPU (app): <span id="cpu">–</span></div>
      <div>CPU (sys): <span id="cpuSys">–</span></div>
      <div>RAM: <span id="ram">–</span></div>
      <div>RSS: <span id="rss">–</span></div>
      <div style="white-space:pre-line;">GPU: <span id="gpu">–</span></div>
      <div>Python: <span id="pyver">–</span></div>
    </div>
    <div class="card">
      <b>Telegram Bot</b>
      <label style="display:block; margin-bottom:6px;">Bot Token
        <input type="password" id="tgToken" placeholder="Введите токен" style="width:100%;">
      </label>
      <label style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
        <input type="checkbox" id="tgAutoStart"> Автозапуск при старте
      </label>
      <div>Status: <span id="tgStatus">—</span></div>
      <div class="muted" id="tgTokenInfo"></div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <button type="button" id="tgSave">Сохранить</button>
        <button type="button" id="tgStart">Запустить</button>
        <button type="button" id="tgStop">Остановить</button>
        <span class="muted" id="tgMessage"></span>
      </div>
    </div>
    <div class="card" style="grid-column: 1 / -1;">
      <b>Knowledge Base</b>
      <form id="kbForm" style="margin:8px 0 10px; display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;">
        <label style="flex:1 1 200px;">Проект
          <input type="text" list="kbProjectList" id="kbProject" placeholder="mmvs" style="width:100%;" readonly>
          <datalist id="kbProjectList"></datalist>
        </label>
        <button type="button" id="kbReloadProjects" title="Обновить список проектов">↻</button>
        <label style="flex:1 1 240px;">Поиск
          <input type="text" id="kbSearch" placeholder="Название или описание" style="width:100%;">
        </label>
        <label>Limit
          <input type="number" id="kbLimit" min="10" max="200" value="50" style="width:80px;">
        </label>
        <button type="submit">Обновить</button>
        <button type="button" id="kbClear">Очистить</button>
        <span class="muted" id="kbInfo"></span>
        <span class="muted" id="kbProjectsSummary"></span>
      </form>
      <form id="kbAddForm" style="margin-bottom:10px; display:flex; flex-wrap:wrap; gap:10px;">
        <label style="flex:1 1 220px;">Имя
          <input type="text" id="kbNewName" placeholder="document.txt" style="width:100%;">
        </label>
        <label style="flex:1 1 220px;">URL
          <input type="url" id="kbNewUrl" placeholder="https://example.com" style="width:100%;">
        </label>
        <label style="flex:1 1 220px;">Описание
          <input type="text" id="kbNewDescription" placeholder="Краткое описание" style="width:100%;">
        </label>
        <label style="flex:1 1 100%;">Текст
          <textarea id="kbNewContent" placeholder="Введите текст документа" style="width:100%; min-height:120px;"></textarea>
        </label>
        <div style="display:flex; gap:10px; align-items:center;">
          <button type="submit">Сохранить</button>
          <button type="button" id="kbResetForm">Сбросить</button>
          <span class="muted" id="kbAddStatus"></span>
        </div>
      </form>
      <div style="max-height:240px; overflow:auto; border:1px solid #e0e0e0; border-radius:6px;">
        <table>
          <thead>
          <tr><th class="nowrap">Имя</th><th>Описание</th><th class="nowrap">Проект</th><th class="nowrap">Файл</th><th class="nowrap">Действия</th></tr>
          </thead>
          <tbody id="kbTable"></tbody>
        </table>
      </div>
    </div>
    <div class="card" style="grid-column: 1 / -1;">
      <b>Logs (last 200)</b>
      <div style="margin:6px 0; display:flex; gap:8px; align-items:center;">
        <label>Lines: <input type="number" id="logLimit" min="50" max="1000" value="200" style="width:80px;"></label>
        <button id="copyLogs" type="button">Copy</button>
        <span class="muted" id="logInfo"></span>
      </div>
      <pre id="logs" style="white-space:pre-wrap; background:#0b1021; color:#b8c1ec; padding:10px; border-radius:8px; max-height:320px; overflow:auto;">
      </pre>
    </div>
  </div>

  <div id="kbModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <strong id="kbModalTitle">Документ</strong>
        <button type="button" class="modal-close" id="kbModalClose">×</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="kbModalId">
        <label>Имя
          <input type="text" id="kbModalName" required>
        </label>
        <label>URL
          <input type="url" id="kbModalUrl" placeholder="https://example.com">
        </label>
        <label>Описание
          <input type="text" id="kbModalDescription" placeholder="Краткое описание">
        </label>
        <label>Проект
          <input type="text" id="kbModalProject" placeholder="project">
        </label>
        <label>Текст
          <textarea id="kbModalContent"></textarea>
        </label>
      </div>
      <div class="modal-footer">
        <span class="muted" id="kbModalStatus"></span>
        <div style="display:flex; gap:8px;">
          <button type="button" id="kbModalCompile">Компилировать</button>
          <button type="button" id="kbModalSave">Сохранить</button>
          <button type="button" id="kbModalCancel">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('crawler-form');
    const stopBtn = document.getElementById('stopBtn');
    const kbModalBackdrop = document.getElementById('kbModal');
    const kbModalClose = document.getElementById('kbModalClose');
    const kbModalCancel = document.getElementById('kbModalCancel');
    const kbModalSave = document.getElementById('kbModalSave');
    const kbModalCompile = document.getElementById('kbModalCompile');
    const kbModalTitle = document.getElementById('kbModalTitle');
    const kbModalId = document.getElementById('kbModalId');
    const kbModalName = document.getElementById('kbModalName');
    const kbModalUrl = document.getElementById('kbModalUrl');
    const kbModalDesc = document.getElementById('kbModalDescription');
    const kbModalProject = document.getElementById('kbModalProject');
    const kbModalContent = document.getElementById('kbModalContent');
    const kbModalStatus = document.getElementById('kbModalStatus');
    const tgTokenInput = document.getElementById('tgToken');
    const tgAutoStart = document.getElementById('tgAutoStart');
    const tgStatus = document.getElementById('tgStatus');
    const tgTokenInfo = document.getElementById('tgTokenInfo');
    const tgMessage = document.getElementById('tgMessage');
    const tgSaveBtn = document.getElementById('tgSave');
    const tgStartBtn = document.getElementById('tgStart');
    const tgStopBtn = document.getElementById('tgStop');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        start_url: document.getElementById('url').value,
        max_depth: Number(document.getElementById('depth').value),
        max_pages: Number(document.getElementById('pages').value),
      };
      if (!currentProject) {
        document.getElementById('launchMsg').textContent = 'Выберите проект';
        return;
      }
      payload.project = currentProject;
      const crawlDomain = projectDomainInput.value.trim();
      if (crawlDomain) {
        payload.domain = crawlDomain;
      }
      const res = await fetch('/api/v1/crawler/run', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      });
      document.getElementById('launchMsg').textContent = res.ok ? 'Запущено' : 'Не удалось запустить';
    });

    stopBtn.addEventListener('click', async () => {
      try {
        const r = await fetch('/api/v1/crawler/stop', { method: 'POST' });
        document.getElementById('launchMsg').textContent = r.ok ? 'Останавливаем…' : 'Не удалось остановить';
      } catch {}
    });

    let currentProject = '';
    const projectSelect = document.getElementById('projectSelect');
    const projectStatus = document.getElementById('projectStatus');
    const projectNameInput = document.getElementById('projectName');
    const projectDomainInput = document.getElementById('projectDomain');
    const projectTitleInput = document.getElementById('projectTitle');
    const projectModelInput = document.getElementById('projectModel');
    const projectPromptInput = document.getElementById('projectPrompt');
    const projectTestBtn = document.getElementById('projectTest');
    let projectsCache = {};
    let projectStatusTimer = null;
    let projectStatusLocked = false;
    let lastProjectCount = 0;

    let LLM_MODEL_OPTIONS = [];

    function updateProjectSummary() {
      if (projectStatusLocked || projectStatusTimer) return;
      if (lastProjectCount > 0) {
        projectStatus.textContent = `${lastProjectCount} проект(ов)`;
      } else {
        projectStatus.textContent = 'Добавьте проект ниже';
      }
    }

    function setProjectStatus(message, timeoutMs) {
      if (projectStatusTimer) {
        clearTimeout(projectStatusTimer);
        projectStatusTimer = null;
      }
      projectStatusLocked = !timeoutMs;
      projectStatus.textContent = message;
      if (timeoutMs) {
        projectStatusTimer = setTimeout(() => {
          projectStatusTimer = null;
          projectStatusLocked = false;
          updateProjectSummary();
        }, timeoutMs);
      }
    }

    function populateModelOptions(selectedValue) {
      const value = (selectedValue || '').trim();
      const seen = new Set();
      projectModelInput.innerHTML = '';
      projectModelInput.appendChild(new Option('— выбрать модель —', '', !value, !value));
      LLM_MODEL_OPTIONS.forEach(({ value: optValue, label }) => {
        if (!optValue || seen.has(optValue)) return;
        seen.add(optValue);
        const option = new Option(label || optValue, optValue, false, optValue === value);
        projectModelInput.appendChild(option);
      });
      if (value && !seen.has(value)) {
        projectModelInput.appendChild(new Option(value, value, true, true));
        seen.add(value);
      }
      projectModelInput.appendChild(new Option('Другая…', '__custom__', false, false));
      if (!value || !seen.has(value)) {
        projectModelInput.value = '';
      }
    }

    populateModelOptions('');
    projectModelInput.addEventListener('change', () => {
      if (projectModelInput.value === '__custom__') {
        const custom = prompt('Введите идентификатор модели', '');
        if (custom && custom.trim()) {
          populateModelOptions(custom.trim());
        } else {
          populateProjectForm(currentProject);
        }
      }
    });

    async function loadLlmModels() {
      try {
        const resp = await fetch('/api/v1/admin/llm/models');
        if (!resp.ok) throw new Error('llm models request failed');
        const data = await resp.json();
        const models = Array.isArray(data.models) ? data.models : [];
        const normalized = models
          .map((m) => (typeof m === 'string' ? m.trim() : ''))
          .filter(Boolean);
        if (normalized.length) {
          LLM_MODEL_OPTIONS = normalized.map((value) => ({ value, label: value }));
        }
      } catch (error) {
        console.error('Cannot load LLM models', error);
        if (!LLM_MODEL_OPTIONS.length) {
          LLM_MODEL_OPTIONS = [
            'Vikhrmodels/Vikhr-YandexGPT-5-Lite-8B-it',
            'yandex/YandexGPT-5-Lite-8B-instruct-GGUF:latest',
            'llama3.1:70b',
            'qwen2.5:14b',
          ].map((value) => ({ value, label: value }));
        }
      }
      populateModelOptions(projectsCache[currentProject]?.llm_model || projectModelInput.value || '');
    }

    function updateProjectInputs(){
      const projectField = document.getElementById('kbProject');
      const project = projectsCache[currentProject] || null;
      projectField.value = project ? project.name : (currentProject || '');
    }
    async function pollStatus() {
      if (!currentProject) {
        document.getElementById('queued').textContent = '0';
        document.getElementById('in_progress').textContent = '0';
        document.getElementById('done').textContent = '0';
        document.getElementById('failed').textContent = '0';
        document.getElementById('last_crawl').textContent = 'Last: –';
        document.getElementById('recent_urls').innerHTML = '';
        return;
      }
      try {
        const url = currentProject ? `/api/v1/crawler/status?project=${encodeURIComponent(currentProject)}` : '/api/v1/crawler/status';
        const resp = await fetch(url);
        if (resp.ok) {
          const data = await resp.json();
          document.getElementById('queued').textContent = data.queued ?? 0;
          document.getElementById('in_progress').textContent = data.in_progress ?? 0;
          document.getElementById('done').textContent = data.done ?? 0;
          document.getElementById('failed').textContent = data.failed ?? 0;
          const iso = data.last_crawl_iso || '–';
          document.getElementById('last_crawl').textContent = 'Last: ' + iso;
          const list = document.getElementById('recent_urls');
          list.innerHTML = '';
          const arr = (data.crawler && data.crawler.recent_urls) || data.recent_urls || [];
          for (const u of arr) {
            const li = document.createElement('li');
            const a = document.createElement('a'); a.href = u; a.textContent = u; a.target = '_blank';
            li.appendChild(a); list.appendChild(li);
          }
        }
      } catch (err) { console.error(err); }
    }

    async function pollHealth() {
      try {
        const r = await fetch('/health');
        if (!r.ok) return;
        const h = await r.json();
        const details = h.details || {};
        const set = (id, ok) => {
          const el = document.getElementById(id);
          const error = details[id] && details[id].error ? details[id].error : '';
          el.textContent = ok ? 'up' : 'down';
          el.className = ok ? 'ok' : 'bad';
          el.title = error;
        };
        set('mongo', !!h.mongo);
        set('redis', !!h.redis);
        set('qdrant', !!h.qdrant);
        document.getElementById('overall').textContent = h.status || 'unknown';
      } catch {}
    }

    async function pollLLM() {
      try {
        const r = await fetch('/api/v1/llm/info');
        if (!r.ok) return;
        const j = await r.json();
        document.getElementById('model').textContent = j.model || '–';
        document.getElementById('backend').textContent = j.backend || '–';
        document.getElementById('device').textContent = j.device || '–';
        document.getElementById('ollamaBase').value = j.ollama_base || '';
        if (j.model) {
          document.getElementById('ollamaModel').value = j.model;
        }
      } catch {}
    }

    function formatBytes(n){ if(!n && n!==0) return '–'; const u=['B','KB','MB','GB','TB']; let i=0; while(n>=1024 && i<u.length-1){ n/=1024; i++; } return n.toFixed(1)+' '+u[i]; }
    function formatPercent(v){ return (typeof v === 'number' && !Number.isNaN(v)) ? v.toFixed(1) + '%' : '–'; }
    async function pollSys() {
      try {
        const r = await fetch('/sysinfo');
        if (!r.ok) return;
        const j = await r.json();
        document.getElementById('cpu').textContent = formatPercent(j.cpu_percent);
        document.getElementById('cpuSys').textContent = formatPercent(j.system_cpu_percent);
        const rss = typeof j.rss_bytes === 'number' ? formatBytes(j.rss_bytes) : '–';
        document.getElementById('rss').textContent = rss;
        const ram = (typeof j.memory_used_bytes === 'number' && typeof j.memory_total_bytes === 'number')
          ? `${formatBytes(j.memory_used_bytes)} / ${formatBytes(j.memory_total_bytes)}${typeof j.memory_percent === 'number' ? ' (' + j.memory_percent.toFixed(1) + '%)' : ''}`
          : '–';
        document.getElementById('ram').textContent = ram;
        const gpuEl = document.getElementById('gpu');
        if (Array.isArray(j.gpus) && j.gpus.length) {
          const lines = j.gpus.map((g, idx) => {
            const label = g.name || `GPU ${idx}`;
            const util = formatPercent(g.util_percent);
            let memInfo = '';
            if (typeof g.memory_used_bytes === 'number' && typeof g.memory_total_bytes === 'number') {
              memInfo = `${formatBytes(g.memory_used_bytes)} / ${formatBytes(g.memory_total_bytes)}`;
            }
            return `${label}: ${util}${memInfo ? ' · ' + memInfo : ''}`;
          });
          gpuEl.textContent = lines.join('\n');
        } else {
          gpuEl.textContent = '—';
        }
        document.getElementById('pyver').textContent = j.python || '';
      } catch {}
    }

    async function pollLogs(){
      const lim = Number(document.getElementById('logLimit').value || 200);
      try{
        const r = await fetch(`/api/v1/admin/logs?limit=${lim}`);
        if(!r.ok) return;
        const j = await r.json();
        const lines = (j && j.lines) || [];
        const pre = document.getElementById('logs');
        pre.textContent = lines.join('\n');
        document.getElementById('logInfo').textContent = `${lines.length} lines`;
        // auto-scroll to bottom
        pre.scrollTop = pre.scrollHeight;
      }catch(e){}
    }

    function tick(){ pollStatus(); pollHealth(); pollLLM(); pollSys(); pollLogs(); }
    tick();
    setInterval(tick, 3000);

    async function loadKnowledge(){
      if (!currentProject) {
        document.getElementById('kbTable').innerHTML = '';
        document.getElementById('kbInfo').textContent = 'Выберите проект';
        return;
      }
      const limitField = document.getElementById('kbLimit');
      const qField = document.getElementById('kbSearch');
      const params = new URLSearchParams();
      const limit = Number(limitField.value || 50);
      if (Number.isFinite(limit)) params.set('limit', Math.min(Math.max(limit, 10), 200));
      const query = qField.value.trim();
      if (query) params.set('q', query);
      if (currentProject) {
        const projectId = currentProject.trim().toLowerCase();
        params.set('project', projectId);
      }
      try {
        const resp = await fetch(`/api/v1/admin/knowledge?${params.toString()}`);
        if (!resp.ok) throw new Error('knowledge request failed');
        const data = await resp.json();
        const tbody = document.getElementById('kbTable');
        tbody.innerHTML = '';
        const docs = data.documents || [];
        if (!docs.length) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 5;
          cell.textContent = query ? 'Ничего не найдено' : 'Документов нет';
          row.appendChild(cell);
          tbody.appendChild(row);
        } else {
          for (const doc of docs) {
            const tr = document.createElement('tr');
            const nameTd = document.createElement('td');
            nameTd.textContent = doc.name || '–';
            const descTd = document.createElement('td');
            descTd.textContent = doc.description || '–';
            const projectTd = document.createElement('td');
            projectTd.textContent = doc.project || doc.domain || '–';
            const linkTd = document.createElement('td');
            const a = document.createElement('a');
            a.textContent = 'Скачать';
            a.href = `/api/v1/admin/knowledge/documents/${encodeURIComponent(doc.fileId)}`;
            a.target = '_blank';
            a.rel = 'noopener';
            linkTd.appendChild(a);
            const actionsTd = document.createElement('td');
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.textContent = 'Редактировать';
            editBtn.addEventListener('click', () => openKnowledgeModal(doc.fileId));
            actionsTd.appendChild(editBtn);
            tr.append(nameTd, descTd, projectTd, linkTd, actionsTd);
            tbody.appendChild(tr);
          }
        }
        const matched = data.matched ?? docs.length;
        const total = data.total ?? matched;
        const infoText = `Показано ${docs.length} / ${matched}${total ? ` (всего ${total})` : ''}${currentProject ? ` · ${currentProject}` : ''}`;
        document.getElementById('kbInfo').textContent = infoText;
      } catch (error) {
        document.getElementById('kbInfo').textContent = 'Ошибка загрузки базы знаний';
        console.error(error);
      }
    }

    function resetKnowledgeModal(){
      kbModalId.value = '';
      kbModalName.value = '';
      kbModalUrl.value = '';
      kbModalDesc.value = '';
      kbModalProject.value = currentProject || '';
      kbModalContent.value = '';
      kbModalStatus.textContent = '';
    }

    function showKnowledgeModal(){
      kbModalBackdrop.classList.add('show');
    }

    function hideKnowledgeModal(){
      kbModalBackdrop.classList.remove('show');
      resetKnowledgeModal();
    }

    async function openKnowledgeModal(fileId){
      resetKnowledgeModal();
      kbModalStatus.textContent = 'Загружаем...';
      try {
        const resp = await fetch(`/api/v1/admin/knowledge/${encodeURIComponent(fileId)}`);
        if (!resp.ok) throw new Error('failed to fetch document');
        const doc = await resp.json();
        kbModalId.value = doc.fileId || fileId;
        kbModalTitle.textContent = doc.name || 'Документ';
        kbModalName.value = doc.name || '';
        kbModalUrl.value = doc.url || '';
        kbModalDesc.value = doc.description || '';
        const projectName = (doc.project || doc.domain || '').toLowerCase();
        kbModalProject.value = projectName;
        if (projectName && currentProject !== projectName) {
          currentProject = projectName;
          projectSelect.value = currentProject;
          updateProjectInputs();
        }
        kbModalContent.value = doc.content || '';
        kbModalStatus.textContent = '';
        showKnowledgeModal();
      } catch (error) {
        console.error(error);
        kbModalStatus.textContent = 'Не удалось загрузить документ';
        setTimeout(() => { kbModalStatus.textContent = ''; }, 3000);
      }
    }

    async function saveKnowledgeModal(){
      const fileId = kbModalId.value;
      if (!fileId) return;
      kbModalStatus.textContent = 'Сохраняем...';
      const payload = {
        name: kbModalName.value,
        url: kbModalUrl.value,
        description: kbModalDesc.value,
        content: kbModalContent.value,
        project: kbModalProject.value,
      };
      try {
        const resp = await fetch(`/api/v1/admin/knowledge/${encodeURIComponent(fileId)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        const result = await resp.json();
        if (result.file_id) {
          kbModalId.value = result.file_id;
        }
        if (result.project) {
          currentProject = (result.project || '').toLowerCase();
        }
        kbModalStatus.textContent = 'Сохранено';
        await loadProjectsList();
        await loadKnowledge();
        setTimeout(() => { hideKnowledgeModal(); }, 800);
      } catch (error) {
        console.error(error);
        kbModalStatus.textContent = 'Ошибка сохранения';
      }
    }

    async function compileKnowledge(){
      kbModalStatus.textContent = 'Запускаем компиляцию...';
      try {
        const resp = await fetch('/api/v1/admin/knowledge/reindex', { method: 'POST' });
        if (!resp.ok) throw new Error('compile failed');
        kbModalStatus.textContent = 'Компиляция запущена';
        setTimeout(() => { kbModalStatus.textContent = ''; }, 2000);
      } catch (error) {
        console.error(error);
        kbModalStatus.textContent = 'Ошибка компиляции';
      }
    }

    async function loadProjectsList(){
      try {
        const resp = await fetch('/api/v1/admin/projects/names');
        if (!resp.ok) return;
        const data = await resp.json();
        const list = document.getElementById('kbProjectList');
        list.innerHTML = '';
        const names = data.projects || [];
        names.forEach((name) => {
          const normalized = (name || '').toLowerCase();
          const option = document.createElement('option');
          option.value = normalized;
          list.appendChild(option);
        });
        document.getElementById('kbProjectsSummary').textContent = names.length ? `${names.length} проект(ов)` : '—';
        if (!currentProject && names.length) {
          currentProject = (names[0] || '').toLowerCase();
          populateProjectForm(currentProject);
          loadKnowledge();
          pollStatus();
        }
      } catch (error) {
        console.error(error);
      }
    }

    async function saveKnowledge(e){
      e.preventDefault();
      const projectName = currentProject.trim().toLowerCase();
      if (!projectName) {
        document.getElementById('kbAddStatus').textContent = 'Выберите проект';
        return;
      }
      const name = document.getElementById('kbNewName').value.trim();
      const url = document.getElementById('kbNewUrl').value.trim();
      const description = document.getElementById('kbNewDescription').value.trim();
      const content = document.getElementById('kbNewContent').value;
      const statusLabel = document.getElementById('kbAddStatus');
      statusLabel.textContent = 'Сохраняем...';
      try {
        const resp = await fetch('/api/v1/admin/knowledge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name || null,
            content,
            project: projectName || null,
            description: description || null,
            url: url || null,
          }),
        });
        if (!resp.ok) {
          statusLabel.textContent = 'Ошибка сохранения';
          return;
        }
        statusLabel.textContent = 'Сохранено';
        document.getElementById('kbNewName').value = '';
        document.getElementById('kbNewUrl').value = '';
        document.getElementById('kbNewDescription').value = '';
        document.getElementById('kbNewContent').value = '';
        await loadKnowledge();
        await loadProjectsList();
      } catch (error) {
        console.error(error);
        statusLabel.textContent = 'Ошибка сохранения';
      }
    }

    document.getElementById('kbForm').addEventListener('submit', (e)=>{ e.preventDefault(); loadKnowledge(); });
    document.getElementById('kbClear').addEventListener('click', ()=>{ document.getElementById('kbSearch').value=''; loadKnowledge(); });
    document.getElementById('kbReloadProjects').addEventListener('click', async ()=>{ await loadProjectsList(); await fetchProjects(); loadKnowledge(); });
    document.getElementById('kbAddForm').addEventListener('submit', saveKnowledge);
    document.getElementById('kbResetForm').addEventListener('click', () => {
      document.getElementById('kbNewName').value = '';
      document.getElementById('kbNewUrl').value = '';
      document.getElementById('kbNewDescription').value = '';
      document.getElementById('kbNewContent').value = '';
      document.getElementById('kbAddStatus').textContent = '';
    });

    kbModalClose.addEventListener('click', hideKnowledgeModal);
    kbModalCancel.addEventListener('click', hideKnowledgeModal);
    kbModalSave.addEventListener('click', saveKnowledgeModal);
    kbModalCompile.addEventListener('click', compileKnowledge);
    kbModalBackdrop.addEventListener('click', (event) => {
      if (event.target === kbModalBackdrop) {
        hideKnowledgeModal();
      }
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && kbModalBackdrop.classList.contains('show')) {
        hideKnowledgeModal();
      }
    });

    async function loadTelegramStatus(){
      try {
        const resp = await fetch('/api/v1/admin/telegram');
        if (!resp.ok) throw new Error('status failed');
        const data = await resp.json();
        tgStatus.textContent = data.running ? 'работает' : 'остановлен';
        tgTokenInfo.textContent = data.token_set ? `Токен сохранён (${data.token_preview || '***'})` : 'Токен не задан';
        tgAutoStart.checked = !!data.auto_start;
        tgMessage.textContent = '';
        tgStartBtn.disabled = !!data.running;
        tgStopBtn.disabled = !data.running;
      } catch (error) {
        console.error(error);
        tgStatus.textContent = 'ошибка';
        tgStartBtn.disabled = false;
        tgStopBtn.disabled = true;
      }
    }

    async function saveTelegramConfig(){
      tgMessage.textContent = 'Сохраняем...';
      const payload = {
        token: tgTokenInput.value || null,
        auto_start: tgAutoStart.checked,
      };
      try {
        const resp = await fetch('/api/v1/admin/telegram/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error('save failed');
        tgTokenInput.value = '';
        tgMessage.textContent = 'Сохранено';
        loadTelegramStatus();
      } catch (error) {
        console.error(error);
        tgMessage.textContent = 'Ошибка сохранения';
      }
    }

    async function startTelegram(){
      tgMessage.textContent = 'Запускаем...';
      const payload = tgTokenInput.value ? { token: tgTokenInput.value } : {};
      try {
        const resp = await fetch('/api/v1/admin/telegram/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error('start failed');
        tgTokenInput.value = '';
        tgMessage.textContent = 'Бот запущен';
        loadTelegramStatus();
      } catch (error) {
        console.error(error);
        tgMessage.textContent = 'Ошибка запуска';
      }
    }

    async function stopTelegram(){
      tgMessage.textContent = 'Останавливаем...';
      try {
        const resp = await fetch('/api/v1/admin/telegram/stop', { method: 'POST' });
        if (!resp.ok) throw new Error('stop failed');
        tgMessage.textContent = 'Бот остановлен';
        loadTelegramStatus();
      } catch (error) {
        console.error(error);
        tgMessage.textContent = 'Ошибка остановки';
      }
    }

    tgSaveBtn.addEventListener('click', saveTelegramConfig);
    tgStartBtn.addEventListener('click', startTelegram);
    tgStopBtn.addEventListener('click', stopTelegram);

    function populateProjectForm(projectName){
      const normalized = (projectName || '').trim().toLowerCase();
      const project = projectsCache[normalized] || null;
      projectNameInput.value = project ? project.name : normalized;
      projectTitleInput.value = project?.title || '';
      projectDomainInput.value = project?.domain || '';
      populateModelOptions(project?.llm_model || '');
      projectPromptInput.value = project?.llm_prompt || '';
      currentProject = normalized;
      projectSelect.value = currentProject;
      updateProjectInputs();
    }

    async function fetchProjects(){
      try {
        const resp = await fetch('/api/v1/admin/projects');
        if (!resp.ok) return;
        const data = await resp.json();
        const projects = data.projects || [];
        projectSelect.innerHTML = '';
        projectsCache = {};
        lastProjectCount = projects.length;

        if (!projects.length) {
          projectSelect.appendChild(new Option('— нет проектов —', '', true, true));
          projectSelect.disabled = true;
          currentProject = '';
          populateProjectForm('');
          updateProjectSummary();
          return;
        }

        projectSelect.disabled = false;
        projectSelect.appendChild(new Option('— выберите проект —', '', false, !currentProject));

        let selectedKey = currentProject && projects.some(p => (p.name || '').toLowerCase() === currentProject)
          ? currentProject
          : '';

        projects.forEach((p, idx) => {
          const key = (p.name || '').toLowerCase();
          projectsCache[key] = {
            ...p,
            name: key,
            llm_model: typeof p.llm_model === 'string' ? p.llm_model.trim() : p.llm_model,
          };
          const shouldSelect = key === selectedKey || (!selectedKey && idx === 0);
          const option = new Option(p.title || p.name || key, key, false, shouldSelect);
          projectSelect.appendChild(option);
          if (shouldSelect) {
            selectedKey = key;
          }
        });

        currentProject = selectedKey;
        populateProjectForm(currentProject);
        updateProjectSummary();
      } catch (error) {
        console.error(error);
      }
    }

    projectSelect.addEventListener('change', () => {
      currentProject = projectSelect.value.trim().toLowerCase();
      populateProjectForm(currentProject);
      loadKnowledge();
      pollStatus();
    });

    document.getElementById('projectForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = projectNameInput.value.trim().toLowerCase();
      if (!name) {
        setProjectStatus('Укажите идентификатор', 3000);
        return;
      }
      const payload = {
        name,
        title: projectTitleInput.value.trim() || null,
        domain: projectDomainInput.value.trim() || null,
        llm_model: projectModelInput.value || null,
        llm_prompt: projectPromptInput.value.trim() || null,
      };
      setProjectStatus('Сохраняем проект...');
      try {
        const resp = await fetch('/api/v1/admin/projects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          setProjectStatus('Не удалось сохранить проект', 4000);
          return;
        }
        currentProject = name;
        await fetchProjects();
        await loadProjectsList();
        await loadKnowledge();
        pollStatus();
        setProjectStatus('Сохранено', 2000);
        populateProjectForm(currentProject);
      } catch (error) {
        console.error(error);
        setProjectStatus('Ошибка сохранения', 4000);
      }
    });

    document.getElementById('projectDelete').addEventListener('click', async () => {
      if (!currentProject) return;
      if (!confirm(`Удалить проект ${currentProject}?`)) return;
      const toDelete = currentProject;
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(toDelete)}`, { method: 'DELETE' });
        if (!resp.ok) {
          setProjectStatus('Не удалось удалить', 4000);
          return;
        }
        delete projectsCache[toDelete];
        currentProject = '';
        await fetchProjects();
        await loadProjectsList();
        document.getElementById('kbTable').innerHTML = '';
        document.getElementById('kbInfo').textContent = '';
        setProjectStatus('Удалено', 2000);
      } catch (error) {
        console.error(error);
        setProjectStatus('Ошибка удаления', 4000);
      }
    });

    projectTestBtn.addEventListener('click', async () => {
      if (!currentProject) {
        setProjectStatus('Выберите проект', 3000);
        return;
      }
      setProjectStatus('Тестируем сервисы...');
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(currentProject)}/test`);
        if (!resp.ok) {
          setProjectStatus('Ошибка теста', 4000);
          return;
        }
        const data = await resp.json();
        const parts = ['mongo', 'redis', 'qdrant'].map((key) => {
          const result = data[key];
          return `${key}: ${result.ok ? 'ok' : 'fail'}${result.error ? ` (${result.error})` : ''}`;
        });
        setProjectStatus(parts.join(' · '), 4000);
      } catch (error) {
        console.error(error);
        setProjectStatus('Ошибка теста', 4000);
      }
    });

    (async () => {
      await loadLlmModels();
      await fetchProjects();
      await loadProjectsList();
      await loadTelegramStatus();
      if (currentProject) {
        populateProjectForm(currentProject);
        await loadKnowledge();
        pollStatus();
      } else {
        updateProjectSummary();
      }
    })();

    // Controls for LLM config
    document.getElementById('saveLLM').addEventListener('click', async () => {
      const base = document.getElementById('ollamaBase').value.trim();
      const model = document.getElementById('ollamaModel').value.trim();
      const payload = { ollama_base: base || null, model: model || null };
      const r = await fetch('/api/v1/llm/config', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      document.getElementById('pingRes').textContent = r.ok ? 'Saved' : 'Save failed';
      pollLLM();
    });
    document.getElementById('pingLLM').addEventListener('click', async () => {
      const r = await fetch('/api/v1/llm/ping');
      if (!r.ok) { document.getElementById('pingRes').textContent = 'Ping failed'; return; }
      const j = await r.json();
      if (!j.enabled) document.getElementById('pingRes').textContent = 'Disabled';
      else document.getElementById('pingRes').textContent = j.reachable ? 'Reachable' : ('Unreachable' + (j.error ? `: ${j.error}` : ''));
    });

    document.getElementById('copyLogs').addEventListener('click', async () => {
      const t = document.getElementById('logs').textContent;
      try{ await navigator.clipboard.writeText(t); document.getElementById('logInfo').textContent = 'Copied'; }
      catch{ document.getElementById('logInfo').textContent = 'Copy failed'; }
    });
  </script>
  </body>
  </html>
