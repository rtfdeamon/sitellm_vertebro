<!--
  Crawler Control Panel
  - Start crawler (URL / depth / pages)
  - Live crawler counters
  - Services health (Mongo/Redis/Qdrant)
  - LLM runtime (model, backend, device)
  - App process metrics (CPU/Mem)
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crawler Admin</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2032%2032%22%3E%3Crect%20width%3D%2232%22%20height%3D%2232%22%20rx%3D%228%22%20fill%3D%22%230b1026%22/%3E%3Ccircle%20cx%3D%2216%22%20cy%3D%2216%22%20r%3D%229%22%20fill%3D%22%2360a5fa%22/%3E%3C/svg%3E">
  <link rel="stylesheet" href="./css/index.css">
</head>
<body>
  <div id="clusterWarning" class="cluster-warning" style="display:none;">Работа с LLM приостановлена. Нет доступных серверов Ollama.</div>
  <div class="page-shell">
    <div class="page-header">
      <div>
        <span class="pill" data-i18n="pillOperations">Operations</span>
        <h1 data-i18n="headerTitle">Crawler Control Panel</h1>
        <p class="page-subtitle" data-i18n="headerSubtitle">Управление краулингом, базой знаний и окружением в едином окне</p>
      </div>
      <div class="page-header-actions">
        <select id="adminLanguage" arыia-label="Language" data-i18n-aria-label="languageLabel"></select>
        <button type="button" id="toggleLayoutOrdering" data-i18n="buttonReorder">Упорядочить блоки</button>
        <button type="button" id="adminLogout" data-i18n="buttonLogout">Выйти</button>
        <a class="dev-credit" href="https://dev-bot.su" target="_blank" rel="noopener" data-i18n="developerCredit">Created by дев-бот-су</a>
      </div>
    </div>

    <div class="top-knowledge">
      <h2 class="section-title">База знаний</h2>

      <section id="block-knowыыledge" class="dashboard-stack top-knowledge-stack" data-block-id="knowledge" data-block-group="knowledge">
        <div class="card knowledge-card">
          <b>Knowledge Base</b>
          <div class="kb-section-nav" role="tablist" aria-label="Управление базой знаний">
            <button type="button" class="kb-tab-button active" id="kbTabOverview" data-kb-target="overview" role="tab" aria-selected="true" aria-controls="kbSectionOverview">Обзор</button>
            <button type="button" class="kb-tab-button" id="kbTabUpload" data-kb-target="upload" role="tab" aria-selected="false" aria-controls="kbSectionUpload" tabindex="-1">Загрузка</button>
            <button type="button" class="kb-tab-button" id="kbTabDocuments" data-kb-target="documents" role="tab" aria-selected="false" aria-controls="kbSectionDocuments" tabindex="-1">Документы</button>
            <button type="button" class="kb-tab-button" id="kbTabQA" data-kb-target="qa" role="tab" aria-selected="false" aria-controls="kbSectionQA" tabindex="-1">Вопрос–ответ</button>
            <button type="button" class="kb-tab-button" id="kbTabUnanswered" data-kb-target="unanswered" role="tab" aria-selected="false" aria-controls="kbSectionUnanswered" tabindex="-1">Вопросы без ответа</button>
          </div>
          <div class="kb-priority-panel">
            <div class="kb-priority-header">
              <strong data-i18n="kbPriorityTitle">Приоритет источников</strong>
              <button type="button" id="kbPrioritySave" data-i18n="saveButton">Сохранить</button>
            </div>
            <ul class="kb-priority-list" id="kbPriorityList"></ul>
            <span class="muted" id="kbPriorityStatus"></span>
          </div>
          <div id="kbThinkingOverlay" class="thinking-overlay">
            <div class="thinking-inner">
              <img
                src="data:image/svg+xml;utf8,%3Csvg%20width%3D%22180%22%20height%3D%22140%22%20viewBox%3D%220%200%20180%20140%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3ClinearGradient%20id%3D%22grad%22%20x1%3D%220%22%20x2%3D%221%22%20y1%3D%220%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%2360a5fa%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%2250%25%22%20stop-color%3D%22%237c3aed%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23f97316%22/%3E%0A%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3Cfilter%20id%3D%22blur%22%20x%3D%22-20%25%22%20y%3D%22-20%25%22%20width%3D%22140%25%22%20height%3D%22140%25%22%3E%0A%20%20%20%20%20%20%3CfeGaussianBlur%20stdDeviation%3D%2218%22/%3E%0A%20%20%20%20%3C/filter%3E%0A%20%20%3C/defs%3E%0A%20%20%3Ccircle%20cx%3D%2250%22%20cy%3D%2270%22%20r%3D%2240%22%20fill%3D%22url(%23grad)%22%20opacity%3D%220.65%22%20filter%3D%22url(%23blur)%22/%3E%0A%20%20%3Ccircle%20cx%3D%22110%22%20cy%3D%2250%22%20r%3D%2230%22%20fill%3D%22url(%23grad)%22%20opacity%3D%220.45%22%20filter%3D%22url(%23blur)%22/%3E%0A%20%20%3Ccircle%20cx%3D%22120%22%20cy%3D%2295%22%20r%3D%2236%22%20fill%3D%22url(%23grad)%22%20opacity%3D%220.55%22%20filter%3D%22url(%23blur)%22/%3E%0A%20%20%3Cpath%20d%3D%22M52%2036c26%200%2048%2020%2048%2045s-22%2045-48%2045-48-20-48-45%2022-45%2048-45zm0%2016c-18%200-32%2013-32%2029s14%2029%2032%2029%2032-13%2032-29-14-29-32-29z%22%20fill%3D%22%23111827%22%20opacity%3D%220.72%22/%3E%0A%20%20%3Cpath%20d%3D%22M116%2028c16%200%2028%2012%2028%2028s-12%2028-28%2028-28-12-28-28%2012-28%2028-28z%22%20fill%3D%22%231e293b%22%20opacity%3D%220.7%22/%3E%0A%20%20%3Ccircle%20cx%3D%22104%22%20cy%3D%2256%22%20r%3D%226%22%20fill%3D%22%2393c5fd%22/%3E%0A%20%20%3Ccircle%20cx%3D%22128%22%20cy%3D%2256%22%20r%3D%226%22%20fill%3D%22%2393c5fd%22/%3E%0A%20%20%3Cpath%20d%3D%22M112%2072c5%206%2013%206%2018%200%22%20stroke%3D%22%23a855f7%22%20stroke-width%3D%223%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E"
                alt="Идёт генерация описания"
                class="thinking-illustration"
              >
              <div class="thinking-spinner"></div>
              <div class="thinking-caption" id="kbThinkingCaption">Генерируем описание…</div>
              <div class="thinking-subtitle" id="kbThinkingMessage">Это может занять несколько секунд.</div>
              <div class="thinking-preview" id="kbThinkingPreview"></div>
            </div>
          </div>
          <div class="kb-section active" data-kb-section="overview" id="kbSectionOverview" role="tabpanel" aria-labelledby="kbTabOverview">
            <form id="kbForm" style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;">
              <label style="flex:1 1 200px;">Проект
                <input type="text" list="kbProjectList" id="kbProject" placeholder="mmvs" style="width:100%;" readonly>
                <datalist id="kbProjectList"></datalist>
              </label>
              <button type="button" id="kbReloadProjects" title="Обновить список проектов">↻</button>
              <label style="flex:1 1 240px;">Поиск
                <input type="text" id="kbSearch" placeholder="Название или описание" style="width:100%;">
              </label>
              <label>Limit
                <input type="number" id="kbLimit" min="10" max="1000" value="1000" style="width:100px;">
              </label>
              <button type="submit">Обновить</button>
              <button type="button" id="kbClear">Очистить</button>
            </form>
            <div class="kb-meta-line">
              <span class="muted" id="kbInfo"></span>
              <span class="muted" id="kbProjectsSummary"></span>
            </div>
          </div>
          <div class="kb-section" data-kb-section="upload" id="kbSectionUpload" role="tabpanel" aria-labelledby="kbTabUpload" aria-hidden="true">
            <form id="kbAddForm" style="display:flex; flex-wrap:wrap; gap:10px;">
              <label style="flex:1 1 220px;">Имя
                <input type="text" id="kbNewName" placeholder="document.txt" style="width:100%;">
              </label>
              <label style="flex:1 1 220px;">URL
                <input type="url" id="kbNewUrl" placeholder="https://example.com" style="width:100%;">
              </label>
              <label style="flex:1 1 220px;">Описание
                <input type="text" id="kbNewDescription" placeholder="Краткое описание" style="width:100%;">
              </label>
              <label style="flex:1 1 220px;">Файл
                <input type="file" id="kbNewFile" multiple style="width:100%;">
              </label>
              <div id="kbDropZone" class="drop-zone" style="flex:1 1 100%;">
                Перетащите файлы сюда или нажмите на поле выше
              </div>
              <div id="kbAutoDescription" class="auto-description"></div>
              <label style="flex:1 1 100%;">Текст
                <textarea id="kbNewContent" placeholder="Введите текст документа" style="width:100%; min-height:120px;"></textarea>
              </label>
              <div style="display:flex; gap:10px; align-items:center;">
                <button type="submit">Сохранить</button>
                <button type="button" id="kbResetForm">Сбросить</button>
                <span class="muted" id="kbAddStatus"></span>
              </div>
            </form>
          </div>
          <div class="kb-section" data-kb-section="documents" id="kbSectionDocuments" role="tabpanel" aria-labelledby="kbTabDocuments" aria-hidden="true">
            <div class="knowledge-actions">
              <button type="button" id="kbDeduplicate">Очистить дубликаты</button>
              <button type="button" id="kbClearKnowledge">Очистить базу</button>
              <span class="muted" id="kbDedupStatus"></span>
              <span class="muted" id="kbClearStatus"></span>
            </div>
            <div class="kb-category" data-kb-category="text">
              <div class="kb-category-header">
                <strong>Текст</strong>
                <span class="muted" id="kbCountText">—</span>
              </div>
              <div class="kb-table-wrapper">
                <table>
                  <thead>
                  <tr><th class="nowrap">Имя</th><th>Описание</th><th class="nowrap">Проект</th><th class="nowrap">Файл</th><th class="nowrap">Действия</th></tr>
                  </thead>
                  <tbody id="kbTableText"></tbody>
                </table>
              </div>
            </div>
            <div class="kb-category" data-kb-category="docs">
              <div class="kb-category-header">
                <strong>Документы</strong>
                <span class="muted" id="kbCountDocs">—</span>
              </div>
              <div class="kb-table-wrapper">
                <table>
                  <thead>
                  <tr><th class="nowrap">Имя</th><th>Описание</th><th class="nowrap">Проект</th><th class="nowrap">Файл</th><th class="nowrap">Действия</th></tr>
                  </thead>
                  <tbody id="kbTableDocs"></tbody>
                </table>
              </div>
            </div>
            <div class="kb-category" data-kb-category="images">
              <div class="kb-category-header">
                <strong>Фото</strong>
                <span class="muted" id="kbCountImages">—</span>
              </div>
              <div class="kb-table-wrapper">
                <table>
                  <thead>
                  <tr><th class="nowrap">Имя</th><th>Описание</th><th class="nowrap">Проект</th><th class="nowrap">Файл</th><th class="nowrap">Действия</th></tr>
                  </thead>
                  <tbody id="kbTableImages"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="kb-section" data-kb-section="qa" id="kbSectionQA" role="tabpanel" aria-labelledby="kbTabQA" aria-hidden="true">
            <div class="qa-import">
              <form id="kbQaImportForm">
                <label class="qa-upload">
                  <span>Excel файл с колонками «Вопрос» и «Ответ»</span>
                  <input type="file" id="kbQaFile" accept=".xlsx,.xlsm,.xltx,.xltm,.csv" required>
                </label>
                <div class="qa-actions">
                  <button type="submit">Импортировать</button>
                  <button type="button" id="kbQaAddRow">Добавить вручную</button>
                  <span class="muted" id="kbQaStatus"></span>
                </div>
              </form>
            </div>
            <div class="kb-meta-line">
              <span>Всего пар:</span>
              <span class="muted" id="kbCountQa">—</span>
            </div>
            <div class="kb-table-wrapper">
              <table class="qa-table">
                <thead>
                  <tr>
                    <th>Вопрос</th>
                    <th>Ответ</th>
                    <th class="nowrap">Приоритет</th>
                    <th class="nowrap">Действия</th>
                  </tr>
                </thead>
                <tbody id="kbTableQa"></tbody>
              </table>
            </div>
          </div>
          <div class="kb-section" data-kb-section="unanswered" id="kbSectionUnanswered" role="tabpanel" aria-labelledby="kbTabUnanswered" aria-hidden="true">
            <div class="kb-meta-line">
              <span>Всего вопросов без ответа:</span>
              <span class="muted" id="kbCountUnanswered">—</span>
            </div>
            <div class="unanswered-actions">
              <button type="button" id="kbUnansweredExport">Экспорт CSV</button>
              <button type="button" id="kbUnansweredClear">Очистить список</button>
              <span class="muted" id="kbUnansweredStatus"></span>
            </div>
            <div class="kb-table-wrapper">
              <table class="unanswered-table">
                <thead>
                  <tr>
                    <th>Вопрос</th>
                    <th class="nowrap">Количество</th>
                    <th class="nowrap">Последний раз</th>
                  </tr>
                </thead>
                <tbody id="kbTableUnanswered"></tbody>
              </table>
            </div>
            <p class="muted" style="margin-top:12px;">Вопросы старше 30 дней удаляются автоматически.</p>
          </div>
        </div>
      </section>
    </div>


    <div class="overview-banner">
    <div class="overview-card" id="summaryProjectCard">
      <div class="overview-pulse"></div>
      <h2>Проект</h2>
      <strong id="summaryProject">—</strong>
      <div class="overview-meta" id="summaryProjectMeta">Нет выбранного проекта</div>
    </div>
    <div class="overview-card" id="summaryCrawlerCard">
      <div class="overview-pulse"></div>
      <h2>Краулинг</h2>
      <strong id="summaryCrawler">—</strong>
      <div class="overview-meta" id="summaryCrawlerMeta"></div>
    </div>
    <div class="overview-card" id="summaryPerfCard">
      <div class="overview-pulse"></div>
      <h2>Ресурсы</h2>
      <strong id="summaryPerf">—</strong>
      <div class="overview-meta" id="summaryPerfMeta"></div>
    </div>
    <div class="overview-card" id="summaryLLMCard">
      <div class="overview-pulse"></div>
      <h2>LLM мысли</h2>
      <div class="prompt-preview" id="summaryPrompt">История запросов появится здесь</div>
      <div class="prompt-docs" id="summaryPromptDocs"></div>
    </div>
    <div class="overview-card" id="summaryBuildCard">
      <div class="overview-pulse"></div>
      <h2>Сборка</h2>
      <strong id="summaryBuild">—</strong>
      <div class="overview-meta" id="summaryBuildMeta">—</div>
    </div>
  </div>

  <div class="dashboard-grid">
    <section id="block-projects" class="dashboard-stack span-3" data-block-id="projects" data-block-group="overview">
      <details class="card project-switch-card collapsible-card" data-collapsible="projects">
        <summary class="collapsible-summary">
          <span class="collapsible-title">Projects</span>
          <span class="collapsible-chevron" aria-hidden="true"></span>
        </summary>
        <div class="collapsible-body">
          <div class="collapsible-content">
            <select id="projectSelect" size="6"></select>
            <div class="project-switch-actions">
              <button type="button" id="projectAdd">Добавить проект</button>
              <button type="button" id="projectRefresh">Обновить список</button>
            </div>
            <span class="muted" id="projectStatus"></span>
            <datalist id="llmModelOptions"></datalist>
          </div>
        </div>
      </details>
    </section>

    <section id="block-status" class="dashboard-stack span-9 status-tiles" data-block-id="status" data-block-group="overview">
      <div class="card status-card">
        <b data-i18n="crawlerStatusTitle">Статус краулера</b>
        <div data-i18n-wrapper="crawlerQueued">Queued: <span data-i18n-value id="queued">0</span></div>
        <div data-i18n-wrapper="crawlerInProgress">In progress: <span data-i18n-value id="in_progress">0</span></div>
        <div data-i18n-wrapper="crawlerDone">Done: <span data-i18n-value id="done">0</span></div>
        <div data-i18n-wrapper="crawlerFailed">Failed: <span data-i18n-value id="failed">0</span></div>
        <div class="muted" data-i18n-wrapper="crawlerLast" id="last_crawl">Last: <span data-i18n-value>–</span></div>
        <div class="muted" data-i18n-wrapper="crawlerProjectLabel">Project: <span data-i18n-value id="crawlerProject">—</span></div>
        <div>
          <details>
            <summary data-i18n="crawlerLastUrls">Последние URL</summary>
            <ol id="recent_urls" style="margin-top:6px;"></ol>
          </details>
        </div>
      </div>
      <div class="card status-card">
        <b data-i18n="servicesTitle">Сервисы</b>
        <div data-i18n-wrapper="serviceMongo">Mongo: <span id="mongo" class="bad" data-i18n-value>down</span></div>
        <div data-i18n-wrapper="serviceRedis">Redis: <span id="redis" class="bad" data-i18n-value>down</span></div>
        <div data-i18n-wrapper="serviceQdrant">Qdrant: <span id="qdrant" class="bad" data-i18n-value>down</span></div>
        <div data-i18n-wrapper="serviceOverall">Status: <span id="overall" data-i18n-value>degraded</span></div>
      </div>
      <div class="card status-card">
        <b data-i18n="resourcesTitle">Ресурсы</b>
        <div data-i18n-wrapper="resourceCpuApp">CPU (app): <span id="cpu" data-i18n-value>–</span></div>
        <div data-i18n-wrapper="resourceCpuSys">CPU (sys): <span id="cpuSys" data-i18n-value>–</span></div>
        <div data-i18n-wrapper="resourceRam">RAM: <span id="ram" data-i18n-value>–</span></div>
        <div data-i18n-wrapper="resourceRss">RSS: <span id="rss" data-i18n-value>–</span></div>
        <div style="white-space:pre-line;" data-i18n-wrapper="resourceGpu">GPU: <span id="gpu" data-i18n-value>–</span></div>
        <div data-i18n-wrapper="resourcePython">Python: <span id="pyver" data-i18n-value>–</span></div>
      </div>
    </section>

    <h2 class="section-title span-all" data-i18n="manageSection">Управление</h2>

    <section id="block-crawler" class="dashboard-stack span-4" data-block-id="crawler" data-block-group="manage">
      <div class="card control-card">
        <div class="crawler-header">
          <b data-i18n="crawlerLaunchTitle">Запуск краулера</b>
          <div class="crawler-logs-buttons">
            <button type="button" id="crawlerLogsBtn" class="icon-button" title="Показать логи" data-i18n-title="crawlerLogsTooltip">?</button>
          </div>
        </div>
        <div class="crawler-progress" id="crawlerProgress">
          <div class="crawler-progress-track">
            <div class="crawler-progress-fill" id="crawlerProgressFill"></div>
          </div>
          <div class="crawler-progress-meta">
            <span id="crawlerProgressStatus">Ожидание запуска</span>
            <span id="crawlerProgressCounters">0 / 0 страниц</span>
          </div>
          <div class="crawler-progress-note" id="crawlerProgressNote"></div>
        </div>
        <form id="crawler-form" style="margin-top:4px; display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end;">
          <label style="flex:1 1 200px;">
            <span data-i18n="crawlerStartUrl">Start URL</span>
            <input type="url" id="url" placeholder="https://example.com" required style="width:100%;">
          </label>
          <label>
            <span data-i18n="crawlerDepth">Depth</span>
            <input type="number" id="depth" min="1" value="2" style="width:80px;">
          </label>
          <label>
            <span data-i18n="crawlerPages">Pages</span>
            <input type="number" id="pages" min="1" value="100" style="width:80px;">
          </label>
          <label class="crawler-option">
            <input type="checkbox" id="crawlerCollectBooks">
            <span data-i18n="crawlerCollectBooks">Store full pages for book reading</span>
          </label>
          <label class="crawler-option">
            <input type="checkbox" id="crawlerCollectMedex">
            <span data-i18n="crawlerCollectMedex">Collect Medesk booking links</span>
          </label>
          <button type="submit" data-i18n="crawlerStartButton">Запустить</button>
          <button type="button" id="stopBtn" data-i18n="crawlerStopButton">Остановить</button>
          <span id="launchMsg" class="muted"></span>
        </form>
        <div class="crawler-actions">
          <button type="button" id="crawlerResetBtn" data-i18n="crawlerResetButton">Сбросить счётчики</button>
          <button type="button" id="crawlerDedupBtn" data-i18n="crawlerDedupButton">Убрать дубликаты URL</button>
          <span class="muted" id="crawlerActionStatus"></span>
        </div>
        <div class="crawler-logs" id="crawlerLogsPanel">
          <div class="crawler-logs-header">
            <span data-i18n="crawlerLogsHeader">Crawler logs</span>
            <div class="crawler-logs-buttons">
              <button type="button" id="crawlerLogsCopy" class="icon-button" title="Скопировать" data-i18n-title="crawlerLogsCopy">⧉</button>
              <button type="button" id="crawlerLogsRefresh" class="icon-button" title="Обновить" data-i18n-title="crawlerLogsRefresh">↻</button>
              <button type="button" id="crawlerLogsClose" class="icon-button" title="Скрыть" data-i18n-title="crawlerLogsHide">×</button>
            </div>
          </div>
          <pre id="crawlerLogsOutput" class="crawler-logs-output" data-i18n="crawlerLogsEmpty">Логи будут загружены по запросу.</pre>
        </div>
      </div>
    </section>
    <section id="block-project" class="dashboard-stack span-8" data-block-id="project" data-block-group="manage">
      <details class="card control-card project-card collapsible-card" data-collapsible="project">
        <summary class="collapsible-summary">
          <span class="collapsible-title">Project</span>
          <span class="collapsible-chevron" aria-hidden="true"></span>
        </summary>
        <div class="collapsible-body">
          <b>Project</b>
        <form id="projectForm" style="display:flex; flex-wrap:wrap; gap:10px;">
          <label style="flex:1 1 200px;">Идентификатор (ENG)
            <input type="text" id="projectName" placeholder="mmvs" required>
          </label>
          <label style="flex:1 1 200px;">Название
            <input type="text" id="projectTitle" placeholder="Название проекта">
          </label>
          <label style="flex:1 1 200px;">Домен (необязательно)
            <input type="text" id="projectDomain" placeholder="https://example.com">
          </label>
          <label style="flex:1 1 200px;">LLM модель
            <select id="projectModel" style="width:100%;"></select>
          </label>
          <label style="flex:1 1 100%;">Стартовый промпт
            <textarea id="projectPrompt" rows="3" placeholder="Укажите инструкцию для модели" style="width:100%; resize:vertical;"></textarea>
          </label>
          <div class="prompt-ai-controls" style="flex:1 1 100%;">
            <select id="projectPromptRole"></select>
            <button type="button" id="projectPromptAi">AI‑сгенерировать</button>
            <span class="muted prompt-ai-status" id="projectPromptAiStatus">—</span>
          </div>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectEmotions" checked>
              Эмоции и эмодзи в ответах
            </label>
            <span class="muted" id="projectEmotionsHint">Оставьте включённым, чтобы ответы были тёплыми и живыми.</span>
          </div>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectVoiceEnabled" checked>
              Голосовой консультант
            </label>
            <span class="muted" id="projectVoiceHint">Включите, чтобы показывать анимированного голосового ассистента на сайте.</span>
          </div>
          <label style="flex:1 1 200px;">Модель для голосового режима (опционально)
            <input type="text" id="projectVoiceModel" placeholder="Например, gpt-4o-mini" list="llmModelOptions">
          </label>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectImageCaptions" checked>
              Подписи к изображениям базы знаний
            </label>
            <span class="muted" id="projectImageCaptionsHint">LLM будет подбирать короткое описание при индексации изображений.</span>
          </div>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectSourcesEnabled">
              Показывать источники ответов
            </label>
            <span class="muted" id="projectSourcesHint">После ответа будет отображаться список ссылок на использованные материалы.</span>
          </div>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectDebugInfo" checked>
              Служебная справка перед ответом
            </label>
            <span class="muted" id="projectDebugInfoHint">Включите, чтобы перед ответом в Telegram приходила служебная справка (endpoint, эмоции и т. п.).</span>
          </div>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectDebug">
              Подробная отладка после ответа
            </label>
            <span class="muted" id="projectDebugHint">Включите, чтобы после ответа приходила подробная сводка (символы, знания, сессия).</span>
          </div>
          <div id="projectAdminSection" style="flex:1 1 100%; display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;">
            <label style="flex:1 1 200px;">Админ логин
              <input type="text" id="projectAdminUsername" placeholder="project_admin">
            </label>
            <label style="flex:1 1 200px;">Новый пароль
              <input type="password" id="projectAdminPassword" placeholder="Оставьте пустым, чтобы не менять">
            </label>
            <span class="muted" id="projectAdminHint" style="flex:1 1 100%;">Укажите логин и пароль администратора проекта.</span>
          </div>
        <div class="project-storage-panel">
          <div>Тексты: <span id="projectStorageText">—</span></div>
          <div>Файлы: <span id="projectStorageFiles">—</span></div>
          <div>Контексты: <span id="projectStorageContexts">—</span></div>
          <div>Redis: <span id="projectStorageRedis">—</span></div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button type="submit">Сохранить</button>
          <button type="button" id="projectPromptSave">Сохранить промпт</button>
          <button type="button" id="projectTest">Тест</button>
        </div>
      </form>
      <div class="card voice-training-card" id="voiceTrainingCard">
        <div>
          <b data-i18n="voiceTrainingTitle">Обучение голоса</b>
          <div class="muted" id="voiceTrainingSummary" data-i18n="voiceTrainingSummary">Загрузите 3+ аудиодорожки с чистой речью, чтобы обучить ассистента говорить голосом проекта.</div>
        </div>
        <div class="voice-upload">
          <div class="voice-upload-row">
            <input type="file" id="voiceSampleInput" accept="audio/*" capture="microphone" multiple>
            <button type="button" id="voiceSampleUpload" data-i18n="voiceUploadButton">Загрузить дорожки</button>
          </div>
          <div class="voice-upload-actions">
            <button type="button" id="voiceRecordBtn" data-i18n="voiceRecordButton">Записать дорожку</button>
            <span class="muted" id="voiceRecordStatus">—</span>
          </div>
          <span class="muted" id="voiceUploadStatus">—</span>
        </div>
        <div class="voice-samples" id="voiceSamplesContainer">
          <div class="muted" id="voiceSamplesEmpty" data-i18n="voiceSamplesEmpty">Дорожки не загружены.</div>
        </div>
        <div class="voice-train-actions">
          <button type="button" id="voiceTrainButton" data-i18n="voiceTrainButton">Обучить голос</button>
          <span class="muted" id="voiceTrainStatus">—</span>
        </div>
        <div class="voice-jobs" id="voiceJobsContainer"></div>
      </div>
      <div class="project-danger" id="projectDangerZone">
        <div>
          <strong>Опасная зона</strong>
          <p>Удаление проекта безвозвратно очищает документы, файлы, контексты и статистику. Действие нельзя отменить.</p>
        </div>
          <button type="button" id="projectDelete" class="project-delete-btn" disabled>Удалить проект</button>
          <span class="muted" id="projectDeleteInfo">Выберите проект, чтобы увидеть объём данных.</span>
        </div>
        <div class="project-extensions" style="display:flex; flex-wrap:wrap; gap:16px; margin-top:16px;">
          <div class="project-telegram" style="flex:1 1 260px; min-width:240px;">
            <b style="display:block; margin-bottom:8px;">Telegram бот</b>
            <label style="display:block; margin-bottom:8px;">Bot Token
              <input type="password" id="projectTelegramToken" placeholder="Введите токен" style="width:100%;">
            </label>
            <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
              <input type="checkbox" id="projectTelegramAutoStart"> Автозапуск при старте
            </label>
            <div>Status: <span id="projectTelegramStatus">—</span></div>
            <div class="muted" id="projectTelegramInfo"></div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <button type="button" id="projectTelegramSave">Сохранить</button>
              <button type="button" id="projectTelegramStart">Запустить</button>
              <button type="button" id="projectTelegramStop">Остановить</button>
              <span class="muted" id="projectTelegramMessage"></span>
            </div>
          </div>
          <div class="project-max" style="flex:1 1 260px; min-width:240px;">
            <b style="display:block; margin-bottom:8px;">MAX бот</b>
            <label style="display:block; margin-bottom:8px;">Access Token
              <input type="password" id="projectMaxToken" placeholder="Введите токен" style="width:100%;">
            </label>
            <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
              <input type="checkbox" id="projectMaxAutoStart"> Автозапуск при старте
            </label>
            <div>Status: <span id="projectMaxStatus">—</span></div>
            <div class="muted" id="projectMaxInfo"></div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <button type="button" id="projectMaxSave">Сохранить</button>
              <button type="button" id="projectMaxStart">Запустить</button>
              <button type="button" id="projectMaxStop">Остановить</button>
              <span class="muted" id="projectMaxMessage"></span>
            </div>
          </div>
          <div class="project-vk" style="flex:1 1 260px; min-width:240px;">
            <b style="display:block; margin-bottom:8px;">VK бот</b>
            <label style="display:block; margin-bottom:8px;">Access Token
              <input type="password" id="projectVkToken" placeholder="Введите токен" style="width:100%;">
            </label>
            <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
              <input type="checkbox" id="projectVkAutoStart"> Автозапуск при старте
            </label>
            <div>Status: <span id="projectVkStatus">—</span></div>
            <div class="muted" id="projectVkInfo"></div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <button type="button" id="projectVkSave">Сохранить</button>
              <button type="button" id="projectVkStart">Запустить</button>
              <button type="button" id="projectVkStop">Остановить</button>
              <span class="muted" id="projectVkMessage"></span>
            </div>
          </div>
          <div class="project-widget" style="flex:1 1 260px; min-width:240px;">
            <b style="display:block; margin-bottom:8px;">Виджет</b>
            <label style="display:block; margin-bottom:8px;">Ссылка на виджет
              <input type="url" id="projectWidgetUrl" placeholder="https://example.com/widget" style="width:100%;">
            </label>
            <div class="muted" id="projectWidgetHint">Ссылка отображается после выбора проекта</div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <a id="projectWidgetLink" href="#" target="_blank" rel="noopener" style="pointer-events:none; opacity:0.6;">Открыть виджет</a>
              <button type="button" id="projectWidgetCopy" disabled>Скопировать</button>
              <span class="muted" id="projectWidgetMessage"></span>
            </div>
          </div>
          <div class="project-bitrix" style="flex:1 1 260px; min-width:240px;">
            <b style="display:block; margin-bottom:8px;">Bitrix24</b>
            <label style="display:block; margin-bottom:8px;">Webhook URL
              <input type="url" id="projectBitrixWebhook" placeholder="https://example.bitrix24.ru/rest/1/xxxxxxxxx/" style="width:100%;">
            </label>
            <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
              <input type="checkbox" id="projectBitrixEnabled">
              Активировать интеграцию
            </label>
            <span class="muted" id="projectBitrixHint">Webhook используется для запросов модели и хранится на сервере.</span>
          </div>
          <div class="project-mail" style="flex:1 1 320px; min-width:280px;">
            <b style="display:block; margin-bottom:8px;">Почтовый коннектор</b>
            <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
              <input type="checkbox" id="projectMailEnabled">
              Включить интеграцию
            </label>
            <div class="muted" id="projectMailHint">Укажите параметры IMAP/SMTP, чтобы ассистент мог отправлять и просматривать письма.</div>
            <div style="display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); margin-top:10px;">
              <label>IMAP хост
                <input type="text" id="projectMailImapHost" placeholder="imap.example.com">
              </label>
              <label>IMAP порт
                <input type="number" id="projectMailImapPort" placeholder="993" min="1" max="65535">
              </label>
              <label style="display:flex; gap:6px; align-items:center;">
                <input type="checkbox" id="projectMailImapSsl" checked>
                IMAP SSL
              </label>
              <label>SMTP хост
                <input type="text" id="projectMailSmtpHost" placeholder="smtp.example.com">
              </label>
              <label>SMTP порт
                <input type="number" id="projectMailSmtpPort" placeholder="587" min="1" max="65535">
              </label>
              <label style="display:flex; gap:6px; align-items:center;">
                <input type="checkbox" id="projectMailSmtpTls" checked>
                SMTP STARTTLS
              </label>
              <label>Имя пользователя
                <input type="text" id="projectMailUsername" placeholder="user@example.com">
              </label>
              <label>Пароль
                <input type="password" id="projectMailPassword" placeholder="Пароль" autocomplete="new-password">
              </label>
              <label>Отправитель (From)
                <input type="email" id="projectMailFrom" placeholder="support@example.com">
              </label>
            </div>
            <label style="display:block; margin-top:10px;">Подпись в письмах
              <textarea id="projectMailSignature" rows="3" placeholder="С уважением, команда Example" style="width:100%; resize:vertical;"></textarea>
            </label>
          </div>
        </div>
      </div>
      </details>
    </section>

    <section id="block-backup" class="dashboard-stack span-4" data-block-id="backup" data-block-group="manage">
      <details class="card control-card collapsible-card" data-collapsible="backup">
        <summary class="collapsible-summary">
          <span class="collapsible-title" data-i18n="backupCardTitle">Резервные копии</span>
          <span class="collapsible-chevron" aria-hidden="true"></span>
        </summary>
        <div class="collapsible-body backup-card">
          <div class="backup-section">
            <b data-i18n="backupScheduleTitle">Расписание</b>
            <label class="backup-toggle">
              <input type="checkbox" id="backupEnabled">
              <span data-i18n="backupEnableLabel">Включить ежедневное резервирование</span>
            </label>
            <div class="backup-field-grid">
              <label>
                <span data-i18n="backupTimeLabel">Время запуска</span>
                <input type="time" id="backupTime" min="00:00" max="23:59">
              </label>
              <label>
                <span data-i18n="backupTimezoneLabel">Часовой пояс</span>
                <select id="backupTimezone"></select>
              </label>
              <label>
                <span data-i18n="backupFolderLabel">Папка на Яндекс.Диске</span>
                <input type="text" id="backupFolder" placeholder="sitellm-backups" data-i18n-placeholder="backupFolderPlaceholder">
              </label>
            </div>
            <div class="backup-token-row">
              <label>
                <span data-i18n="backupTokenLabel">OAuth токен</span>
                <input type="password" id="backupToken" autocomplete="off" data-i18n-placeholder="backupTokenPlaceholder">
              </label>
              <button type="button" id="backupTokenSave" data-i18n="backupTokenSave">Сохранить</button>
              <button type="button" id="backupTokenClear" data-i18n="backupTokenClear">Удалить</button>
              <span class="backup-status-line" id="backupTokenStatus"></span>
            </div>
            <div class="backup-action-buttons">
              <button type="button" id="backupSettingsApply" data-i18n="backupScheduleSave">Сохранить расписание</button>
            </div>
            <span class="backup-status-line" id="backupStatusLine"></span>
          </div>
          <div class="backup-section">
            <b data-i18n="backupManualTitle">Ручные действия</b>
            <div class="backup-action-buttons">
              <button type="button" id="backupRunBtn" data-i18n="backupRunNow">Создать резервную копию</button>
              <button type="button" id="backupRefreshBtn" data-i18n="backupRefresh">Обновить статус</button>
            </div>
            <label>
              <span data-i18n="backupRestoreLabel">Восстановление по пути</span>
              <input type="text" id="backupRestorePath" data-i18n-placeholder="backupRestorePlaceholder" placeholder="/sitellm-backups/backup.archive.gz">
            </label>
            <button type="button" id="backupRestoreBtn" data-i18n="backupRestoreButton">Восстановить</button>
          </div>
          <div class="backup-section">
            <b data-i18n="backupJobsTitle">Журнал операций</b>
            <div class="backup-jobs-list" id="backupJobsList">
              <div class="backup-empty" data-i18n="backupJobsEmpty">Пока нет записей.</div>
            </div>
          </div>
          <div class="backup-status-line" id="backupErrorLine"></div>
        </div>
      </details>
    </section>

    <section id="block-llm" class="dashboard-stack span-4" data-block-id="llm" data-block-group="manage">
      <div class="card control-card">
        <b>LLM</b>
        <div>Model: <code id="model">–</code></div>
        <div>Backend: <span id="backend">–</span></div>
        <div>Device: <span id="device">–</span></div>
        <div style="margin-top:6px;">
          <label>Ollama Base:
            <input type="text" id="ollamaBase" placeholder="http://host.docker.internal:11434" style="width:100%">
          </label>
          <label style="display:block; margin-top:6px;">Model name:
            <input type="text" id="ollamaModel" placeholder="yandex/YandexGPT-5-Lite-8B-instruct-GGUF:latest" style="width:100%">
          </label>
          <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" id="saveLLM">Save</button>
            <button type="button" id="pingLLM">Ping</button>
            <span id="pingRes" class="muted"></span>
          </div>
          <div class="ollama-catalog" id="ollamaCatalog">
            <div class="ollama-catalog-header">
              <span class="muted">Каталог моделей Ollama</span>
              <button type="button" id="ollamaRefresh">Обновить</button>
            </div>
            <div class="ollama-meta" id="ollamaAvailability">—</div>
            <div>
              <strong style="font-size:12px; letter-spacing:0.06em; text-transform:uppercase;">Установленные</strong>
              <ul class="ollama-list" id="ollamaInstalledList"></ul>
            </div>
            <div>
              <strong style="font-size:12px; letter-spacing:0.06em; text-transform:uppercase;">Популярные</strong>
              <ul class="ollama-list" id="ollamaPopularList"></ul>
            </div>
            <div>
              <strong style="font-size:12px; letter-spacing:0.06em; text-transform:uppercase;">Установка</strong>
              <div class="ollama-jobs" id="ollamaJobsList"></div>
            </div>
            <div class="ollama-servers" id="ollamaServersPanel">
              <div class="ollama-servers-header">
                <strong style="font-size:12px; letter-spacing:0.06em; text-transform:uppercase;">Серверы</strong>
                <button type="button" id="ollamaServersRefresh">Обновить</button>
              </div>
              <div class="ollama-meta" id="ollamaServersStatus">—</div>
              <ul class="ollama-list" id="ollamaServersList"></ul>
              <form id="ollamaServerForm" class="ollama-server-form">
                <div class="ollama-server-form-grid">
                  <input type="text" id="ollamaServerName" placeholder="идентификатор" required>
                  <input type="text" id="ollamaServerUrl" placeholder="http://host:11434" required>
                  <label class="ollama-server-enabled">
                    <input type="checkbox" id="ollamaServerEnabled" checked>
                    Включён
                  </label>
                  <button type="submit">Добавить</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="block-feedback" class="dashboard-stack span-4" data-block-id="feedback" data-block-group="manage">
      <div class="card control-card">
        <div class="card-header">
          <b data-i18n="feedbackSectionTitle">Feedback</b>
          <button type="button" id="feedbackRefresh" data-i18n="reloadProjects">Reload</button>
        </div>
        <div class="feedback-list" id="feedbackTasksList">
          <div class="muted" data-i18n="feedbackNoItems">No feedback yet.</div>
        </div>
      </div>
    </section>

    <section id="block-stats" class="dashboard-stack span-12" data-block-id="stats" data-block-group="manage">
      <details class="card stats-card collapsible-card" data-collapsible="stats">
        <summary class="collapsible-summary">
          <span class="collapsible-title">Активность пользователей</span>
          <span class="collapsible-chevron" aria-hidden="true"></span>
        </summary>
        <div class="collapsible-body">
          <div class="muted" id="statsSubtitle">Последние 14 дней</div>
          <div class="stats-graph">
            <canvas id="statsCanvas"></canvas>
            <div id="statsTooltip" class="stats-tooltip"></div>
            <div id="statsEmpty" class="stats-empty">Нет данных</div>
          </div>
          <div class="stats-actions">
            <button type="button" id="statsRefresh">Обновить</button>
            <button type="button" id="statsExport">Экспорт CSV</button>
            <span class="muted" id="statsSummary"></span>
          </div>
        </div>
      </details>
    </section>


    <section id="block-knowledge-tools" class="dashboard-stack span-12" data-block-id="knowledge-tools" data-block-group="knowledge">
      <div class="card knowledge-service-card">
        <b>Интеллектуальная обработка</b>
        <div class="muted">Настройте промт и режим обновления векторной базы знаний.</div>
        <label style="display:flex; align-items:center; gap:8px; margin:10px 0;">
          <input type="checkbox" id="knowledgeServiceToggle">
          Сервис включён
        </label>
        <label style="display:flex; flex-direction:column; gap:6px;">
          <span>Режим запуска</span>
          <select id="knowledgeServiceMode" style="max-width:260px;">
            <option value="manual">Ручной (по команде)</option>
            <option value="auto">Автоматический (при простое очереди)</option>
          </select>
        </label>
        <label style="display:flex; flex-direction:column; gap:6px;">
          <span>Промт обработки</span>
          <textarea id="knowledgeServicePrompt" rows="5" placeholder="Опишите, как обрабатывать документы по частям" style="min-height:120px;"></textarea>
        </label>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button type="button" id="knowledgeServiceApply">Сохранить</button>
          <button type="button" id="knowledgeServiceRun">Запустить обработку</button>
          <button type="button" id="knowledgeServiceRefresh">Обновить</button>
          <span class="muted" id="knowledgeServiceStatus">—</span>
        </div>
      </div>
      <div class="card prompts-card">
        <b>LLM Prompts</b>
        <div class="muted">Последние запросы (с учётом базы знаний)</div>
        <pre id="promptLogs" style="white-space:pre-wrap; padding:10px; border-radius:8px; overflow:auto;"></pre>
      </div>
      <div class="card logs-card">
        <b>Logs (last 200)</b>
        <div style="margin:6px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>Lines: <input type="number" id="logLimit" min="50" max="1000" value="200" style="width:80px;"></label>
          <button id="copyLogs" type="button">Copy</button>
          <span class="muted" id="logInfo"></span>
        </div>
        <pre id="logs" style="white-space:pre-wrap; background:#0b1021; color:#b8c1ec; padding:10px; border-radius:8px; max-height:320px; overflow:auto;"></pre>
      </div>
    </section>
  </div>


  <div id="projectModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <strong>Новый проект</strong>
        <button type="button" class="modal-close" id="projectModalClose">×</button>
      </div>
      <form id="projectModalForm">
        <div class="modal-body">
          <label>Идентификатор (ENG)
            <input type="text" id="projectModalName" placeholder="mmvs" required>
          </label>
          <label>Название
            <input type="text" id="projectModalTitle" placeholder="Название проекта">
          </label>
          <label>Домен
            <input type="text" id="projectModalDomain" placeholder="https://example.com">
          </label>
          <label>LLM модель
            <input type="text" id="projectModalModel" list="llmModelOptions" placeholder="Например, yandex/YandexGPT-5-Lite-8B-instruct-GGUF:latest">
          </label>
          <label>Стартовый промпт
            <textarea id="projectModalPrompt" rows="4" placeholder="Опишите инструкцию для модели"></textarea>
          </label>
          <div class="prompt-ai-controls">
            <select id="projectModalPromptRole"></select>
            <button type="button" id="projectModalPromptAi">AI‑сгенерировать</button>
            <span class="muted prompt-ai-status" id="projectModalPromptAiStatus">—</span>
          </div>
          <label>Админ логин
            <input type="text" id="projectModalAdminUsername" placeholder="project_admin">
          </label>
          <label>Пароль администратора
            <input type="password" id="projectModalAdminPassword" placeholder="Оставьте пустым, чтобы не задавать">
          </label>
          <label style="display:flex; gap:10px; align-items:center;">
            <input type="checkbox" id="projectModalEmotions" checked>
            Эмоции и эмодзи в ответах
          </label>
        </div>
        <div class="modal-footer">
          <span class="muted" id="projectModalStatus"></span>
          <div style="display:flex; gap:8px;">
            <button type="submit">Создать</button>
            <button type="button" id="projectModalCancel">Отмена</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="kbModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <strong id="kbModalTitle">Документ</strong>
        <button type="button" class="modal-close" id="kbModalClose">×</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="kbModalId">
        <label>Имя
          <input type="text" id="kbModalName" required>
        </label>
        <label>URL
          <input type="url" id="kbModalUrl" placeholder="https://example.com">
        </label>
        <label>Описание
          <input type="text" id="kbModalDescription" placeholder="Краткое описание">
        </label>
        <label>Проект
          <input type="text" id="kbModalProject" placeholder="project">
        </label>
        <label>Текст
          <textarea id="kbModalContent"></textarea>
        </label>
      </div>
      <div class="modal-footer">
        <span class="muted" id="kbModalStatus"></span>
        <div style="display:flex; gap:8px;">
          <button type="button" id="kbModalCompile">Компилировать</button>
          <button type="button" id="kbModalSave">Сохранить</button>
          <button type="button" id="kbModalCancel">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  </div>
  <script src="./js/i18n.js"></script>
  <script src="./js/auth.js"></script>
  <script src="./js/session.js"></script>
  <script src="./js/index.js"></script>
  </body>
  </html>
