<!--
  Crawler Control Panel
  - Start crawler (URL / depth / pages)
  - Live crawler counters
  - Services health (Mongo/Redis/Qdrant)
  - LLM runtime (model, backend, device)
  - App process metrics (CPU/Mem)
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crawler Admin</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2032%2032%22%3E%3Crect%20width%3D%2232%22%20height%3D%2232%22%20rx%3D%228%22%20fill%3D%22%230b1026%22/%3E%3Ccircle%20cx%3D%2216%22%20cy%3D%2216%22%20r%3D%229%22%20fill%3D%22%2360a5fa%22/%3E%3C/svg%3E">
  <style>
    :root {
      --bg-primary: radial-gradient(circle at 15% 15%, rgba(79, 70, 229, 0.6), transparent 45%), radial-gradient(circle at 85% 20%, rgba(6, 182, 212, 0.55), transparent 50%), linear-gradient(135deg, #0b1026, #131b2f 55%, #0e1629);
      --card-bg: rgba(19, 27, 45, 0.75);
      --card-border: rgba(148, 163, 184, 0.15);
      --card-shadow: 0 20px 45px rgba(8, 12, 24, 0.35);
      --text-primary: #f1f5ff;
      --text-muted: #8fa0c6;
      --accent: #60a5fa;
      --accent-soft: rgba(96, 165, 250, 0.2);
      --danger: #f87171;
      --success: #4ade80;
      --input-bg: rgba(13, 19, 34, 0.7);
      --input-border: rgba(96, 112, 152, 0.35);
      --badge-bg: rgba(59, 130, 246, 0.2);
      --scroll-thumb: rgba(96, 165, 250, 0.4);
      --scroll-track: rgba(15, 19, 35, 0.6);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", "SF Pro Display", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
    }

    .cluster-warning {
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 12px 18px;
      background: rgba(239, 68, 68, 0.9);
      color: #fff7f7;
      text-align: center;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      box-shadow: 0 12px 30px rgba(127, 29, 29, 0.45);
    }

    a { color: var(--accent); }

    .page-shell {
      width: min(1680px, 100%);
      margin: 0 auto;
      padding: clamp(28px, 5vw, 56px) clamp(18px, 6vw, 64px) clamp(48px, 7vw, 72px);
      display: flex;
      flex-direction: column;
      gap: clamp(24px, 4vw, 40px);
    }

    .page-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 24px;
    }

    .page-header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .page-header-actions button {
      background: rgba(17, 24, 39, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 999px;
      color: var(--text-primary);
      padding: 8px 16px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
    }
    .page-header-actions button:hover {
      border-color: rgba(96, 165, 250, 0.65);
      background: rgba(96, 165, 250, 0.2);
      color: #f8fafc;
    }
    .page-header-actions select {
      background: rgba(17, 24, 39, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 999px;
      color: var(--text-primary);
      padding: 8px 14px;
      font-size: 12px;
      letter-spacing: 0.05em;
      min-width: 140px;
      cursor: pointer;
    }
    .page-header-actions select:focus {
      outline: none;
      border-color: rgba(96, 165, 250, 0.65);
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.25);
    }
    body.modal-open { overflow: hidden; }
    .auth-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .auth-modal[data-visible="true"] { display: flex; }
    .auth-modal .auth-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(11, 17, 33, 0.72);
      backdrop-filter: blur(6px);
    }
    .auth-modal .auth-card {
      position: relative;
      width: min(420px, 92vw);
      background: rgba(15, 23, 42, 0.94);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      box-shadow: 0 28px 68px rgba(6, 10, 24, 0.55);
      padding: 30px;
      color: #f8fafc;
      display: flex;
      flex-direction: column;
      gap: 20px;
      z-index: 1;
    }
    .auth-modal h3 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .auth-modal p {
      margin: 0;
      font-size: 14px;
      color: rgba(203, 213, 225, 0.78);
    }
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .auth-form label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(203, 213, 225, 0.86);
    }
    .auth-form input {
      border-radius: 12px;
      border: 1px solid rgba(96, 112, 152, 0.45);
      background: rgba(12, 19, 34, 0.8);
      color: #f8fafc;
      padding: 10px 12px;
      font-size: 14px;
    }
    .auth-form input:focus {
      outline: none;
      border-color: rgba(96, 165, 250, 0.65);
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.25);
    }
    .auth-error {
      min-height: 18px;
      font-size: 13px;
      color: var(--danger);
    }
    .auth-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .auth-actions .btn {
      background: rgba(96, 165, 250, 0.18);
      border: 1px solid rgba(96, 165, 250, 0.4);
      color: #e0f2ff;
      padding: 10px 16px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    .auth-actions .btn:hover {
      background: rgba(96, 165, 250, 0.28);
      border-color: rgba(96, 165, 250, 0.55);
    }
    .auth-actions .btn.secondary {
      background: rgba(15, 23, 42, 0.72);
      border-color: rgba(148, 163, 184, 0.32);
      color: rgba(226, 232, 240, 0.82);
    }
    .auth-actions .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .dev-credit {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.6);
      text-decoration: none;
    }
    .dev-credit:hover {
      color: rgba(248, 250, 252, 0.85);
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #f8fafc;
    }

    .page-subtitle {
      margin: 4px 0 0;
      color: var(--text-muted);
      font-size: 14px;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--badge-bg);
      color: var(--accent);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: clamp(16px, 2.5vw, 28px);
      align-items: stretch;
    }

    .dashboard-stack {
      display: grid;
      gap: 24px;
      align-content: flex-start;
    }

    .span-3 { grid-column: span 3; }
    .span-4 { grid-column: span 4; }
    .span-5 { grid-column: span 5; }
    .span-7 { grid-column: span 7; }
    .span-8 { grid-column: span 8; }
    .span-9 { grid-column: span 9; }
    .span-all,
    .span-12 { grid-column: 1 / -1; }

    .status-tiles {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      align-items: stretch;
    }

    .status-tiles > .card { height: 100%; }

    .top-knowledge {
      display: grid;
      gap: 18px;
      margin-bottom: clamp(24px, 4vw, 40px);
    }

    .top-knowledge-stack {
      grid-template-columns: minmax(0, 1fr);
    }

    .collapsible-card {
      padding: 0;
      overflow: hidden;
    }

    .collapsible-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 18px 20px;
      cursor: pointer;
      list-style: none;
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(226, 232, 255, 0.78);
      background: transparent;
      border-radius: 16px;
      transition: color 0.2s ease, background 0.2s ease;
    }

    .collapsible-summary::-webkit-details-marker { display: none; }

    .collapsible-title {
      font-weight: 600;
      letter-spacing: 0.14em;
    }

    .collapsible-chevron {
      width: 12px;
      height: 12px;
      border-right: 2px solid rgba(226, 232, 255, 0.7);
      border-bottom: 2px solid rgba(226, 232, 255, 0.7);
      transform: rotate(-45deg);
      transition: transform 0.2s ease, border-color 0.2s ease;
      flex-shrink: 0;
    }

    .collapsible-card[open] .collapsible-summary {
      color: #f8fafc;
      background: rgba(96, 165, 250, 0.12);
      border-radius: 16px 16px 0 0;
    }

    .collapsible-card[open] .collapsible-chevron {
      transform: rotate(45deg);
      border-color: rgba(148, 197, 255, 0.85);
    }

    .collapsible-card .collapsible-summary:hover {
      color: #f8fafc;
    }

    .collapsible-body {
      display: flex;
      flex-direction: column;
      gap: 18px;
      padding: 16px 20px 20px;
      background: rgba(10, 16, 32, 0.55);
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 0 0 16px 16px;
    }

    .collapsible-summary:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.4);
    }

    .collapsible-content {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .project-switch-card .collapsible-content {
      gap: 12px;
    }

    .collapsible-card:not([open]) .collapsible-body {
      display: none;
    }

    .status-card.status-combined {
      display: block;
    }

    .status-combined-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .status-combined-header b {
      font-size: clamp(16px, 2.2vw, 20px);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .status-groups {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: clamp(14px, 2vw, 20px);
    }

    .status-group {
      background: rgba(13, 19, 34, 0.62);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 16px;
      padding: 16px 18px 18px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .status-group:hover {
      border-color: rgba(96, 165, 250, 0.45);
      box-shadow: 0 12px 24px rgba(8, 12, 24, 0.35);
    }

    .status-group summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      cursor: pointer;
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(226, 232, 255, 0.78);
      list-style: none;
    }

    .status-group summary::-webkit-details-marker { display: none; }
    .status-group summary::after {
      content: '';
      width: 10px;
      height: 10px;
      border-right: 2px solid currentColor;
      border-bottom: 2px solid currentColor;
      transform: rotate(-45deg);
      transition: transform 0.2s ease;
    }

    .status-group[open] summary { color: #f8fafc; }
    .status-group[open] summary::after { transform: rotate(45deg); }

    .status-list {
      margin: 14px 0 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .status-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      font-size: 13px;
      color: rgba(226, 232, 255, 0.9);
    }

    .status-label { color: rgba(226, 232, 255, 0.75); }

    .status-value {
      display: inline-flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      min-width: 64px;
      font-weight: 600;
      color: #f8fafc;
    }

    .status-value > span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.36);
      background: rgba(15, 23, 42, 0.6);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.08em;
      min-width: 72px;
    }

    .status-value > span.good {
      border-color: rgba(74, 222, 128, 0.5);
      background: rgba(34, 197, 94, 0.18);
      color: #bbf7d0;
    }

    .status-value > span.bad {
      border-color: rgba(248, 113, 113, 0.5);
      background: rgba(248, 113, 113, 0.18);
      color: #fecaca;
    }

    .status-meta {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      width: 100%;
    }

    .status-meta-line { font-size: 12px; color: var(--text-muted); }

    .status-nested {
      width: 100%;
      padding: 0;
    }

    .status-nested summary {
      list-style: none;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
    }

    .status-nested summary::-webkit-details-marker { display: none; }

    .status-nested[open] summary { color: rgba(226, 232, 255, 0.85); }

    #recent_urls {
      margin: 10px 0 0 0;
      padding-left: 18px;
      max-height: 160px;
      overflow-y: auto;
      color: rgba(226, 232, 255, 0.85);
    }

    #recent_urls li { margin-bottom: 4px; }

    #gpu { white-space: pre-line; }

    .section-title {
      margin: 4px 0;
      font-size: 15px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(226, 232, 255, 0.75);
    }

    .knowledge-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    .kb-priority-panel { margin-top: 14px; border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 12px; padding: 12px; background: rgba(15, 23, 42, 0.35); display: grid; gap: 10px; }
    .kb-priority-header { display: flex; justify-content: space-between; align-items: center; }
    .kb-priority-list { list-style: none; margin: 0; padding: 0; display: grid; gap: 8px; }
    .kb-priority-item { display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 8px 12px; border-radius: 10px; background: rgba(23, 37, 84, 0.25); cursor: grab; }
    .kb-priority-item.dragging { opacity: 0.6; }
    .kb-priority-item span { font-size: 13px; letter-spacing: 0.04em; text-transform: uppercase; }
    .kb-priority-controls { display: inline-flex; gap: 6px; }
    .kb-priority-controls button { width: 26px; height: 26px; border-radius: 50%; border: 1px solid rgba(148, 163, 184, 0.35); background: rgba(17, 24, 39, 0.6); color: rgba(226, 232, 240, 0.9); cursor: pointer; }
    .kb-priority-controls button:disabled { opacity: 0.4; cursor: not-allowed; }
    .kb-priority-handle { font-size: 18px; line-height: 1; opacity: 0.65; }

    .feedback-list { display: flex; flex-direction: column; gap: 12px; max-height: 320px; overflow-y: auto; padding-right: 4px; }
    .feedback-item { border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 12px; padding: 12px; background: rgba(15, 23, 42, 0.45); display: grid; gap: 8px; }
    .feedback-meta { display: flex; gap: 8px; flex-wrap: wrap; font-size: 12px; color: rgba(148, 163, 184, 0.8); }
    .feedback-message { font-size: 13px; color: #e2e8f0; white-space: pre-wrap; }
    .feedback-actions-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .feedback-actions-row select { background: rgba(17, 24, 39, 0.6); border: 1px solid rgba(148, 163, 184, 0.35); border-radius: 999px; color: #e2e8f0; padding: 6px 12px; font-size: 12px; }
    .feedback-status-badge { border-radius: 999px; padding: 2px 8px; font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase; background: rgba(79, 124, 255, 0.16); color: rgba(196, 210, 255, 0.95); }
    .feedback-timestamp { font-size: 11px; color: rgba(148, 163, 184, 0.7); }

    #kbForm {
      display: grid !important;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px !important;
      align-items: end !important;
    }

    #kbForm label,
    #kbForm button {
      margin: 0;
    }

    #kbForm button {
      align-self: end;
      min-height: 48px;
    }

    #kbReloadProjects {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      min-height: 48px;
      padding: 0;
      font-size: 20px;
      border-radius: 14px;
      letter-spacing: 0;
    }

    .prompt-ai-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .prompt-ai-controls select {
      min-width: 200px;
    }

    .prompt-ai-status {
      min-width: 160px;
    }

    .prompt-ai-controls button {
      background: rgba(96, 165, 250, 0.15);
      border: 1px solid rgba(96, 165, 250, 0.45);
      border-radius: 10px;
      color: #e2e8ff;
      padding: 8px 16px;
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
    }

    .prompt-ai-controls button:hover {
      background: rgba(96, 165, 250, 0.25);
      border-color: rgba(96, 165, 250, 0.75);
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 18px;
      backdrop-filter: blur(24px);
      box-shadow: var(--card-shadow);
    }

    .card > b {
      display: block;
      font-size: 15px;
      margin-bottom: 10px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #cbd5ff;
    }

    .crawler-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .icon-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 17, 29, 0.6);
      color: #dbeafe;
      font-size: 13px;
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .icon-button:hover {
      border-color: rgba(96, 165, 250, 0.7);
      background: rgba(96, 165, 250, 0.15);
    }

    .icon-button:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.35);
    }

    .crawler-progress {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .crawler-progress-track {
      position: relative;
      width: 100%;
      height: 8px;
      border-radius: 6px;
      background: rgba(71, 85, 105, 0.45);
      overflow: hidden;
    }

    .crawler-progress-fill {
      position: absolute;
      inset: 0;
      width: 0%;
      background: linear-gradient(90deg, rgba(96, 165, 250, 0.9), rgba(139, 92, 246, 0.9));
      transition: width 0.35s ease;
    }

    .crawler-progress-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: rgba(203, 213, 225, 0.85);
      gap: 12px;
      flex-wrap: wrap;
    }

    .crawler-progress-note {
      font-size: 12px;
      color: rgba(148, 163, 184, 0.85);
      white-space: pre-wrap;
      line-height: 1.5;
      display: none;
    }

    .crawler-logs {
      display: none;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
      background: rgba(17, 24, 39, 0.85);
      border: 1px solid rgba(96, 165, 250, 0.32);
      border-radius: 10px;
      padding: 12px;
    }

    .crawler-logs.visible {
      display: flex;
    }

    .crawler-logs-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: rgba(226, 232, 255, 0.85);
    }

    .crawler-logs-buttons {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .crawler-logs-output {
      max-height: 200px;
      overflow-y: auto;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 6px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
      color: #e2e8f0;
      user-select: text;
    }

    .crawler-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .crawler-actions button {
      background: rgba(96, 165, 250, 0.16);
      border: 1px solid rgba(96, 165, 250, 0.35);
      color: #e2e8f0;
      border-radius: 10px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .crawler-option {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: rgba(148, 163, 184, 0.95);
    }

    .crawler-option input[type="checkbox"] {
      accent-color: rgba(96, 165, 250, 0.85);
    }

    .crawler-actions button:hover {
      border-color: rgba(147, 197, 253, 0.7);
    }

    .crawler-option {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: rgba(148, 163, 184, 0.95);
    }

    .crawler-option input[type="checkbox"] {
      accent-color: rgba(96, 165, 250, 0.85);
    }

    .voice-training-card {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .voice-upload {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .voice-upload input[type="file"] {
      flex: 1 1 240px;
    }

    .voice-samples-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 180px;
      overflow-y: auto;
      padding: 6px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.25);
    }

    .voice-sample-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      padding: 4px 6px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.3);
    }

    .voice-sample-row button {
      border: none;
      background: rgba(248, 113, 113, 0.2);
      color: #fecaca;
      border-radius: 8px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .voice-train-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .voice-jobs {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .voice-job-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(30, 64, 175, 0.18);
    }

    .voice-progress-bar {
      flex: 1 1 auto;
      height: 6px;
      background: rgba(148, 163, 184, 0.3);
      border-radius: 999px;
      overflow: hidden;
      margin-left: 12px;
    }

    .voice-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, rgba(96, 165, 250, 0.95), rgba(129, 140, 248, 0.95));
      width: 0%;
    }

    .muted { color: var(--text-muted); font-size: 12px; }

    .span-12 {
      grid-column: span 12;
    }

    .knowledge-card {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow: hidden;
    }

    .kb-section-nav {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--card-border);
      padding: 4px 0 8px;
      margin-top: -6px;
    }

    .kb-tab-button {
      border: 1px solid var(--input-border);
      background: rgba(13, 19, 34, 0.7);
      color: var(--text-muted);
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .kb-tab-button:hover {
      border-color: rgba(96, 165, 250, 0.55);
      color: var(--text-primary);
    }

    .kb-tab-button.active {
      background: rgba(96, 165, 250, 0.18);
      border-color: rgba(96, 165, 250, 0.6);
      color: var(--accent);
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.25);
    }

    .kb-tab-button:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.45);
    }

    .kb-section {
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    .kb-section.active {
      display: flex;
    }

    .kb-meta-line {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .kb-table-wrapper {
      max-height: 260px;
      overflow: auto;
      border: 1px solid var(--card-border);
      border-radius: 10px;
      background: rgba(11, 16, 34, 0.35);
    }
    .qa-import { display: grid; gap: 12px; }
    .qa-upload { display: grid; gap: 6px; font-size: 12px; letter-spacing: 0.04em; text-transform: uppercase; color: var(--text-muted); }
    .qa-upload input { background: rgba(15, 23, 42, 0.55); border: 1px dashed rgba(148, 163, 184, 0.35); border-radius: 12px; padding: 14px; color: var(--text-primary); }
    .qa-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .qa-actions button { padding: 8px 14px; border-radius: 999px; border: 1px solid rgba(148, 163, 184, 0.35); background: rgba(17, 24, 39, 0.6); color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer; }
    .qa-table textarea { width: 100%; min-height: 80px; resize: vertical; background: rgba(15, 23, 42, 0.55); border: 1px solid rgba(148, 163, 184, 0.35); color: var(--text-primary); border-radius: 10px; font-family: inherit; padding: 8px 10px; }
    .qa-table input[type="number"] { width: 72px; background: rgba(15, 23, 42, 0.55); border: 1px solid rgba(148, 163, 184, 0.35); color: var(--text-primary); border-radius: 8px; padding: 6px; }
    .qa-table .qa-actions-cell { display: flex; gap: 8px; }
    .unanswered-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
    .unanswered-table td { vertical-align: top; }
    .unanswered-table td:first-child { max-width: 520px; }

    .kb-category {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 8px 0 4px;
    }

    .kb-category + .kb-category {
      border-top: 1px solid rgba(148, 163, 184, 0.15);
      padding-top: 18px;
      margin-top: 8px;
    }

    .kb-category-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(226, 232, 255, 0.7);
    }

    .kb-category-header strong {
      color: var(--text-primary);
      font-size: 14px;
      letter-spacing: 0.1em;
    }

    .kb-auto-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 7px;
      height: 18px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      background: rgba(96, 165, 250, 0.18);
      color: #bfdbfe;
      margin-right: 6px;
    }

    .kb-auto-badge.pending {
      animation: pulse-soft 1.6s ease-in-out infinite;
    }

    .kb-auto-badge.failed {
      background: rgba(248, 113, 113, 0.18);
      color: #fecaca;
      animation: none;
    }

    .kb-type-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
      height: 18px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      background: rgba(96, 165, 250, 0.12);
      color: #dbeafe;
      margin-right: 6px;
    }

    @keyframes pulse-soft {
      0% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.25); }
      70% { box-shadow: 0 0 0 6px rgba(96, 165, 250, 0); }
      100% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0); }
    }

    .thinking-overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(11, 16, 38, 0.78);
      backdrop-filter: blur(6px);
      z-index: 20;
    }

    .thinking-overlay.active {
      display: flex;
    }

    .thinking-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      text-align: center;
      max-width: 320px;
    }

    .thinking-illustration {
      width: 180px;
      max-width: 65%;
      filter: drop-shadow(0 18px 28px rgba(59, 130, 246, 0.35));
      animation: thinking-float 3.6s ease-in-out infinite;
    }

    .thinking-spinner {
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: conic-gradient(from 0deg, rgba(96, 165, 250, 0.85), rgba(59, 130, 246, 0.2) 55%, rgba(192, 132, 252, 0.8));
      position: relative;
      animation: thinking-spin 1.6s linear infinite;
    }

    .thinking-spinner::after {
      content: '';
      position: absolute;
      inset: 14px;
      border-radius: 50%;
      background: rgba(11, 16, 38, 0.85);
      box-shadow: inset 0 0 18px rgba(96, 165, 250, 0.35);
    }

    .thinking-caption {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .thinking-subtitle {
      font-size: 13px;
      color: rgba(191, 219, 254, 0.75);
      line-height: 1.6;
    }

    .thinking-preview {
      display: none;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(17, 24, 39, 0.86);
      border: 1px solid rgba(96, 165, 250, 0.45);
      color: rgba(226, 232, 255, 0.92);
      font-size: 13px;
      line-height: 1.6;
      box-shadow: 0 14px 28px rgba(37, 99, 235, 0.2);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .thinking-preview.visible {
      display: block;
    }

    .auto-description {
      display: none;
      padding: 12px 14px;
      border-radius: 12px;
      margin-top: -4px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(139, 92, 246, 0.12));
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: rgba(226, 232, 255, 0.85);
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .auto-description.visible {
      display: block;
    }

    @keyframes thinking-float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    @keyframes thinking-spin {
      to { transform: rotate(360deg); }
    }

    .stats-card { display: flex; flex-direction: column; gap: 16px; }
    .stats-graph {
      position: relative;
      width: 100%;
      height: 220px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.4);
      overflow: hidden;
    }
    .stats-graph canvas { width: 100%; height: 100%; display: block; }
    .stats-empty {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: var(--text-muted);
      font-size: 12px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      opacity: 0.75;
    }
    .stats-tooltip {
      position: absolute;
      padding: 6px 10px;
      background: rgba(13, 19, 34, 0.95);
      color: #e2e8ff;
      border-radius: 8px;
      border: 1px solid rgba(96, 165, 250, 0.45);
      font-size: 11px;
      pointer-events: none;
      transform: translate(-50%, -140%);
      transition: opacity 0.15s ease;
      opacity: 0;
      white-space: nowrap;
      box-shadow: 0 14px 30px rgba(8, 12, 24, 0.42);
      z-index: 2;
    }
    .stats-tooltip.show { opacity: 1; }
    .stats-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translate(-50%, 0);
      border-width: 6px 6px 0 6px;
      border-style: solid;
      border-color: rgba(13, 19, 34, 0.95) transparent transparent transparent;
    }
    .stats-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .knowledge-service-card { display: flex; flex-direction: column; gap: 10px; }
    .knowledge-service-card b { text-transform: uppercase; letter-spacing: 0.08em; font-size: 13px; }
    .project-danger { margin-top: 16px; padding: 14px; border-radius: 14px; border: 1px solid rgba(239, 68, 68, 0.35); background: rgba(239, 68, 68, 0.12); display: none; flex-direction: column; gap: 10px; }
    .project-danger.show { display: flex; }
    .project-danger strong { text-transform: uppercase; letter-spacing: 0.08em; font-size: 12px; color: #fecaca; }
    .project-danger p { margin: 0; font-size: 12px; color: rgba(254, 202, 202, 0.9); }
    .project-delete-btn { align-self: flex-start; padding: 8px 14px; border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.6); background: rgba(239, 68, 68, 0.25); color: #fee2e2; font-weight: 600; cursor: pointer; }
    .project-delete-btn:hover:not([disabled]) { background: rgba(239, 68, 68, 0.35); }
    .project-delete-btn[disabled] { opacity: 0.6; cursor: not-allowed; }
    .ollama-catalog { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(99, 102, 241, 0.25); display: none; flex-direction: column; gap: 8px; }
    .ollama-catalog.show { display: flex; }
    .ollama-catalog-header { display: flex; justify-content: space-between; gap: 8px; align-items: center; }
    .ollama-list { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 4px; }
    .ollama-list li { display: flex; justify-content: space-between; align-items: center; gap: 8px; font-size: 13px; }
    .ollama-meta { color: var(--text-muted); font-size: 12px; }
    .ollama-install-btn { padding: 4px 8px; border-radius: 6px; background: rgba(96, 165, 250, 0.18); border: 1px solid rgba(96, 165, 250, 0.45); color: var(--text-primary); cursor: pointer; }
    .ollama-install-btn[disabled] { opacity: 0.6; cursor: not-allowed; }
    .ollama-jobs { display: flex; flex-direction: column; gap: 4px; font-size: 12px; }
    .ollama-job.running { color: #fbbf24; }
    .ollama-job.success { color: #10b981; }
    .ollama-job.error { color: #f87171; }
    .ollama-servers { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
    .ollama-servers-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .ollama-server-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 6px; align-items: center; }
    .ollama-server-form-grid input[type=text] { padding: 6px 8px; border-radius: 6px; border: 1px solid rgba(99, 102, 241, 0.35); background: rgba(12, 16, 32, 0.6); color: var(--text-primary); font-size: 13px; }
    .ollama-server-form-grid button { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(99, 102, 241, 0.45); background: rgba(99, 102, 241, 0.2); color: var(--text-primary); cursor: pointer; }
    .ollama-server-enabled { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-muted); }
    .ollama-server-row { display: flex; flex-direction: column; gap: 4px; padding: 6px 8px; background: rgba(15, 23, 42, 0.45); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.25); width: 100%; }
    .ollama-server-row h4 { margin: 0; font-size: 13px; letter-spacing: 0.04em; text-transform: uppercase; }
    .ollama-server-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px; color: var(--text-muted); }
    .ollama-server-actions { display: flex; gap: 6px; margin-top: 4px; }
    .ollama-server-actions button { padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(148, 163, 184, 0.4); background: rgba(30, 41, 59, 0.6); color: var(--text-primary); cursor: pointer; font-size: 12px; }
    .ollama-server-actions button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .ollama-server-toggle { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-muted); }
    .ollama-server-toggle input { accent-color: rgba(96, 165, 250, 0.7); }
    .ollama-server-offline { border-color: rgba(239, 68, 68, 0.45); }
    .reorder-mode .dashboard-grid section[data-block-id] {
      cursor: grab;
      outline: 1px dashed rgba(96, 165, 250, 0.45);
      border-radius: 20px;
      transition: outline 0.2s ease, background 0.2s ease;
      position: relative;
    }
    .reorder-mode .dashboard-grid section[data-block-id]::after {
      content: 'â‡…';
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 18px;
      color: rgba(96, 165, 250, 0.6);
      pointer-events: none;
    }
    .reorder-mode .dashboard-grid section[data-block-id].dragging {
      opacity: 0.6;
      cursor: grabbing;
    }
    .dashboard-grid section[data-block-id].reorder-drop-target {
      outline: 2px solid var(--accent);
    }
    .drop-zone {
      border: 2px dashed rgba(96, 165, 250, 0.5);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      font-size: 14px;
      color: var(--text-muted);
      transition: border-color 0.2s ease, background 0.2s ease;
      cursor: pointer;
    }
    .drop-zone.drag-over {
      border-color: var(--accent);
      background: rgba(79, 70, 229, 0.1);
      color: var(--text-primary);
    }
    .project-storage-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 6px 12px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.35);
      font-size: 12px;
      color: rgba(226, 232, 255, 0.85);
    }

    .ok { color: var(--success); font-weight: 600; }
    .bad { color: var(--danger); font-weight: 600; }

    label { display: inline-block; margin: 6px 8px 6px 0; color: var(--text-muted); font-size: 13px; }

    input:not([type="checkbox"]):not([type="radio"]),
    select,
    textarea {
      width: 100%;
      font: inherit;
      padding: 9px 12px;
      border-radius: 10px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:not([type="checkbox"]):not([type="radio"]):focus,
    select:focus,
    textarea:focus {
      border-color: rgba(96, 165, 250, 0.7);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.25);
    }

    select { appearance: none; background-image: linear-gradient(135deg, rgba(96, 165, 250, 0.2), rgba(96, 165, 250, 0)); }

    input[type="checkbox"],
    input[type="radio"] {
      width: auto;
      accent-color: #60a5fa;
      transform: scale(1.05);
      margin-right: 6px;
    }

    button {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.95), rgba(14, 165, 233, 0.85));
      color: #0b1220;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    button:hover { transform: translateY(-1px); box-shadow: 0 12px 24px rgba(56, 189, 248, 0.35); }
    button:disabled { opacity: 0.45; cursor: not-allowed; box-shadow: none; }

    code {
      background: rgba(15, 23, 42, 0.75);
      color: #bfdbfe;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 13px;
    }

    table { width: 100%; border-collapse: collapse; font-size: 13px; color: var(--text-primary); }
    th, td { padding: 8px 10px; border-bottom: 1px solid rgba(99, 102, 241, 0.15); text-align: left; }
    tbody tr:hover { background: rgba(148, 163, 184, 0.08); }
    .nowrap { white-space: nowrap; }

    .project-switch-card select { min-height: 220px; color: var(--text-primary); }
    .project-switch-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    .project-switch-card .muted { margin-top: 10px; display: block; }

    .overview-banner { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .overview-card { position: relative; overflow: hidden; padding: 18px 20px; border-radius: 18px; background: linear-gradient(180deg, rgba(30, 41, 59, 0.65), rgba(15, 23, 42, 0.65)); border: 1px solid rgba(99, 102, 241, 0.25); backdrop-filter: blur(28px); box-shadow: var(--card-shadow); }
    .overview-card h2 { margin: 0 0 8px; font-size: 13px; letter-spacing: 0.18em; text-transform: uppercase; color: rgba(226, 232, 255, 0.8); }
    .overview-card strong { font-size: 22px; display: block; color: #f7faff; font-weight: 600; letter-spacing: 0.02em; }
    .overview-meta { font-size: 12px; color: rgba(196, 210, 255, 0.8); margin-top: 8px; white-space: pre-line; line-height: 1.4; }
    .overview-pulse { position: absolute; inset: -25%; pointer-events: none; opacity: 0; transition: opacity 0.4s ease; background: radial-gradient(circle at 30% 20%, rgba(96, 165, 250, 0.4), transparent 60%); }
    .overview-card.updated .overview-pulse { opacity: 1; animation: pulseFade 1.6s ease-out forwards; }

    @keyframes pulseFade { 0% { opacity: 0.7; } 40% { opacity: 0.35; } 100% { opacity: 0; } }

    .prompt-preview { font-size: 13px; color: #e2e8ff; line-height: 1.4; max-height: 140px; overflow: auto; white-space: pre-line; }
    .prompt-docs { margin-top: 10px; font-size: 12px; color: rgba(203, 213, 255, 0.72); display: grid; gap: 6px; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { background: rgba(56, 189, 248, 0.16); color: #bae6fd; padding: 4px 8px; border-radius: 999px; font-size: 11px; letter-spacing: 0.04em; }

    .logs-card pre,
    .prompts-card pre {
      background: rgba(8, 12, 26, 0.9);
      color: #cbd5ff;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(99, 102, 241, 0.2);
      max-height: 340px;
      overflow: auto;
      font-size: 13px;
    }

    .prompts-card pre { max-height: 260px; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(10, 16, 32, 0.72);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2100;
      backdrop-filter: blur(10px);
    }

    .modal-backdrop.show { display: flex; }

    .modal {
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.85));
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      width: min(720px, 92vw);
      max-height: 92vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 30px 60px rgba(8, 12, 24, 0.45);
      backdrop-filter: blur(28px);
      color: var(--text-primary);
      overflow: hidden;
    }

    .modal form {
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;
    }

    .modal-header,
    .modal-footer {
      padding: 18px 22px;
      border-bottom: 1px solid rgba(99, 102, 241, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .modal-footer {
      border-top: 1px solid rgba(99, 102, 241, 0.2);
      border-bottom: none;
    }

    .modal-body {
      padding: 18px 22px;
      overflow-y: auto;
      display: grid;
      gap: 12px;
      flex: 1 1 auto;
      min-height: 0;
    }

    .modal-body textarea { min-height: 180px; resize: vertical; }

    .modal-close {
      background: transparent;
      border: none;
      color: rgba(226, 232, 255, 0.65);
      font-size: 22px;
      cursor: pointer;
      padding: 0;
      transition: color 0.2s ease;
    }

    .modal-close:hover { color: #fff; }

    fieldset {
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 16px;
      padding: 18px;
      margin: 0 0 18px;
      background: rgba(15, 23, 42, 0.45);
    }

    legend { padding: 0 10px; color: #cbd5ff; text-transform: uppercase; letter-spacing: 0.12em; font-size: 12px; }

    pre { font-family: "JetBrains Mono", "SFMono-Regular", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 999px; }
    ::-webkit-scrollbar-track { background: var(--scroll-track); }

    @media (max-width: 1480px) {
      .dashboard-grid { grid-template-columns: repeat(8, minmax(0, 1fr)); }
      .span-9 { grid-column: span 4; }
      .span-8 { grid-column: span 4; }
      .span-7 { grid-column: span 8; }
      .span-5 { grid-column: span 8; }
      .span-4 { grid-column: span 4; }
      .span-3 { grid-column: span 4; }
      .span-12 { grid-column: span 8; }
      .status-groups { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    }

    @media (max-width: 1080px) {
      .dashboard-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .span-9,
      .span-8,
      .span-7,
      .span-5,
      .span-4,
      .span-3 { grid-column: span 4; }
      .span-12 { grid-column: span 4; }
      .status-card.status-combined { padding: 20px; }
      .status-group { padding: 14px 16px; }
      .status-list li { font-size: 12px; }
    }

    @media (max-width: 960px) {
      .page-header { flex-direction: column; align-items: flex-start; gap: 18px; }
      .status-combined-header { flex-direction: column; align-items: flex-start; gap: 6px; }
      .status-value { min-width: auto; }
      .collapsible-summary { padding: 16px 18px; font-size: 12px; }
      .collapsible-body { padding: 12px 18px 18px; }
      .collapsible-chevron { width: 10px; height: 10px; }
    }

    @media (max-width: 720px) {
      body { font-size: 15px; line-height: 1.6; }
      .page-shell { padding: 26px 18px 46px; gap: 24px; }
      .overview-banner { grid-template-columns: 1fr; }
      .dashboard-grid { grid-template-columns: minmax(0, 1fr); }
      .dashboard-stack { gap: 18px; }
      .span-9,
      .span-8,
      .span-7,
      .span-5,
      .span-4,
      .span-3,
      .span-12 { grid-column: span 1; }
      .page-header-actions { width: 100%; gap: 12px; }
      .page-header-actions button { flex: 1 1 auto; min-height: 48px; }
      .card { padding: 18px; }
      .card > b { font-size: 14px; }
      .section-title { font-size: 14px; }
      .status-group { padding: 14px; }
      .status-list { gap: 8px; }
      .status-list li { flex-wrap: wrap; }
      .status-value { justify-content: flex-start; }
      .collapsible-summary { padding: 16px 16px; flex-wrap: wrap; row-gap: 8px; font-size: 13px; }
      .collapsible-body { padding: 12px 16px 18px; gap: 16px; }
      .top-knowledge { gap: 14px; }
      .kb-section-nav { flex-direction: column; align-items: stretch; gap: 10px; }
      .kb-tab-button { width: 100%; justify-content: center; }
      .knowledge-actions { flex-direction: column; align-items: stretch; }
      .knowledge-actions button { width: 100%; min-height: 46px; }
      .kb-section { padding: 0; }
      .kb-table-wrapper { margin: 0 -4px; padding-bottom: 6px; }
      table { font-size: 12px; }
      th, td { padding: 9px 8px; }
      #kbAddForm { display: grid !important; grid-template-columns: minmax(0, 1fr); gap: 12px; }
      #kbAddForm button { width: 100%; min-height: 46px; }
      #crawler-form { flex-direction: column !important; align-items: stretch !important; }
      #crawler-form label,
      #crawler-form button { width: 100%; }
      .crawler-actions { flex-direction: column; align-items: stretch; }
      .crawler-actions button { width: 100%; min-height: 46px; }
      #projectForm { display: grid !important; grid-template-columns: minmax(0, 1fr); gap: 12px; }
      #projectForm button { width: 100%; min-height: 46px; }
      .prompt-ai-controls { width: 100%; flex-direction: column; align-items: stretch; }
      .prompt-ai-controls select,
      .prompt-ai-controls button,
      .prompt-ai-controls .prompt-ai-status { width: 100%; }
      .project-extensions { gap: 18px; }
      .project-extensions > div { min-width: 100% !important; }
      .project-storage-panel { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .stats-actions { flex-direction: column; align-items: stretch; gap: 12px; }
      .stats-actions button { width: 100%; }
      .page-header h1 { font-size: 26px; }
      .page-subtitle { font-size: 15px; }
    }

    @media (max-width: 540px) {
      body { font-size: 16px; }
      h1 { font-size: 24px; }
      .page-subtitle { font-size: 15px; }
      .page-shell { padding: 24px 16px 44px; gap: 24px; }
      .card { padding: 16px; }
      button {
        padding: 12px 18px;
        font-size: 14px;
        border-radius: 12px;
      }
      input:not([type="checkbox"]):not([type="radio"]),
      select,
      textarea {
        padding: 12px 14px;
        font-size: 15px;
        border-radius: 12px;
      }
      .collapsible-summary {
        font-size: 14px;
        padding: 16px 16px;
      }
      .collapsible-body {
        padding: 12px 16px 18px;
        gap: 16px;
      }
      .overview-card { padding: 16px; }
      .overview-card strong { font-size: 20px; }
      .stats-graph { height: 220px; }
      #kbForm {
        grid-template-columns: minmax(0, 1fr) !important;
        gap: 14px !important;
      }
      #kbForm button {
        width: 100%;
        min-height: 52px;
      }
      #kbReloadProjects {
        width: 100%;
        border-radius: 12px;
        font-size: 18px;
      }
      .project-extensions > div {
        min-width: 100% !important;
      }
    }

    @media (max-width: 420px) {
      body { font-size: 15.5px; }
      .page-shell { padding: 22px 14px 40px; }
      .collapsible-summary { font-size: 12px; }
      .collapsible-body { gap: 14px; }
      .overview-card { padding: 14px; }
      .overview-card strong { font-size: 18px; }
      .status-group summary { font-size: 12px; }
      .stats-graph { height: 200px; }
      #kbForm button,
      #kbAddForm button,
      .crawler-actions button,
      #projectForm button,
      .stats-actions button { min-height: 52px; font-size: 14px; }
      .kb-tab-button { font-size: 13px; }
      th, td { padding: 8px 6px; }
    }
    .backup-card {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .backup-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .backup-section b {
      font-size: 13px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: rgba(15, 23, 42, 0.72);
    }

    .backup-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: rgba(15, 23, 42, 0.72);
    }

    .backup-field-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .backup-field-grid label,
    .backup-token-row label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      color: rgba(15, 23, 42, 0.72);
    }

    .backup-token-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto auto;
      gap: 10px;
      align-items: end;
    }

    .backup-token-row button {
      min-width: 120px;
    }

    .backup-status-line {
      font-size: 12px;
      color: rgba(15, 23, 42, 0.58);
    }

    .backup-action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .backup-jobs-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 220px;
      overflow-y: auto;
    }

    .backup-job {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(248, 250, 255, 0.78);
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.04);
      display: grid;
      gap: 4px;
    }

    .backup-job.primary {
      border-color: rgba(79, 124, 255, 0.28);
      background: rgba(79, 124, 255, 0.12);
      box-shadow: 0 10px 18px rgba(79, 124, 255, 0.18);
    }

    .backup-job strong {
      font-size: 13px;
      color: rgba(15, 23, 42, 0.78);
    }

    .backup-job small {
      font-size: 11px;
      color: rgba(15, 23, 42, 0.6);
    }

    .backup-job-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .backup-job-actions button {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 10px;
    }

    .backup-empty {
      font-size: 12px;
      color: rgba(15, 23, 42, 0.55);
    }

    @media (max-width: 1280px) {
      .backup-field-grid { grid-template-columns: minmax(0, 1fr); }
      .backup-token-row { grid-template-columns: minmax(0, 1fr); }
      .backup-token-row button { width: 100%; }
    }

    @media (max-width: 960px) {
      .backup-action-buttons { flex-direction: column; }
      .backup-action-buttons button { width: 100%; }
    }

    @media (max-width: 720px) {
      .backup-field-grid { grid-template-columns: minmax(0, 1fr); }
    }
  </style>
  </head>
  <body>
  <div id="clusterWarning" class="cluster-warning" style="display:none;">Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ LLM Ð¿Ñ€Ð¸Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°. ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð² Ollama.</div>
  <div class="page-shell">
    <div class="page-header">
      <div>
        <span class="pill" data-i18n="pillOperations">Operations</span>
        <h1 data-i18n="headerTitle">Crawler Control Panel</h1>
        <p class="page-subtitle" data-i18n="headerSubtitle">Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÑ€Ð°ÑƒÐ»Ð¸Ð½Ð³Ð¾Ð¼, Ð±Ð°Ð·Ð¾Ð¹ Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸ÐµÐ¼ Ð² ÐµÐ´Ð¸Ð½Ð¾Ð¼ Ð¾ÐºÐ½Ðµ</p>
      </div>
      <div class="page-header-actions">
        <select id="adminLanguage" aria-label="Language" data-i18n-aria-label="languageLabel"></select>
        <button type="button" id="toggleLayoutOrdering" data-i18n="buttonReorder">Ð£Ð¿Ð¾Ñ€ÑÐ´Ð¾Ñ‡Ð¸Ñ‚ÑŒ Ð±Ð»Ð¾ÐºÐ¸</button>
        <button type="button" id="adminLogout" data-i18n="buttonLogout">Ð’Ñ‹Ð¹Ñ‚Ð¸</button>
        <a class="dev-credit" href="https://dev-bot.su" target="_blank" rel="noopener" data-i18n="developerCredit">Created by Ð´ÐµÐ²-Ð±Ð¾Ñ‚-ÑÑƒ</a>
      </div>
    </div>

    <div class="top-knowledge">
      <h2 class="section-title">Ð‘Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹</h2>

      <section id="block-knowledge" class="dashboard-stack top-knowledge-stack" data-block-id="knowledge" data-block-group="knowledge">
        <div class="card knowledge-card">
          <b>Knowledge Base</b>
          <div class="kb-section-nav" role="tablist" aria-label="Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð±Ð°Ð·Ð¾Ð¹ Ð·Ð½Ð°Ð½Ð¸Ð¹">
            <button type="button" class="kb-tab-button active" id="kbTabOverview" data-kb-target="overview" role="tab" aria-selected="true" aria-controls="kbSectionOverview">ÐžÐ±Ð·Ð¾Ñ€</button>
            <button type="button" class="kb-tab-button" id="kbTabUpload" data-kb-target="upload" role="tab" aria-selected="false" aria-controls="kbSectionUpload" tabindex="-1">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°</button>
            <button type="button" class="kb-tab-button" id="kbTabDocuments" data-kb-target="documents" role="tab" aria-selected="false" aria-controls="kbSectionDocuments" tabindex="-1">Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹</button>
            <button type="button" class="kb-tab-button" id="kbTabQA" data-kb-target="qa" role="tab" aria-selected="false" aria-controls="kbSectionQA" tabindex="-1">Ð’Ð¾Ð¿Ñ€Ð¾Ñâ€“Ð¾Ñ‚Ð²ÐµÑ‚</button>
            <button type="button" class="kb-tab-button" id="kbTabUnanswered" data-kb-target="unanswered" role="tab" aria-selected="false" aria-controls="kbSectionUnanswered" tabindex="-1">Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð±ÐµÐ· Ð¾Ñ‚Ð²ÐµÑ‚Ð°</button>
          </div>
          <div class="kb-priority-panel">
            <div class="kb-priority-header">
              <strong data-i18n="kbPriorityTitle">ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð²</strong>
              <button type="button" id="kbPrioritySave" data-i18n="saveButton">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
            </div>
            <ul class="kb-priority-list" id="kbPriorityList"></ul>
            <span class="muted" id="kbPriorityStatus"></span>
          </div>
          <div id="kbThinkingOverlay" class="thinking-overlay">
            <div class="thinking-inner">
              <img
                src="data:image/svg+xml;utf8,%3Csvg%20width%3D%22180%22%20height%3D%22140%22%20viewBox%3D%220%200%20180%20140%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3ClinearGradient%20id%3D%22grad%22%20x1%3D%220%22%20x2%3D%221%22%20y1%3D%220%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%2360a5fa%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%2250%25%22%20stop-color%3D%22%237c3aed%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23f97316%22/%3E%0A%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3Cfilter%20id%3D%22blur%22%20x%3D%22-20%25%22%20y%3D%22-20%25%22%20width%3D%22140%25%22%20height%3D%22140%25%22%3E%0A%20%20%20%20%20%20%3CfeGaussianBlur%20stdDeviation%3D%2218%22/%3E%0A%20%20%20%20%3C/filter%3E%0A%20%20%3C/defs%3E%0A%20%20%3Ccircle%20cx%3D%2250%22%20cy%3D%2270%22%20r%3D%2240%22%20fill%3D%22url(%23grad)%22%20opacity%3D%220.65%22%20filter%3D%22url(%23blur)%22/%3E%0A%20%20%3Ccircle%20cx%3D%22110%22%20cy%3D%2250%22%20r%3D%2230%22%20fill%3D%22url(%23grad)%22%20opacity%3D%220.45%22%20filter%3D%22url(%23blur)%22/%3E%0A%20%20%3Ccircle%20cx%3D%22120%22%20cy%3D%2295%22%20r%3D%2236%22%20fill%3D%22url(%23grad)%22%20opacity%3D%220.55%22%20filter%3D%22url(%23blur)%22/%3E%0A%20%20%3Cpath%20d%3D%22M52%2036c26%200%2048%2020%2048%2045s-22%2045-48%2045-48-20-48-45%2022-45%2048-45zm0%2016c-18%200-32%2013-32%2029s14%2029%2032%2029%2032-13%2032-29-14-29-32-29z%22%20fill%3D%22%23111827%22%20opacity%3D%220.72%22/%3E%0A%20%20%3Cpath%20d%3D%22M116%2028c16%200%2028%2012%2028%2028s-12%2028-28%2028-28-12-28-28%2012-28%2028-28z%22%20fill%3D%22%231e293b%22%20opacity%3D%220.7%22/%3E%0A%20%20%3Ccircle%20cx%3D%22104%22%20cy%3D%2256%22%20r%3D%226%22%20fill%3D%22%2393c5fd%22/%3E%0A%20%20%3Ccircle%20cx%3D%22128%22%20cy%3D%2256%22%20r%3D%226%22%20fill%3D%22%2393c5fd%22/%3E%0A%20%20%3Cpath%20d%3D%22M112%2072c5%206%2013%206%2018%200%22%20stroke%3D%22%23a855f7%22%20stroke-width%3D%223%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E"
                alt="Ð˜Ð´Ñ‘Ñ‚ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ"
                class="thinking-illustration"
              >
              <div class="thinking-spinner"></div>
              <div class="thinking-caption" id="kbThinkingCaption">Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµâ€¦</div>
              <div class="thinking-subtitle" id="kbThinkingMessage">Ð­Ñ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÐµÐºÑƒÐ½Ð´.</div>
              <div class="thinking-preview" id="kbThinkingPreview"></div>
            </div>
          </div>
          <div class="kb-section active" data-kb-section="overview" id="kbSectionOverview" role="tabpanel" aria-labelledby="kbTabOverview">
            <form id="kbForm" style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;">
              <label style="flex:1 1 200px;">ÐŸÑ€Ð¾ÐµÐºÑ‚
                <input type="text" list="kbProjectList" id="kbProject" placeholder="mmvs" style="width:100%;" readonly>
                <datalist id="kbProjectList"></datalist>
              </label>
              <button type="button" id="kbReloadProjects" title="ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð²">â†»</button>
              <label style="flex:1 1 240px;">ÐŸÐ¾Ð¸ÑÐº
                <input type="text" id="kbSearch" placeholder="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ" style="width:100%;">
              </label>
              <label>Limit
                <input type="number" id="kbLimit" min="10" max="1000" value="1000" style="width:100px;">
              </label>
              <button type="submit">ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ</button>
              <button type="button" id="kbClear">ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ</button>
            </form>
            <div class="kb-meta-line">
              <span class="muted" id="kbInfo"></span>
              <span class="muted" id="kbProjectsSummary"></span>
            </div>
          </div>
          <div class="kb-section" data-kb-section="upload" id="kbSectionUpload" role="tabpanel" aria-labelledby="kbTabUpload" aria-hidden="true">
            <form id="kbAddForm" style="display:flex; flex-wrap:wrap; gap:10px;">
              <label style="flex:1 1 220px;">Ð˜Ð¼Ñ
                <input type="text" id="kbNewName" placeholder="document.txt" style="width:100%;">
              </label>
              <label style="flex:1 1 220px;">URL
                <input type="url" id="kbNewUrl" placeholder="https://example.com" style="width:100%;">
              </label>
              <label style="flex:1 1 220px;">ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ
                <input type="text" id="kbNewDescription" placeholder="ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ" style="width:100%;">
              </label>
              <label style="flex:1 1 220px;">Ð¤Ð°Ð¹Ð»
                <input type="file" id="kbNewFile" multiple style="width:100%;">
              </label>
              <div id="kbDropZone" class="drop-zone" style="flex:1 1 100%;">
                ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° Ð¿Ð¾Ð»Ðµ Ð²Ñ‹ÑˆÐµ
              </div>
              <div id="kbAutoDescription" class="auto-description"></div>
              <label style="flex:1 1 100%;">Ð¢ÐµÐºÑÑ‚
                <textarea id="kbNewContent" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°" style="width:100%; min-height:120px;"></textarea>
              </label>
              <div style="display:flex; gap:10px; align-items:center;">
                <button type="submit">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
                <button type="button" id="kbResetForm">Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ</button>
                <span class="muted" id="kbAddStatus"></span>
              </div>
            </form>
          </div>
          <div class="kb-section" data-kb-section="documents" id="kbSectionDocuments" role="tabpanel" aria-labelledby="kbTabDocuments" aria-hidden="true">
            <div class="knowledge-actions">
              <button type="button" id="kbDeduplicate">ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹</button>
              <button type="button" id="kbClearKnowledge">ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð°Ð·Ñƒ</button>
              <span class="muted" id="kbDedupStatus"></span>
              <span class="muted" id="kbClearStatus"></span>
            </div>
            <div class="kb-category" data-kb-category="text">
              <div class="kb-category-header">
                <strong>Ð¢ÐµÐºÑÑ‚</strong>
                <span class="muted" id="kbCountText">â€”</span>
              </div>
              <div class="kb-table-wrapper">
                <table>
                  <thead>
                  <tr><th class="nowrap">Ð˜Ð¼Ñ</th><th>ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ</th><th class="nowrap">ÐŸÑ€Ð¾ÐµÐºÑ‚</th><th class="nowrap">Ð¤Ð°Ð¹Ð»</th><th class="nowrap">Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</th></tr>
                  </thead>
                  <tbody id="kbTableText"></tbody>
                </table>
              </div>
            </div>
            <div class="kb-category" data-kb-category="docs">
              <div class="kb-category-header">
                <strong>Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹</strong>
                <span class="muted" id="kbCountDocs">â€”</span>
              </div>
              <div class="kb-table-wrapper">
                <table>
                  <thead>
                  <tr><th class="nowrap">Ð˜Ð¼Ñ</th><th>ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ</th><th class="nowrap">ÐŸÑ€Ð¾ÐµÐºÑ‚</th><th class="nowrap">Ð¤Ð°Ð¹Ð»</th><th class="nowrap">Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</th></tr>
                  </thead>
                  <tbody id="kbTableDocs"></tbody>
                </table>
              </div>
            </div>
            <div class="kb-category" data-kb-category="images">
              <div class="kb-category-header">
                <strong>Ð¤Ð¾Ñ‚Ð¾</strong>
                <span class="muted" id="kbCountImages">â€”</span>
              </div>
              <div class="kb-table-wrapper">
                <table>
                  <thead>
                  <tr><th class="nowrap">Ð˜Ð¼Ñ</th><th>ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ</th><th class="nowrap">ÐŸÑ€Ð¾ÐµÐºÑ‚</th><th class="nowrap">Ð¤Ð°Ð¹Ð»</th><th class="nowrap">Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</th></tr>
                  </thead>
                  <tbody id="kbTableImages"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="kb-section" data-kb-section="qa" id="kbSectionQA" role="tabpanel" aria-labelledby="kbTabQA" aria-hidden="true">
            <div class="qa-import">
              <form id="kbQaImportForm">
                <label class="qa-upload">
                  <span>Excel Ñ„Ð°Ð¹Ð» Ñ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ°Ð¼Ð¸ Â«Ð’Ð¾Ð¿Ñ€Ð¾ÑÂ» Ð¸ Â«ÐžÑ‚Ð²ÐµÑ‚Â»</span>
                  <input type="file" id="kbQaFile" accept=".xlsx,.xlsm,.xltx,.xltm,.csv" required>
                </label>
                <div class="qa-actions">
                  <button type="submit">Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ</button>
                  <button type="button" id="kbQaAddRow">Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ</button>
                  <span class="muted" id="kbQaStatus"></span>
                </div>
              </form>
            </div>
            <div class="kb-meta-line">
              <span>Ð’ÑÐµÐ³Ð¾ Ð¿Ð°Ñ€:</span>
              <span class="muted" id="kbCountQa">â€”</span>
            </div>
            <div class="kb-table-wrapper">
              <table class="qa-table">
                <thead>
                  <tr>
                    <th>Ð’Ð¾Ð¿Ñ€Ð¾Ñ</th>
                    <th>ÐžÑ‚Ð²ÐµÑ‚</th>
                    <th class="nowrap">ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚</th>
                    <th class="nowrap">Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</th>
                  </tr>
                </thead>
                <tbody id="kbTableQa"></tbody>
              </table>
            </div>
          </div>
          <div class="kb-section" data-kb-section="unanswered" id="kbSectionUnanswered" role="tabpanel" aria-labelledby="kbTabUnanswered" aria-hidden="true">
            <div class="kb-meta-line">
              <span>Ð’ÑÐµÐ³Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð±ÐµÐ· Ð¾Ñ‚Ð²ÐµÑ‚Ð°:</span>
              <span class="muted" id="kbCountUnanswered">â€”</span>
            </div>
            <div class="unanswered-actions">
              <button type="button" id="kbUnansweredExport">Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ CSV</button>
              <button type="button" id="kbUnansweredClear">ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº</button>
              <span class="muted" id="kbUnansweredStatus"></span>
            </div>
            <div class="kb-table-wrapper">
              <table class="unanswered-table">
                <thead>
                  <tr>
                    <th>Ð’Ð¾Ð¿Ñ€Ð¾Ñ</th>
                    <th class="nowrap">ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾</th>
                    <th class="nowrap">ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ€Ð°Ð·</th>
                  </tr>
                </thead>
                <tbody id="kbTableUnanswered"></tbody>
              </table>
            </div>
            <p class="muted" style="margin-top:12px;">Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹ ÑÑ‚Ð°Ñ€ÑˆÐµ 30 Ð´Ð½ÐµÐ¹ ÑƒÐ´Ð°Ð»ÑÑŽÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸.</p>
          </div>
        </div>
      </section>
    </div>


    <div class="overview-banner">
    <div class="overview-card" id="summaryProjectCard">
      <div class="overview-pulse"></div>
      <h2>ÐŸÑ€Ð¾ÐµÐºÑ‚</h2>
      <strong id="summaryProject">â€”</strong>
      <div class="overview-meta" id="summaryProjectMeta">ÐÐµÑ‚ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°</div>
    </div>
    <div class="overview-card" id="summaryCrawlerCard">
      <div class="overview-pulse"></div>
      <h2>ÐšÑ€Ð°ÑƒÐ»Ð¸Ð½Ð³</h2>
      <strong id="summaryCrawler">â€”</strong>
      <div class="overview-meta" id="summaryCrawlerMeta"></div>
    </div>
    <div class="overview-card" id="summaryPerfCard">
      <div class="overview-pulse"></div>
      <h2>Ð ÐµÑÑƒÑ€ÑÑ‹</h2>
      <strong id="summaryPerf">â€”</strong>
      <div class="overview-meta" id="summaryPerfMeta"></div>
    </div>
    <div class="overview-card" id="summaryLLMCard">
      <div class="overview-pulse"></div>
      <h2>LLM Ð¼Ñ‹ÑÐ»Ð¸</h2>
      <div class="prompt-preview" id="summaryPrompt">Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð·Ð´ÐµÑÑŒ</div>
      <div class="prompt-docs" id="summaryPromptDocs"></div>
    </div>
    <div class="overview-card" id="summaryBuildCard">
      <div class="overview-pulse"></div>
      <h2>Ð¡Ð±Ð¾Ñ€ÐºÐ°</h2>
      <strong id="summaryBuild">â€”</strong>
      <div class="overview-meta" id="summaryBuildMeta">â€”</div>
    </div>
  </div>

  <div class="dashboard-grid">
    <section id="block-projects" class="dashboard-stack span-3" data-block-id="projects" data-block-group="overview">
      <details class="card project-switch-card collapsible-card" data-collapsible="projects">
        <summary class="collapsible-summary">
          <span class="collapsible-title">Projects</span>
          <span class="collapsible-chevron" aria-hidden="true"></span>
        </summary>
        <div class="collapsible-body">
          <div class="collapsible-content">
            <select id="projectSelect" size="6"></select>
            <div class="project-switch-actions">
              <button type="button" id="projectAdd">Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚</button>
              <button type="button" id="projectRefresh">ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº</button>
            </div>
            <span class="muted" id="projectStatus"></span>
            <datalist id="llmModelOptions"></datalist>
          </div>
        </div>
      </details>
    </section>

    <section id="block-status" class="dashboard-stack span-9 status-tiles" data-block-id="status" data-block-group="overview">
      <div class="card status-card">
        <b data-i18n="crawlerStatusTitle">Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð°</b>
        <div data-i18n-wrapper="crawlerQueued">Queued: <span data-i18n-value id="queued">0</span></div>
        <div data-i18n-wrapper="crawlerInProgress">In progress: <span data-i18n-value id="in_progress">0</span></div>
        <div data-i18n-wrapper="crawlerDone">Done: <span data-i18n-value id="done">0</span></div>
        <div data-i18n-wrapper="crawlerFailed">Failed: <span data-i18n-value id="failed">0</span></div>
        <div class="muted" data-i18n-wrapper="crawlerLast" id="last_crawl">Last: <span data-i18n-value>â€“</span></div>
        <div class="muted" data-i18n-wrapper="crawlerProjectLabel">Project: <span data-i18n-value id="crawlerProject">â€”</span></div>
        <div>
          <details>
            <summary data-i18n="crawlerLastUrls">ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ URL</summary>
            <ol id="recent_urls" style="margin-top:6px;"></ol>
          </details>
        </div>
      </div>
      <div class="card status-card">
        <b data-i18n="servicesTitle">Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹</b>
        <div data-i18n-wrapper="serviceMongo">Mongo: <span id="mongo" class="bad" data-i18n-value>down</span></div>
        <div data-i18n-wrapper="serviceRedis">Redis: <span id="redis" class="bad" data-i18n-value>down</span></div>
        <div data-i18n-wrapper="serviceQdrant">Qdrant: <span id="qdrant" class="bad" data-i18n-value>down</span></div>
        <div data-i18n-wrapper="serviceOverall">Status: <span id="overall" data-i18n-value>degraded</span></div>
      </div>
      <div class="card status-card">
        <b data-i18n="resourcesTitle">Ð ÐµÑÑƒÑ€ÑÑ‹</b>
        <div data-i18n-wrapper="resourceCpuApp">CPU (app): <span id="cpu" data-i18n-value>â€“</span></div>
        <div data-i18n-wrapper="resourceCpuSys">CPU (sys): <span id="cpuSys" data-i18n-value>â€“</span></div>
        <div data-i18n-wrapper="resourceRam">RAM: <span id="ram" data-i18n-value>â€“</span></div>
        <div data-i18n-wrapper="resourceRss">RSS: <span id="rss" data-i18n-value>â€“</span></div>
        <div style="white-space:pre-line;" data-i18n-wrapper="resourceGpu">GPU: <span id="gpu" data-i18n-value>â€“</span></div>
        <div data-i18n-wrapper="resourcePython">Python: <span id="pyver" data-i18n-value>â€“</span></div>
      </div>
    </section>

    <h2 class="section-title span-all" data-i18n="manageSection">Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ</h2>

    <section id="block-crawler" class="dashboard-stack span-4" data-block-id="crawler" data-block-group="manage">
      <div class="card control-card">
        <div class="crawler-header">
          <b data-i18n="crawlerLaunchTitle">Ð—Ð°Ð¿ÑƒÑÐº ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð°</b>
          <div class="crawler-logs-buttons">
            <button type="button" id="crawlerLogsBtn" class="icon-button" title="ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸" data-i18n-title="crawlerLogsTooltip">?</button>
          </div>
        </div>
        <div class="crawler-progress" id="crawlerProgress">
          <div class="crawler-progress-track">
            <div class="crawler-progress-fill" id="crawlerProgressFill"></div>
          </div>
          <div class="crawler-progress-meta">
            <span id="crawlerProgressStatus">ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°</span>
            <span id="crawlerProgressCounters">0 / 0 ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†</span>
          </div>
          <div class="crawler-progress-note" id="crawlerProgressNote"></div>
        </div>
        <form id="crawler-form" style="margin-top:4px; display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end;">
          <label style="flex:1 1 200px;" data-i18n="crawlerStartUrl">Start URL
            <input type="url" id="url" placeholder="https://example.com" required style="width:100%;">
          </label>
          <label data-i18n="crawlerDepth">Depth
            <input type="number" id="depth" min="1" value="2" style="width:80px;">
          </label>
          <label data-i18n="crawlerPages">Pages
            <input type="number" id="pages" min="1" value="100" style="width:80px;">
          </label>
          <label class="crawler-option">
            <input type="checkbox" id="crawlerCollectBooks">
            <span data-i18n="crawlerCollectBooks">Store full pages for book reading</span>
          </label>
          <button type="submit" data-i18n="crawlerStartButton">Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ</button>
          <button type="button" id="stopBtn" data-i18n="crawlerStopButton">ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ</button>
          <span id="launchMsg" class="muted"></span>
        </form>
        <div class="crawler-actions">
          <button type="button" id="crawlerResetBtn" data-i18n="crawlerResetButton">Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ ÑÑ‡Ñ‘Ñ‚Ñ‡Ð¸ÐºÐ¸</button>
          <button type="button" id="crawlerDedupBtn" data-i18n="crawlerDedupButton">Ð£Ð±Ñ€Ð°Ñ‚ÑŒ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ URL</button>
          <span class="muted" id="crawlerActionStatus"></span>
        </div>
        <div class="crawler-logs" id="crawlerLogsPanel">
          <div class="crawler-logs-header">
            <span data-i18n="crawlerLogsHeader">Crawler logs</span>
            <div class="crawler-logs-buttons">
              <button type="button" id="crawlerLogsCopy" class="icon-button" title="Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ" data-i18n-title="crawlerLogsCopy">â§‰</button>
              <button type="button" id="crawlerLogsRefresh" class="icon-button" title="ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ" data-i18n-title="crawlerLogsRefresh">â†»</button>
              <button type="button" id="crawlerLogsClose" class="icon-button" title="Ð¡ÐºÑ€Ñ‹Ñ‚ÑŒ" data-i18n-title="crawlerLogsHide">Ã—</button>
            </div>
          </div>
          <pre id="crawlerLogsOutput" class="crawler-logs-output" data-i18n="crawlerLogsEmpty">Ð›Ð¾Ð³Ð¸ Ð±ÑƒÐ´ÑƒÑ‚ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ.</pre>
        </div>
      </div>
    </section>
    <section id="block-project" class="dashboard-stack span-8" data-block-id="project" data-block-group="manage">
      <details class="card control-card project-card collapsible-card" data-collapsible="project">
        <summary class="collapsible-summary">
          <span class="collapsible-title">Project</span>
          <span class="collapsible-chevron" aria-hidden="true"></span>
        </summary>
        <div class="collapsible-body">
          <b>Project</b>
        <form id="projectForm" style="display:flex; flex-wrap:wrap; gap:10px;">
          <label style="flex:1 1 200px;">Ð˜Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ (ENG)
            <input type="text" id="projectName" placeholder="mmvs" required>
          </label>
          <label style="flex:1 1 200px;">ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ
            <input type="text" id="projectTitle" placeholder="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°">
          </label>
          <label style="flex:1 1 200px;">Ð”Ð¾Ð¼ÐµÐ½ (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)
            <input type="text" id="projectDomain" placeholder="https://example.com">
          </label>
          <label style="flex:1 1 200px;">LLM Ð¼Ð¾Ð´ÐµÐ»ÑŒ
            <select id="projectModel" style="width:100%;"></select>
          </label>
          <label style="flex:1 1 100%;">Ð¡Ñ‚Ð°Ñ€Ñ‚Ð¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚
            <textarea id="projectPrompt" rows="3" placeholder="Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑŽ Ð´Ð»Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸" style="width:100%; resize:vertical;"></textarea>
          </label>
          <div class="prompt-ai-controls" style="flex:1 1 100%;">
            <select id="projectPromptRole"></select>
            <button type="button" id="projectPromptAi">AIâ€‘ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ</button>
            <span class="muted prompt-ai-status" id="projectPromptAiStatus">â€”</span>
          </div>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectEmotions" checked>
              Ð­Ð¼Ð¾Ñ†Ð¸Ð¸ Ð¸ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ñ…
            </label>
            <span class="muted" id="projectEmotionsHint">ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½Ð½Ñ‹Ð¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð±Ñ‹Ð»Ð¸ Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¼Ð¸ Ð¸ Ð¶Ð¸Ð²Ñ‹Ð¼Ð¸.</span>
          </div>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectVoiceEnabled" checked>
              Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð¹ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚
            </label>
            <span class="muted" id="projectVoiceHint">Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð°Ð½Ð¸Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð° Ð½Ð° ÑÐ°Ð¹Ñ‚Ðµ.</span>
          </div>
          <label style="flex:1 1 200px;">ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð´Ð»Ñ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ Ñ€ÐµÐ¶Ð¸Ð¼Ð° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
            <input type="text" id="projectVoiceModel" placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, gpt-4o-mini" list="llmModelOptions">
          </label>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectImageCaptions" checked>
              ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ¸ Ðº Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼ Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹
            </label>
            <span class="muted" id="projectImageCaptionsHint">LLM Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°Ñ‚ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ð¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹.</span>
          </div>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectSourcesEnabled">
              ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²
            </label>
            <span class="muted" id="projectSourcesHint">ÐŸÐ¾ÑÐ»Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒÑÑ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÑÑ‹Ð»Ð¾Ðº Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ñ‹.</span>
          </div>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectDebugInfo" checked>
              Ð¡Ð»ÑƒÐ¶ÐµÐ±Ð½Ð°Ñ ÑÐ¿Ñ€Ð°Ð²ÐºÐ° Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼
            </label>
            <span class="muted" id="projectDebugInfoHint">Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼ Ð² Telegram Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð¸Ð»Ð° ÑÐ»ÑƒÐ¶ÐµÐ±Ð½Ð°Ñ ÑÐ¿Ñ€Ð°Ð²ÐºÐ° (endpoint, ÑÐ¼Ð¾Ñ†Ð¸Ð¸ Ð¸ Ñ‚. Ð¿.).</span>
          </div>
          <div style="flex:1 1 200px; display:flex; flex-direction:column; gap:4px; margin-top:4px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="projectDebug">
              ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
            </label>
            <span class="muted" id="projectDebugHint">Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð¸Ð»Ð° Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ ÑÐ²Ð¾Ð´ÐºÐ° (ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹, Ð·Ð½Ð°Ð½Ð¸Ñ, ÑÐµÑÑÐ¸Ñ).</span>
          </div>
          <div id="projectAdminSection" style="flex:1 1 100%; display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;">
            <label style="flex:1 1 200px;">ÐÐ´Ð¼Ð¸Ð½ Ð»Ð¾Ð³Ð¸Ð½
              <input type="text" id="projectAdminUsername" placeholder="project_admin">
            </label>
            <label style="flex:1 1 200px;">ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
              <input type="password" id="projectAdminPassword" placeholder="ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ð¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¼ÐµÐ½ÑÑ‚ÑŒ">
            </label>
            <span class="muted" id="projectAdminHint" style="flex:1 1 100%;">Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð»Ð¾Ð³Ð¸Ð½ Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.</span>
          </div>
        <div class="project-storage-panel">
          <div>Ð¢ÐµÐºÑÑ‚Ñ‹: <span id="projectStorageText">â€”</span></div>
          <div>Ð¤Ð°Ð¹Ð»Ñ‹: <span id="projectStorageFiles">â€”</span></div>
          <div>ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ñ‹: <span id="projectStorageContexts">â€”</span></div>
          <div>Redis: <span id="projectStorageRedis">â€”</span></div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button type="submit">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
          <button type="button" id="projectPromptSave">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚</button>
          <button type="button" id="projectTest">Ð¢ÐµÑÑ‚</button>
        </div>
      </form>
      <div class="card voice-training-card" id="voiceTrainingCard">
        <div>
          <b data-i18n="voiceTrainingTitle">ÐžÐ±ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð³Ð¾Ð»Ð¾ÑÐ°</b>
          <div class="muted" id="voiceTrainingSummary" data-i18n="voiceTrainingSummary">Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ 3+ Ð°ÑƒÐ´Ð¸Ð¾Ð´Ð¾Ñ€Ð¾Ð¶ÐºÐ¸ Ñ Ñ‡Ð¸ÑÑ‚Ð¾Ð¹ Ñ€ÐµÑ‡ÑŒÑŽ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð±ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð° Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.</div>
        </div>
        <div class="voice-upload">
          <input type="file" id="voiceSampleInput" accept="audio/*" multiple>
          <button type="button" id="voiceSampleUpload" data-i18n="voiceUploadButton">Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð¾Ñ€Ð¾Ð¶ÐºÐ¸</button>
          <span class="muted" id="voiceUploadStatus">â€”</span>
        </div>
        <div class="voice-samples" id="voiceSamplesContainer">
          <div class="muted" id="voiceSamplesEmpty" data-i18n="voiceSamplesEmpty">Ð”Ð¾Ñ€Ð¾Ð¶ÐºÐ¸ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹.</div>
        </div>
        <div class="voice-train-actions">
          <button type="button" id="voiceTrainButton" data-i18n="voiceTrainButton">ÐžÐ±ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾Ñ</button>
          <span class="muted" id="voiceTrainStatus">â€”</span>
        </div>
        <div class="voice-jobs" id="voiceJobsContainer"></div>
      </div>
      <div class="project-danger" id="projectDangerZone">
        <div>
          <strong>ÐžÐ¿Ð°ÑÐ½Ð°Ñ Ð·Ð¾Ð½Ð°</strong>
          <p>Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð±ÐµÐ·Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð½Ð¾ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÑ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹, Ñ„Ð°Ð¹Ð»Ñ‹, ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ñ‹ Ð¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ. Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ»ÑŒÐ·Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ.</p>
        </div>
          <button type="button" id="projectDelete" class="project-delete-btn" disabled>Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚</button>
          <span class="muted" id="projectDeleteInfo">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ Ð¾Ð±ÑŠÑ‘Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ñ….</span>
        </div>
        <div class="project-extensions" style="display:flex; flex-wrap:wrap; gap:16px; margin-top:16px;">
          <div class="project-telegram" style="flex:1 1 260px; min-width:240px;">
            <b style="display:block; margin-bottom:8px;">Telegram Ð±Ð¾Ñ‚</b>
            <label style="display:block; margin-bottom:8px;">Bot Token
              <input type="password" id="projectTelegramToken" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚Ð¾ÐºÐµÐ½" style="width:100%;">
            </label>
            <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
              <input type="checkbox" id="projectTelegramAutoStart"> ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ
            </label>
            <div>Status: <span id="projectTelegramStatus">â€”</span></div>
            <div class="muted" id="projectTelegramInfo"></div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <button type="button" id="projectTelegramSave">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
              <button type="button" id="projectTelegramStart">Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ</button>
              <button type="button" id="projectTelegramStop">ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ</button>
              <span class="muted" id="projectTelegramMessage"></span>
            </div>
          </div>
          <div class="project-max" style="flex:1 1 260px; min-width:240px;">
            <b style="display:block; margin-bottom:8px;">MAX Ð±Ð¾Ñ‚</b>
            <label style="display:block; margin-bottom:8px;">Access Token
              <input type="password" id="projectMaxToken" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚Ð¾ÐºÐµÐ½" style="width:100%;">
            </label>
            <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
              <input type="checkbox" id="projectMaxAutoStart"> ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ
            </label>
            <div>Status: <span id="projectMaxStatus">â€”</span></div>
            <div class="muted" id="projectMaxInfo"></div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <button type="button" id="projectMaxSave">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
              <button type="button" id="projectMaxStart">Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ</button>
              <button type="button" id="projectMaxStop">ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ</button>
              <span class="muted" id="projectMaxMessage"></span>
            </div>
          </div>
          <div class="project-vk" style="flex:1 1 260px; min-width:240px;">
            <b style="display:block; margin-bottom:8px;">VK Ð±Ð¾Ñ‚</b>
            <label style="display:block; margin-bottom:8px;">Access Token
              <input type="password" id="projectVkToken" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚Ð¾ÐºÐµÐ½" style="width:100%;">
            </label>
            <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
              <input type="checkbox" id="projectVkAutoStart"> ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ
            </label>
            <div>Status: <span id="projectVkStatus">â€”</span></div>
            <div class="muted" id="projectVkInfo"></div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <button type="button" id="projectVkSave">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
              <button type="button" id="projectVkStart">Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ</button>
              <button type="button" id="projectVkStop">ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ</button>
              <span class="muted" id="projectVkMessage"></span>
            </div>
          </div>
          <div class="project-widget" style="flex:1 1 260px; min-width:240px;">
            <b style="display:block; margin-bottom:8px;">Ð’Ð¸Ð´Ð¶ÐµÑ‚</b>
            <label style="display:block; margin-bottom:8px;">Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð²Ð¸Ð´Ð¶ÐµÑ‚
              <input type="url" id="projectWidgetUrl" placeholder="https://example.com/widget" style="width:100%;">
            </label>
            <div class="muted" id="projectWidgetHint">Ð¡ÑÑ‹Ð»ÐºÐ° Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°</div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <a id="projectWidgetLink" href="#" target="_blank" rel="noopener" style="pointer-events:none; opacity:0.6;">ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð²Ð¸Ð´Ð¶ÐµÑ‚</a>
              <button type="button" id="projectWidgetCopy" disabled>Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ</button>
              <span class="muted" id="projectWidgetMessage"></span>
            </div>
          </div>
          <div class="project-bitrix" style="flex:1 1 260px; min-width:240px;">
            <b style="display:block; margin-bottom:8px;">Bitrix24</b>
            <label style="display:block; margin-bottom:8px;">Webhook URL
              <input type="url" id="projectBitrixWebhook" placeholder="https://example.bitrix24.ru/rest/1/xxxxxxxxx/" style="width:100%;">
            </label>
            <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
              <input type="checkbox" id="projectBitrixEnabled">
              ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÑŽ
            </label>
            <span class="muted" id="projectBitrixHint">Webhook Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð¸ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ.</span>
          </div>
          <div class="project-mail" style="flex:1 1 320px; min-width:280px;">
            <b style="display:block; margin-bottom:8px;">ÐŸÐ¾Ñ‡Ñ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ð½ÐµÐºÑ‚Ð¾Ñ€</b>
            <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
              <input type="checkbox" id="projectMailEnabled">
              Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÑŽ
            </label>
            <div class="muted" id="projectMailHint">Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ IMAP/SMTP, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð¼Ð¾Ð³ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¸ Ð¿Ñ€Ð¾ÑÐ¼Ð°Ñ‚Ñ€Ð¸Ð²Ð°Ñ‚ÑŒ Ð¿Ð¸ÑÑŒÐ¼Ð°.</div>
            <div style="display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); margin-top:10px;">
              <label>IMAP Ñ…Ð¾ÑÑ‚
                <input type="text" id="projectMailImapHost" placeholder="imap.example.com">
              </label>
              <label>IMAP Ð¿Ð¾Ñ€Ñ‚
                <input type="number" id="projectMailImapPort" placeholder="993" min="1" max="65535">
              </label>
              <label style="display:flex; gap:6px; align-items:center;">
                <input type="checkbox" id="projectMailImapSsl" checked>
                IMAP SSL
              </label>
              <label>SMTP Ñ…Ð¾ÑÑ‚
                <input type="text" id="projectMailSmtpHost" placeholder="smtp.example.com">
              </label>
              <label>SMTP Ð¿Ð¾Ñ€Ñ‚
                <input type="number" id="projectMailSmtpPort" placeholder="587" min="1" max="65535">
              </label>
              <label style="display:flex; gap:6px; align-items:center;">
                <input type="checkbox" id="projectMailSmtpTls" checked>
                SMTP STARTTLS
              </label>
              <label>Ð˜Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
                <input type="text" id="projectMailUsername" placeholder="user@example.com">
              </label>
              <label>ÐŸÐ°Ñ€Ð¾Ð»ÑŒ
                <input type="password" id="projectMailPassword" placeholder="ÐŸÐ°Ñ€Ð¾Ð»ÑŒ" autocomplete="new-password">
              </label>
              <label>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ (From)
                <input type="email" id="projectMailFrom" placeholder="support@example.com">
              </label>
            </div>
            <label style="display:block; margin-top:10px;">ÐŸÐ¾Ð´Ð¿Ð¸ÑÑŒ Ð² Ð¿Ð¸ÑÑŒÐ¼Ð°Ñ…
              <textarea id="projectMailSignature" rows="3" placeholder="Ð¡ ÑƒÐ²Ð°Ð¶ÐµÐ½Ð¸ÐµÐ¼, ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Example" style="width:100%; resize:vertical;"></textarea>
            </label>
          </div>
        </div>
      </div>
      </details>
    </section>

    <section id="block-backup" class="dashboard-stack span-4" data-block-id="backup" data-block-group="manage">
      <details class="card control-card collapsible-card" data-collapsible="backup">
        <summary class="collapsible-summary">
          <span class="collapsible-title" data-i18n="backupCardTitle">Ð ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¿Ð¸Ð¸</span>
          <span class="collapsible-chevron" aria-hidden="true"></span>
        </summary>
        <div class="collapsible-body backup-card">
          <div class="backup-section">
            <b data-i18n="backupScheduleTitle">Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ</b>
            <label class="backup-toggle">
              <input type="checkbox" id="backupEnabled">
              <span data-i18n="backupEnableLabel">Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ</span>
            </label>
            <div class="backup-field-grid">
              <label>
                <span data-i18n="backupTimeLabel">Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°</span>
                <input type="time" id="backupTime" min="00:00" max="23:59">
              </label>
              <label>
                <span data-i18n="backupTimezoneLabel">Ð§Ð°ÑÐ¾Ð²Ð¾Ð¹ Ð¿Ð¾ÑÑ</span>
                <select id="backupTimezone"></select>
              </label>
              <label>
                <span data-i18n="backupFolderLabel">ÐŸÐ°Ð¿ÐºÐ° Ð½Ð° Ð¯Ð½Ð´ÐµÐºÑ.Ð”Ð¸ÑÐºÐµ</span>
                <input type="text" id="backupFolder" placeholder="sitellm-backups" data-i18n-placeholder="backupFolderPlaceholder">
              </label>
            </div>
            <div class="backup-token-row">
              <label>
                <span data-i18n="backupTokenLabel">OAuth Ñ‚Ð¾ÐºÐµÐ½</span>
                <input type="password" id="backupToken" autocomplete="off" data-i18n-placeholder="backupTokenPlaceholder">
              </label>
              <button type="button" id="backupTokenSave" data-i18n="backupTokenSave">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
              <button type="button" id="backupTokenClear" data-i18n="backupTokenClear">Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ</button>
              <span class="backup-status-line" id="backupTokenStatus"></span>
            </div>
            <div class="backup-action-buttons">
              <button type="button" id="backupSettingsApply" data-i18n="backupScheduleSave">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ</button>
            </div>
            <span class="backup-status-line" id="backupStatusLine"></span>
          </div>
          <div class="backup-section">
            <b data-i18n="backupManualTitle">Ð ÑƒÑ‡Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</b>
            <div class="backup-action-buttons">
              <button type="button" id="backupRunBtn" data-i18n="backupRunNow">Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ</button>
              <button type="button" id="backupRefreshBtn" data-i18n="backupRefresh">ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ</button>
            </div>
            <label>
              <span data-i18n="backupRestoreLabel">Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ Ð¿ÑƒÑ‚Ð¸</span>
              <input type="text" id="backupRestorePath" data-i18n-placeholder="backupRestorePlaceholder" placeholder="/sitellm-backups/backup.archive.gz">
            </label>
            <button type="button" id="backupRestoreBtn" data-i18n="backupRestoreButton">Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ</button>
          </div>
          <div class="backup-section">
            <b data-i18n="backupJobsTitle">Ð–ÑƒÑ€Ð½Ð°Ð» Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹</b>
            <div class="backup-jobs-list" id="backupJobsList">
              <div class="backup-empty" data-i18n="backupJobsEmpty">ÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹.</div>
            </div>
          </div>
          <div class="backup-status-line" id="backupErrorLine"></div>
        </div>
      </details>
    </section>

    <section id="block-llm" class="dashboard-stack span-4" data-block-id="llm" data-block-group="manage">
      <div class="card control-card">
        <b>LLM</b>
        <div>Model: <code id="model">â€“</code></div>
        <div>Backend: <span id="backend">â€“</span></div>
        <div>Device: <span id="device">â€“</span></div>
        <div style="margin-top:6px;">
          <label>Ollama Base:
            <input type="text" id="ollamaBase" placeholder="http://host.docker.internal:11434" style="width:100%">
          </label>
          <label style="display:block; margin-top:6px;">Model name:
            <input type="text" id="ollamaModel" placeholder="yandex/YandexGPT-5-Lite-8B-instruct-GGUF:latest" style="width:100%">
          </label>
          <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" id="saveLLM">Save</button>
            <button type="button" id="pingLLM">Ping</button>
            <span id="pingRes" class="muted"></span>
          </div>
          <div class="ollama-catalog" id="ollamaCatalog">
            <div class="ollama-catalog-header">
              <span class="muted">ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ Ollama</span>
              <button type="button" id="ollamaRefresh">ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ</button>
            </div>
            <div class="ollama-meta" id="ollamaAvailability">â€”</div>
            <div>
              <strong style="font-size:12px; letter-spacing:0.06em; text-transform:uppercase;">Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ</strong>
              <ul class="ollama-list" id="ollamaInstalledList"></ul>
            </div>
            <div>
              <strong style="font-size:12px; letter-spacing:0.06em; text-transform:uppercase;">ÐŸÐ¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ</strong>
              <ul class="ollama-list" id="ollamaPopularList"></ul>
            </div>
            <div>
              <strong style="font-size:12px; letter-spacing:0.06em; text-transform:uppercase;">Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°</strong>
              <div class="ollama-jobs" id="ollamaJobsList"></div>
            </div>
            <div class="ollama-servers" id="ollamaServersPanel">
              <div class="ollama-servers-header">
                <strong style="font-size:12px; letter-spacing:0.06em; text-transform:uppercase;">Ð¡ÐµÑ€Ð²ÐµÑ€Ñ‹</strong>
                <button type="button" id="ollamaServersRefresh">ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ</button>
              </div>
              <div class="ollama-meta" id="ollamaServersStatus">â€”</div>
              <ul class="ollama-list" id="ollamaServersList"></ul>
              <form id="ollamaServerForm" class="ollama-server-form">
                <div class="ollama-server-form-grid">
                  <input type="text" id="ollamaServerName" placeholder="Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€" required>
                  <input type="text" id="ollamaServerUrl" placeholder="http://host:11434" required>
                  <label class="ollama-server-enabled">
                    <input type="checkbox" id="ollamaServerEnabled" checked>
                    Ð’ÐºÐ»ÑŽÑ‡Ñ‘Ð½
                  </label>
                  <button type="submit">Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="block-feedback" class="dashboard-stack span-4" data-block-id="feedback" data-block-group="manage">
      <div class="card control-card">
        <div class="card-header">
          <b data-i18n="feedbackSectionTitle">Feedback</b>
          <button type="button" id="feedbackRefresh" data-i18n="reloadProjects">Reload</button>
        </div>
        <div class="feedback-list" id="feedbackTasksList">
          <div class="muted" data-i18n="feedbackNoItems">No feedback yet.</div>
        </div>
      </div>
    </section>

    <section id="block-stats" class="dashboard-stack span-12" data-block-id="stats" data-block-group="manage">
      <details class="card stats-card collapsible-card" data-collapsible="stats">
        <summary class="collapsible-summary">
          <span class="collapsible-title">ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹</span>
          <span class="collapsible-chevron" aria-hidden="true"></span>
        </summary>
        <div class="collapsible-body">
          <div class="muted" id="statsSubtitle">ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 14 Ð´Ð½ÐµÐ¹</div>
          <div class="stats-graph">
            <canvas id="statsCanvas"></canvas>
            <div id="statsTooltip" class="stats-tooltip"></div>
            <div id="statsEmpty" class="stats-empty">ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…</div>
          </div>
          <div class="stats-actions">
            <button type="button" id="statsRefresh">ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ</button>
            <button type="button" id="statsExport">Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ CSV</button>
            <span class="muted" id="statsSummary"></span>
          </div>
        </div>
      </details>
    </section>


    <section id="block-knowledge-tools" class="dashboard-stack span-12" data-block-id="knowledge-tools" data-block-group="knowledge">
      <div class="card knowledge-service-card">
        <b>Ð˜Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°</b>
        <div class="muted">ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ð²ÐµÐºÑ‚Ð¾Ñ€Ð½Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹, ÐºÐ¾Ð³Ð´Ð° Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ Ð¿Ñ€Ð¾ÑÑ‚Ð°Ð¸Ð²Ð°ÐµÑ‚ Ð±Ð¾Ð»ÑŒÑˆÐµ 5 Ð¼Ð¸Ð½ÑƒÑ‚.</div>
        <label style="display:flex; align-items:center; gap:8px; margin:10px 0;">
          <input type="checkbox" id="knowledgeServiceToggle">
          Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ðµ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸
        </label>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button type="button" id="knowledgeServiceApply">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
          <button type="button" id="knowledgeServiceRefresh">ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ</button>
          <span class="muted" id="knowledgeServiceStatus">â€”</span>
        </div>
      </div>
      <div class="card prompts-card">
        <b>LLM Prompts</b>
        <div class="muted">ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ (Ñ ÑƒÑ‡Ñ‘Ñ‚Ð¾Ð¼ Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹)</div>
        <pre id="promptLogs" style="white-space:pre-wrap; padding:10px; border-radius:8px; overflow:auto;"></pre>
      </div>
      <div class="card logs-card">
        <b>Logs (last 200)</b>
        <div style="margin:6px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>Lines: <input type="number" id="logLimit" min="50" max="1000" value="200" style="width:80px;"></label>
          <button id="copyLogs" type="button">Copy</button>
          <span class="muted" id="logInfo"></span>
        </div>
        <pre id="logs" style="white-space:pre-wrap; background:#0b1021; color:#b8c1ec; padding:10px; border-radius:8px; max-height:320px; overflow:auto;"></pre>
      </div>
    </section>
  </div>


  <div id="projectModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <strong>ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚</strong>
        <button type="button" class="modal-close" id="projectModalClose">Ã—</button>
      </div>
      <form id="projectModalForm">
        <div class="modal-body">
          <label>Ð˜Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ (ENG)
            <input type="text" id="projectModalName" placeholder="mmvs" required>
          </label>
          <label>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ
            <input type="text" id="projectModalTitle" placeholder="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°">
          </label>
          <label>Ð”Ð¾Ð¼ÐµÐ½
            <input type="text" id="projectModalDomain" placeholder="https://example.com">
          </label>
          <label>LLM Ð¼Ð¾Ð´ÐµÐ»ÑŒ
            <input type="text" id="projectModalModel" list="llmModelOptions" placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, yandex/YandexGPT-5-Lite-8B-instruct-GGUF:latest">
          </label>
          <label>Ð¡Ñ‚Ð°Ñ€Ñ‚Ð¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚
            <textarea id="projectModalPrompt" rows="4" placeholder="ÐžÐ¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑŽ Ð´Ð»Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸"></textarea>
          </label>
          <div class="prompt-ai-controls">
            <select id="projectModalPromptRole"></select>
            <button type="button" id="projectModalPromptAi">AIâ€‘ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ</button>
            <span class="muted prompt-ai-status" id="projectModalPromptAiStatus">â€”</span>
          </div>
          <label>ÐÐ´Ð¼Ð¸Ð½ Ð»Ð¾Ð³Ð¸Ð½
            <input type="text" id="projectModalAdminUsername" placeholder="project_admin">
          </label>
          <label>ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
            <input type="password" id="projectModalAdminPassword" placeholder="ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ð¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð·Ð°Ð´Ð°Ð²Ð°Ñ‚ÑŒ">
          </label>
          <label style="display:flex; gap:10px; align-items:center;">
            <input type="checkbox" id="projectModalEmotions" checked>
            Ð­Ð¼Ð¾Ñ†Ð¸Ð¸ Ð¸ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ñ…
          </label>
        </div>
        <div class="modal-footer">
          <span class="muted" id="projectModalStatus"></span>
          <div style="display:flex; gap:8px;">
            <button type="submit">Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ</button>
            <button type="button" id="projectModalCancel">ÐžÑ‚Ð¼ÐµÐ½Ð°</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="kbModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <strong id="kbModalTitle">Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚</strong>
        <button type="button" class="modal-close" id="kbModalClose">Ã—</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="kbModalId">
        <label>Ð˜Ð¼Ñ
          <input type="text" id="kbModalName" required>
        </label>
        <label>URL
          <input type="url" id="kbModalUrl" placeholder="https://example.com">
        </label>
        <label>ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ
          <input type="text" id="kbModalDescription" placeholder="ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ">
        </label>
        <label>ÐŸÑ€Ð¾ÐµÐºÑ‚
          <input type="text" id="kbModalProject" placeholder="project">
        </label>
        <label>Ð¢ÐµÐºÑÑ‚
          <textarea id="kbModalContent"></textarea>
        </label>
      </div>
      <div class="modal-footer">
        <span class="muted" id="kbModalStatus"></span>
        <div style="display:flex; gap:8px;">
          <button type="button" id="kbModalCompile">ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ</button>
          <button type="button" id="kbModalSave">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
          <button type="button" id="kbModalCancel">Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const languageSelect = document.getElementById('adminLanguage');
    const authModal = document.getElementById('adminAuthModal');
    const authForm = document.getElementById('adminAuthForm');
    const authUserInput = document.getElementById('adminAuthUsername');
    const authPasswordInput = document.getElementById('adminAuthPassword');
    const authSubmitBtn = document.getElementById('adminAuthSubmit');
    const authCancelBtn = document.getElementById('adminAuthCancel');
    const authError = document.getElementById('adminAuthError');
    const authHint = document.getElementById('adminAuthHint');
    const authMessage = document.getElementById('adminAuthMessage');
    const form = document.getElementById('crawler-form');
    const stopBtn = document.getElementById('stopBtn');
    const crawlerProgressFill = document.getElementById('crawlerProgressFill');
    const crawlerProgressStatus = document.getElementById('crawlerProgressStatus');
    const crawlerProgressCounters = document.getElementById('crawlerProgressCounters');
    const crawlerProgressNote = document.getElementById('crawlerProgressNote');
    const crawlerLogsBtn = document.getElementById('crawlerLogsBtn');
    const crawlerLogsPanel = document.getElementById('crawlerLogsPanel');
    const crawlerLogsOutput = document.getElementById('crawlerLogsOutput');
    const crawlerLogsRefresh = document.getElementById('crawlerLogsRefresh');
    const crawlerLogsClose = document.getElementById('crawlerLogsClose');
    const crawlerLogsCopy = document.getElementById('crawlerLogsCopy');
    const crawlerResetBtn = document.getElementById('crawlerResetBtn');
    const crawlerDedupBtn = document.getElementById('crawlerDedupBtn');
    const crawlerActionStatus = document.getElementById('crawlerActionStatus');
    const crawlerCollectBooks = document.getElementById('crawlerCollectBooks');
    const voiceTrainingCard = document.getElementById('voiceTrainingCard');
    const voiceSampleInput = document.getElementById('voiceSampleInput');
    const voiceSampleUploadBtn = document.getElementById('voiceSampleUpload');
    const voiceUploadStatus = document.getElementById('voiceUploadStatus');
    const voiceTrainingSummary = document.getElementById('voiceTrainingSummary');
    const voiceSamplesContainer = document.getElementById('voiceSamplesContainer');
    const voiceSamplesEmpty = document.getElementById('voiceSamplesEmpty');
    const voiceTrainButton = document.getElementById('voiceTrainButton');
    const voiceTrainStatus = document.getElementById('voiceTrainStatus');
    const voiceJobsContainer = document.getElementById('voiceJobsContainer');
    const kbModalBackdrop = document.getElementById('kbModal');
    const kbModalClose = document.getElementById('kbModalClose');
    const kbModalCancel = document.getElementById('kbModalCancel');
    const kbModalSave = document.getElementById('kbModalSave');
    const kbModalCompile = document.getElementById('kbModalCompile');
    const kbModalTitle = document.getElementById('kbModalTitle');
    const kbModalId = document.getElementById('kbModalId');
    const kbModalName = document.getElementById('kbModalName');
    const kbModalUrl = document.getElementById('kbModalUrl');
    const kbModalDesc = document.getElementById('kbModalDescription');
    const kbModalProject = document.getElementById('kbModalProject');
    const kbModalContent = document.getElementById('kbModalContent');
    const kbModalStatus = document.getElementById('kbModalStatus');
    const backupEnabledInput = document.getElementById('backupEnabled');
    const backupTimeInput = document.getElementById('backupTime');
    const backupTimezoneSelect = document.getElementById('backupTimezone');
    const backupFolderInput = document.getElementById('backupFolder');
    const backupTokenInput = document.getElementById('backupToken');
    const backupTokenSaveBtn = document.getElementById('backupTokenSave');
    const backupTokenClearBtn = document.getElementById('backupTokenClear');
    const backupTokenStatus = document.getElementById('backupTokenStatus');
    const backupSettingsApplyBtn = document.getElementById('backupSettingsApply');
    const backupStatusLine = document.getElementById('backupStatusLine');
    const backupRunBtn = document.getElementById('backupRunBtn');
    const backupRefreshBtn = document.getElementById('backupRefreshBtn');
    const backupRestorePathInput = document.getElementById('backupRestorePath');
    const backupRestoreBtn = document.getElementById('backupRestoreBtn');
    const backupJobsList = document.getElementById('backupJobsList');
    const backupErrorLine = document.getElementById('backupErrorLine');
    const backupCard = document.getElementById('block-backup');
    const projectTelegramTokenInput = document.getElementById('projectTelegramToken');
    const projectTelegramAutoStart = document.getElementById('projectTelegramAutoStart');
    const projectTelegramStatus = document.getElementById('projectTelegramStatus');
    const projectTelegramInfo = document.getElementById('projectTelegramInfo');
    const projectTelegramMessage = document.getElementById('projectTelegramMessage');
    const projectTelegramSaveBtn = document.getElementById('projectTelegramSave');
    const projectTelegramStartBtn = document.getElementById('projectTelegramStart');
    const projectTelegramStopBtn = document.getElementById('projectTelegramStop');
    const projectBitrixWebhookInput = document.getElementById('projectBitrixWebhook');
    const projectBitrixEnabled = document.getElementById('projectBitrixEnabled');
    const projectBitrixHint = document.getElementById('projectBitrixHint');
    const projectMailEnabled = document.getElementById('projectMailEnabled');
    const projectMailHint = document.getElementById('projectMailHint');
    const projectMailImapHostInput = document.getElementById('projectMailImapHost');
    const projectMailImapPortInput = document.getElementById('projectMailImapPort');
    const projectMailImapSslInput = document.getElementById('projectMailImapSsl');
    const projectMailSmtpHostInput = document.getElementById('projectMailSmtpHost');
    const projectMailSmtpPortInput = document.getElementById('projectMailSmtpPort');
    const projectMailSmtpTlsInput = document.getElementById('projectMailSmtpTls');
    const projectMailUsernameInput = document.getElementById('projectMailUsername');
    const projectMailPasswordInput = document.getElementById('projectMailPassword');
    const projectMailFromInput = document.getElementById('projectMailFrom');
    const projectMailSignatureInput = document.getElementById('projectMailSignature');
    const projectMaxTokenInput = document.getElementById('projectMaxToken');
    const projectMaxAutoStart = document.getElementById('projectMaxAutoStart');
    const projectMaxStatus = document.getElementById('projectMaxStatus');
    const projectMaxInfo = document.getElementById('projectMaxInfo');
    const projectMaxMessage = document.getElementById('projectMaxMessage');
    const projectMaxSaveBtn = document.getElementById('projectMaxSave');
    const projectMaxStartBtn = document.getElementById('projectMaxStart');
    const projectMaxStopBtn = document.getElementById('projectMaxStop');
    const projectVkTokenInput = document.getElementById('projectVkToken');
    const projectVkAutoStart = document.getElementById('projectVkAutoStart');
    const projectVkStatus = document.getElementById('projectVkStatus');
    const projectVkInfo = document.getElementById('projectVkInfo');
    const projectVkMessage = document.getElementById('projectVkMessage');
    const projectVkSaveBtn = document.getElementById('projectVkSave');
    const projectVkStartBtn = document.getElementById('projectVkStart');
    const projectVkStopBtn = document.getElementById('projectVkStop');
    const statsCanvas = document.getElementById('statsCanvas');
    const statsTooltip = document.getElementById('statsTooltip');
    const statsEmpty = document.getElementById('statsEmpty');
    const statsSummary = document.getElementById('statsSummary');
    const statsSubtitle = document.getElementById('statsSubtitle');
    const statsRefreshBtn = document.getElementById('statsRefresh');
    const statsExportBtn = document.getElementById('statsExport');

    const LANGUAGE_STORAGE_KEY = 'admin_language';
    const FALLBACK_LANGUAGE = 'en';
    const nativeFetch = window.fetch.bind(window);
    const ADMIN_PREFIX = '/api/v1/admin/';
    const AUTH_CANCELLED_CODE = 'ADMIN_AUTH_CANCELLED';
    const ADMIN_AUTH_HEADER_SESSION_KEY = 'admin_auth_header_v1';
    const ADMIN_AUTH_USER_STORAGE_KEY = 'admin_auth_user_v1';
    const ADMIN_BASE_KEY = window.location.origin.replace(/\/$/, '');
    const adminAuthHeaders = new Map();

    try {
      const storedHeader = sessionStorage.getItem(ADMIN_AUTH_HEADER_SESSION_KEY);
      if (storedHeader) {
        adminAuthHeaders.set(ADMIN_BASE_KEY, storedHeader);
      }
    } catch (error) {
      console.warn('admin_auth_header_restore_failed', error);
    }

    if (authHint) {
      authHint.dataset.host = window.location.origin;
      authHint.textContent = authHint.textContent.replace('localhost', window.location.origin);
    }

    function translateInstant(key) {
      if (!key) return '';
      try {
        return typeof t === 'function' ? t(key) : key;
      } catch (error) {
        return key;
      }
    }

    function getAuthHeaderForBase(base) {
      return adminAuthHeaders.get(base) || null;
    }

    function setAuthHeaderForBase(base, header) {
      if (!header) {
        clearAuthHeaderForBase(base);
        return;
      }
      adminAuthHeaders.set(base, header);
      try {
        sessionStorage.setItem(ADMIN_AUTH_HEADER_SESSION_KEY, header);
      } catch (error) {
        console.warn('admin_auth_header_store_failed', error);
      }
    }

    function clearAuthHeaderForBase(base) {
      adminAuthHeaders.delete(base);
      try {
        sessionStorage.removeItem(ADMIN_AUTH_HEADER_SESSION_KEY);
      } catch (error) {
        console.warn('admin_auth_header_clear_failed', error);
      }
    }

    function getStoredAdminUser() {
      try {
        return localStorage.getItem(ADMIN_AUTH_USER_STORAGE_KEY) || '';
      } catch (error) {
        console.warn('admin_auth_user_restore_failed', error);
        return '';
      }
    }

    function setStoredAdminUser(value) {
      try {
        if (value) {
          localStorage.setItem(ADMIN_AUTH_USER_STORAGE_KEY, value);
        } else {
          localStorage.removeItem(ADMIN_AUTH_USER_STORAGE_KEY);
        }
      } catch (error) {
        console.warn('admin_auth_user_store_failed', error);
      }
    }

    function setAuthErrorKey(key) {
      if (!authError) return;
      if (key) {
        authError.dataset.key = key;
        authError.textContent = translateInstant(key);
      } else {
        delete authError.dataset.key;
        authError.textContent = '';
      }
    }

    function setAuthSubmitting(state) {
      if (authSubmitBtn) authSubmitBtn.disabled = state;
      if (authCancelBtn) authCancelBtn.disabled = state;
      if (state) {
        setAuthErrorKey('authStatusChecking');
      } else if (authError?.dataset.key === 'authStatusChecking') {
        setAuthErrorKey('');
      }
    }

    let authModalPromise = null;
    let authModalResolver = null;

    function showAuthModal() {
      if (!authModal) return;
      if (authModal.dataset.visible === 'true') return;
      setAuthSubmitting(false);
      setAuthErrorKey('');
      if (authMessage) authMessage.textContent = translateInstant('authPrompt');
      if (authHint) {
        const host = authHint.dataset.host || window.location.origin;
        authHint.textContent = translateInstant('authHint').replace('{host}', host);
      }
      if (authPasswordInput) authPasswordInput.value = '';
      const storedUser = getStoredAdminUser();
      if (authUserInput && !authUserInput.value && storedUser) {
        authUserInput.value = storedUser;
      }
      authModal.dataset.visible = 'true';
      document.body.classList.add('modal-open');
      setTimeout(() => {
        authUserInput?.focus();
        authUserInput?.select?.();
      }, 15);
    }

    function hideAuthModal() {
      if (!authModal) return;
      authModal.dataset.visible = 'false';
      document.body.classList.remove('modal-open');
      setAuthSubmitting(false);
    }

    function cancelAuthModal() {
      if (!authModal || authModal.dataset.visible !== 'true') return;
      hideAuthModal();
      setAuthErrorKey('');
      if (authModalResolver) authModalResolver(false);
    }

    async function verifyAdminCredentials(header) {
      try {
        const response = await nativeFetch('/api/v1/admin/session', {
          headers: { Authorization: header },
          credentials: 'same-origin',
        });
        return { ok: response.ok, status: response.status };
      } catch (error) {
        return { ok: false, status: 0, error };
      }
    }

    function requestAdminAuth() {
      if (!authModal) return Promise.resolve(false);
      if (authModalPromise) return authModalPromise;
      showAuthModal();
      authModalPromise = new Promise((resolve) => {
        authModalResolver = resolve;
      }).finally(() => {
        authModalPromise = null;
        authModalResolver = null;
      });
      return authModalPromise;
    }

    function createAuthCancelledError() {
      const error = new Error('admin-auth-cancelled');
      error.code = AUTH_CANCELLED_CODE;
      return error;
    }

    async function handleAuthSubmit(event) {
      event?.preventDefault?.();
      if (!authForm) return;
      const username = (authUserInput?.value || '').trim();
      const password = authPasswordInput?.value || '';
      if (!username || !password) {
        setAuthErrorKey('authErrorMissing');
        if (!username) authUserInput?.focus();
        else authPasswordInput?.focus();
        return;
      }
      const header = `Basic ${btoa(`${username}:${password}`)}`;
      setAuthSubmitting(true);
      const result = await verifyAdminCredentials(header);
      setAuthSubmitting(false);
      if (!result.ok) {
        if (result.status === 401) {
          setAuthErrorKey('authErrorInvalid');
          if (authPasswordInput) {
            authPasswordInput.value = '';
            authPasswordInput.focus();
          }
        } else {
          setAuthErrorKey('authErrorNetwork');
        }
        return;
      }
      setAuthHeaderForBase(ADMIN_BASE_KEY, header);
      setStoredAdminUser(username);
      if (authPasswordInput) authPasswordInput.value = '';
      hideAuthModal();
      setAuthErrorKey('');
      if (authModalResolver) authModalResolver(true);
    }

    if (authForm) {
      authForm.addEventListener('submit', handleAuthSubmit);
    }

    if (authCancelBtn) {
      authCancelBtn.addEventListener('click', (event) => {
        event.preventDefault();
        cancelAuthModal();
      });
    }

    if (authModal) {
      authModal.addEventListener('click', (event) => {
        if (event.target === authModal || event.target.classList.contains('auth-backdrop')) {
          event.preventDefault();
          cancelAuthModal();
        }
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && authModal?.dataset.visible === 'true') {
        event.preventDefault();
        event.stopImmediatePropagation();
        cancelAuthModal();
      }
    }, true);

    async function fetchAdmin(url, init = {}) {
      const attempt = async () => {
        const headers = new Headers(init.headers || {});
        const token = getAuthHeaderForBase(ADMIN_BASE_KEY);
        if (token && !headers.has('Authorization')) {
          headers.set('Authorization', token);
        }
        const options = { ...init, headers };
        if (!options.credentials) options.credentials = 'same-origin';
        return nativeFetch(url, options);
      };

      let response;
      try {
        response = await attempt();
      } catch (error) {
        throw error;
      }

      if (response.status !== 401) {
        if (response.status === 403) {
          clearAuthHeaderForBase(ADMIN_BASE_KEY);
        }
        return response;
      }

      const authenticated = await requestAdminAuth();
      if (!authenticated) {
        throw createAuthCancelledError();
      }

      response = await attempt();
      if (response.status === 401) {
        clearAuthHeaderForBase(ADMIN_BASE_KEY);
      }
      return response;
    }

    window.fetch = async function wrappedFetch(input, init = {}) {
      if (typeof input === 'string') {
        if (input.startsWith(ADMIN_PREFIX)) {
          return fetchAdmin(input, init);
        }
        if (input.startsWith(`${ADMIN_BASE_KEY}${ADMIN_PREFIX}`)) {
          return fetchAdmin(input, init);
        }
      }
      return nativeFetch(input, init);
    };

    window.fetch = function basicFetch(input, init = {}) {
      if (typeof input === 'string') {
        if (input.startsWith(ADMIN_PREFIX) || input.startsWith(`${ADMIN_BASE_KEY}${ADMIN_PREFIX}`)) {
          const options = { ...init };
          if (!options.credentials) options.credentials = 'same-origin';
          return nativeFetch(input, options);
        }
      }
      return nativeFetch(input, init);
    };

    const BASE_STRINGS = {
      pillOperations: 'Operations',
      headerTitle: 'Crawler Control Panel',
      headerSubtitle: 'Manage crawling, knowledge base, and infrastructure in one dashboard',
      buttonReorder: 'Reorder blocks',
      buttonReorderDone: 'Done',
      buttonLogout: 'Log out',
      languageLabel: 'Language',
      overviewProjectTitle: 'Project',
      overviewProjectMeta: 'No project selected',
      overviewCrawlerTitle: 'Crawler',
      overviewResourcesTitle: 'Resources',
      overviewLLMTitle: 'LLM insights',
      overviewLLMEmpty: 'Recent prompts will appear here',
      overviewBuildTitle: 'Build',
      cardProjectsTitle: 'Projects',
      buttonAddProject: 'Add project',
      buttonRefreshProjects: 'Refresh list',
      crawlerStatusTitle: 'Crawler status',
      crawlerQueued: 'Queued: {value}',
      crawlerInProgress: 'In progress: {value}',
      crawlerDone: 'Done: {value}',
      crawlerFailed: 'Failed: {value}',
      crawlerLast: 'Last: {value}',
      crawlerProjectLabel: 'Project: {value}',
      crawlerLastUrls: 'Recent URLs',
      servicesTitle: 'Services',
      serviceMongo: 'Mongo: {value}',
      serviceRedis: 'Redis: {value}',
      serviceQdrant: 'Qdrant: {value}',
      serviceOverall: 'Status: {value}',
      resourcesTitle: 'Resources',
      resourceCpuApp: 'CPU (app): {value}',
      resourceCpuSys: 'CPU (sys): {value}',
      resourceRam: 'RAM: {value}',
      resourceRss: 'RSS: {value}',
      resourceGpu: 'GPU: {value}',
      resourcePython: 'Python: {value}',
      manageSection: 'Management',
      crawlerLaunchTitle: 'Crawler launch',
      crawlerLogsTooltip: 'Show logs',
      crawlerLogsHeader: 'Crawler logs',
      crawlerLogsCopy: 'Copy',
      crawlerLogsRefresh: 'Refresh',
      crawlerLogsHide: 'Hide',
      crawlerLogsEmpty: 'Logs will be fetched on demand.',
      crawlerSelectProject: 'Select a project',
      crawlerLaunched: 'Started',
      crawlerLaunchFailed: 'Failed to start',
      crawlerStartError: 'Crawler start error',
      crawlerStopping: 'Stoppingâ€¦',
      crawlerStopFailed: 'Failed to stop',
      crawlerStopError: 'Crawler stop error',
      crawlerActionReset: 'Counters reset',
      crawlerActionDedup: 'Duplicates removed',
      crawlerActionNoData: 'Nothing to copy',
      crawlerActionProcessing: 'Workingâ€¦',
      crawlerActionExecuteError: 'Failed to execute action',
      crawlerStartButton: 'Start',
      crawlerStopButton: 'Stop',
      crawlerResetButton: 'Reset counters',
      crawlerDedupButton: 'Remove duplicate URLs',
      crawlerStartUrl: 'Start URL',
      crawlerDepth: 'Depth',
      crawlerPages: 'Pages',
      crawlerCollectBooks: 'Store full pages for book reading',
      voiceTrainingTitle: 'Voice training',
      voiceTrainingSummary: 'Upload 3+ clean voice clips to teach the assistant to speak like your project.',
      voiceUploadButton: 'Upload clips',
      voiceSamplesEmpty: 'No audio clips uploaded yet.',
      voiceTrainButton: 'Train custom voice',
      promptAiStart: 'Generatingâ€¦',
      promptAiReady: 'Prompt ready',
      promptAiStopped: 'Stopped',
      promptAiError: 'Error: {message}',
      promptAiInvalidDomain: 'Specify a valid domain or URL',
      promptAiEmpty: 'Model returned empty result',
      genericFailed: 'failed',
      logoutProgress: 'Signing outâ€¦',
      logCopyEmpty: 'Nothing to copy',
      logCopySuccess: 'Logs copied',
      logCopyError: 'Failed to copy',
      knowledgeServiceUnavailable: 'Service unavailable for your access level',
      knowledgeServiceLoading: 'Loadingâ€¦',
      knowledgeServiceNoData: 'No data',
      knowledgeServiceUpgrade: 'Service unavailable (update backend)',
      knowledgeServiceFetchError: 'Failed to fetch status',
      knowledgeServiceSaving: 'Savingâ€¦',
      knowledgeServiceSaved: 'Saved',
      knowledgeServiceSaveError: 'Save failed',
      authTitle: 'Administrator sign-in',
      authPrompt: 'Enter administrator credentials to continue.',
      authHint: 'Credentials are sent to {host}.',
      authUsernameLabel: 'Username',
      authUsernamePlaceholder: 'Admin username',
      authPasswordLabel: 'Password',
      authPasswordPlaceholder: 'Admin password',
      authSubmit: 'Sign in',
      authCancel: 'Cancel',
      authStatusChecking: 'Checking credentialsâ€¦',
      authErrorMissing: 'Enter username and password',
      authErrorInvalid: 'Invalid credentials',
      authErrorNetwork: 'Could not verify credentials',
      errorAuthRequired: 'Administrator credentials required',
      developerCredit: 'Created by Ð´ÐµÐ²-Ð±Ð¾Ñ‚-ÑÑƒ',
      feedbackSectionTitle: 'Feedback',
      feedbackStatusOpen: 'Open',
      feedbackStatusInProgress: 'In progress',
      feedbackStatusDone: 'Resolved',
      feedbackStatusDismissed: 'Dismissed',
      feedbackNoItems: 'No feedback yet.',
      feedbackUpdated: 'Updated',
      feedbackError: 'Failed to load feedback',
      backupCardTitle: 'Backups',
      backupScheduleTitle: 'Schedule',
      backupEnableLabel: 'Enable daily backup',
      backupTimeLabel: 'Run at',
      backupTimezoneLabel: 'Timezone',
      backupFolderLabel: 'Remote folder',
      backupFolderPlaceholder: 'sitellm-backups',
      backupTokenLabel: 'OAuth token',
      backupTokenPlaceholder: 'Paste Yandex.Disk OAuth token',
      backupTokenSave: 'Save token',
      backupTokenClear: 'Remove token',
      backupTokenSaved: 'Token saved',
      backupTokenRequired: 'Enter OAuth token',
      backupScheduleSave: 'Save schedule',
      backupManualTitle: 'Manual actions',
      backupRunNow: 'Create backup now',
      backupRefresh: 'Refresh status',
      backupRestoreLabel: 'Restore from path',
      backupRestorePlaceholder: '/backups/archive.gz',
      backupRestoreButton: 'Restore',
      backupJobsTitle: 'Recent jobs',
      backupJobsEmpty: 'No jobs yet.',
      backupStatusLineWaiting: 'Backups disabled',
      backupStatusLineQueued: 'Next run queued',
      backupStatusLineActive: 'Backup in progressâ€¦',
      backupTokenMissing: 'Token not configured',
      backupStatusLastRun: 'Last run: {value}',
      backupStatusLastSuccess: 'Last success: {value}',
      backupStatusNever: 'No backups performed yet',
      backupJobStatusQueued: 'Status: queued',
      backupJobStatusRunning: 'Status: running',
      backupJobStatusCompleted: 'Status: completed',
      backupJobStatusFailed: 'Status: failed',
      backupJobOperationBackup: 'Backup',
      backupJobOperationRestore: 'Restore',
      backupJobRestore: 'Restore',
      backupJobCopyPath: 'Copy path',
      backupJobsFetchError: 'Failed to load backup status',
      backupSaveSuccess: 'Backup settings saved',
      backupSaveError: 'Could not save settings',
      backupRunQueued: 'Backup job queued',
      backupRestoreQueued: 'Restore job queued',
      backupRestorePathMissing: 'Specify remote path',
      backupActiveJobMessage: 'An operation is already running'
    };

    function createLanguage(name, dir, overrides = {}) {
      return { name, dir, strings: { ...BASE_STRINGS, ...overrides } };
    }

    const LANGUAGES = {
      en: createLanguage('English', 'ltr'),
      es: createLanguage('EspaÃ±ol', 'ltr', {
        pillOperations: 'Operaciones',
        headerTitle: 'Panel de control del rastreador',
        headerSubtitle: 'Gestiona el rastreo, la base de conocimiento y la infraestructura desde un solo panel',
        buttonReorder: 'Reordenar bloques',
        buttonReorderDone: 'Listo',
        buttonLogout: 'Cerrar sesiÃ³n',
        languageLabel: 'Idioma',
        overviewProjectTitle: 'Proyecto',
        overviewProjectMeta: 'Sin proyecto seleccionado',
        overviewCrawlerTitle: 'Rastreo',
        overviewResourcesTitle: 'Recursos',
        overviewLLMTitle: 'InformaciÃ³n del LLM',
        overviewLLMEmpty: 'Los prompts recientes aparecerÃ¡n aquÃ­',
        overviewBuildTitle: 'VersiÃ³n',
        cardProjectsTitle: 'Proyectos',
        buttonAddProject: 'AÃ±adir proyecto',
        buttonRefreshProjects: 'Actualizar lista',
        crawlerStatusTitle: 'Estado del rastreador',
        crawlerQueued: 'En cola: {value}',
        crawlerInProgress: 'En progreso: {value}',
        crawlerDone: 'Completadas: {value}',
        crawlerFailed: 'Fallidas: {value}',
        crawlerLast: 'Ãšltimo: {value}',
        crawlerProjectLabel: 'Proyecto: {value}',
        crawlerLastUrls: 'Ãšltimas URL',
        servicesTitle: 'Servicios',
        serviceMongo: 'Mongo: {value}',
        serviceRedis: 'Redis: {value}',
        serviceQdrant: 'Qdrant: {value}',
        serviceOverall: 'Estado: {value}',
        resourcesTitle: 'Recursos',
        resourceCpuApp: 'CPU (app): {value}',
        resourceCpuSys: 'CPU (sistema): {value}',
        resourceRam: 'RAM: {value}',
        resourceRss: 'RSS: {value}',
        resourceGpu: 'GPU: {value}',
        resourcePython: 'Python: {value}',
        manageSection: 'GestiÃ³n',
        crawlerLaunchTitle: 'Inicio del rastreador',
        crawlerLogsTooltip: 'Mostrar registros',
        crawlerLogsHeader: 'Registros del rastreador',
        crawlerLogsCopy: 'Copiar',
        crawlerLogsRefresh: 'Actualizar',
        crawlerLogsHide: 'Ocultar',
        crawlerLogsEmpty: 'Los registros se cargarÃ¡n bajo demanda.',
        crawlerSelectProject: 'Selecciona un proyecto',
        crawlerLaunched: 'Iniciado',
        crawlerLaunchFailed: 'No se pudo iniciar',
        crawlerStartError: 'Error al iniciar el rastreador',
        crawlerStopping: 'Deteniendoâ€¦',
        crawlerStopFailed: 'No se pudo detener',
        crawlerStopError: 'Error al detener el rastreador',
        crawlerActionReset: 'Contadores reiniciados',
        crawlerActionDedup: 'Duplicados eliminados',
        crawlerActionNoData: 'Nada que copiar',
        crawlerActionProcessing: 'Trabajandoâ€¦',
        crawlerActionExecuteError: 'Error al ejecutar la acciÃ³n',
        crawlerStartButton: 'Iniciar',
        crawlerStopButton: 'Detener',
        crawlerResetButton: 'Reiniciar contadores',
        crawlerDedupButton: 'Eliminar URL duplicadas',
        crawlerStartUrl: 'URL inicial',
        crawlerDepth: 'Profundidad',
        crawlerPages: 'PÃ¡ginas',
        crawlerCollectBooks: 'Guardar pÃ¡ginas completas para modo lectura',
        voiceTrainingTitle: 'Entrenamiento de voz',
        voiceTrainingSummary: 'Sube 3 o mÃ¡s clips limpios para que el asistente hable con la voz de tu proyecto.',
        voiceUploadButton: 'Subir clips',
        voiceSamplesEmpty: 'AÃºn no hay audios cargados.',
        voiceTrainButton: 'Entrenar voz personalizada',
        crawlerCollectBooks: 'Guardar pÃ¡ginas completas para modo lectura',
        promptAiStart: 'Generandoâ€¦',
        promptAiReady: 'Prompt listo',
        promptAiStopped: 'Detenido',
        promptAiError: 'Error: {message}',
        promptAiInvalidDomain: 'Especifica un dominio o URL vÃ¡lido',
        promptAiEmpty: 'El modelo devolviÃ³ un resultado vacÃ­o',
        genericFailed: 'fallÃ³',
        logoutProgress: 'Cerrando sesiÃ³nâ€¦',
        logCopyEmpty: 'Nada que copiar',
        logCopySuccess: 'Registros copiados',
        logCopyError: 'No se pudo copiar',
        knowledgeServiceUnavailable: 'Servicio no disponible para tu nivel de acceso',
        knowledgeServiceLoading: 'Cargandoâ€¦',
        knowledgeServiceNoData: 'Sin datos',
        knowledgeServiceUpgrade: 'Servicio no disponible (actualiza el backend)',
        knowledgeServiceFetchError: 'Error al obtener el estado',
        knowledgeServiceSaving: 'Guardandoâ€¦',
        knowledgeServiceSaved: 'Guardado',
        knowledgeServiceSaveError: 'Error al guardar'
      }),
      de: createLanguage('Deutsch', 'ltr', {
        pillOperations: 'Betrieb',
        headerTitle: 'Crawler-Steuerzentrale',
        headerSubtitle: 'Verwalte Crawling, Wissensbasis und Infrastruktur in einem Dashboard',
        buttonReorder: 'BlÃ¶cke neu ordnen',
        buttonReorderDone: 'Fertig',
        buttonLogout: 'Abmelden',
        languageLabel: 'Sprache',
        overviewProjectTitle: 'Projekt',
        overviewProjectMeta: 'Kein Projekt ausgewÃ¤hlt',
        overviewCrawlerTitle: 'Crawler',
        overviewResourcesTitle: 'Ressourcen',
        overviewLLMTitle: 'LLM-Einblicke',
        overviewLLMEmpty: 'Aktuelle Prompts erscheinen hier',
        overviewBuildTitle: 'Build',
        cardProjectsTitle: 'Projekte',
        buttonAddProject: 'Projekt hinzufÃ¼gen',
        buttonRefreshProjects: 'Liste aktualisieren',
        crawlerStatusTitle: 'Crawler-Status',
        crawlerQueued: 'In Warteschlange: {value}',
        crawlerInProgress: 'In Arbeit: {value}',
        crawlerDone: 'Fertig: {value}',
        crawlerFailed: 'Fehlgeschlagen: {value}',
        crawlerLast: 'Zuletzt: {value}',
        crawlerProjectLabel: 'Projekt: {value}',
        crawlerLastUrls: 'Neueste URLs',
        servicesTitle: 'Dienste',
        serviceMongo: 'Mongo: {value}',
        serviceRedis: 'Redis: {value}',
        serviceQdrant: 'Qdrant: {value}',
        serviceOverall: 'Status: {value}',
        resourcesTitle: 'Ressourcen',
        resourceCpuApp: 'CPU (App): {value}',
        resourceCpuSys: 'CPU (System): {value}',
        resourceRam: 'RAM: {value}',
        resourceRss: 'RSS: {value}',
        resourceGpu: 'GPU: {value}',
        resourcePython: 'Python: {value}',
        manageSection: 'Verwaltung',
        crawlerLaunchTitle: 'Crawler-Start',
        crawlerLogsTooltip: 'Protokolle anzeigen',
        crawlerLogsHeader: 'Crawler-Protokolle',
        crawlerLogsCopy: 'Kopieren',
        crawlerLogsRefresh: 'Aktualisieren',
        crawlerLogsHide: 'Ausblenden',
        crawlerLogsEmpty: 'Protokolle werden bei Bedarf geladen.',
        crawlerSelectProject: 'Projekt auswÃ¤hlen',
        crawlerLaunched: 'Gestartet',
        crawlerLaunchFailed: 'Start fehlgeschlagen',
        crawlerStartError: 'Crawler-Startfehler',
        crawlerStopping: 'Wird gestopptâ€¦',
        crawlerStopFailed: 'Stopp fehlgeschlagen',
        crawlerStopError: 'Crawler-Stoppfehler',
        crawlerActionReset: 'ZÃ¤hler zurÃ¼ckgesetzt',
        crawlerActionDedup: 'Duplikate entfernt',
        crawlerActionNoData: 'Nichts zu kopieren',
        crawlerActionProcessing: 'In Arbeitâ€¦',
        crawlerActionExecuteError: 'Aktion konnte nicht ausgefÃ¼hrt werden',
        crawlerStartButton: 'Starten',
        crawlerStopButton: 'Stoppen',
        crawlerResetButton: 'ZÃ¤hler zurÃ¼cksetzen',
        crawlerDedupButton: 'Doppelte URLs entfernen',
        crawlerStartUrl: 'Start-URL',
        crawlerDepth: 'Tiefe',
        crawlerPages: 'Seiten',
        crawlerCollectBooks: 'Komplette Seiten fÃ¼r Lesemodus speichern',
        voiceTrainingTitle: 'Stimmtraining',
        voiceTrainingSummary: 'Laden Sie mindestens 3 saubere Sprachaufnahmen hoch, damit der Assistent mit Ihrer Stimme spricht.',
        voiceUploadButton: 'Clips hochladen',
        voiceSamplesEmpty: 'Noch keine Audiodateien hochgeladen.',
        voiceTrainButton: 'Eigene Stimme trainieren',
        crawlerCollectBooks: 'Komplette Seiten fÃ¼r Lesemodus speichern',
        promptAiStart: 'Generiereâ€¦',
        promptAiReady: 'Prompt bereit',
        promptAiStopped: 'Gestoppt',
        promptAiError: 'Fehler: {message}',
        promptAiInvalidDomain: 'Gib eine gÃ¼ltige Domain oder URL an',
        promptAiEmpty: 'Modell gab ein leeres Ergebnis zurÃ¼ck',
        genericFailed: 'fehlgeschlagen',
        logoutProgress: 'Abmeldenâ€¦',
        logCopyEmpty: 'Nichts zu kopieren',
        logCopySuccess: 'Protokolle kopiert',
        logCopyError: 'Kopieren fehlgeschlagen',
        knowledgeServiceUnavailable: 'Dienst fÃ¼r deine Zugriffsstufe nicht verfÃ¼gbar',
        knowledgeServiceLoading: 'LÃ¤dtâ€¦',
        knowledgeServiceNoData: 'Keine Daten',
        knowledgeServiceUpgrade: 'Dienst nicht verfÃ¼gbar (Backend aktualisieren)',
        knowledgeServiceFetchError: 'Status konnte nicht abgerufen werden',
        knowledgeServiceSaving: 'Speichernâ€¦',
        knowledgeServiceSaved: 'Gespeichert',
        knowledgeServiceSaveError: 'Speichern fehlgeschlagen'
      }),
      fr: createLanguage('FranÃ§ais', 'ltr', {
        pillOperations: 'OpÃ©rations',
        headerTitle: 'Panneau de contrÃ´le du crawler',
        headerSubtitle: 'GÃ©rez le crawling, la base de connaissances et lâ€™infrastructure depuis un seul tableau de bord',
        buttonReorder: 'RÃ©organiser les blocs',
        buttonReorderDone: 'TerminÃ©',
        buttonLogout: 'DÃ©connexion',
        languageLabel: 'Langue',
        overviewProjectTitle: 'Projet',
        overviewProjectMeta: 'Aucun projet sÃ©lectionnÃ©',
        overviewCrawlerTitle: 'Crawler',
        overviewResourcesTitle: 'Ressources',
        overviewLLMTitle: 'AperÃ§us LLM',
        overviewLLMEmpty: 'Les invites rÃ©centes apparaÃ®tront ici',
        overviewBuildTitle: 'Version',
        cardProjectsTitle: 'Projets',
        buttonAddProject: 'Ajouter un projet',
        buttonRefreshProjects: 'Actualiser la liste',
        crawlerStatusTitle: 'Statut du crawler',
        crawlerQueued: 'En file dâ€™attente : {value}',
        crawlerInProgress: 'En cours : {value}',
        crawlerDone: 'TerminÃ© : {value}',
        crawlerFailed: 'Ã‰checs : {value}',
        crawlerLast: 'Dernier : {value}',
        crawlerProjectLabel: 'Projet : {value}',
        crawlerLastUrls: 'DerniÃ¨res URL',
        servicesTitle: 'Services',
        serviceMongo: 'Mongo : {value}',
        serviceRedis: 'Redis : {value}',
        serviceQdrant: 'Qdrant : {value}',
        serviceOverall: 'Statut : {value}',
        resourcesTitle: 'Ressources',
        resourceCpuApp: 'CPU (app) : {value}',
        resourceCpuSys: 'CPU (systÃ¨me) : {value}',
        resourceRam: 'RAM : {value}',
        resourceRss: 'RSS : {value}',
        resourceGpu: 'GPU : {value}',
        resourcePython: 'Python : {value}',
        manageSection: 'Gestion',
        crawlerLaunchTitle: 'Lancement du crawler',
        crawlerLogsTooltip: 'Afficher les journaux',
        crawlerLogsHeader: 'Journaux du crawler',
        crawlerLogsCopy: 'Copier',
        crawlerLogsRefresh: 'Actualiser',
        crawlerLogsHide: 'Masquer',
        crawlerLogsEmpty: 'Les journaux seront chargÃ©s Ã  la demande.',
        crawlerSelectProject: 'SÃ©lectionnez un projet',
        crawlerLaunched: 'DÃ©marrÃ©',
        crawlerLaunchFailed: 'Ã‰chec du dÃ©marrage',
        crawlerStartError: 'Erreur de dÃ©marrage du crawler',
        crawlerStopping: 'ArrÃªtâ€¦',
        crawlerStopFailed: 'Ã‰chec de lâ€™arrÃªt',
        crawlerStopError: 'Erreur dâ€™arrÃªt du crawler',
        crawlerActionReset: 'Compteurs rÃ©initialisÃ©s',
        crawlerActionDedup: 'Doublons supprimÃ©s',
        crawlerActionNoData: 'Rien Ã  copier',
        crawlerActionProcessing: 'Traitementâ€¦',
        crawlerActionExecuteError: 'Impossible dâ€™exÃ©cuter lâ€™action',
        crawlerStartButton: 'DÃ©marrer',
        crawlerStopButton: 'ArrÃªter',
        crawlerResetButton: 'RÃ©initialiser les compteurs',
        crawlerDedupButton: 'Supprimer les URL dupliquÃ©es',
        crawlerStartUrl: 'URL de dÃ©part',
        crawlerDepth: 'Profondeur',
        crawlerPages: 'Pages',
        crawlerCollectBooks: 'Conserver les pages complÃ¨tes pour la lecture',
        voiceTrainingTitle: 'EntraÃ®nement vocal',
        voiceTrainingSummary: 'Importez au moins 3 extraits audio propres pour que lâ€™assistant parle avec la voix de votre projet.',
        voiceUploadButton: 'TÃ©lÃ©verser des extraits',
        voiceSamplesEmpty: 'Aucun extrait audio tÃ©lÃ©versÃ© pour le moment.',
        voiceTrainButton: 'EntraÃ®ner la voix personnalisÃ©e',
        crawlerCollectBooks: 'Conserver les pages complÃ¨tes pour la lecture',
        promptAiStart: 'GÃ©nÃ©rationâ€¦',
        promptAiReady: 'Invite prÃªte',
        promptAiStopped: 'ArrÃªtÃ©',
        promptAiError: 'Erreur : {message}',
        promptAiInvalidDomain: 'Indiquez un domaine ou une URL valide',
        promptAiEmpty: 'Le modÃ¨le a renvoyÃ© un rÃ©sultat vide',
        genericFailed: 'Ã©chec',
        logoutProgress: 'DÃ©connexionâ€¦',
        logCopyEmpty: 'Rien Ã  copier',
        logCopySuccess: 'Journaux copiÃ©s',
        logCopyError: 'Copie impossible',
        knowledgeServiceUnavailable: 'Service indisponible pour votre niveau dâ€™accÃ¨s',
        knowledgeServiceLoading: 'Chargementâ€¦',
        knowledgeServiceNoData: 'Aucune donnÃ©e',
        knowledgeServiceUpgrade: 'Service indisponible (mettez Ã  jour le backend)',
        knowledgeServiceFetchError: 'Ã‰chec de rÃ©cupÃ©ration du statut',
        knowledgeServiceSaving: 'Enregistrementâ€¦',
        knowledgeServiceSaved: 'EnregistrÃ©',
        knowledgeServiceSaveError: 'Ã‰chec de lâ€™enregistrement'
      }),
      it: createLanguage('Italiano', 'ltr', {
        pillOperations: 'Operazioni',
        headerTitle: 'Pannello di controllo del crawler',
        headerSubtitle: 'Gestisci crawling, base di conoscenza e infrastruttura da unâ€™unica dashboard',
        buttonReorder: 'Riordina blocchi',
        buttonReorderDone: 'Fine',
        buttonLogout: 'Esci',
        languageLabel: 'Lingua',
        overviewProjectTitle: 'Progetto',
        overviewProjectMeta: 'Nessun progetto selezionato',
        overviewCrawlerTitle: 'Crawler',
        overviewResourcesTitle: 'Risorse',
        overviewLLMTitle: 'Approfondimenti LLM',
        overviewLLMEmpty: 'I prompt recenti appariranno qui',
        overviewBuildTitle: 'Build',
        cardProjectsTitle: 'Progetti',
        buttonAddProject: 'Aggiungi progetto',
        buttonRefreshProjects: 'Aggiorna elenco',
        crawlerStatusTitle: 'Stato del crawler',
        crawlerQueued: 'In coda: {value}',
        crawlerInProgress: 'In esecuzione: {value}',
        crawlerDone: 'Completati: {value}',
        crawlerFailed: 'Non riusciti: {value}',
        crawlerLast: 'Ultimo: {value}',
        crawlerProjectLabel: 'Progetto: {value}',
        crawlerLastUrls: 'Ultimi URL',
        servicesTitle: 'Servizi',
        serviceMongo: 'Mongo: {value}',
        serviceRedis: 'Redis: {value}',
        serviceQdrant: 'Qdrant: {value}',
        serviceOverall: 'Stato: {value}',
        resourcesTitle: 'Risorse',
        resourceCpuApp: 'CPU (app): {value}',
        resourceCpuSys: 'CPU (sistema): {value}',
        resourceRam: 'RAM: {value}',
        resourceRss: 'RSS: {value}',
        resourceGpu: 'GPU: {value}',
        resourcePython: 'Python: {value}',
        manageSection: 'Gestione',
        crawlerLaunchTitle: 'Avvio crawler',
        crawlerLogsTooltip: 'Mostra log',
        crawlerLogsHeader: 'Log del crawler',
        crawlerLogsCopy: 'Copia',
        crawlerLogsRefresh: 'Aggiorna',
        crawlerLogsHide: 'Nascondi',
        crawlerLogsEmpty: 'I log verranno caricati su richiesta.',
        crawlerSelectProject: 'Seleziona un progetto',
        crawlerLaunched: 'Avviato',
        crawlerLaunchFailed: 'Avvio non riuscito',
        crawlerStartError: 'Errore di avvio del crawler',
        crawlerStopping: 'Arrestoâ€¦',
        crawlerStopFailed: 'Arresto non riuscito',
        crawlerStopError: 'Errore di arresto del crawler',
        crawlerActionReset: 'Contatori azzerati',
        crawlerActionDedup: 'Duplicati rimossi',
        crawlerActionNoData: 'Niente da copiare',
        crawlerActionProcessing: 'Elaborazioneâ€¦',
        crawlerActionExecuteError: 'Impossibile eseguire lâ€™azione',
        crawlerStartButton: 'Avvia',
        crawlerStopButton: 'Ferma',
        crawlerResetButton: 'Azzera contatori',
        crawlerDedupButton: 'Rimuovi URL duplicati',
        crawlerStartUrl: 'URL iniziale',
        crawlerDepth: 'ProfonditÃ ',
        crawlerPages: 'Pagine',
        crawlerCollectBooks: 'Salva le pagine complete per la lettura',
        voiceTrainingTitle: 'Addestramento voce',
        voiceTrainingSummary: 'Carica almeno 3 clip pulite per far parlare lâ€™assistente con la voce del progetto.',
        voiceUploadButton: 'Carica clip',
        voiceSamplesEmpty: 'Nessuna traccia caricata.',
        voiceTrainButton: 'Addestra voce personalizzata',
        crawlerCollectBooks: 'Salva le pagine complete per la lettura',
        promptAiStart: 'Generazioneâ€¦',
        promptAiReady: 'Prompt pronto',
        promptAiStopped: 'Interrotto',
        promptAiError: 'Errore: {message}',
        promptAiInvalidDomain: 'Specifica un dominio o URL valido',
        promptAiEmpty: 'Il modello ha restituito un risultato vuoto',
        genericFailed: 'non riuscito',
        logoutProgress: 'Disconnessioneâ€¦',
        logCopyEmpty: 'Niente da copiare',
        logCopySuccess: 'Log copiati',
        logCopyError: 'Copia non riuscita',
        knowledgeServiceUnavailable: 'Servizio non disponibile per il tuo livello di accesso',
        knowledgeServiceLoading: 'Caricamentoâ€¦',
        knowledgeServiceNoData: 'Nessun dato',
        knowledgeServiceUpgrade: 'Servizio non disponibile (aggiorna il backend)',
        knowledgeServiceFetchError: 'Impossibile ottenere lo stato',
        knowledgeServiceSaving: 'Salvataggioâ€¦',
        knowledgeServiceSaved: 'Salvato',
        knowledgeServiceSaveError: 'Errore durante il salvataggio'
      }),
      pt: createLanguage('PortuguÃªs', 'ltr', {
        pillOperations: 'OperaÃ§Ãµes',
        headerTitle: 'Painel de controle do crawler',
        headerSubtitle: 'Gerencie o rastreamento, a base de conhecimento e a infraestrutura em um Ãºnico painel',
        buttonReorder: 'Reordenar blocos',
        buttonReorderDone: 'ConcluÃ­do',
        buttonLogout: 'Sair',
        languageLabel: 'Idioma',
        overviewProjectTitle: 'Projeto',
        overviewProjectMeta: 'Nenhum projeto selecionado',
        overviewCrawlerTitle: 'Crawler',
        overviewResourcesTitle: 'Recursos',
        overviewLLMTitle: 'Insights do LLM',
        overviewLLMEmpty: 'Os prompts recentes aparecerÃ£o aqui',
        overviewBuildTitle: 'Build',
        cardProjectsTitle: 'Projetos',
        buttonAddProject: 'Adicionar projeto',
        buttonRefreshProjects: 'Atualizar lista',
        crawlerStatusTitle: 'Status do crawler',
        crawlerQueued: 'Na fila: {value}',
        crawlerInProgress: 'Em andamento: {value}',
        crawlerDone: 'ConcluÃ­dos: {value}',
        crawlerFailed: 'Falhas: {value}',
        crawlerLast: 'Ãšltimo: {value}',
        crawlerProjectLabel: 'Projeto: {value}',
        crawlerLastUrls: 'Ãšltimas URLs',
        servicesTitle: 'ServiÃ§os',
        serviceMongo: 'Mongo: {value}',
        serviceRedis: 'Redis: {value}',
        serviceQdrant: 'Qdrant: {value}',
        serviceOverall: 'Status: {value}',
        resourcesTitle: 'Recursos',
        resourceCpuApp: 'CPU (app): {value}',
        resourceCpuSys: 'CPU (sistema): {value}',
        resourceRam: 'RAM: {value}',
        resourceRss: 'RSS: {value}',
        resourceGpu: 'GPU: {value}',
        resourcePython: 'Python: {value}',
        manageSection: 'GestÃ£o',
        crawlerLaunchTitle: 'InicializaÃ§Ã£o do crawler',
        crawlerLogsTooltip: 'Mostrar logs',
        crawlerLogsHeader: 'Logs do crawler',
        crawlerLogsCopy: 'Copiar',
        crawlerLogsRefresh: 'Atualizar',
        crawlerLogsHide: 'Ocultar',
        crawlerLogsEmpty: 'Os logs serÃ£o carregados sob demanda.',
        crawlerSelectProject: 'Selecione um projeto',
        crawlerLaunched: 'Iniciado',
        crawlerLaunchFailed: 'Falha ao iniciar',
        crawlerStartError: 'Erro ao iniciar o crawler',
        crawlerStopping: 'Parandoâ€¦',
        crawlerStopFailed: 'Falha ao parar',
        crawlerStopError: 'Erro ao parar o crawler',
        crawlerActionReset: 'Contadores redefinidos',
        crawlerActionDedup: 'Duplicatas removidas',
        crawlerActionNoData: 'Nada para copiar',
        crawlerActionProcessing: 'Processandoâ€¦',
        crawlerActionExecuteError: 'Falha ao executar aÃ§Ã£o',
        crawlerStartButton: 'Iniciar',
        crawlerStopButton: 'Parar',
        crawlerResetButton: 'Redefinir contadores',
        crawlerDedupButton: 'Remover URLs duplicadas',
        crawlerStartUrl: 'URL inicial',
        crawlerDepth: 'Profundidade',
        crawlerPages: 'PÃ¡ginas',
        crawlerCollectBooks: 'Guardar pÃ¡ginas completas para modo leitura',
        voiceTrainingTitle: 'Treinamento de voz',
        voiceTrainingSummary: 'Envie 3+ clipes limpos para que o assistente fale com a voz do projeto.',
        voiceUploadButton: 'Enviar clipes',
        voiceSamplesEmpty: 'Nenhum Ã¡udio enviado ainda.',
        voiceTrainButton: 'Treinar voz personalizada',
        crawlerCollectBooks: 'Guardar pÃ¡ginas completas para modo leitura',
        promptAiStart: 'Gerandoâ€¦',
        promptAiReady: 'Prompt pronto',
        promptAiStopped: 'Parado',
        promptAiError: 'Erro: {message}',
        promptAiInvalidDomain: 'Informe um domÃ­nio ou URL vÃ¡lido',
        promptAiEmpty: 'O modelo retornou um resultado vazio',
        genericFailed: 'falhou',
        logoutProgress: 'Saindoâ€¦',
        logCopyEmpty: 'Nada para copiar',
        logCopySuccess: 'Logs copiados',
        logCopyError: 'Falha ao copiar',
        knowledgeServiceUnavailable: 'ServiÃ§o indisponÃ­vel para o seu nÃ­vel de acesso',
        knowledgeServiceLoading: 'Carregandoâ€¦',
        knowledgeServiceNoData: 'Sem dados',
        knowledgeServiceUpgrade: 'ServiÃ§o indisponÃ­vel (atualize o backend)',
        knowledgeServiceFetchError: 'Falha ao obter status',
        knowledgeServiceSaving: 'Salvandoâ€¦',
        knowledgeServiceSaved: 'Salvo',
        knowledgeServiceSaveError: 'Erro ao salvar'
      }),
      ru: createLanguage('Ð ÑƒÑÑÐºÐ¸Ð¹', 'ltr', {
        pillOperations: 'ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¸',
        headerTitle: 'ÐŸÐ°Ð½ÐµÐ»ÑŒ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð¾Ð¼',
        headerSubtitle: 'Ð£Ð¿Ñ€Ð°Ð²Ð»ÑÐ¹Ñ‚Ðµ ÐºÑ€Ð°ÑƒÐ»Ð¸Ð½Ð³Ð¾Ð¼, Ð±Ð°Ð·Ð¾Ð¹ Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸ÐµÐ¼ Ð² Ð¾Ð´Ð½Ð¾Ð¼ Ð¾ÐºÐ½Ðµ',
        buttonReorder: 'Ð£Ð¿Ð¾Ñ€ÑÐ´Ð¾Ñ‡Ð¸Ñ‚ÑŒ Ð±Ð»Ð¾ÐºÐ¸',
        buttonReorderDone: 'Ð“Ð¾Ñ‚Ð¾Ð²Ð¾',
        buttonLogout: 'Ð’Ñ‹Ð¹Ñ‚Ð¸',
        languageLabel: 'Ð¯Ð·Ñ‹Ðº',
        overviewProjectTitle: 'ÐŸÑ€Ð¾ÐµÐºÑ‚',
        overviewProjectMeta: 'ÐÐµÑ‚ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°',
        overviewCrawlerTitle: 'ÐšÑ€Ð°ÑƒÐ»Ð¸Ð½Ð³',
        overviewResourcesTitle: 'Ð ÐµÑÑƒÑ€ÑÑ‹',
        overviewLLMTitle: 'LLM Ð¼Ñ‹ÑÐ»Ð¸',
        overviewLLMEmpty: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð·Ð´ÐµÑÑŒ',
        overviewBuildTitle: 'Ð¡Ð±Ð¾Ñ€ÐºÐ°',
        cardProjectsTitle: 'ÐŸÑ€Ð¾ÐµÐºÑ‚Ñ‹',
        buttonAddProject: 'Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚',
        buttonRefreshProjects: 'ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº',
        crawlerStatusTitle: 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð°',
        crawlerQueued: 'Ð’ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸: {value}',
        crawlerInProgress: 'Ð’ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ: {value}',
        crawlerDone: 'Ð“Ð¾Ñ‚Ð¾Ð²Ð¾: {value}',
        crawlerFailed: 'ÐžÑˆÐ¸Ð±Ð¾Ðº: {value}',
        crawlerLast: 'ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹: {value}',
        crawlerProjectLabel: 'ÐŸÑ€Ð¾ÐµÐºÑ‚: {value}',
        crawlerLastUrls: 'ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ URL',
        servicesTitle: 'Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹',
        serviceMongo: 'Mongo: {value}',
        serviceRedis: 'Redis: {value}',
        serviceQdrant: 'Qdrant: {value}',
        serviceOverall: 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: {value}',
        resourcesTitle: 'Ð ÐµÑÑƒÑ€ÑÑ‹',
        resourceCpuApp: 'CPU (Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ): {value}',
        resourceCpuSys: 'CPU (ÑÐ¸ÑÑ‚ÐµÐ¼Ð°): {value}',
        resourceRam: 'RAM: {value}',
        resourceRss: 'RSS: {value}',
        resourceGpu: 'GPU: {value}',
        resourcePython: 'Python: {value}',
        manageSection: 'Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ',
        crawlerLaunchTitle: 'Ð—Ð°Ð¿ÑƒÑÐº ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð°',
        crawlerLogsTooltip: 'ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸',
        crawlerLogsHeader: 'Ð›Ð¾Ð³Ð¸ ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð°',
        crawlerLogsCopy: 'Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ',
        crawlerLogsRefresh: 'ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ',
        crawlerLogsHide: 'Ð¡ÐºÑ€Ñ‹Ñ‚ÑŒ',
        crawlerLogsEmpty: 'Ð›Ð¾Ð³Ð¸ Ð±ÑƒÐ´ÑƒÑ‚ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ.',
        crawlerSelectProject: 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚',
        crawlerLaunched: 'Ð—Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾',
        crawlerLaunchFailed: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ',
        crawlerStartError: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð°',
        crawlerStopping: 'ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼â€¦',
        crawlerStopFailed: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ',
        crawlerStopError: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸',
        crawlerActionReset: 'Ð¡Ñ‡Ñ‘Ñ‚Ñ‡Ð¸ÐºÐ¸ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹',
        crawlerActionDedup: 'Ð”ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹',
        crawlerActionNoData: 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ',
        crawlerActionProcessing: 'Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼â€¦',
        crawlerActionExecuteError: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ',
        crawlerStartButton: 'Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ',
        crawlerStopButton: 'ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ',
        crawlerResetButton: 'Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ ÑÑ‡Ñ‘Ñ‚Ñ‡Ð¸ÐºÐ¸',
        crawlerDedupButton: 'Ð£Ð±Ñ€Ð°Ñ‚ÑŒ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ URL',
        crawlerStartUrl: 'Ð¡Ñ‚Ð°Ñ€Ñ‚Ð¾Ð²Ñ‹Ð¹ URL',
        crawlerDepth: 'Ð“Ð»ÑƒÐ±Ð¸Ð½Ð°',
        crawlerPages: 'Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹',
        crawlerCollectBooks: 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ†ÐµÐ»Ð¸ÐºÐ¾Ð¼ Ð´Ð»Ñ Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ',
        voiceTrainingTitle: 'ÐžÐ±ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð³Ð¾Ð»Ð¾ÑÐ°',
        voiceTrainingSummary: 'Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ 3+ Ð°ÑƒÐ´Ð¸Ð¾Ð´Ð¾Ñ€Ð¾Ð¶ÐºÐ¸ Ñ Ñ‡Ð¸ÑÑ‚Ð¾Ð¹ Ñ€ÐµÑ‡ÑŒÑŽ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ð» Ð³Ð¾Ð»Ð¾ÑÐ¾Ð¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.',
        voiceUploadButton: 'Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð¾Ñ€Ð¾Ð¶ÐºÐ¸',
        voiceSamplesEmpty: 'Ð”Ð¾Ñ€Ð¾Ð¶ÐºÐ¸ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹.',
        voiceTrainButton: 'ÐžÐ±ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾Ñ',
        promptAiStart: 'Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼â€¦',
        promptAiReady: 'ÐŸÑ€Ð¾Ð¼Ñ‚ Ð³Ð¾Ñ‚Ð¾Ð²',
        promptAiStopped: 'ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾',
        promptAiError: 'ÐžÑˆÐ¸Ð±ÐºÐ°: {message}',
        promptAiInvalidDomain: 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ð´Ð¾Ð¼ÐµÐ½ Ð¸Ð»Ð¸ URL',
        promptAiEmpty: 'ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð²ÐµÑ€Ð½ÑƒÐ»Ð° Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚',
        genericFailed: 'Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ',
        logoutProgress: 'Ð’Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼â€¦',
        logCopyEmpty: 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ',
        logCopySuccess: 'Ð›Ð¾Ð³Ð¸ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹',
        logCopyError: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ',
        knowledgeServiceUnavailable: 'Ð¡ÐµÑ€Ð²Ð¸Ñ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°',
        knowledgeServiceLoading: 'Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼â€¦',
        knowledgeServiceNoData: 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…',
        knowledgeServiceUpgrade: 'Ð¡ÐµÑ€Ð²Ð¸Ñ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ (Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ backend)',
        knowledgeServiceFetchError: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ',
        knowledgeServiceSaving: 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼â€¦',
        knowledgeServiceSaved: 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾',
        knowledgeServiceSaveError: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ',
        backupCardTitle: 'Ð ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¿Ð¸Ð¸',
        backupScheduleTitle: 'Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ',
        backupEnableLabel: 'Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ',
        backupTimeLabel: 'Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°',
        backupTimezoneLabel: 'Ð§Ð°ÑÐ¾Ð²Ð¾Ð¹ Ð¿Ð¾ÑÑ',
        backupFolderLabel: 'ÐŸÐ°Ð¿ÐºÐ° Ð½Ð° Ð¯Ð½Ð´ÐµÐºÑ.Ð”Ð¸ÑÐºÐµ',
        backupFolderPlaceholder: 'sitellm-backups',
        backupTokenLabel: 'OAuth Ñ‚Ð¾ÐºÐµÐ½',
        backupTokenPlaceholder: 'Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ OAuth Ñ‚Ð¾ÐºÐµÐ½ Ð¯Ð½Ð´ÐµÐºÑ.Ð”Ð¸ÑÐºÐ°',
        backupTokenSave: 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ‚Ð¾ÐºÐµÐ½',
        backupTokenClear: 'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ð¾ÐºÐµÐ½',
        backupTokenSaved: 'Ð¢Ð¾ÐºÐµÐ½ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½',
        backupTokenRequired: 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ OAuth Ñ‚Ð¾ÐºÐµÐ½',
        backupScheduleSave: 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ',
        backupManualTitle: 'Ð ÑƒÑ‡Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ',
        backupRunNow: 'Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ',
        backupRefresh: 'ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ',
        backupRestoreLabel: 'Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾ Ð¿ÑƒÑ‚Ð¸',
        backupRestorePlaceholder: '/backups/archive.gz',
        backupRestoreButton: 'Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ',
        backupJobsTitle: 'Ð–ÑƒÑ€Ð½Ð°Ð» Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹',
        backupJobsEmpty: 'ÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹.',
        backupStatusLineWaiting: 'Ð ÐµÐ·ÐµÑ€Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾',
        backupStatusLineQueued: 'Ð—Ð°Ð´Ð°Ñ‡Ð° Ð¿Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð° Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ',
        backupStatusLineActive: 'Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑâ€¦',
        backupTokenMissing: 'Ð¢Ð¾ÐºÐµÐ½ Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½',
        backupStatusLastRun: 'ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº: {value}',
        backupStatusLastSuccess: 'ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº: {value}',
        backupStatusNever: 'Ð ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¿Ð¸Ð¸ ÐµÑ‰Ñ‘ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ð»Ð¸ÑÑŒ',
        backupJobStatusQueued: 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸',
        backupJobStatusRunning: 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ',
        backupJobStatusCompleted: 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾',
        backupJobStatusFailed: 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð¾ÑˆÐ¸Ð±ÐºÐ°',
        backupJobOperationBackup: 'Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ',
        backupJobOperationRestore: 'Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ',
        backupJobRestore: 'Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ',
        backupJobCopyPath: 'Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿ÑƒÑ‚ÑŒ',
        backupJobsFetchError: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ñ€ÐµÐ·ÐµÑ€Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ',
        backupSaveSuccess: 'ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹',
        backupSaveError: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸',
        backupRunQueued: 'Ð—Ð°Ð´Ð°Ñ‡Ð° Ñ€ÐµÐ·ÐµÑ€Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð°',
        backupRestoreQueued: 'Ð—Ð°Ð´Ð°Ñ‡Ð° Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð°',
        backupRestorePathMissing: 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿ÑƒÑ‚ÑŒ Ð½Ð° Ð´Ð¸ÑÐºÐµ',
        backupActiveJobMessage: 'Ð£Ð¶Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ',
        authTitle: 'Ð’Ñ…Ð¾Ð´ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°',
        authPrompt: 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑƒÑ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ.',
        authHint: 'Ð£Ñ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±ÑƒÐ´ÑƒÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð½Ð° {host}.',
        authUsernameLabel: 'Ð›Ð¾Ð³Ð¸Ð½',
        authUsernamePlaceholder: 'Ð˜Ð¼Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°',
        authPasswordLabel: 'ÐŸÐ°Ñ€Ð¾Ð»ÑŒ',
        authPasswordPlaceholder: 'ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°',
        authSubmit: 'Ð’Ð¾Ð¹Ñ‚Ð¸',
        authCancel: 'ÐžÑ‚Ð¼ÐµÐ½Ð°',
        authStatusChecking: 'ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµâ€¦',
        authErrorMissing: 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð»Ð¾Ð³Ð¸Ð½ Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ',
        authErrorInvalid: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ ÑƒÑ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ',
        authErrorNetwork: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑƒÑ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ',
        errorAuthRequired: 'Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð²Ñ…Ð¾Ð´ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°'
      }),
      zh: createLanguage('ä¸­æ–‡', 'ltr', {
        pillOperations: 'è¿ç»´',
        headerTitle: 'çˆ¬è™«æŽ§åˆ¶é¢æ¿',
        headerSubtitle: 'åœ¨ä¸€ä¸ªä»ªè¡¨ç›˜ä¸­ç®¡ç†çˆ¬å–ã€çŸ¥è¯†åº“å’ŒåŸºç¡€è®¾æ–½',
        buttonReorder: 'é‡æ–°æŽ’åˆ—æ¨¡å—',
        buttonReorderDone: 'å®Œæˆ',
        buttonLogout: 'é€€å‡º',
        languageLabel: 'è¯­è¨€',
        overviewProjectTitle: 'é¡¹ç›®',
        overviewProjectMeta: 'æœªé€‰æ‹©é¡¹ç›®',
        overviewCrawlerTitle: 'çˆ¬è™«',
        overviewResourcesTitle: 'èµ„æº',
        overviewLLMTitle: 'LLM æ´žå¯Ÿ',
        overviewLLMEmpty: 'æœ€è¿‘çš„æç¤ºè¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ',
        overviewBuildTitle: 'æž„å»º',
        cardProjectsTitle: 'é¡¹ç›®',
        buttonAddProject: 'æ·»åŠ é¡¹ç›®',
        buttonRefreshProjects: 'åˆ·æ–°åˆ—è¡¨',
        crawlerStatusTitle: 'çˆ¬è™«çŠ¶æ€',
        crawlerQueued: 'æŽ’é˜Ÿï¼š{value}',
        crawlerInProgress: 'å¤„ç†ä¸­ï¼š{value}',
        crawlerDone: 'å®Œæˆï¼š{value}',
        crawlerFailed: 'å¤±è´¥ï¼š{value}',
        crawlerLast: 'æœ€è¿‘ï¼š{value}',
        crawlerProjectLabel: 'é¡¹ç›®ï¼š{value}',
        crawlerLastUrls: 'æœ€æ–° URL',
        servicesTitle: 'æœåŠ¡',
        serviceMongo: 'Mongoï¼š{value}',
        serviceRedis: 'Redisï¼š{value}',
        serviceQdrant: 'Qdrantï¼š{value}',
        serviceOverall: 'çŠ¶æ€ï¼š{value}',
        resourcesTitle: 'èµ„æº',
        resourceCpuApp: 'CPUï¼ˆåº”ç”¨ï¼‰ï¼š{value}',
        resourceCpuSys: 'CPUï¼ˆç³»ç»Ÿï¼‰ï¼š{value}',
        resourceRam: 'å†…å­˜ï¼š{value}',
        resourceRss: 'RSSï¼š{value}',
        resourceGpu: 'GPUï¼š{value}',
        resourcePython: 'Pythonï¼š{value}',
        manageSection: 'ç®¡ç†',
        crawlerLaunchTitle: 'å¯åŠ¨çˆ¬è™«',
        crawlerLogsTooltip: 'æŸ¥çœ‹æ—¥å¿—',
        crawlerLogsHeader: 'çˆ¬è™«æ—¥å¿—',
        crawlerLogsCopy: 'å¤åˆ¶',
        crawlerLogsRefresh: 'åˆ·æ–°',
        crawlerLogsHide: 'éšè—',
        crawlerLogsEmpty: 'æ—¥å¿—å°†æŒ‰éœ€åŠ è½½ã€‚',
        crawlerSelectProject: 'é€‰æ‹©é¡¹ç›®',
        crawlerLaunched: 'å·²å¯åŠ¨',
        crawlerLaunchFailed: 'å¯åŠ¨å¤±è´¥',
        crawlerStartError: 'çˆ¬è™«å¯åŠ¨é”™è¯¯',
        crawlerStopping: 'æ­£åœ¨åœæ­¢â€¦',
        crawlerStopFailed: 'åœæ­¢å¤±è´¥',
        crawlerStopError: 'çˆ¬è™«åœæ­¢é”™è¯¯',
        crawlerActionReset: 'è®¡æ•°å·²é‡ç½®',
        crawlerActionDedup: 'å·²ç§»é™¤é‡å¤é¡¹',
        crawlerActionNoData: 'æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹',
        crawlerActionProcessing: 'å¤„ç†ä¸­â€¦',
        crawlerActionExecuteError: 'æ‰§è¡Œæ“ä½œå¤±è´¥',
        crawlerStartButton: 'å¯åŠ¨',
        crawlerStopButton: 'åœæ­¢',
        crawlerResetButton: 'é‡ç½®è®¡æ•°',
        crawlerDedupButton: 'ç§»é™¤é‡å¤ URL',
        crawlerStartUrl: 'èµ·å§‹ URL',
        crawlerDepth: 'æ·±åº¦',
        crawlerPages: 'é¡µé¢',
        crawlerCollectBooks: 'ä¸ºé˜…è¯»æ¨¡å¼ä¿å­˜å®Œæ•´é¡µé¢',
        voiceTrainingTitle: 'è¯­éŸ³è®­ç»ƒ',
        voiceTrainingSummary: 'ä¸Šä¼ è‡³å°‘ 3 æ®µå¹²å‡€è¯­éŸ³ï¼Œå¸®åŠ©åŠ©æ‰‹å­¦ä¼šé¡¹ç›®ä¸“å±žçš„å£°éŸ³ã€‚',
        voiceUploadButton: 'ä¸Šä¼ éŸ³é¢‘',
        voiceSamplesEmpty: 'å°šæœªä¸Šä¼ éŸ³é¢‘ç‰‡æ®µã€‚',
        voiceTrainButton: 'è®­ç»ƒè‡ªå®šä¹‰è¯­éŸ³',
        promptAiStart: 'æ­£åœ¨ç”Ÿæˆâ€¦',
        promptAiReady: 'æç¤ºè¯å·²å°±ç»ª',
        promptAiStopped: 'å·²åœæ­¢',
        promptAiError: 'é”™è¯¯ï¼š{message}',
        promptAiInvalidDomain: 'è¯·æŒ‡å®šæœ‰æ•ˆçš„åŸŸåæˆ– URL',
        promptAiEmpty: 'æ¨¡åž‹è¿”å›žäº†ç©ºç»“æžœ',
        genericFailed: 'å¤±è´¥',
        logoutProgress: 'æ­£åœ¨é€€å‡ºâ€¦',
        logCopyEmpty: 'æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹',
        logCopySuccess: 'æ—¥å¿—å·²å¤åˆ¶',
        logCopyError: 'å¤åˆ¶å¤±è´¥',
        knowledgeServiceUnavailable: 'å½“å‰æƒé™æ— æ³•ä½¿ç”¨è¯¥æœåŠ¡',
        knowledgeServiceLoading: 'åŠ è½½ä¸­â€¦',
        knowledgeServiceNoData: 'æš‚æ— æ•°æ®',
        knowledgeServiceUpgrade: 'æœåŠ¡ä¸å¯ç”¨ï¼ˆè¯·æ›´æ–°åŽç«¯ï¼‰',
        knowledgeServiceFetchError: 'èŽ·å–çŠ¶æ€å¤±è´¥',
        knowledgeServiceSaving: 'ä¿å­˜ä¸­â€¦',
        knowledgeServiceSaved: 'å·²ä¿å­˜',
        knowledgeServiceSaveError: 'ä¿å­˜å¤±è´¥'
      }),
      ja: createLanguage('æ—¥æœ¬èªž', 'ltr', {
        pillOperations: 'é‹ç”¨',
        headerTitle: 'ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ç®¡ç†ãƒ‘ãƒãƒ«',
        headerSubtitle: 'ã‚¯ãƒ­ãƒ¼ãƒ«ã€ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã²ã¨ã¤ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç®¡ç†',
        buttonReorder: 'ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸¦ã¹æ›¿ãˆ',
        buttonReorderDone: 'å®Œäº†',
        buttonLogout: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        languageLabel: 'è¨€èªž',
        overviewProjectTitle: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
        overviewProjectMeta: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠžã•ã‚Œã¦ã„ã¾ã›ã‚“',
        overviewCrawlerTitle: 'ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼',
        overviewResourcesTitle: 'ãƒªã‚½ãƒ¼ã‚¹',
        overviewLLMTitle: 'LLM ã‚¤ãƒ³ã‚µã‚¤ãƒˆ',
        overviewLLMEmpty: 'æœ€è¿‘ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™',
        overviewBuildTitle: 'ãƒ“ãƒ«ãƒ‰',
        cardProjectsTitle: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
        buttonAddProject: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ',
        buttonRefreshProjects: 'ãƒªã‚¹ãƒˆã‚’æ›´æ–°',
        crawlerStatusTitle: 'ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã®çŠ¶æ³',
        crawlerQueued: 'å¾…æ©Ÿä¸­: {value}',
        crawlerInProgress: 'å®Ÿè¡Œä¸­: {value}',
        crawlerDone: 'å®Œäº†: {value}',
        crawlerFailed: 'å¤±æ•—: {value}',
        crawlerLast: 'æœ€æ–°: {value}',
        crawlerProjectLabel: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: {value}',
        crawlerLastUrls: 'æœ€æ–°ã® URL',
        servicesTitle: 'ã‚µãƒ¼ãƒ“ã‚¹',
        serviceMongo: 'Mongo: {value}',
        serviceRedis: 'Redis: {value}',
        serviceQdrant: 'Qdrant: {value}',
        serviceOverall: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {value}',
        resourcesTitle: 'ãƒªã‚½ãƒ¼ã‚¹',
        resourceCpuApp: 'CPU (ã‚¢ãƒ—ãƒª): {value}',
        resourceCpuSys: 'CPU (ã‚·ã‚¹ãƒ†ãƒ ): {value}',
        resourceRam: 'RAM: {value}',
        resourceRss: 'RSS: {value}',
        resourceGpu: 'GPU: {value}',
        resourcePython: 'Python: {value}',
        manageSection: 'ç®¡ç†',
        crawlerLaunchTitle: 'ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã®èµ·å‹•',
        crawlerLogsTooltip: 'ãƒ­ã‚°ã‚’è¡¨ç¤º',
        crawlerLogsHeader: 'ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ãƒ­ã‚°',
        crawlerLogsCopy: 'ã‚³ãƒ”ãƒ¼',
        crawlerLogsRefresh: 'æ›´æ–°',
        crawlerLogsHide: 'éžè¡¨ç¤º',
        crawlerLogsEmpty: 'ãƒ­ã‚°ã¯å¿…è¦ã«å¿œã˜ã¦èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚',
        crawlerSelectProject: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠž',
        crawlerLaunched: 'é–‹å§‹ã—ã¾ã—ãŸ',
        crawlerLaunchFailed: 'é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ',
        crawlerStartError: 'ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼',
        crawlerStopping: 'åœæ­¢ã—ã¦ã„ã¾ã™â€¦',
        crawlerStopFailed: 'åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ',
        crawlerStopError: 'ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼',
        crawlerActionReset: 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ',
        crawlerActionDedup: 'é‡è¤‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ',
        crawlerActionNoData: 'ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“',
        crawlerActionProcessing: 'å‡¦ç†ä¸­â€¦',
        crawlerActionExecuteError: 'æ“ä½œã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ',
        crawlerStartButton: 'é–‹å§‹',
        crawlerStopButton: 'åœæ­¢',
        crawlerResetButton: 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ',
        crawlerDedupButton: 'é‡è¤‡ URL ã‚’å‰Šé™¤',
        crawlerStartUrl: 'é–‹å§‹ URL',
        crawlerDepth: 'æ·±ã•',
        crawlerPages: 'ãƒšãƒ¼ã‚¸',
        crawlerCollectBooks: 'èª­æ›¸ãƒ¢ãƒ¼ãƒ‰ç”¨ã«ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ä¿å­˜',
        voiceTrainingTitle: 'éŸ³å£°ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°',
        voiceTrainingSummary: 'ã‚¯ãƒªã‚¢ãªéŸ³å£°ã‚¯ãƒªãƒƒãƒ—ã‚’3ã¤ä»¥ä¸Šã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å£°ã‚’å­¦ç¿’ã•ã›ã¾ã—ã‚‡ã†ã€‚',
        voiceUploadButton: 'ã‚¯ãƒªãƒƒãƒ—ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰',
        voiceSamplesEmpty: 'éŸ³å£°ã‚¯ãƒªãƒƒãƒ—ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚',
        voiceTrainButton: 'ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°ã‚’å­¦ç¿’',
        promptAiStart: 'ç”Ÿæˆä¸­â€¦',
        promptAiReady: 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æº–å‚™å®Œäº†',
        promptAiStopped: 'åœæ­¢ã—ã¾ã—ãŸ',
        promptAiError: 'ã‚¨ãƒ©ãƒ¼: {message}',
        promptAiInvalidDomain: 'æœ‰åŠ¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã¾ãŸã¯ URL ã‚’æŒ‡å®šã—ã¦ãã ã•ã„',
        promptAiEmpty: 'ãƒ¢ãƒ‡ãƒ«ãŒç©ºã®çµæžœã‚’è¿”ã—ã¾ã—ãŸ',
        genericFailed: 'å¤±æ•—',
        logoutProgress: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­â€¦',
        logCopyEmpty: 'ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“',
        logCopySuccess: 'ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ',
        logCopyError: 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ',
        knowledgeServiceUnavailable: 'ã“ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ãƒ™ãƒ«ã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“',
        knowledgeServiceLoading: 'èª­ã¿è¾¼ã¿ä¸­â€¦',
        knowledgeServiceNoData: 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',
        knowledgeServiceUpgrade: 'ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ï¼‰',
        knowledgeServiceFetchError: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
        knowledgeServiceSaving: 'ä¿å­˜ä¸­â€¦',
        knowledgeServiceSaved: 'ä¿å­˜ã—ã¾ã—ãŸ',
        knowledgeServiceSaveError: 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'
      }),
      ar: createLanguage('Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'rtl', {
        pillOperations: 'Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
        headerTitle: 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø²Ø§Ø­Ù',
        headerSubtitle: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø­Ù ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ© ÙˆØ§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© Ù…Ù† Ù„ÙˆØ­Ø© ÙˆØ§Ø­Ø¯Ø©',
        buttonReorder: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª',
        buttonReorderDone: 'ØªÙ…',
        buttonLogout: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
        languageLabel: 'Ø§Ù„Ù„ØºØ©',
        overviewProjectTitle: 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
        overviewProjectMeta: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø±ÙˆØ¹ Ù…Ø­Ø¯Ø¯',
        overviewCrawlerTitle: 'Ø§Ù„Ø²Ø§Ø­Ù',
        overviewResourcesTitle: 'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯',
        overviewLLMTitle: 'Ø±Ø¤Ù‰ LLM',
        overviewLLMEmpty: 'Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù‡Ù†Ø§',
        overviewBuildTitle: 'Ø§Ù„Ø¨Ù†Ø§Ø¡',
        cardProjectsTitle: 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',
        buttonAddProject: 'Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹',
        buttonRefreshProjects: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©',
        crawlerStatusTitle: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø§Ø­Ù',
        crawlerQueued: 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: {value}',
        crawlerInProgress: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°: {value}',
        crawlerDone: 'Ù…ÙƒØªÙ…Ù„: {value}',
        crawlerFailed: 'ÙØ´Ù„: {value}',
        crawlerLast: 'Ø§Ù„Ø£Ø­Ø¯Ø«: {value}',
        crawlerProjectLabel: 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: {value}',
        crawlerLastUrls: 'Ø£Ø­Ø¯Ø« Ø§Ù„Ø±ÙˆØ§Ø¨Ø·',
        servicesTitle: 'Ø§Ù„Ø®Ø¯Ù…Ø§Øª',
        serviceMongo: 'Mongo: {value}',
        serviceRedis: 'Redis: {value}',
        serviceQdrant: 'Qdrant: {value}',
        serviceOverall: 'Ø§Ù„Ø­Ø§Ù„Ø©: {value}',
        resourcesTitle: 'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯',
        resourceCpuApp: 'CPU (ØªØ·Ø¨ÙŠÙ‚): {value}',
        resourceCpuSys: 'CPU (Ù†Ø¸Ø§Ù…): {value}',
        resourceRam: 'Ø§Ù„Ø°Ø§ÙƒØ±Ø©: {value}',
        resourceRss: 'RSS: {value}',
        resourceGpu: 'GPU: {value}',
        resourcePython: 'Python: {value}',
        manageSection: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',
        crawlerLaunchTitle: 'ØªØ´ØºÙŠÙ„ Ø§Ù„Ø²Ø§Ø­Ù',
        crawlerLogsTooltip: 'Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª',
        crawlerLogsHeader: 'Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø²Ø§Ø­Ù',
        crawlerLogsCopy: 'Ù†Ø³Ø®',
        crawlerLogsRefresh: 'ØªØ­Ø¯ÙŠØ«',
        crawlerLogsHide: 'Ø¥Ø®ÙØ§Ø¡',
        crawlerLogsEmpty: 'Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨.',
        crawlerSelectProject: 'Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ù‹Ø§',
        crawlerLaunched: 'ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡',
        crawlerLaunchFailed: 'ÙØ´Ù„ Ø§Ù„Ø¨Ø¯Ø¡',
        crawlerStartError: 'Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø²Ø§Ø­Ù',
        crawlerStopping: 'ÙŠØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ùâ€¦',
        crawlerStopFailed: 'ÙØ´Ù„ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù',
        crawlerStopError: 'Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø²Ø§Ø­Ù',
        crawlerActionReset: 'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª',
        crawlerActionDedup: 'ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª',
        crawlerActionNoData: 'Ù„Ø§ Ø´ÙŠØ¡ Ù„Ù„Ù†Ø³Ø®',
        crawlerActionProcessing: 'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°â€¦',
        crawlerActionExecuteError: 'ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡',
        crawlerStartButton: 'Ø§Ø¨Ø¯Ø£',
        crawlerStopButton: 'Ø¥ÙŠÙ‚Ø§Ù',
        crawlerResetButton: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª',
        crawlerDedupButton: 'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…ÙƒØ±Ø±Ø©',
        crawlerStartUrl: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
        crawlerDepth: 'Ø§Ù„Ø¹Ù…Ù‚',
        crawlerPages: 'Ø§Ù„ØµÙØ­Ø§Øª',
        crawlerCollectBooks: 'Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø§Øª ÙƒØ§Ù…Ù„Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©',
        voiceTrainingTitle: 'ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØµÙˆØª',
        voiceTrainingSummary: 'Ø­Ù…Ù‘Ù„ 3 Ù…Ù‚Ø§Ø·Ø¹ ØµÙˆØªÙŠØ© Ù†Ø¸ÙŠÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„ÙŠÙƒØªØ³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ØµÙˆØª Ù…Ø´Ø±ÙˆØ¹Ùƒ.',
        voiceUploadButton: 'Ø±ÙØ¹ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹',
        voiceSamplesEmpty: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ø·Ø¹ ØµÙˆØªÙŠØ© Ø¨Ø¹Ø¯.',
        voiceTrainButton: 'ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØµØµ',
        promptAiStart: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯â€¦',
        promptAiReady: 'Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¬Ø§Ù‡Ø²Ø©',
        promptAiStopped: 'ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù',
        promptAiError: 'Ø®Ø·Ø£: {message}',
        promptAiInvalidDomain: 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ø£Ùˆ Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­',
        promptAiEmpty: 'Ø£Ø¹Ø§Ø¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù†ØªÙŠØ¬Ø© ÙØ§Ø±ØºØ©',
        genericFailed: 'ÙØ´Ù„',
        logoutProgress: 'Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬â€¦',
        logCopyEmpty: 'Ù„Ø§ Ø´ÙŠØ¡ Ù„Ù„Ù†Ø³Ø®',
        logCopySuccess: 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø³Ø¬Ù„Ø§Øª',
        logCopyError: 'ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®',
        knowledgeServiceUnavailable: 'Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØµÙˆÙ„Ùƒ',
        knowledgeServiceLoading: 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦',
        knowledgeServiceNoData: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª',
        knowledgeServiceUpgrade: 'Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© (ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ù„ÙÙŠØ©)',
        knowledgeServiceFetchError: 'ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©',
        knowledgeServiceSaving: 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦',
        knowledgeServiceSaved: 'ØªÙ… Ø§Ù„Ø­ÙØ¸',
        knowledgeServiceSaveError: 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'
      })
    };

    let currentLanguage = (() => {
      try {
        const stored = localStorage.getItem(LANGUAGE_STORAGE_KEY);
        if (stored && LANGUAGES[stored]) {
          return stored;
        }
      } catch {}
      return FALLBACK_LANGUAGE;
    })();

    let feedbackTasksCache = [];
    var feedbackTasksList = null;

    let backupState = null;

    function t(key, params = {}) {
      const dict = LANGUAGES[currentLanguage]?.strings || LANGUAGES[FALLBACK_LANGUAGE].strings;
      const template = dict[key] ?? LANGUAGES[FALLBACK_LANGUAGE].strings[key] ?? key;
      return template.replace(/\{(\w+)\}/g, (_, token) => {
        if (token in params) {
          return String(params[token]);
        }
        return '';
      });
    }

    function applyLanguage(lang) {
      if (!LANGUAGES[lang]) lang = FALLBACK_LANGUAGE;
      currentLanguage = lang;
      try { localStorage.setItem(LANGUAGE_STORAGE_KEY, currentLanguage); } catch {}
      const cfg = LANGUAGES[currentLanguage];
      document.documentElement.lang = currentLanguage;
      document.documentElement.dir = cfg.dir || 'ltr';

      if (languageSelect) {
        languageSelect.innerHTML = '';
        Object.entries(LANGUAGES).forEach(([code, meta]) => {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = meta.name;
          if (code === currentLanguage) option.selected = true;
          languageSelect.appendChild(option);
        });
      }

      document.querySelectorAll('[data-i18n]').forEach((node) => {
        const key = node.dataset.i18n;
        node.textContent = t(key);
      });

      document.querySelectorAll('[data-i18n-placeholder]').forEach((node) => {
        const key = node.dataset.i18nPlaceholder;
        node.setAttribute('placeholder', t(key));
      });

      document.querySelectorAll('[data-i18n-aria-label]').forEach((node) => {
        const key = node.dataset.i18nAriaLabel;
        node.setAttribute('aria-label', t(key));
      });

      document.querySelectorAll('[data-i18n-wrapper]').forEach((node) => {
        const key = node.dataset.i18nWrapper;
        const valueNode = node.querySelector('[data-i18n-value]');
        const valueText = valueNode ? valueNode.textContent : '';
        const placeholder = '__VALUE_PLACEHOLDER__';
        const html = t(key, { value: placeholder });
        const id = valueNode?.id;
        const className = valueNode?.className;
        node.innerHTML = html.replace(placeholder, `<span data-i18n-value>${valueText}</span>`);
        const newValueNode = node.querySelector('[data-i18n-value]');
        if (newValueNode) {
          if (id) newValueNode.id = id;
          if (className) newValueNode.className = className;
        }
      });

      if (authHint) {
        const host = authHint.dataset.host || window.location.origin;
        authHint.textContent = t('authHint').replace('{host}', host);
      }
      if (authMessage) {
        authMessage.textContent = t('authPrompt');
      }
      if (authError?.dataset.key) {
        authError.textContent = t(authError.dataset.key);
      }

      if (backupState) {
        renderBackupState(backupState);
      } else if (backupJobsList) {
        backupJobsList.innerHTML = '';
        const empty = document.createElement('div');
        empty.className = 'backup-empty';
        empty.textContent = t('backupJobsEmpty');
        backupJobsList.appendChild(empty);
      }

      renderFeedbackTasks(feedbackTasksCache);
    }

    if (languageSelect) {
      languageSelect.addEventListener('change', (event) => {
        applyLanguage(event.target.value);
      });
    }

    applyLanguage(currentLanguage);
    const STATS_DAYS = 14;
    const BACKUP_TIMEZONES = [
      'UTC',
      'Europe/Kaliningrad',
      'Europe/Moscow',
      'Europe/Samara',
      'Asia/Yekaterinburg',
      'Asia/Omsk',
      'Asia/Novosibirsk',
      'Asia/Krasnoyarsk',
      'Asia/Irkutsk',
      'Asia/Yakutsk',
      'Asia/Vladivostok',
      'Asia/Sakhalin',
      'Asia/Magadan',
      'Asia/Kamchatka'
    ];
    let backupRefreshTimer = null;
    let projectStorageCache = {};
    const CRAWLER_LOG_REFRESH_INTERVAL = 5000;
    let lastCrawlerLogFetch = 0;
    let crawlerLogsLoading = false;
    resetCrawlerProgress();
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const launchMsg = document.getElementById('launchMsg');
      const payload = {
        start_url: document.getElementById('url').value,
        max_depth: Number(document.getElementById('depth').value),
        max_pages: Number(document.getElementById('pages').value),
      };
      if (crawlerCollectBooks) {
        payload.collect_books = crawlerCollectBooks.checked;
      }
      if (!currentProject) {
        launchMsg.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      payload.project = currentProject;
      const crawlDomain = projectDomainInput.value.trim();
      if (crawlDomain) {
        payload.domain = crawlDomain;
      }
      try {
        const res = await fetch('/api/v1/crawler/run', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        launchMsg.textContent = res.ok ? 'Ð—Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾' : 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ';
      } catch (error) {
        console.error('crawler_start_failed', error);
        launchMsg.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð°';
      }
    });

    stopBtn.addEventListener('click', async () => {
      const launchMsg = document.getElementById('launchMsg');
      try {
        const r = await fetch('/api/v1/crawler/stop', { method: 'POST' });
        launchMsg.textContent = r.ok ? 'ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼â€¦' : 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ';
      } catch (error) {
        console.error('crawler_stop_failed', error);
        launchMsg.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸';
      }
    });

    if (crawlerLogsBtn) {
      crawlerLogsBtn.addEventListener('click', () => {
        if (!crawlerLogsPanel) return;
        if (crawlerLogsPanel.classList.contains('visible')) {
          hideCrawlerLogs();
        } else {
          showCrawlerLogs();
        }
      });
    }
    if (crawlerLogsClose) crawlerLogsClose.addEventListener('click', hideCrawlerLogs);
    if (crawlerLogsRefresh) crawlerLogsRefresh.addEventListener('click', () => refreshCrawlerLogs(true));
    if (crawlerLogsCopy) {
      crawlerLogsCopy.addEventListener('click', async () => {
        const text = crawlerLogsOutput?.textContent || '';
        if (!text.trim()) {
          setCrawlerActionStatus(t('crawlerActionNoData'), 2000);
          return;
        }
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const selection = window.getSelection();
            if (!selection) throw new Error('selection_unavailable');
            const range = document.createRange();
            range.selectNodeContents(crawlerLogsOutput);
            selection.removeAllRanges();
            selection.addRange(range);
            const legacyOk = document.execCommand('copy');
            selection.removeAllRanges();
          if (!legacyOk) throw new Error('exec_command_failed');
        }
        setCrawlerActionStatus(t('logCopySuccess'), 2000);
      } catch (error) {
        console.error('crawler_logs_copy_failed', error);
        setCrawlerActionStatus(t('logCopyError'), 3000);
      }
      });
    }
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && crawlerLogsPanel?.classList.contains('visible')) {
        hideCrawlerLogs();
      }
    });

    const sessionDefaults = {
      username: '',
      is_super: false,
      projects: [],
      primary_project: null,
      can_manage_projects: false,
    };
    let adminSession = { ...sessionDefaults };
    let currentProject = (localStorage.getItem('admin_project') || '').trim().toLowerCase();
    const projectSelect = document.getElementById('projectSelect');
    const projectStatus = document.getElementById('projectStatus');
    const projectAddBtn = document.getElementById('projectAdd');
    const projectRefreshBtn = document.getElementById('projectRefresh');
    const logoutButton = document.getElementById('adminLogout');
    const projectNameInput = document.getElementById('projectName');
    const projectDomainInput = document.getElementById('projectDomain');
    const projectTitleInput = document.getElementById('projectTitle');
    const projectModelInput = document.getElementById('projectModel');
    const projectVoiceInput = document.getElementById('projectVoiceEnabled');
    const projectVoiceHint = document.getElementById('projectVoiceHint');
    const projectVoiceModelInput = document.getElementById('projectVoiceModel');
    const projectPromptInput = document.getElementById('projectPrompt');
    const projectPromptRoleSelect = document.getElementById('projectPromptRole');
    const projectPromptAiBtn = document.getElementById('projectPromptAi');
    const projectPromptAiStatus = document.getElementById('projectPromptAiStatus');
    const projectEmotionsInput = document.getElementById('projectEmotions');
    const projectImageCaptionsInput = document.getElementById('projectImageCaptions');
    const projectImageCaptionsHint = document.getElementById('projectImageCaptionsHint');
    const projectSourcesInput = document.getElementById('projectSourcesEnabled');
    const projectSourcesHint = document.getElementById('projectSourcesHint');
    const projectDebugInfoInput = document.getElementById('projectDebugInfo');
    const projectDebugInfoHint = document.getElementById('projectDebugInfoHint');
    const projectDebugInput = document.getElementById('projectDebug');
    const projectDebugHint = document.getElementById('projectDebugHint');
    const projectEmotionsHint = document.getElementById('projectEmotionsHint');
    const projectDeleteBtn = document.getElementById('projectDelete');
    const projectAdminSection = document.getElementById('projectAdminSection');
    const projectAdminUsernameInput = document.getElementById('projectAdminUsername');
    const projectAdminPasswordInput = document.getElementById('projectAdminPassword');
    const projectAdminHint = document.getElementById('projectAdminHint');
    const projectStorageText = document.getElementById('projectStorageText');
    const projectStorageFiles = document.getElementById('projectStorageFiles');
    const projectStorageContexts = document.getElementById('projectStorageContexts');
    const projectStorageRedis = document.getElementById('projectStorageRedis');
    const feedbackSection = document.getElementById('block-feedback');
    feedbackTasksList = document.getElementById('feedbackTasksList');
    const feedbackRefreshBtn = document.getElementById('feedbackRefresh');
    const knowledgeServiceToggle = document.getElementById('knowledgeServiceToggle');
    const knowledgeServiceApply = document.getElementById('knowledgeServiceApply');
    const knowledgeServiceRefresh = document.getElementById('knowledgeServiceRefresh');
    const knowledgeServiceStatus = document.getElementById('knowledgeServiceStatus');
    const knowledgeServiceCard = document.querySelector('.knowledge-service-card');
    const knowledgeServiceEndpoints = [
      '/api/v1/knowledge/service',
      '/api/v1/admin/knowledge/service',
      '/api/v1/llm/admin/knowledge/service',
    ];
    let activeKnowledgeServiceEndpoint = null;
    const PROMPT_AI_ROLES = [
      {
        value: 'friendly_expert',
        label: 'Ð”Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹ ÑÐºÑÐ¿ÐµÑ€Ñ‚',
        hint: 'Ð¢Ñ‘Ð¿Ð»Ñ‹Ð¹ Ñ‚Ð¾Ð½, Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð¸ Ð·Ð°Ð±Ð¾Ñ‚Ð° Ð¾ ÐµÐ³Ð¾ Ð·Ð°Ð´Ð°Ñ‡Ð°Ñ….',
      },
      {
        value: 'formal_consultant',
        label: 'Ð¤Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚',
        hint: 'Ð”ÐµÐ»Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ð¸Ð»ÑŒ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ, Ð°ÐºÑ†ÐµÐ½Ñ‚ Ð½Ð° Ñ„Ð°ÐºÑ‚Ð°Ñ… Ð¸ Ñ€ÐµÐ³Ð»Ð°Ð¼ÐµÐ½Ñ‚Ð°Ñ….',
      },
      {
        value: 'sales_manager',
        label: 'ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€',
        hint: 'Ð¤Ð¾ÐºÑƒÑ Ð½Ð° Ð²Ñ‹Ð³Ð¾Ð´Ð°Ñ… Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð° Ð¸ Ð¼ÑÐ³ÐºÐ¸Ñ… Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð°Ñ….',
      },
    ];
    const setKnowledgeServiceControlsDisabled = (disabled) => {
      if (knowledgeServiceToggle) knowledgeServiceToggle.disabled = disabled;
      if (knowledgeServiceApply) knowledgeServiceApply.disabled = disabled;
      if (knowledgeServiceRefresh) knowledgeServiceRefresh.disabled = disabled;
    };

    const ensurePromptRoleOptions = (select) => {
      if (!select || select.options.length) return;
      PROMPT_AI_ROLES.forEach((role) => {
        const option = document.createElement('option');
        option.value = role.value;
        option.textContent = role.label;
        if (role.hint) option.title = role.hint;
        select.appendChild(option);
      });
      if (PROMPT_AI_ROLES.length) {
        select.value = PROMPT_AI_ROLES[0].value;
      }
    };

    const buildTargetUrl = (raw) => {
      if (!raw) return null;
      let candidate = String(raw).trim();
      if (!candidate) return null;
      if (!/^https?:\/\//i.test(candidate)) {
        candidate = `https://${candidate}`;
      }
      try {
        const parsed = new URL(candidate);
        if (!parsed.hostname) return null;
        if (!parsed.pathname) parsed.pathname = '/';
        return parsed.toString();
      } catch (error) {
        return null;
      }
    };

    const initPromptAiControls = ({ textarea, domainInput, roleSelect, button, status }) => {
      if (!textarea || !domainInput || !button || !status || !roleSelect) {
        return null;
      }

      ensurePromptRoleOptions(roleSelect);
      let controller = null;
      let generating = false;

      const setStatus = (message, timeoutMs = 0) => {
        status.textContent = message || 'â€”';
        if (timeoutMs > 0) {
          const expected = status.textContent;
          setTimeout(() => {
            if (status.textContent === expected) {
              status.textContent = 'â€”';
            }
          }, timeoutMs);
        }
      };

      const stopGeneration = (message) => {
        if (controller) {
          controller.abort();
        }
        controller = null;
        generating = false;
        button.disabled = false;
        roleSelect.disabled = false;
        if (message) {
          setStatus(message, 3500);
        }
      };

      textarea.addEventListener('input', () => {
        if (generating) {
          stopGeneration('ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾: Ð²Ð²Ð¾Ð´ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ');
        }
      });

      button.addEventListener('click', async () => {
        const pageUrl = buildTargetUrl(domainInput.value || projectDomainInput?.value || '');
        if (!pageUrl) {
          setStatus(t('promptAiInvalidDomain'), 4000);
          return;
        }
        const role = roleSelect.value || PROMPT_AI_ROLES[0]?.value || null;

        if (controller) {
          controller.abort();
        }
        controller = new AbortController();
        generating = true;
        button.disabled = true;
        roleSelect.disabled = true;
        setStatus(t('promptAiStart'));

        try {
          const response = await fetch('/api/v1/admin/projects/prompt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: pageUrl, role }),
            signal: controller.signal,
          });
          if (!response.ok) {
            let detail = `HTTP ${response.status}`;
            try {
              const data = await response.json();
              if (data?.detail) detail = data.detail;
            } catch (error) {
              /* ignore */
            }
            throw new Error(detail);
          }
          const data = await response.json();
          const prompt = (data?.prompt || '').trim();
          if (!prompt) {
            setStatus(t('promptAiEmpty'), 4000);
          } else {
            textarea.value = prompt;
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            setStatus(t('promptAiReady'), 3500);
          }
        } catch (error) {
          if (error?.name === 'AbortError') {
            setStatus(t('promptAiStopped'), 3000);
          } else {
            console.error('prompt_ai_failed', error);
            const msg = error?.message || t('genericFailed');
            setStatus(t('promptAiError', { message: msg }), 4500);
          }
        } finally {
          if (controller) {
            controller = null;
          }
          generating = false;
          button.disabled = false;
          roleSelect.disabled = false;
        }
      });

      return {
        abort: () => stopGeneration(),
        reset: () => setStatus('â€”'),
      };
    };

    const normalizeProjectName = (value) => (typeof value === 'string' ? value.trim().toLowerCase() : '');

    const applySessionPermissions = () => {
      const promptsCard = document.querySelector('.prompts-card');
      const logsCard = document.querySelector('.logs-card');
      if (!adminSession.is_super) {
        if (projectAddBtn) projectAddBtn.style.display = 'none';
        const hasProjects = Array.isArray(adminSession.projects) && adminSession.projects.length > 0;
        if (projectDeleteBtn) {
          projectDeleteBtn.style.display = hasProjects ? '' : 'none';
          projectDeleteBtn.disabled = !hasProjects;
        }
        if (projectDangerZone) {
          projectDangerZone.classList.toggle('show', hasProjects);
        }
        if (summaryPerfCard) summaryPerfCard.style.display = 'none';
        if (summaryLLMCard) summaryLLMCard.style.display = 'none';
        if (summaryBuildCard) summaryBuildCard.style.display = 'none';
        if (llmSection) llmSection.style.display = 'none';
        if (knowledgeServiceCard) knowledgeServiceCard.style.display = 'none';
        if (promptsCard) promptsCard.style.display = 'none';
        if (logsCard) logsCard.style.display = 'none';
        if (feedbackSection) feedbackSection.style.display = 'none';
        setKnowledgeServiceControlsDisabled(true);
        const modalAdminLogin = projectModalAdminUsername ? projectModalAdminUsername.closest('label') : null;
        const modalAdminPass = projectModalAdminPassword ? projectModalAdminPassword.closest('label') : null;
        if (modalAdminLogin) modalAdminLogin.style.display = 'none';
        if (modalAdminPass) modalAdminPass.style.display = 'none';
        if (projectPromptAiBtn) projectPromptAiBtn.disabled = true;
        if (projectPromptRoleSelect) projectPromptRoleSelect.disabled = true;
        if (projectModalPromptAiBtn) projectModalPromptAiBtn.disabled = true;
        if (projectModalPromptRole) projectModalPromptRole.disabled = true;
        if (ollamaCatalog) ollamaCatalog.classList.remove('show');
        if (backupCard) backupCard.style.display = 'none';
        backupState = null;
        if (backupStatusLine) backupStatusLine.textContent = '';
        if (backupJobsList) {
          backupJobsList.innerHTML = '';
          const empty = document.createElement('div');
          empty.className = 'backup-empty';
          empty.textContent = t('backupJobsEmpty');
          backupJobsList.appendChild(empty);
        }
        pushBackupMessage('', 'info');
        setBackupControlsDisabled(true);
        scheduleBackupRefresh(false);
      } else {
        setKnowledgeServiceControlsDisabled(false);
        const modalAdminLogin = projectModalAdminUsername ? projectModalAdminUsername.closest('label') : null;
        const modalAdminPass = projectModalAdminPassword ? projectModalAdminPassword.closest('label') : null;
        if (modalAdminLogin) modalAdminLogin.style.display = '';
        if (modalAdminPass) modalAdminPass.style.display = '';
        if (projectPromptAiBtn) projectPromptAiBtn.disabled = false;
        if (projectPromptRoleSelect) projectPromptRoleSelect.disabled = false;
        if (projectModalPromptAiBtn) projectModalPromptAiBtn.disabled = false;
        if (projectModalPromptRole) projectModalPromptRole.disabled = false;
        if (projectDeleteBtn) {
          projectDeleteBtn.style.display = '';
          projectDeleteBtn.disabled = false;
        }
        if (projectDangerZone) {
          projectDangerZone.classList.add('show');
        }
        if (summaryPerfCard) summaryPerfCard.style.display = '';
        if (summaryLLMCard) summaryLLMCard.style.display = '';
        if (summaryBuildCard) summaryBuildCard.style.display = '';
        if (llmSection) llmSection.style.display = '';
        if (promptsCard) promptsCard.style.display = '';
        if (logsCard) logsCard.style.display = '';
        if (feedbackSection) feedbackSection.style.display = '';
        if (ollamaCatalog) ollamaCatalog.classList.add('show');
        if (backupCard) backupCard.style.display = '';
        setBackupControlsDisabled(false);
        ensureBackupTimezones();
        refreshBackupStatus(false);
        updateBackupActionButtons();
      }
    };

    async function fetchSession() {
      try {
        const resp = await fetch('/api/v1/admin/session');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const projects = Array.isArray(data.projects)
          ? data.projects.map((item) => normalizeProjectName(item)).filter(Boolean)
          : [];
        adminSession = {
          username: typeof data.username === 'string' ? data.username.trim().toLowerCase() : '',
          is_super: Boolean(data.is_super),
          can_manage_projects: Boolean(data.can_manage_projects),
          projects,
          primary_project: data.primary_project ? normalizeProjectName(data.primary_project) : (projects[0] || null),
        };
      } catch (error) {
        console.error('Failed to load admin session', error);
        adminSession = { ...sessionDefaults };
      }
      applySessionPermissions();
    }
    const LAYOUT_ORDER_STORAGE_KEY = 'admin_layout_order_v1';
    const projectTestBtn = document.getElementById('projectTest');
    const projectPromptSaveBtn = document.getElementById('projectPromptSave');
    const projectForm = document.getElementById('projectForm');
    const projectWidgetUrl = document.getElementById('projectWidgetUrl');
    const projectWidgetHint = document.getElementById('projectWidgetHint');
    const projectWidgetLink = document.getElementById('projectWidgetLink');
    const projectWidgetCopyBtn = document.getElementById('projectWidgetCopy');
    const projectWidgetMessage = document.getElementById('projectWidgetMessage');
    const projectDangerZone = document.getElementById('projectDangerZone');
    const projectDeleteInfo = document.getElementById('projectDeleteInfo');
    const summaryPerfCard = document.getElementById('summaryPerfCard');
    const summaryLLMCard = document.getElementById('summaryLLMCard');
    const summaryBuildCard = document.getElementById('summaryBuildCard');
    const llmSection = document.getElementById('block-llm');
    const crawlerProjectLabel = document.getElementById('crawlerProject');
    const llmModelDatalist = document.getElementById('llmModelOptions');
    const ollamaCatalog = document.getElementById('ollamaCatalog');
    const ollamaRefreshBtn = document.getElementById('ollamaRefresh');
    const ollamaAvailability = document.getElementById('ollamaAvailability');
    const ollamaInstalledList = document.getElementById('ollamaInstalledList');
    const ollamaPopularList = document.getElementById('ollamaPopularList');
    const ollamaJobsList = document.getElementById('ollamaJobsList');
    const clusterWarning = document.getElementById('clusterWarning');
    let clusterAvailabilityTimer = null;
    const ollamaServersPanel = document.getElementById('ollamaServersPanel');
    const ollamaServersList = document.getElementById('ollamaServersList');
    const ollamaServersStatus = document.getElementById('ollamaServersStatus');
    const ollamaServersRefreshBtn = document.getElementById('ollamaServersRefresh');
    const ollamaServerForm = document.getElementById('ollamaServerForm');
    const ollamaServerName = document.getElementById('ollamaServerName');
    const ollamaServerUrl = document.getElementById('ollamaServerUrl');
    const ollamaServerEnabled = document.getElementById('ollamaServerEnabled');
    const projectModalBackdrop = document.getElementById('projectModal');
    const projectModalForm = document.getElementById('projectModalForm');
    const projectModalClose = document.getElementById('projectModalClose');
    const projectModalCancel = document.getElementById('projectModalCancel');
    const projectModalStatus = document.getElementById('projectModalStatus');
    const projectModalName = document.getElementById('projectModalName');
    const projectModalTitle = document.getElementById('projectModalTitle');
    const projectModalDomain = document.getElementById('projectModalDomain');
    const projectModalModel = document.getElementById('projectModalModel');
    const projectModalPrompt = document.getElementById('projectModalPrompt');
    const projectModalPromptRole = document.getElementById('projectModalPromptRole');
    const projectModalPromptAiBtn = document.getElementById('projectModalPromptAi');
    const projectModalPromptAiStatus = document.getElementById('projectModalPromptAiStatus');
    ensurePromptRoleOptions(projectPromptRoleSelect);
    ensurePromptRoleOptions(projectModalPromptRole);
    if (projectPromptAiStatus) projectPromptAiStatus.textContent = 'â€”';
    if (projectModalPromptAiStatus) projectModalPromptAiStatus.textContent = 'â€”';
    const projectModalEmotions = document.getElementById('projectModalEmotions');
    const projectModalAdminUsername = document.getElementById('projectModalAdminUsername');
    const projectModalAdminPassword = document.getElementById('projectModalAdminPassword');
    const projectModalWidget = document.getElementById('projectModalWidgetUrl');
    const projectModalTelegram = document.getElementById('projectModalTelegram');
    const projectModalTelegramAuto = document.getElementById('projectModalTelegramAuto');
    const startUrlInput = document.getElementById('url');
    let startUrlManual = false;
    if (startUrlInput) {
      startUrlInput.addEventListener('input', () => { startUrlManual = true; });
    }
    let projectsCache = {};
    let voiceSamplesCache = [];
    let voiceJobsCache = [];
    let voiceJobsPollTimer = null;
    const VOICE_MIN_SAMPLE_COUNT = 3;
    let projectStatusTimer = null;
    let projectStatusLocked = false;
    let lastProjectCount = 0;

    let LLM_MODEL_OPTIONS = [];
    let OLLAMA_CATALOG = { available: false, installed: [], popular: [], jobs: {}, default_model: null };
    let OLLAMA_INSTALLED_SET = new Set();
    let ollamaPollTimer = null;
    let OLLAMA_SERVERS = [];
    let qaPairsCache = [];
    let knowledgePriorityOrder = [];
    let draggingPriorityItem = null;

    async function performAdminLogout() {
      if (logoutButton) {
        logoutButton.disabled = true;
        logoutButton.textContent = t('logoutProgress');
      }
      clearAuthHeaderForBase(ADMIN_BASE_KEY);
      setStoredAdminUser('');
      const origin = window.location.origin || `${window.location.protocol}//${window.location.host}`;
      const logoutEndpoint = `${origin}/api/v1/admin/logout`;
      const nonce = Date.now().toString(36);
      const invalidAuthHeader = `Basic ${btoa(`logout:${nonce}`)}`;
      try {
        await fetch(logoutEndpoint, {
          method: 'POST',
          cache: 'no-store',
          credentials: 'include',
          headers: {
            Authorization: invalidAuthHeader,
            'Cache-Control': 'no-store, max-age=0',
            Pragma: 'no-cache',
          },
        });
      } catch (error) {
        console.warn('admin_logout_request_failed', error);
      }
      try {
        await navigator.credentials?.preventSilentAccess?.();
      } catch (error) {
        console.warn('admin_logout_credentials_failed', error);
      }
      try {
        localStorage.removeItem('admin_project');
      } catch (error) {
        console.warn('admin_logout_localstorage_failed', error);
      }
      setTimeout(() => {
        const logoutUrlWithNonce = `${window.location.protocol}//logout:${nonce}@${window.location.host}/api/v1/admin/logout?ts=${Date.now()}`;
        try {
          window.location.replace(logoutUrlWithNonce);
        } catch (error) {
          console.warn('admin_logout_replace_failed', error);
          window.location.href = `${logoutEndpoint}?ts=${Date.now()}`;
        }
      }, 120);
    }

    if (logoutButton) {
      logoutButton.addEventListener('click', (event) => {
        event.preventDefault();
        performAdminLogout();
      });
    }

    const summaryProjectCard = document.getElementById('summaryProjectCard');
    const summaryProjectEl = document.getElementById('summaryProject');
    const summaryProjectMeta = document.getElementById('summaryProjectMeta');
    const summaryCrawlerCard = document.getElementById('summaryCrawlerCard');
    const summaryCrawlerEl = document.getElementById('summaryCrawler');
    const summaryCrawlerMeta = document.getElementById('summaryCrawlerMeta');
    const summaryPerfEl = document.getElementById('summaryPerf');
    const summaryPerfMeta = document.getElementById('summaryPerfMeta');
    const summaryPromptEl = document.getElementById('summaryPrompt');
    const summaryPromptDocs = document.getElementById('summaryPromptDocs');
    const summaryBuildEl = document.getElementById('summaryBuild');
    const summaryBuildMeta = document.getElementById('summaryBuildMeta');
    const kbDedupBtn = document.getElementById('kbDeduplicate');
    const kbDedupStatus = document.getElementById('kbDedupStatus');
    const kbClearBtn = document.getElementById('kbClearKnowledge');
    const kbClearStatus = document.getElementById('kbClearStatus');
    const kbDropZone = document.getElementById('kbDropZone');
    const kbDropZoneDefaultText = kbDropZone ? kbDropZone.textContent.trim() : '';
    const kbNewFileInput = document.getElementById('kbNewFile');
    const kbThinkingOverlay = document.getElementById('kbThinkingOverlay');
    const kbThinkingCaption = document.getElementById('kbThinkingCaption');
    const kbThinkingMessage = document.getElementById('kbThinkingMessage');
    const kbThinkingPreview = document.getElementById('kbThinkingPreview');
    const kbAutoDescription = document.getElementById('kbAutoDescription');
    const kbTableText = document.getElementById('kbTableText');
    const kbTableDocs = document.getElementById('kbTableDocs');
    const kbTableImages = document.getElementById('kbTableImages');
    const kbTableQa = document.getElementById('kbTableQa');
    const kbCountText = document.getElementById('kbCountText');
    const kbCountDocs = document.getElementById('kbCountDocs');
    const kbCountImages = document.getElementById('kbCountImages');
    const kbCountQa = document.getElementById('kbCountQa');
    const kbQaStatus = document.getElementById('kbQaStatus');
    const kbQaImportForm = document.getElementById('kbQaImportForm');
    const kbQaFileInput = document.getElementById('kbQaFile');
    const kbQaAddRowBtn = document.getElementById('kbQaAddRow');
    const kbPriorityList = document.getElementById('kbPriorityList');
    const kbPrioritySave = document.getElementById('kbPrioritySave');
    const kbPriorityStatus = document.getElementById('kbPriorityStatus');
    const kbTableUnanswered = document.getElementById('kbTableUnanswered');
    const kbCountUnanswered = document.getElementById('kbCountUnanswered');
    const kbUnansweredExportBtn = document.getElementById('kbUnansweredExport');
    const kbUnansweredClearBtn = document.getElementById('kbUnansweredClear');
    const kbUnansweredStatus = document.getElementById('kbUnansweredStatus');
    const KB_IMAGE_EXTENSIONS = ['.png', '.jpg', '.jpeg', '.gif', '.webp', '.bmp', '.svg'];
    const KB_TEXT_LIKE_TYPES = new Set(['application/json', 'application/xml', 'text/csv']);
    const KB_STATUS_PENDING = new Set(['pending_auto_description', 'auto_description_in_progress']);
    const KNOWLEDGE_SOURCES = [
      { id: 'qa', label: 'FAQ (Ð’Ð¾Ð¿Ñ€Ð¾Ñâ€“Ð¾Ñ‚Ð²ÐµÑ‚)' },
      { id: 'qdrant', label: 'Ð’ÐµÐºÑ‚Ð¾Ñ€Ð½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº' },
      { id: 'mongo', label: 'Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¸ Ñ„Ð°Ð¹Ð»Ñ‹' },
    ];

    const kbTables = {
      text: { body: kbTableText, counter: kbCountText, empty: 'Ð¢ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚' },
      docs: { body: kbTableDocs, counter: kbCountDocs, empty: 'Ð¤Ð°Ð¹Ð»Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹' },
      images: { body: kbTableImages, counter: kbCountImages, empty: 'ÐÐµÑ‚ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹' },
    };

    const getDocCategory = (doc) => {
      const contentType = String(doc.content_type || doc.contentType || '').toLowerCase();
      if (contentType.startsWith('image/')) return 'images';
      if (contentType && contentType.startsWith('text/')) return 'text';
      if (KB_TEXT_LIKE_TYPES.has(contentType)) return 'text';
      const name = String(doc.name || '').toLowerCase();
      if (KB_IMAGE_EXTENSIONS.some((ext) => name.endsWith(ext))) return 'images';
      if (contentType && !contentType.startsWith('text/')) return 'docs';
      if (doc.fileId && !contentType) return 'docs';
      return 'text';
    };

    const createAutoBadge = (doc) => {
      const autoPending = doc.autoDescriptionPending === true;
      const status = String(doc.status || '').toLowerCase();
      const message = doc.statusMessage || '';
      if (autoPending || KB_STATUS_PENDING.has(status)) {
        const badge = document.createElement('span');
        badge.className = 'kb-auto-badge pending';
        badge.textContent = 'AI';
        badge.title = message || 'ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÑ‚ÑÑ';
        badge.setAttribute('aria-label', badge.title);
        return badge;
      }
      if (status === 'auto_description_failed') {
        const badge = document.createElement('span');
        badge.className = 'kb-auto-badge failed';
        badge.textContent = 'AI';
        badge.title = message || 'ÐÐ²Ñ‚Ð¾Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ';
        badge.setAttribute('aria-label', badge.title);
        return badge;
      }
      return null;
    };

    const createTypeBadge = (category) => {
      if (category === 'text') return null;
      const badge = document.createElement('span');
      badge.className = 'kb-type-badge';
      badge.textContent = category === 'images' ? 'Ð¤Ð¾Ñ‚Ð¾' : 'Ð¤Ð°Ð¹Ð»';
      return badge;
    };

    const renderKnowledgeRow = (doc, category) => {
      const tr = document.createElement('tr');
      const nameTd = document.createElement('td');
      const autoBadge = createAutoBadge(doc);
      if (autoBadge) nameTd.appendChild(autoBadge);
      const typeBadge = createTypeBadge(category);
      if (typeBadge) nameTd.appendChild(typeBadge);
      nameTd.appendChild(document.createTextNode(doc.name || 'â€“'));

      const descTd = document.createElement('td');
      descTd.textContent = doc.description || 'â€“';

      const projectTd = document.createElement('td');
      projectTd.textContent = doc.project || doc.domain || 'â€“';

      const linkTd = document.createElement('td');
      if (doc.fileId || doc.downloadUrl || doc.url) {
        const a = document.createElement('a');
        a.textContent = 'Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ';
        const href = doc.downloadUrl || doc.url || `/api/v1/admin/knowledge/documents/${encodeURIComponent(doc.fileId)}`;
        a.href = href;
        a.target = '_blank';
        a.rel = 'noopener';
        if (doc.name) a.download = doc.name;
        linkTd.appendChild(a);
      } else {
        linkTd.textContent = 'â€”';
      }

      const actionsTd = document.createElement('td');
      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.textContent = 'Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ';
      if (category !== 'text') {
        editBtn.textContent = 'ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ';
        editBtn.title = 'Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ';
      }
      editBtn.addEventListener('click', () => openKnowledgeModal(doc.fileId));
      actionsTd.appendChild(editBtn);

      tr.append(nameTd, descTd, projectTd, linkTd, actionsTd);
      return tr;
    };

    const renderEmptyRow = (tbody, text) => {
      const row = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 5;
      cell.textContent = text;
      cell.className = 'muted';
      row.appendChild(cell);
      tbody.appendChild(row);
    };

    const normalizeKnowledgePriority = (order) => {
      const known = new Set(KNOWLEDGE_SOURCES.map((item) => item.id));
      const sanitized = Array.isArray(order)
        ? order.map((value) => String(value || '').trim()).filter((value) => known.has(value))
        : [];
      KNOWLEDGE_SOURCES.forEach((source) => {
        if (!sanitized.includes(source.id)) sanitized.push(source.id);
      });
      return sanitized;
    };

    const renderKnowledgePriority = (order) => {
      if (!kbPriorityList) return;
      kbPriorityList.innerHTML = '';
      knowledgePriorityOrder = normalizeKnowledgePriority(order);
      knowledgePriorityOrder.forEach((sourceId) => {
        const source = KNOWLEDGE_SOURCES.find((item) => item.id === sourceId);
        if (!source) return;
        const li = document.createElement('li');
        li.className = 'kb-priority-item';
        li.draggable = true;
        li.dataset.source = source.id;
        const label = document.createElement('span');
        label.textContent = source.label;
        li.appendChild(label);
        const handle = document.createElement('span');
        handle.className = 'kb-priority-handle';
        handle.textContent = 'â‹®â‹®';
        li.appendChild(handle);
        kbPriorityList.appendChild(li);
      });

      kbPriorityList.querySelectorAll('.kb-priority-item').forEach((item) => {
        item.addEventListener('dragstart', (event) => {
          draggingPriorityItem = item;
          item.classList.add('dragging');
          if (event.dataTransfer) {
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', item.dataset.source || '');
          }
        });
        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
          draggingPriorityItem = null;
        });
      });

      if (!kbPriorityList.dataset.dragBound) {
        kbPriorityList.addEventListener('dragover', (event) => {
          if (!draggingPriorityItem) return;
          event.preventDefault();
          const target = event.target.closest('.kb-priority-item');
          if (!target || target === draggingPriorityItem) return;
          const rect = target.getBoundingClientRect();
          const after = event.clientY - rect.top > rect.height / 2;
          kbPriorityList.insertBefore(
            draggingPriorityItem,
            after ? target.nextSibling : target,
          );
        });
        kbPriorityList.dataset.dragBound = '1';
      }
    };

    const getKnowledgePriorityOrder = () => {
      if (!kbPriorityList) return knowledgePriorityOrder;
      const order = Array.from(kbPriorityList.querySelectorAll('.kb-priority-item'))
        .map((item) => item.dataset.source || '')
        .filter(Boolean);
      knowledgePriorityOrder = normalizeKnowledgePriority(order);
      return knowledgePriorityOrder;
    };

    async function loadKnowledgePriority(projectName) {
      if (!kbPriorityList) return;
      try {
        const params = new URLSearchParams();
        if (projectName) params.set('project', projectName);
        const query = params.toString();
        const url = query ? `/api/v1/admin/knowledge/priority?${query}` : '/api/v1/admin/knowledge/priority';
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('priority_load_failed');
        const data = await resp.json();
        renderKnowledgePriority(data.order || []);
      } catch (error) {
        console.error('knowledge_priority_load_failed', error);
        renderKnowledgePriority(knowledgePriorityOrder);
        if (kbPriorityStatus) {
          kbPriorityStatus.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ñ‹';
        }
      }
    }

    async function saveKnowledgePriority() {
      if (!kbPriorityList || !kbPrioritySave) return;
      const order = getKnowledgePriorityOrder();
      if (kbPriorityStatus) {
        kbPriorityStatus.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼...';
      }
      kbPrioritySave.disabled = true;
      try {
        const payload = { order };
        const params = new URLSearchParams();
        if (currentProject) params.set('project', currentProject);
        const query = params.toString();
        const url = query ? `/api/v1/admin/knowledge/priority?${query}` : '/api/v1/admin/knowledge/priority';
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        if (kbPriorityStatus) {
          kbPriorityStatus.textContent = 'ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹';
        }
      } catch (error) {
        console.error('knowledge_priority_save_failed', error);
        if (kbPriorityStatus) {
          kbPriorityStatus.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ñ‹';
        }
      } finally {
        kbPrioritySave.disabled = false;
        setTimeout(() => {
          if (kbPriorityStatus) kbPriorityStatus.textContent = '';
        }, 4000);
      }
    }
    const kbNavButtons = Array.from(document.querySelectorAll('[data-kb-target]'));
    const kbSections = Array.from(document.querySelectorAll('[data-kb-section]'));

    const activateKnowledgeSection = (target) => {
      if (!target) return;
      kbSections.forEach((section) => {
        const matches = section.dataset.kbSection === target;
        section.classList.toggle('active', matches);
        if (matches) {
          section.removeAttribute('aria-hidden');
        } else {
          section.setAttribute('aria-hidden', 'true');
        }
      });
      kbNavButtons.forEach((button) => {
        const matches = button.dataset.kbTarget === target;
        button.classList.toggle('active', matches);
        button.setAttribute('aria-selected', matches ? 'true' : 'false');
        button.setAttribute('tabindex', matches ? '0' : '-1');
      });
    };

    if (kbNavButtons.length && kbSections.length) {
      const defaultTarget = (kbNavButtons.find((btn) => btn.classList.contains('active')) || kbNavButtons[0]).dataset.kbTarget;
      activateKnowledgeSection(defaultTarget);

      const focusTabByOffset = (currentIndex, delta) => {
        const total = kbNavButtons.length;
        const nextIndex = (currentIndex + delta + total) % total;
        const nextBtn = kbNavButtons[nextIndex];
        activateKnowledgeSection(nextBtn.dataset.kbTarget);
        nextBtn.focus();
      };

      kbNavButtons.forEach((button, index) => {
        button.addEventListener('click', () => {
          activateKnowledgeSection(button.dataset.kbTarget);
          button.focus();
        });
        button.addEventListener('keydown', (event) => {
          if (event.key === 'ArrowRight') {
            event.preventDefault();
            focusTabByOffset(index, 1);
          } else if (event.key === 'ArrowLeft') {
            event.preventDefault();
            focusTabByOffset(index, -1);
          }
        });
      });
    }

    const resetKnowledgePreview = () => {
      if (kbThinkingPreview) {
        kbThinkingPreview.textContent = '';
        kbThinkingPreview.classList.remove('visible');
      }
    };

    const showKnowledgeDescriptionPreview = (text) => {
      if (!kbThinkingPreview) return;
      const value = (text || '').trim();
      if (!value) {
        kbThinkingPreview.textContent = '';
        kbThinkingPreview.classList.remove('visible');
        return;
      }
      kbThinkingPreview.textContent = value;
      kbThinkingPreview.classList.add('visible');
    };

    const renderAutoDescription = (text) => {
      if (!kbAutoDescription) return;
      const value = (text || '').trim();
      if (!value) {
        kbAutoDescription.textContent = '';
        kbAutoDescription.classList.remove('visible');
        return;
      }
      kbAutoDescription.textContent = `ÐÐ²Ñ‚Ð¾Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ: ${value}`;
      kbAutoDescription.classList.add('visible');
    };

    const showKnowledgeThinking = (
      caption = 'Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµâ€¦',
      subtitle = 'Ð­Ñ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÐµÐºÑƒÐ½Ð´.'
    ) => {
      if (!kbThinkingOverlay) return;
      kbThinkingOverlay.classList.add('active');
      if (kbThinkingCaption) kbThinkingCaption.textContent = caption;
      if (kbThinkingMessage) kbThinkingMessage.textContent = subtitle;
      resetKnowledgePreview();
      renderAutoDescription('');
    };

    const updateKnowledgeThinking = (subtitle, caption) => {
      if (caption && kbThinkingCaption) {
        kbThinkingCaption.textContent = caption;
      }
      if (
        kbThinkingOverlay &&
        kbThinkingOverlay.classList.contains('active') &&
        kbThinkingMessage &&
        subtitle
      ) {
        kbThinkingMessage.textContent = subtitle;
      }
    };

    const hideKnowledgeThinking = () => {
      if (kbThinkingOverlay) kbThinkingOverlay.classList.remove('active');
      resetKnowledgePreview();
    };

    const summaryState = {
      project: '',
      crawler: '',
      perf: '',
      build: '',
      prompt: '',
    };

    const WEEK_WINDOW_MS = 7 * 24 * 60 * 60 * 1000;

    const statsGraphState = {
      data: [],
      currentPoints: [],
      startPoints: [],
      targetPoints: [],
      animationId: null,
      startTime: 0,
      duration: 520,
      hoverIndex: null,
      width: 0,
      height: 0,
      pixelRatio: window.devicePixelRatio || 1,
      lastSignature: '',
      renderedPoints: [],
    };

    function pulseCard(card) {
      if (!card) return;
      card.classList.remove('updated');
      void card.offsetWidth;
      card.classList.add('updated');
      setTimeout(() => card.classList.remove('updated'), 1800);
    }

    function updateDropZonePreview(fileList) {
      if (!kbDropZone) return;
      const files = Array.from(fileList || []).filter(Boolean);
      if (!files.length) {
        kbDropZone.textContent = kbDropZoneDefaultText || 'ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° Ð¿Ð¾Ð»Ðµ Ð²Ñ‹ÑˆÐµ';
        kbDropZone.classList.remove('has-files');
        return;
      }

      const maxPreview = 4;
      const preview = files.slice(0, maxPreview).map((file) => {
        const size = typeof file.size === 'number' ? ` (${formatBytes(file.size)})` : '';
        return `${file.name}${size}`;
      }).join(', ');
      const remaining = files.length > maxPreview ? `, +${files.length - maxPreview}` : '';
      kbDropZone.textContent = `Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²: ${files.length}. ${preview}${remaining}`;
      kbDropZone.classList.add('has-files');
    }

    window.updateDropZonePreview = updateDropZonePreview;

    function formatDateISO(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    const formatBytesOptional = (value) => {
      const numeric = Number(value || 0);
      return numeric > 0 ? formatBytes(numeric) : 'â€”';
    };

    const formatTimestamp = (value) => {
      if (value === null || value === undefined) return 'â€”';
      let numeric = Number(value);
      if (!Number.isFinite(numeric)) return 'â€”';
      if (numeric < 1e11) {
        numeric *= 1000;
      }
      const dt = new Date(numeric);
      if (Number.isNaN(dt.getTime())) return 'â€”';
      return dt.toLocaleString();
    };

    const ensureBackupTimezones = () => {
      if (!backupTimezoneSelect || backupTimezoneSelect.options.length) return;
      BACKUP_TIMEZONES.forEach((tz) => {
        const option = document.createElement('option');
        option.value = tz;
        option.textContent = tz;
        backupTimezoneSelect.appendChild(option);
      });
    };

    const setBackupControlsDisabled = (disabled) => {
      const nodes = [
        backupEnabledInput,
        backupTimeInput,
        backupTimezoneSelect,
        backupFolderInput,
        backupTokenInput,
        backupTokenSaveBtn,
        backupTokenClearBtn,
        backupSettingsApplyBtn,
        backupRunBtn,
        backupRefreshBtn,
        backupRestorePathInput,
        backupRestoreBtn,
      ];
      nodes.forEach((node) => {
        if (node) node.disabled = disabled;
      });
    };

    const formatBackupTimeValue = (hour, minute) => {
      const safeHour = Math.max(0, Math.min(23, Number.isFinite(Number(hour)) ? Number(hour) : 0));
      const safeMinute = Math.max(0, Math.min(59, Number.isFinite(Number(minute)) ? Number(minute) : 0));
      return `${String(safeHour).padStart(2, '0')}:${String(safeMinute).padStart(2, '0')}`;
    };

    const parseBackupTime = (value) => {
      if (typeof value !== 'string') return { hour: 3, minute: 0 };
      const [hours, minutes] = value.split(':');
      const hour = Number(hours);
      const minute = Number(minutes);
      if (!Number.isFinite(hour) || !Number.isFinite(minute)) {
        return { hour: 3, minute: 0 };
      }
      return {
        hour: Math.max(0, Math.min(23, Math.trunc(hour))),
        minute: Math.max(0, Math.min(59, Math.trunc(minute))),
      };
    };

    const formatBackupTimestamp = (value) => {
      if (!value) return null;
      try {
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return null;
        return date.toLocaleString();
      } catch (error) {
        return null;
      }
    };

    const pushBackupMessage = (key, type = 'info') => {
      if (!backupErrorLine) return;
      const message = key ? t(key) : '';
      backupErrorLine.textContent = message;
      backupErrorLine.classList.remove('bad', 'ok');
      if (!message) return;
      if (type === 'error') {
        backupErrorLine.classList.add('bad');
      } else if (type === 'success') {
        backupErrorLine.classList.add('ok');
      }
    };

    const scheduleBackupRefresh = (active) => {
      if (backupRefreshTimer) {
        clearTimeout(backupRefreshTimer);
        backupRefreshTimer = null;
      }
      if (active) {
        backupRefreshTimer = setTimeout(() => {
          refreshBackupStatus(false);
        }, 5000);
      }
    };

    const updateBackupActionButtons = () => {
      const tokenSet = Boolean(backupState?.settings?.tokenSet);
      const activeJob = Boolean(backupState?.activeJob);
      const hasRestorePath = Boolean(backupRestorePathInput?.value.trim());
      if (backupRunBtn) backupRunBtn.disabled = !adminSession.is_super || !tokenSet || activeJob;
      if (backupRefreshBtn) backupRefreshBtn.disabled = !adminSession.is_super;
      if (backupSettingsApplyBtn) backupSettingsApplyBtn.disabled = !adminSession.is_super;
      if (backupTokenSaveBtn) backupTokenSaveBtn.disabled = !adminSession.is_super;
      if (backupTokenClearBtn) backupTokenClearBtn.disabled = !adminSession.is_super;
      if (backupRestoreBtn) backupRestoreBtn.disabled = !adminSession.is_super || !tokenSet || activeJob || !hasRestorePath;
    };

    const renderBackupState = (data) => {
      if (!adminSession.is_super) {
        scheduleBackupRefresh(false);
        return;
      }
      ensureBackupTimezones();
      backupState = {
        settings: data?.settings || {},
        activeJob: data?.activeJob || null,
        jobs: Array.isArray(data?.jobs) ? data.jobs : [],
      };
      const settings = backupState.settings;
      if (backupEnabledInput) {
        backupEnabledInput.checked = settings.enabled === undefined ? false : Boolean(settings.enabled);
      }
      if (backupTimeInput) {
        backupTimeInput.value = formatBackupTimeValue(settings.hour ?? 3, settings.minute ?? 0);
      }
      if (backupTimezoneSelect) {
        const tzValue = settings.timezone || 'UTC';
        if (!Array.from(backupTimezoneSelect.options).some((option) => option.value === tzValue)) {
          const option = document.createElement('option');
          option.value = tzValue;
          option.textContent = tzValue;
          backupTimezoneSelect.appendChild(option);
        }
        backupTimezoneSelect.value = tzValue;
      }
      if (backupFolderInput) {
        backupFolderInput.value = settings.yaDiskFolder || '';
      }
      if (backupTokenStatus) {
        if (settings.tokenSet) {
          backupTokenStatus.textContent = t('backupTokenSaved');
          backupTokenStatus.classList.add('ok');
          backupTokenStatus.classList.remove('bad');
        } else {
          backupTokenStatus.textContent = t('backupTokenMissing');
          backupTokenStatus.classList.add('bad');
          backupTokenStatus.classList.remove('ok');
        }
      }

      const lines = [];
      const activeJob = backupState.activeJob;
      if (activeJob) {
        const statusKey = activeJob.status === 'running' ? 'backupStatusLineActive' : 'backupStatusLineQueued';
        lines.push(t(statusKey));
      } else if (!settings.enabled) {
        lines.push(t('backupStatusLineWaiting'));
      }
      const lastRunText = formatBackupTimestamp(settings.lastRunAtIso || settings.lastRunAt);
      if (lastRunText) {
        lines.push(t('backupStatusLastRun', { value: lastRunText }));
      }
      const lastSuccessText = formatBackupTimestamp(settings.lastSuccessAtIso || settings.lastSuccessAt);
      if (lastSuccessText) {
        lines.push(t('backupStatusLastSuccess', { value: lastSuccessText }));
      }
      if (!lastRunText && !lastSuccessText && !activeJob) {
        lines.push(t('backupStatusNever'));
      }
      if (backupStatusLine) {
        backupStatusLine.textContent = lines.join(' â€¢ ');
      }

      if (backupJobsList) {
        backupJobsList.innerHTML = '';
        const jobs = backupState.jobs;
        if (!jobs.length) {
          const empty = document.createElement('div');
          empty.className = 'backup-empty';
          empty.textContent = t('backupJobsEmpty');
          backupJobsList.appendChild(empty);
        } else {
          jobs.forEach((job) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'backup-job';
            if (activeJob && job.id === activeJob.id) {
              wrapper.classList.add('primary');
            }
            const operationLabel = job.operation === 'restore'
              ? t('backupJobOperationRestore')
              : t('backupJobOperationBackup');
            let statusKey = 'backupJobStatusQueued';
            if (job.status === 'running') statusKey = 'backupJobStatusRunning';
            else if (job.status === 'completed') statusKey = 'backupJobStatusCompleted';
            else if (job.status === 'failed') statusKey = 'backupJobStatusFailed';

            const title = document.createElement('strong');
            title.textContent = `${operationLabel} â€” ${t(statusKey)}`;
            wrapper.appendChild(title);

            if (job.remotePath) {
              const remote = document.createElement('small');
              remote.textContent = job.remotePath;
              wrapper.appendChild(remote);
            }

            if (job.createdAtIso || job.createdAt) {
              const created = document.createElement('small');
              created.textContent = formatBackupTimestamp(job.createdAtIso || job.createdAt) || '';
              wrapper.appendChild(created);
            }

            if (job.error) {
              const errorRow = document.createElement('small');
              errorRow.className = 'bad';
              errorRow.textContent = job.error;
              wrapper.appendChild(errorRow);
            }

            if (job.remotePath) {
              const actions = document.createElement('div');
              actions.className = 'backup-job-actions';
              if (job.operation === 'backup' && backupRestorePathInput) {
                const useBtn = document.createElement('button');
                useBtn.type = 'button';
                useBtn.textContent = t('backupJobRestore');
                useBtn.addEventListener('click', () => {
                  backupRestorePathInput.value = job.remotePath;
                  updateBackupActionButtons();
                  backupRestorePathInput.focus();
                });
                actions.appendChild(useBtn);
              }
              const copyBtn = document.createElement('button');
              copyBtn.type = 'button';
              copyBtn.textContent = t('backupJobCopyPath');
              copyBtn.addEventListener('click', async () => {
                try {
                  if (navigator.clipboard?.writeText) {
                    await navigator.clipboard.writeText(job.remotePath);
                  } else {
                    const temp = document.createElement('textarea');
                    temp.value = job.remotePath;
                    document.body.appendChild(temp);
                    temp.select();
                    document.execCommand('copy');
                    document.body.removeChild(temp);
                  }
                  pushBackupMessage('logCopySuccess', 'success');
                } catch (error) {
                  console.error('backup_copy_path_failed', error);
                  pushBackupMessage('logCopyError', 'error');
                }
              });
              actions.appendChild(copyBtn);
              wrapper.appendChild(actions);
            }

            backupJobsList.appendChild(wrapper);
          });
        }
      }

      updateBackupActionButtons();
      scheduleBackupRefresh(Boolean(activeJob));
    };

    const refreshBackupStatus = async (clearMessage = false) => {
      if (!adminSession.is_super) {
        scheduleBackupRefresh(false);
        return;
      }
      ensureBackupTimezones();
      if (backupRefreshTimer) {
        clearTimeout(backupRefreshTimer);
        backupRefreshTimer = null;
      }
      try {
        const resp = await fetch('/api/v1/backup/status?limit=6');
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        const data = await resp.json();
        renderBackupState(data);
        if (clearMessage) pushBackupMessage('', 'info');
      } catch (error) {
        console.error('backup_status_failed', error);
        pushBackupMessage('backupJobsFetchError', 'error');
      }
    };

    const handleBackupSettingsSave = async ({ tokenAction } = {}) => {
      if (!adminSession.is_super) return;
      ensureBackupTimezones();
      const { hour, minute } = parseBackupTime(backupTimeInput?.value || '03:00');
      const payload = {
        enabled: Boolean(backupEnabledInput?.checked),
        hour,
        minute,
        timezone: backupTimezoneSelect?.value || 'UTC',
        yaDiskFolder: backupFolderInput?.value?.trim() || 'sitellm-backups',
      };
      if (tokenAction === 'save') {
        const tokenValue = (backupTokenInput?.value || '').trim();
        if (!tokenValue) {
          pushBackupMessage('backupTokenRequired', 'error');
          return;
        }
        payload.token = tokenValue;
      } else if (tokenAction === 'clear') {
        payload.clearToken = true;
      }
      try {
        const resp = await fetch('/api/v1/backup/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        if (tokenAction === 'save' && backupTokenInput) {
          backupTokenInput.value = '';
        }
        pushBackupMessage('backupSaveSuccess', 'success');
        await refreshBackupStatus(false);
      } catch (error) {
        console.error('backup_settings_save_failed', error);
        pushBackupMessage('backupSaveError', 'error');
      }
    };

    const handleBackupRun = async () => {
      if (!adminSession.is_super || backupRunBtn?.disabled) return;
      try {
        backupRunBtn.disabled = true;
        const resp = await fetch('/api/v1/backup/run', { method: 'POST' });
        if (!resp.ok) {
          const detail = await resp.json().catch(() => null);
          throw new Error(detail?.detail || `HTTP ${resp.status}`);
        }
        pushBackupMessage('backupRunQueued', 'success');
        await refreshBackupStatus(false);
      } catch (error) {
        console.error('backup_run_failed', error);
        pushBackupMessage('backupSaveError', 'error');
      } finally {
        updateBackupActionButtons();
      }
    };

    const handleBackupRestore = async () => {
      if (!adminSession.is_super || backupRestoreBtn?.disabled) return;
      const remotePath = (backupRestorePathInput?.value || '').trim();
      if (!remotePath) {
        pushBackupMessage('backupRestorePathMissing', 'error');
        return;
      }
      try {
        backupRestoreBtn.disabled = true;
        const resp = await fetch('/api/v1/backup/restore', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ remotePath }),
        });
        if (!resp.ok) {
          const detail = await resp.json().catch(() => null);
          throw new Error(detail?.detail || `HTTP ${resp.status}`);
        }
        pushBackupMessage('backupRestoreQueued', 'success');
        await refreshBackupStatus(false);
      } catch (error) {
        console.error('backup_restore_failed', error);
        pushBackupMessage('backupSaveError', 'error');
      } finally {
        updateBackupActionButtons();
      }
    };

    if (backupSettingsApplyBtn) {
      backupSettingsApplyBtn.addEventListener('click', () => handleBackupSettingsSave());
    }
    if (backupTokenSaveBtn) {
      backupTokenSaveBtn.addEventListener('click', () => handleBackupSettingsSave({ tokenAction: 'save' }));
    }
    if (backupTokenClearBtn) {
      backupTokenClearBtn.addEventListener('click', () => handleBackupSettingsSave({ tokenAction: 'clear' }));
    }
    if (backupRunBtn) {
      backupRunBtn.addEventListener('click', handleBackupRun);
    }
    if (backupRefreshBtn) {
      backupRefreshBtn.addEventListener('click', () => refreshBackupStatus(true));
    }
    if (backupRestoreBtn) {
      backupRestoreBtn.addEventListener('click', handleBackupRestore);
    }
    if (backupRestorePathInput) {
      backupRestorePathInput.addEventListener('input', () => updateBackupActionButtons());
    }

    function parseLogLineTimestamp(line) {
      if (!line) return null;
      try {
        const obj = JSON.parse(line);
        const ts = obj.timestamp || obj.ts || obj.time;
        if (typeof ts === 'string') {
          const parsed = Date.parse(ts);
          if (!Number.isNaN(parsed)) return parsed;
        }
      } catch {}
      const isoMatch = line.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[\+\-]\d{2}:?\d{2})?/);
      if (isoMatch) {
        const parsed = Date.parse(isoMatch[0]);
        if (!Number.isNaN(parsed)) return parsed;
      }
      const dateMatch = line.match(/\d{4}-\d{2}-\d{2}/);
      if (dateMatch) {
        const parsed = Date.parse(`${dateMatch[0]}T00:00:00Z`);
        if (!Number.isNaN(parsed)) return parsed;
      }
      return null;
    }

    function filterRecentLines(lines) {
      const cutoff = Date.now() - WEEK_WINDOW_MS;
      if (!Array.isArray(lines)) return [];
      return lines.filter((line) => {
        const ts = parseLogLineTimestamp(line);
        return ts === null || ts >= cutoff;
      });
    }

    function renderKnowledgeServiceStatus(data) {
      if (!knowledgeServiceStatus) return;
      const bits = [];
      const message = data?.message || (data?.enabled ? 'Ð¡ÐµÑ€Ð²Ð¸Ñ Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½' : 'Ð¡ÐµÑ€Ð²Ð¸Ñ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½');
      bits.push(message);
      if (typeof data?.running === 'boolean') {
        bits.push(data.running ? 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½' : 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½');
      }
      if (typeof data?.enabled === 'boolean') {
        bits.push(data.enabled ? 'Ð ÐµÐ¶Ð¸Ð¼: Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½' : 'Ð ÐµÐ¶Ð¸Ð¼: Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½');
      }
      if (typeof data?.last_queue === 'number') {
        bits.push(`ÐžÑ‡ÐµÑ€ÐµÐ´ÑŒ: ${data.last_queue}`);
      }
      if (typeof data?.idle_seconds === 'number') {
        bits.push(`ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹: ${Math.max(0, Math.round(data.idle_seconds))} Ñ`);
      }
      if (data?.last_run_ts) {
        bits.push(`ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº: ${formatTimestamp(data.last_run_ts)}`);
      }
      if (data?.last_error) {
        bits.push(`ÐžÑˆÐ¸Ð±ÐºÐ°: ${data.last_error}`);
      }
      if (data?.updated_at) {
        bits.push(`ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾: ${formatTimestamp(data.updated_at)}`);
      }
      knowledgeServiceStatus.textContent = bits.join(' â€¢ ') || 'â€”';
    }

    async function callKnowledgeService(method = 'GET', payload = null) {
      if (!knowledgeServiceToggle && method === 'GET') {
        return null;
      }

      const headers = { Accept: 'application/json' };
      let body;
      if (method !== 'GET' && payload !== null) {
        headers['Content-Type'] = 'application/json';
        body = JSON.stringify(payload);
      }

      const tried = new Set();
      const order = [];
      if (activeKnowledgeServiceEndpoint) {
        order.push(activeKnowledgeServiceEndpoint);
        tried.add(activeKnowledgeServiceEndpoint);
      }
      for (const endpoint of knowledgeServiceEndpoints) {
        if (!tried.has(endpoint)) {
          order.push(endpoint);
          tried.add(endpoint);
        }
      }

      let lastError = null;
      for (const endpoint of order) {
        try {
          const resp = await fetch(endpoint, {
            method,
            headers,
            body,
            credentials: 'same-origin',
          });
          if (resp.status === 404) {
            const err = new Error('not_found');
            err.status = 404;
            lastError = err;
            continue;
          }
          if (!resp.ok) {
            const err = new Error(`HTTP ${resp.status}`);
            err.response = resp;
            throw err;
          }
          let data = null;
          if (method === 'GET') {
            data = await resp.json();
          } else if (resp.headers.get('Content-Type')?.includes('application/json')) {
            data = await resp.json();
          }
          activeKnowledgeServiceEndpoint = endpoint;
          return data;
        } catch (error) {
          lastError = error;
        }
      }
      throw lastError || new Error('knowledge service unavailable');
    }

    async function fetchKnowledgeServiceStatus(triggerPulse = false) {
      if (!knowledgeServiceToggle) return;
      if (!adminSession.is_super) {
        knowledgeServiceStatus.textContent = t('knowledgeServiceUnavailable');
        setKnowledgeServiceControlsDisabled(true);
        return;
      }
      knowledgeServiceStatus.textContent = t('knowledgeServiceLoading');
      setKnowledgeServiceControlsDisabled(true);
      try {
        const data = await callKnowledgeService('GET');
        if (data) {
          knowledgeServiceToggle.checked = !!data.enabled;
          renderKnowledgeServiceStatus(data);
          if (triggerPulse && knowledgeServiceCard) {
            pulseCard(knowledgeServiceCard);
          }
        } else {
          knowledgeServiceStatus.textContent = t('knowledgeServiceNoData');
        }
      } catch (error) {
        console.error('knowledge_service_status_failed', error);
        if (error?.message === 'not_found') {
          knowledgeServiceStatus.textContent = t('knowledgeServiceUpgrade');
        } else {
          knowledgeServiceStatus.textContent = t('knowledgeServiceFetchError');
        }
      } finally {
        setKnowledgeServiceControlsDisabled(false);
      }
    }

    async function saveKnowledgeServiceState() {
      if (!knowledgeServiceToggle) return;
      if (!adminSession.is_super) return;
      knowledgeServiceStatus.textContent = t('knowledgeServiceSaving');
      setKnowledgeServiceControlsDisabled(true);
      try {
        const payload = {
          enabled: knowledgeServiceToggle.checked,
        };
        await callKnowledgeService('POST', payload);
        knowledgeServiceStatus.textContent = t('knowledgeServiceSaved');
        await fetchKnowledgeServiceStatus(true);
      } catch (error) {
        console.error('knowledge_service_save_failed', error);
        if (error?.message === 'not_found') {
          knowledgeServiceStatus.textContent = t('knowledgeServiceUpgrade');
        } else {
          knowledgeServiceStatus.textContent = t('knowledgeServiceSaveError');
        }
      } finally {
        setKnowledgeServiceControlsDisabled(false);
      }
    }

    function initLayoutReordering() {
      const layout = document.querySelector('.dashboard-grid');
      const toggleButton = document.getElementById('toggleLayoutOrdering');
      if (!layout || !toggleButton) return;

      const getSections = () => Array.from(layout.querySelectorAll(':scope > section[data-block-id]'));

      const saveOrder = () => {
        const order = getSections()
          .map((section) => section.dataset.blockId || '')
          .filter(Boolean);
        try {
          localStorage.setItem(LAYOUT_ORDER_STORAGE_KEY, JSON.stringify(order));
        } catch (error) {
          console.warn('layout_order_save_failed', error);
        }
      };

      const restoreOrder = () => {
        const raw = localStorage.getItem(LAYOUT_ORDER_STORAGE_KEY);
        if (!raw) return;
        try {
          const stored = JSON.parse(raw);
          if (!Array.isArray(stored) || !stored.length) return;
          const sections = getSections();
          const desiredOrder = sections.slice().sort((a, b) => {
            const aIndex = stored.indexOf(a.dataset.blockId || '');
            const bIndex = stored.indexOf(b.dataset.blockId || '');
            const fallbackA = sections.indexOf(a);
            const fallbackB = sections.indexOf(b);
            const safeA = aIndex === -1 ? stored.length + fallbackA : aIndex;
            const safeB = bIndex === -1 ? stored.length + fallbackB : bIndex;
            return safeA - safeB;
          });
          const currentSections = sections.slice();
          desiredOrder.forEach((section, index) => {
            const target = currentSections[index];
            if (!target || section === target) {
              return;
            }
            layout.insertBefore(section, target);
            const currentIndex = currentSections.indexOf(section);
            currentSections.splice(currentIndex, 1);
            currentSections.splice(index, 0, section);
          });
        } catch (error) {
          console.warn('layout_order_restore_failed', error);
        }
      };

      restoreOrder();

      const clearDropHighlights = () => {
        layout.querySelectorAll('.reorder-drop-target').forEach((el) => el.classList.remove('reorder-drop-target'));
      };

      const getDragAfterElement = (container, y) => {
        const draggableElements = [...container.querySelectorAll(':scope > section[data-block-id]:not(.dragging)')];
        let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
        draggableElements.forEach((child) => {
          const rect = child.getBoundingClientRect();
          const offset = y - rect.top - rect.height / 2;
          if (offset < 0 && offset > closest.offset) {
            closest = { offset, element: child };
          }
        });
        return closest.element;
      };

      let isReorderMode = false;
      let draggingSection = null;

      const handleDragStart = (event) => {
        if (!isReorderMode) return;
        draggingSection = event.currentTarget;
        draggingSection.classList.add('dragging');
        if (event.dataTransfer) {
          event.dataTransfer.effectAllowed = 'move';
          event.dataTransfer.setData('text/plain', draggingSection.dataset.blockId || '');
        }
      };

      const handleDragEnd = (event) => {
        if (!isReorderMode) return;
        event.currentTarget.classList.remove('dragging');
        draggingSection = null;
        clearDropHighlights();
        saveOrder();
      };

      const handleDragOver = (event) => {
        if (!isReorderMode || !draggingSection) return;
        event.preventDefault();
        const afterElement = getDragAfterElement(layout, event.clientY);
        if (afterElement === draggingSection) return;
        if (afterElement == null) {
          layout.appendChild(draggingSection);
        } else {
          layout.insertBefore(draggingSection, afterElement);
        }
        clearDropHighlights();
        if (afterElement) {
          afterElement.classList.add('reorder-drop-target');
        }
      };

      layout.addEventListener('dragover', handleDragOver);
      layout.addEventListener('drop', (event) => {
        if (!isReorderMode) return;
        event.preventDefault();
        clearDropHighlights();
      });

      getSections().forEach((section) => {
        section.draggable = false;
        section.addEventListener('dragstart', handleDragStart);
        section.addEventListener('dragend', handleDragEnd);
      });

      const applyMode = (enabled) => {
        isReorderMode = enabled;
        document.body.classList.toggle('reorder-mode', enabled);
        toggleButton.textContent = enabled ? t('buttonReorderDone') : t('buttonReorder');
        toggleButton.setAttribute('aria-pressed', enabled ? 'true' : 'false');
        if (!enabled) {
          clearDropHighlights();
          if (draggingSection) {
            draggingSection.classList.remove('dragging');
            draggingSection = null;
          }
          saveOrder();
        }
        getSections().forEach((section) => {
          section.draggable = enabled;
        });
      };

      toggleButton.addEventListener('click', () => {
        applyMode(!isReorderMode);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && isReorderMode) {
          applyMode(false);
        }
      });
    }

    function ensureStatsCanvas() {
      if (!statsCanvas) return null;
      const rect = statsCanvas.getBoundingClientRect();
      const width = rect.width || statsCanvas.parentElement?.clientWidth || 400;
      const height = rect.height || statsCanvas.parentElement?.clientHeight || 200;
      const dpr = window.devicePixelRatio || 1;
      const scaledWidth = Math.round(width * dpr);
      const scaledHeight = Math.round(height * dpr);
      if (statsCanvas.width !== scaledWidth || statsCanvas.height !== scaledHeight) {
        statsCanvas.width = scaledWidth;
        statsCanvas.height = scaledHeight;
      }
      statsGraphState.width = width;
      statsGraphState.height = height;
      statsGraphState.pixelRatio = dpr;
      return { width, height, dpr };
    }

    function buildStatsPoints(stats) {
      if (!stats || !stats.length) return [];
      const dims = ensureStatsCanvas();
      if (!dims) return [];
      const { width, height } = dims;
      const paddingX = 28;
      const paddingY = 24;
      const innerWidth = Math.max(width - paddingX * 2, 10);
      const innerHeight = Math.max(height - paddingY * 2, 10);
      const maxValue = Math.max(...stats.map((item) => item.count || 0), 1);
      const step = stats.length > 1 ? innerWidth / (stats.length - 1) : 0;
      return stats.map((item, idx) => ({
        x: paddingX + step * idx,
        y: height - paddingY - ((item.count || 0) / maxValue) * innerHeight,
        value: item.count || 0,
        date: item.date,
      }));
    }

    function drawStatsGraph(points) {
      if (!statsCanvas) return;
      const dims = ensureStatsCanvas();
      if (!dims) return;
      const { width, height, dpr } = dims;
      const ctx = statsCanvas.getContext('2d');
      const paddingX = 28;
      const paddingY = 24;
      const baseline = height - paddingY;

      ctx.save();
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0, 0, width, height);

      ctx.strokeStyle = 'rgba(148, 163, 184, 0.12)';
      ctx.lineWidth = 1;
      ctx.setLineDash([6, 6]);
      const gridSteps = 4;
      for (let i = 0; i <= gridSteps; i++) {
        const y = paddingY + ((baseline - paddingY) / gridSteps) * i;
        ctx.beginPath();
        ctx.moveTo(paddingX, y);
        ctx.lineTo(width - paddingX, y);
        ctx.stroke();
      }
      ctx.setLineDash([]);

      if (points.length) {
        ctx.beginPath();
        ctx.moveTo(points[0].x, baseline);
        points.forEach((pt) => ctx.lineTo(pt.x, pt.y));
        ctx.lineTo(points[points.length - 1].x, baseline);
        ctx.closePath();
        const gradient = ctx.createLinearGradient(0, paddingY, 0, baseline);
        gradient.addColorStop(0, 'rgba(96, 165, 250, 0.32)');
        gradient.addColorStop(1, 'rgba(96, 165, 250, 0.04)');
        ctx.fillStyle = gradient;
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length; i += 1) {
          ctx.lineTo(points[i].x, points[i].y);
        }
        ctx.strokeStyle = 'rgba(96, 165, 250, 0.9)';
        ctx.lineWidth = 2;
        ctx.stroke();

        points.forEach((pt, idx) => {
          ctx.beginPath();
          ctx.arc(pt.x, pt.y, idx === statsGraphState.hoverIndex ? 4.6 : 3.2, 0, Math.PI * 2);
          ctx.fillStyle = idx === statsGraphState.hoverIndex ? '#ffffff' : 'rgba(96, 165, 250, 0.86)';
          ctx.fill();
        });

        const highlightIndex = statsGraphState.hoverIndex ?? points.length - 1;
        if (points[highlightIndex]) {
          const pt = points[highlightIndex];
          ctx.beginPath();
          ctx.moveTo(pt.x, paddingY - 8);
          ctx.lineTo(pt.x, baseline);
          ctx.strokeStyle = 'rgba(96, 165, 250, 0.28)';
          ctx.lineWidth = 1;
          ctx.stroke();
        }
      }

      ctx.restore();
      statsGraphState.renderedPoints = points;
    }

    function animateStatsGraphTo(points, animate = true) {
      if (!animate) {
        statsGraphState.currentPoints = points;
        drawStatsGraph(points);
        return;
      }
      const previous = statsGraphState.currentPoints;
      if (!previous.length || previous.length !== points.length) {
        statsGraphState.currentPoints = points;
        drawStatsGraph(points);
        return;
      }
      const startPoints = previous.map((pt) => ({ ...pt }));
      const targetPoints = points.map((pt) => ({ ...pt }));
      const startTime = performance.now();
      const duration = statsGraphState.duration;

      if (statsGraphState.animationId) cancelAnimationFrame(statsGraphState.animationId);

      function step(now) {
        const progress = Math.min((now - startTime) / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const blended = targetPoints.map((target, idx) => {
          const origin = startPoints[idx] || target;
          return {
            x: origin.x + (target.x - origin.x) * eased,
            y: origin.y + (target.y - origin.y) * eased,
            value: target.value,
            date: target.date,
          };
        });
        statsGraphState.currentPoints = blended;
        drawStatsGraph(blended);
        if (progress < 1) {
          statsGraphState.animationId = requestAnimationFrame(step);
        }
      }

      statsGraphState.animationId = requestAnimationFrame(step);
    }

    function handleStatsHover(event) {
      if (!statsCanvas || !statsGraphState.renderedPoints?.length) return;
      const rect = statsCanvas.getBoundingClientRect();
      const clientX = event.touches?.[0]?.clientX ?? event.clientX;
      const x = clientX - rect.left;
      let closest = 0;
      let minDist = Number.POSITIVE_INFINITY;
      statsGraphState.renderedPoints.forEach((pt, idx) => {
        const dist = Math.abs(pt.x - x);
        if (dist < minDist) {
          minDist = dist;
          closest = idx;
        }
      });
      statsGraphState.hoverIndex = closest;
      drawStatsGraph(statsGraphState.currentPoints.length ? statsGraphState.currentPoints : statsGraphState.renderedPoints);
      if (statsTooltip && statsGraphState.data[closest]) {
        const dataPoint = statsGraphState.data[closest];
        const point = statsGraphState.renderedPoints[closest];
        statsTooltip.textContent = `${dataPoint.date}: ${dataPoint.count}`;
        statsTooltip.style.left = `${point.x}px`;
        const clampedY = Math.max(point.y, 32);
        statsTooltip.style.top = `${clampedY}px`;
        statsTooltip.classList.add('show');
      }
    }

    function clearStatsHover() {
      statsGraphState.hoverIndex = null;
      drawStatsGraph(statsGraphState.currentPoints);
      if (statsTooltip) statsTooltip.classList.remove('show');
    }

    function renderStatsChart(stats, { animate = true } = {}) {
      if (!statsCanvas) return;
      statsGraphState.hoverIndex = null;
      if (statsTooltip) statsTooltip.classList.remove('show');

      const hasData = Array.isArray(stats) && stats.length > 0;
      if (statsEmpty) statsEmpty.style.display = hasData ? 'none' : 'grid';

      if (!hasData) {
        statsGraphState.data = [];
        statsGraphState.currentPoints = [];
        drawStatsGraph([]);
        if (statsSummary) {
          statsSummary.dataset.lastText = 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…';
          statsSummary.textContent = 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…';
        }
        if (statsSubtitle) {
          statsSubtitle.textContent = `ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ ${STATS_DAYS} Ð´Ð½ÐµÐ¹`;
        }
        return;
      }

      statsGraphState.data = stats;
      const signature = stats.map((item) => `${item.date}:${item.count || 0}`).join('|');
      const shouldAnimate = animate && statsGraphState.lastSignature && statsGraphState.lastSignature !== signature;
      statsGraphState.lastSignature = signature;

      const points = buildStatsPoints(stats);
      statsGraphState.currentPoints = statsGraphState.currentPoints.length ? statsGraphState.currentPoints : points;
      animateStatsGraphTo(points, shouldAnimate);

      const total = stats.reduce((sum, item) => sum + (item.count || 0), 0);
      const average = total && stats.length ? (total / stats.length).toFixed(1) : null;
      if (statsSummary) {
        const text = total ? `Ð’ÑÐµÐ³Ð¾ ${total} Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²${average ? ` Â· Ð² Ð´ÐµÐ½ÑŒ ${average}` : ''}` : 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…';
        statsSummary.dataset.lastText = text;
        statsSummary.textContent = text;
      }
      if (statsSubtitle) {
        const first = stats[0]?.date;
        const last = stats[stats.length - 1]?.date;
        statsSubtitle.textContent = first && last && stats.length > 1
          ? `${first} â€” ${last}`
          : (first || `ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ ${STATS_DAYS} Ð´Ð½ÐµÐ¹`);
      }
    }

    if (statsCanvas) {
      statsCanvas.addEventListener('mousemove', handleStatsHover);
      statsCanvas.addEventListener('mouseleave', clearStatsHover);
      statsCanvas.addEventListener('touchstart', handleStatsHover, { passive: true });
      statsCanvas.addEventListener('touchmove', handleStatsHover, { passive: true });
      statsCanvas.addEventListener('touchend', clearStatsHover);
    }

    window.addEventListener('resize', () => {
      if (!statsCanvas || !statsGraphState.data.length) return;
      const points = buildStatsPoints(statsGraphState.data);
      statsGraphState.currentPoints = points;
      drawStatsGraph(points);
    });

    async function loadRequestStats() {
      if (!statsCanvas) return;
      const previousSummary = statsSummary ? (statsSummary.dataset.lastText || statsSummary.textContent) : '';
      if (statsSummary) statsSummary.textContent = 'Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼â€¦';
      if (statsEmpty) statsEmpty.textContent = 'Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°â€¦';
      const params = new URLSearchParams();
      if (currentProject) params.set('project', currentProject);
      const end = new Date();
      const start = new Date(end);
      start.setDate(end.getDate() - (STATS_DAYS - 1));
      params.set('start', formatDateISO(start));
      params.set('end', formatDateISO(end));
      try {
        const resp = await fetch(`/api/v1/admin/stats/requests?${params.toString()}`);
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        if (statsEmpty) statsEmpty.textContent = 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…';
        renderStatsChart(data.stats || [], { animate: true });
      } catch (error) {
        console.error(error);
        if (statsEmpty) {
          statsEmpty.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸';
          statsEmpty.style.display = 'grid';
        }
        drawStatsGraph([]);
        if (statsSummary) {
          statsSummary.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸';
        }
        setTimeout(() => {
          if (statsSummary && statsSummary.textContent === 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸') {
            statsSummary.textContent = previousSummary || 'â€”';
          }
        }, 3000);
      }
    }

    async function exportRequestStats() {
      if (!statsExportBtn) return;
      const params = new URLSearchParams();
      if (currentProject) params.set('project', currentProject);
      const end = new Date();
      const start = new Date(end);
      start.setDate(end.getDate() - (STATS_DAYS - 1));
      params.set('start', formatDateISO(start));
      params.set('end', formatDateISO(end));
      const previousSummary = statsSummary ? (statsSummary.dataset.lastText || statsSummary.textContent) : '';
      try {
        if (statsSummary) statsSummary.textContent = 'Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ CSVâ€¦';
        const resp = await fetch(`/api/v1/admin/stats/requests/export?${params.toString()}`);
        if (!resp.ok) {
          const message = await resp.text();
          throw new Error(message || `HTTP ${resp.status}`);
        }
        const blob = await resp.blob();
        const href = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = href;
        link.download = `request-stats-${currentProject || 'all'}.csv`;
        document.body.appendChild(link);
        link.click();
        requestAnimationFrame(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(href);
        });
        if (statsSummary) {
          statsSummary.textContent = 'CSV Ð²Ñ‹Ð³Ñ€ÑƒÐ¶ÐµÐ½';
          setTimeout(() => {
            if (statsSummary.textContent === 'CSV Ð²Ñ‹Ð³Ñ€ÑƒÐ¶ÐµÐ½') {
              statsSummary.textContent = previousSummary || 'â€”';
            }
          }, 2600);
        }
      } catch (error) {
        console.error(error);
        if (statsSummary) {
          statsSummary.textContent = `ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°: ${error.message || error}`;
          setTimeout(() => {
            if (statsSummary.textContent?.startsWith('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°')) {
              statsSummary.textContent = previousSummary || 'â€”';
            }
          }, 3600);
        }
      }
    }

    function setSummaryProject(name, meta) {
      const label = name || 'â€”';
      const metaText = meta || 'ÐÐµÑ‚ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°';
      const signature = `${label}::${metaText}`;
      if (summaryState.project === signature) return;
      summaryState.project = signature;
      summaryProjectEl.textContent = label;
      summaryProjectMeta.textContent = metaText;
      pulseCard(summaryProjectCard);
    }

    function setSummaryCrawler(main, meta) {
      const display = main || 'â€”';
      const metaText = meta || '';
      const signature = `${display}::${metaText}`;
      if (summaryState.crawler === signature) return;
      summaryState.crawler = signature;
      summaryCrawlerEl.textContent = display;
      summaryCrawlerMeta.textContent = metaText;
      pulseCard(summaryCrawlerCard);
    }

    function setSummaryPerf(main, meta) {
      const display = main || 'â€”';
      const metaText = meta || '';
      const signature = `${display}::${metaText}`;
      if (summaryState.perf === signature) return;
      summaryState.perf = signature;
      summaryPerfEl.textContent = display;
      summaryPerfMeta.textContent = metaText;
      pulseCard(summaryPerfCard);
    }

    function setSummaryBuild(main, meta) {
      if (!summaryBuildEl || !summaryBuildMeta) return;
      const display = main || 'â€”';
      const metaText = meta || '';
      const signature = `${display}::${metaText}`;
      if (summaryState.build === signature) return;
      summaryState.build = signature;
      summaryBuildEl.textContent = display;
      summaryBuildMeta.textContent = metaText || 'â€”';
      pulseCard(summaryBuildCard);
    }

    function setSummaryPrompt(text, docs, meta) {
      const display = text || 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð·Ð´ÐµÑÑŒ';
      const docsList = Array.isArray(docs) ? docs.join('|') : '';
      const signature = `${display}::${docsList}::${meta || ''}`;
      if (summaryState.prompt === signature) return;
      summaryState.prompt = signature;
      summaryPromptEl.textContent = display;
      summaryPromptDocs.innerHTML = '';
      if (Array.isArray(docs) && docs.length) {
        const chipsWrap = document.createElement('div');
        chipsWrap.className = 'chips';
        docs.forEach((doc) => {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = doc;
          chipsWrap.appendChild(chip);
        });
        summaryPromptDocs.appendChild(chipsWrap);
      }
      if (meta) {
        const metaEl = document.createElement('div');
        metaEl.className = 'overview-meta';
        metaEl.textContent = meta;
        summaryPromptDocs.appendChild(metaEl);
      }
      pulseCard(summaryLLMCard);
    }

    function updateProjectSummary() {
      if (projectStatusLocked || projectStatusTimer) return;
      if (lastProjectCount > 0) {
        projectStatus.textContent = `${lastProjectCount} Ð¿Ñ€Ð¾ÐµÐºÑ‚(Ð¾Ð²)`;
      } else {
        projectStatus.textContent = 'Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚ ÐºÐ½Ð¾Ð¿ÐºÐ¾Ð¹ Ð²Ñ‹ÑˆÐµ';
      }
    }

    async function fetchProjectStorage() {
      try {
        const resp = await fetch('/api/v1/admin/projects/storage');
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        projectStorageCache = data.projects || {};
        updateProjectDeleteInfo(currentProject);
      } catch (error) {
        console.error(error);
      }
    }

    function setProjectStatus(message, timeoutMs) {
      if (projectStatusTimer) {
        clearTimeout(projectStatusTimer);
        projectStatusTimer = null;
      }
      projectStatusLocked = !timeoutMs;
      projectStatus.textContent = message;
      if (timeoutMs) {
        projectStatusTimer = setTimeout(() => {
          projectStatusTimer = null;
          projectStatusLocked = false;
          updateProjectSummary();
        }, timeoutMs);
      }
    }

    function getPreferredModelValue(currentValue = '') {
      const trimmed = (currentValue || '').trim();
      if (trimmed) return trimmed;
      const installedOption = LLM_MODEL_OPTIONS.find((option) => option.installed);
      if (installedOption) return installedOption.value;
      if (OLLAMA_CATALOG.default_model) return OLLAMA_CATALOG.default_model;
      return '';
    }

    function populateModelOptions(selectedValue) {
      const normalized = (selectedValue || '').trim();
      const initialValue = normalized || getPreferredModelValue('');
      const seen = new Set();
      projectModelInput.innerHTML = '';
      projectModelInput.appendChild(new Option('â€” Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð¼Ð¾Ð´ÐµÐ»ÑŒ â€”', '', !initialValue, !initialValue));
      LLM_MODEL_OPTIONS.forEach(({ value: optValue, label, installed }) => {
        if (!optValue || seen.has(optValue)) return;
        seen.add(optValue);
        let display = label || optValue;
        if (installed) display = `${display} Â· Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾`;
        const option = new Option(display, optValue, false, optValue === initialValue);
        if (installed) option.dataset.installed = '1';
        projectModelInput.appendChild(option);
      });
      if (initialValue && !seen.has(initialValue)) {
        const fallbackLabel = `${initialValue} Â· Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ°Ñ`;
        projectModelInput.appendChild(new Option(fallbackLabel, initialValue, true, true));
        seen.add(initialValue);
      }
      projectModelInput.appendChild(new Option('Ð”Ñ€ÑƒÐ³Ð°Ñâ€¦', '__custom__', false, false));
      if (!initialValue || !seen.has(initialValue)) {
        projectModelInput.value = '';
      }
      if (llmModelDatalist) {
        const dlValues = new Set();
        llmModelDatalist.innerHTML = '';
        LLM_MODEL_OPTIONS.forEach(({ value: optValue }) => {
          if (!optValue || dlValues.has(optValue)) return;
          dlValues.add(optValue);
          const option = document.createElement('option');
          option.value = optValue;
          llmModelDatalist.appendChild(option);
        });
        if (initialValue && !dlValues.has(initialValue)) {
          const option = document.createElement('option');
          option.value = initialValue;
          llmModelDatalist.appendChild(option);
        }
      }
    }

    function updateProjectDeleteInfo(projectKey) {
      if (!projectDeleteBtn || !projectDeleteInfo) return;
      const normalized = (projectKey || '').trim().toLowerCase();
      if (!normalized) {
        projectDeleteBtn.disabled = true;
        projectDeleteInfo.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ðµ.';
        if (projectDangerZone) projectDangerZone.classList.remove('show');
        return;
      }
      if (projectDangerZone && !projectDangerZone.classList.contains('show')) {
        projectDangerZone.classList.add('show');
      }
      const storage = projectStorageCache[normalized] || null;
      const infoParts = [];
      if (storage) {
        const docCount = Number(storage.document_count || 0);
        const binaryBytes = Number(storage.binary_bytes || 0);
        const ctxCount = Number(storage.context_count || 0);
        const redisKeys = Number(storage.redis_keys || 0);
        if (docCount > 0) infoParts.push(`Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²: ${docCount}`);
        if (binaryBytes > 0) infoParts.push(`Ñ„Ð°Ð¹Ð»Ñ‹: ${formatBytesOptional(binaryBytes)}`);
        if (ctxCount > 0) infoParts.push(`ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð¾Ð²: ${ctxCount}`);
        if (redisKeys > 0) infoParts.push(`Redis ÐºÐ»ÑŽÑ‡ÐµÐ¹: ${redisKeys}`);
      }
      projectDeleteInfo.textContent = infoParts.length
        ? `Ð‘ÑƒÐ´ÐµÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾ â†’ ${infoParts.join(' Â· ')}`
        : 'Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹. Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸.';
      projectDeleteBtn.disabled = false;
    }

    populateModelOptions('');
    projectModelInput.addEventListener('change', () => {
      if (projectModelInput.value === '__custom__') {
        const custom = prompt('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð¼Ð¾Ð´ÐµÐ»Ð¸', '');
        if (custom && custom.trim()) {
          populateModelOptions(custom.trim());
        } else {
          populateProjectForm(currentProject);
        }
      }
    });

    function resetProjectModal() {
      if (modalPromptAiHandler && typeof modalPromptAiHandler.reset === 'function') {
        modalPromptAiHandler.reset();
      }
      projectModalName.value = '';
      projectModalTitle.value = '';
      projectModalDomain.value = '';
      projectModalModel.value = getPreferredModelValue(projectModalModel.value);
      projectModalPrompt.value = '';
      if (projectModalPromptRole) {
        ensurePromptRoleOptions(projectModalPromptRole);
        projectModalPromptRole.value = PROMPT_AI_ROLES[0]?.value || '';
      }
      if (projectModalPromptAiStatus) {
        projectModalPromptAiStatus.textContent = 'â€”';
      }
      if (projectModalEmotions) projectModalEmotions.checked = true;
       if (projectModalAdminUsername) projectModalAdminUsername.value = '';
       if (projectModalAdminPassword) projectModalAdminPassword.value = '';
      projectModalStatus.textContent = '';
    }

    function showProjectModal() {
      resetProjectModal();
      projectModalBackdrop.classList.add('show');
      setTimeout(() => projectModalName.focus(), 50);
    }

    function hideProjectModal() {
      if (modalPromptAiHandler && typeof modalPromptAiHandler.abort === 'function') {
        modalPromptAiHandler.abort();
      }
      projectModalBackdrop.classList.remove('show');
    }

    if (projectAddBtn) {
      projectAddBtn.addEventListener('click', showProjectModal);
    }
    projectRefreshBtn.addEventListener('click', async () => {
      setProjectStatus('ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼â€¦', 1500);
      try {
        await fetchProjects();
        await fetchProjectStorage();
        populateProjectForm(currentProject);
      } catch (error) {
        console.error('project_refresh_failed', error);
        setProjectStatus('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð²', 3000);
      }
    });
    projectModalClose.addEventListener('click', hideProjectModal);
    projectModalCancel.addEventListener('click', hideProjectModal);
    projectModalBackdrop.addEventListener('click', (event) => {
      if (event.target === projectModalBackdrop) hideProjectModal();
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && projectModalBackdrop.classList.contains('show')) {
        hideProjectModal();
      }
    });

    projectModalForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const name = projectModalName.value.trim().toLowerCase();
      if (!name) {
        projectModalStatus.textContent = 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€';
        return;
      }
      const payload = {
        name,
        title: projectModalTitle.value.trim() || null,
        domain: projectModalDomain.value.trim() || null,
        llm_model: projectModalModel.value.trim() || null,
        llm_prompt: projectModalPrompt.value.trim() || null,
        llm_emotions_enabled: projectModalEmotions ? projectModalEmotions.checked : true,
      };
      if (adminSession.is_super && projectModalAdminUsername) {
        const modalAdmin = projectModalAdminUsername.value.trim();
        payload.admin_username = modalAdmin || null;
      }
      if (adminSession.is_super && projectModalAdminPassword) {
        const modalPassword = projectModalAdminPassword.value;
        if (modalPassword && modalPassword.trim()) {
          payload.admin_password = modalPassword;
        }
      }
      projectModalStatus.textContent = 'Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼â€¦';
      try {
        const resp = await fetch('/api/v1/admin/projects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          const message = await resp.text().catch(() => '');
          throw new Error(message || `HTTP ${resp.status}`);
        }
        const saved = await resp.json();
        projectModalStatus.textContent = 'Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾';
        setTimeout(hideProjectModal, 300);
        currentProject = (saved.name || name).toLowerCase();
        await fetchProjects();
        await loadKnowledge();
        pollStatus();
        setProjectStatus('ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½', 3000);
      } catch (error) {
        console.error('Failed to create project', error);
        projectModalStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°';
        setProjectStatus('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚', 3000);
      }
    });

    async function loadLlmModels() {
      try {
        const resp = await fetch('/api/v1/admin/llm/models');
        if (!resp.ok) throw new Error('llm models request failed');
        const data = await resp.json();
        const models = Array.isArray(data.models) ? data.models : [];
        const normalized = models
          .map((m) => (typeof m === 'string' ? m.trim() : ''))
          .filter(Boolean);
        const installedSet = new Set(Array.from(OLLAMA_INSTALLED_SET));
        const options = [];
        normalized.forEach((value) => {
          if (!value || options.some((item) => item.value === value)) return;
          options.push({ value, label: value, installed: installedSet.has(value) });
        });
        installedSet.forEach((value) => {
          if (!value || options.some((item) => item.value === value)) return;
          options.push({ value, label: value, installed: true });
        });
        if (options.length) {
          options.sort((a, b) => {
            if (a.installed && !b.installed) return -1;
            if (!a.installed && b.installed) return 1;
            return a.value.localeCompare(b.value);
          });
        }
        if (options.length) {
          LLM_MODEL_OPTIONS = options;
        }
      } catch (error) {
        console.error('Cannot load LLM models', error);
        if (!LLM_MODEL_OPTIONS.length) {
          LLM_MODEL_OPTIONS = [
            'Vikhrmodels/Vikhr-YandexGPT-5-Lite-8B-it',
            'yandex/YandexGPT-5-Lite-8B-instruct-GGUF:latest',
            'llama3.1:70b',
            'qwen2.5:14b',
          ].map((value) => ({ value, label: value, installed: OLLAMA_INSTALLED_SET.has(value) }));
        }
      }
      populateModelOptions(projectsCache[currentProject]?.llm_model || projectModelInput.value || '');
    }

    function renderOllamaInstalledList(items) {
      if (!ollamaInstalledList) return;
      ollamaInstalledList.innerHTML = '';
      if (!Array.isArray(items) || !items.length) {
        const li = document.createElement('li');
        li.className = 'ollama-meta';
        li.textContent = 'ÐÐµÑ‚ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹';
        ollamaInstalledList.appendChild(li);
        return;
      }
      const frag = document.createDocumentFragment();
      items.forEach((item) => {
        const li = document.createElement('li');
        const name = document.createElement('span');
        name.textContent = item.name || 'â€”';
        const meta = document.createElement('span');
        meta.className = 'ollama-meta';
        meta.textContent = item.size_human || '';
        li.appendChild(name);
        li.appendChild(meta);
        frag.appendChild(li);
      });
      ollamaInstalledList.appendChild(frag);
    }

    function renderOllamaPopularList(items, jobsMap) {
      if (!ollamaPopularList) return;
      ollamaPopularList.innerHTML = '';
      if (!Array.isArray(items) || !items.length) {
        const li = document.createElement('li');
        li.className = 'ollama-meta';
        li.textContent = 'Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ñ… Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ Ð¿ÑƒÑÑ‚.';
        ollamaPopularList.appendChild(li);
        return;
      }
      const frag = document.createDocumentFragment();
      items.forEach((item) => {
        const name = item.name || '';
        if (!name) return;
        const li = document.createElement('li');
        const label = document.createElement('span');
        const meta = document.createElement('span');
        meta.className = 'ollama-meta';
        if (item.approx_size_human) {
          meta.textContent = item.approx_size_human;
        } else if (item.size_gb) {
          meta.textContent = `${item.size_gb} GB`;
        } else {
          meta.textContent = '';
        }
        label.textContent = name;
        li.appendChild(label);
        li.appendChild(meta);

        const job = jobsMap?.[name];
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ollama-install-btn';
        if (item.installed) {
          btn.textContent = 'Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°';
          btn.disabled = true;
        } else if (job && (job.status === 'running' || job.status === 'pending')) {
          const progress = typeof job.progress === 'number' ? ` Â· ${Math.round(job.progress)}%` : '';
          btn.textContent = job.status === 'running' ? `Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°${progress}` : 'Ð’ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸';
          btn.disabled = true;
        } else {
          btn.textContent = 'Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ';
          btn.disabled = !OLLAMA_CATALOG.available;
          btn.addEventListener('click', () => startOllamaInstall(name));
        }
        li.appendChild(btn);
        frag.appendChild(li);
      });
      ollamaPopularList.appendChild(frag);
    }

    function renderOllamaJobs(jobs) {
      if (!ollamaJobsList) return false;
      ollamaJobsList.innerHTML = '';
      const entries = Object.values(jobs || {}).sort((a, b) => (b?.started_at || 0) - (a?.started_at || 0));
      if (!entries.length) {
        const span = document.createElement('span');
        span.className = 'ollama-meta';
        span.textContent = 'ÐÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð·Ð°Ð´Ð°Ñ‡';
        ollamaJobsList.appendChild(span);
        return false;
      }
      let hasRunning = false;
      const frag = document.createDocumentFragment();
      entries.forEach((job) => {
        const status = job?.status || 'unknown';
        const line = document.createElement('div');
        line.className = `ollama-job ${status}`;
        const modelName = job?.model || 'Ð¼Ð¾Ð´ÐµÐ»ÑŒ';
        let text = `${modelName} â€” ${status}`;
        if (status === 'running') {
          hasRunning = true;
          const progress = typeof job.progress === 'number' ? `${Math.round(job.progress)}%` : '';
          text = `${modelName} â€” ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ ${progress}`.trim();
        } else if (status === 'pending') {
          hasRunning = true;
          text = `${modelName} â€” Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸`;
        } else if (status === 'success') {
          text = `${modelName} â€” ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°`;
        } else if (status === 'error') {
          text = `${modelName} â€” Ð¾ÑˆÐ¸Ð±ÐºÐ°: ${job.error || 'Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ'}`;
        }
        if (job.last_line && status === 'running') {
          text += ` (${job.last_line})`;
        }
        line.textContent = text;
        frag.appendChild(line);
      });
      ollamaJobsList.appendChild(frag);
      return hasRunning;
    }

    function renderOllamaServers(servers) {
      if (!ollamaServersList) return;
      OLLAMA_SERVERS = Array.isArray(servers) ? servers : [];
      ollamaServersList.innerHTML = '';
      if (!OLLAMA_SERVERS.length) {
        const li = document.createElement('li');
        li.className = 'ollama-meta';
        li.textContent = 'ÐÐµÑ‚ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²';
        ollamaServersList.appendChild(li);
        if (ollamaServersStatus) ollamaServersStatus.textContent = 'Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÐµÑ€Ð²ÐµÑ€ Ollama';
        return;
      }
      const frag = document.createDocumentFragment();
      OLLAMA_SERVERS.forEach((server) => {
        const li = document.createElement('li');
        const row = document.createElement('div');
        row.className = 'ollama-server-row';

        const title = document.createElement('h4');
        title.textContent = server.name || 'ÑÐµÑ€Ð²ÐµÑ€';
        row.appendChild(title);

        const base = document.createElement('div');
        base.className = 'ollama-meta';
        base.textContent = server.base_url || 'â€”';
        row.appendChild(base);

        const meta = document.createElement('div');
        const enabled = Boolean(server.enabled);
        const healthy = server.healthy !== false;
        meta.className = 'ollama-server-meta';
        const avg = typeof server.avg_latency_ms === 'number'
          ? `${Math.round(server.avg_latency_ms)} Ð¼Ñ`
          : 'â€”';
        const reqs = typeof server.requests_last_hour === 'number'
          ? `${server.requests_last_hour}/Ñ‡`
          : '0/Ñ‡';
        const inflight = typeof server.inflight === 'number' ? `Ð² Ñ€Ð°Ð±Ð¾Ñ‚Ðµ: ${server.inflight}` : 'Ð² Ñ€Ð°Ð±Ð¾Ñ‚Ðµ: 0';
        const statusLabel = enabled ? 'Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½' : 'Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½';
        const healthLabel = healthy ? 'ÑÐ²ÑÐ·ÑŒ ÐµÑÑ‚ÑŒ' : 'Ð½ÐµÑ‚ ÑÐ²ÑÐ·Ð¸';
        meta.appendChild(document.createTextNode(`Ð¡Ñ€ÐµÐ´Ð½ÐµÐµ: ${avg}`));
        meta.appendChild(document.createTextNode(` â€¢ ${reqs}`));
        meta.appendChild(document.createTextNode(` â€¢ ${inflight}`));
        meta.appendChild(document.createTextNode(` â€¢ ${statusLabel}`));
        meta.appendChild(document.createTextNode(` â€¢ ${healthLabel}`));
        row.appendChild(meta);

        if (server.last_error) {
          const errorLine = document.createElement('div');
          errorLine.className = 'ollama-meta';
          errorLine.style.color = '#f87171';
          errorLine.textContent = `ÐžÑˆÐ¸Ð±ÐºÐ°: ${server.last_error}`;
          row.appendChild(errorLine);
        }

        if (!healthy) {
          row.classList.add('ollama-server-offline');
        }

        const actions = document.createElement('div');
        actions.className = 'ollama-server-actions';
        const toggleLabel = document.createElement('label');
        toggleLabel.className = 'ollama-server-toggle';
        const toggleCheckbox = document.createElement('input');
        toggleCheckbox.type = 'checkbox';
        toggleCheckbox.checked = enabled;
        toggleCheckbox.addEventListener('change', async () => {
          const next = toggleCheckbox.checked;
          toggleCheckbox.disabled = true;
          try {
            await toggleOllamaServer(server.name, next);
          } catch (error) {
            console.error('toggle failed', error);
            toggleCheckbox.checked = !next;
          } finally {
            toggleCheckbox.disabled = false;
          }
        });
        toggleLabel.appendChild(toggleCheckbox);
        toggleLabel.append('Ð’ÐºÐ»ÑŽÑ‡Ñ‘Ð½');
        actions.appendChild(toggleLabel);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ';
        deleteBtn.addEventListener('click', () => deleteOllamaServer(server.name));
        actions.appendChild(deleteBtn);

        row.appendChild(actions);
        li.appendChild(row);
        frag.appendChild(li);
      });
      ollamaServersList.appendChild(frag);
      const anyHealthy = OLLAMA_SERVERS.some((server) => server.enabled && server.healthy !== false);
      if (ollamaServersStatus) {
        ollamaServersStatus.textContent = `Ð’ÑÐµÐ³Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²: ${OLLAMA_SERVERS.length}`;
      }
      if (clusterWarning) {
        if (!anyHealthy) {
          clusterWarning.style.display = 'block';
        } else {
          clusterWarning.style.display = 'none';
        }
      }
    }

    async function refreshClusterAvailability() {
      if (!clusterWarning) return;
      try {
        const resp = await fetch('/api/v1/admin/llm/availability', { cache: 'no-store' });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        const available = Boolean(data?.available);
        clusterWarning.style.display = available ? 'none' : 'block';
      } catch (error) {
        console.error('cluster availability check failed', error);
        clusterWarning.style.display = 'block';
      }
    }

    async function refreshOllamaServers() {
      if (!ollamaServersPanel) return;
      if (ollamaServersStatus) {
        ollamaServersStatus.textContent = 'Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼â€¦';
      }
      try {
        const resp = await fetch('/api/v1/admin/ollama/servers', { cache: 'no-store' });
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        renderOllamaServers(data.servers || []);
      } catch (error) {
        console.error('Failed to load Ollama servers', error);
        if (ollamaServersStatus) {
          ollamaServersStatus.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²';
        }
        if (clusterWarning) {
          clusterWarning.style.display = 'block';
        }
      }
    }

    const FEEDBACK_STATUS_OPTIONS = ['open', 'in_progress', 'done', 'dismissed'];

    function feedbackStatusLabel(value) {
      const map = {
        open: 'feedbackStatusOpen',
        in_progress: 'feedbackStatusInProgress',
        done: 'feedbackStatusDone',
        dismissed: 'feedbackStatusDismissed',
      };
      return t(map[value] || value || 'feedbackStatusOpen');
    }

    function renderFeedbackTasks(tasks) {
      if (!feedbackTasksList) return;
      feedbackTasksCache = tasks || [];
      feedbackTasksList.innerHTML = '';
      if (!tasks || !tasks.length) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = t('feedbackNoItems');
        feedbackTasksList.appendChild(empty);
        return;
      }
      tasks.forEach((task) => {
        const item = document.createElement('div');
        item.className = 'feedback-item';

        const metaRow = document.createElement('div');
        metaRow.className = 'feedback-meta';
        if (task.project) {
          const badge = document.createElement('span');
          badge.className = 'feedback-status-badge';
          badge.textContent = `#${task.project}`;
          metaRow.appendChild(badge);
        }
        const statusBadge = document.createElement('span');
        statusBadge.className = 'feedback-status-badge';
        statusBadge.textContent = feedbackStatusLabel(task.status);
        metaRow.appendChild(statusBadge);
        const created = document.createElement('span');
        created.className = 'feedback-timestamp';
        const createdIso = task.created_at_iso || (task.created_at ? new Date(task.created_at * 1000).toISOString() : null);
        if (createdIso) created.textContent = new Date(createdIso).toLocaleString();
        metaRow.appendChild(created);
        item.appendChild(metaRow);

        const messageEl = document.createElement('div');
        messageEl.className = 'feedback-message';
        messageEl.textContent = task.message || '';
        item.appendChild(messageEl);

        if (task.contact || task.name || task.page) {
          const infoRow = document.createElement('div');
          infoRow.className = 'feedback-meta';
          if (task.name) infoRow.appendChild(document.createTextNode(task.name));
          if (task.contact) infoRow.appendChild(document.createTextNode(task.contact));
          if (task.page) {
            const link = document.createElement('a');
            link.href = task.page;
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = task.page;
            infoRow.appendChild(link);
          }
          item.appendChild(infoRow);
        }

        const actionsRow = document.createElement('div');
        actionsRow.className = 'feedback-actions-row';
        const select = document.createElement('select');
        FEEDBACK_STATUS_OPTIONS.forEach((status) => {
          const option = document.createElement('option');
          option.value = status;
          option.textContent = feedbackStatusLabel(status);
          if (status === task.status) option.selected = true;
          select.appendChild(option);
        });
        select.addEventListener('change', () => {
          updateFeedbackTask(task.id, select.value);
        });
        actionsRow.appendChild(select);

        const updated = document.createElement('span');
        updated.className = 'feedback-timestamp';
        const updatedIso = task.updated_at_iso || (task.updated_at ? new Date(task.updated_at * 1000).toISOString() : null);
        if (updatedIso) updated.textContent = `${t('feedbackUpdated')}: ${new Date(updatedIso).toLocaleString()}`;
        actionsRow.appendChild(updated);

        item.appendChild(actionsRow);
        feedbackTasksList.appendChild(item);
      });
    }

    async function fetchFeedbackTasks() {
      if (!adminSession.is_super) {
        if (feedbackSection) feedbackSection.style.display = 'none';
        return;
      }
      if (feedbackSection) feedbackSection.style.display = '';
      try {
        const resp = await fetch('/api/v1/admin/feedback', { cache: 'no-store' });
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        renderFeedbackTasks(Array.isArray(data.tasks) ? data.tasks : []);
      } catch (error) {
        console.error('feedback_tasks_fetch_failed', error);
        if (feedbackTasksList) {
          feedbackTasksList.innerHTML = '';
          const fallback = document.createElement('div');
          fallback.className = 'muted';
          fallback.textContent = t('feedbackError');
          feedbackTasksList.appendChild(fallback);
        }
      }
    }

    async function updateFeedbackTask(id, status) {
      try {
        const resp = await fetch(`/api/v1/admin/feedback/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
        });
        if (!resp.ok) throw new Error(await resp.text());
        await fetchFeedbackTasks();
      } catch (error) {
        console.error('feedback_task_update_failed', error);
      }
    }

    async function submitOllamaServerForm(event) {
      event.preventDefault();
      if (!ollamaServerForm) return;
      const name = (ollamaServerName?.value || '').trim();
      const url = (ollamaServerUrl?.value || '').trim();
      if (!name || !url) {
        if (ollamaServersStatus) ollamaServersStatus.textContent = 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ð¸ Ð°Ð´Ñ€ÐµÑ ÑÐµÑ€Ð²ÐµÑ€Ð°';
        return;
      }
      const payload = {
        name,
        base_url: url,
        enabled: ollamaServerEnabled ? ollamaServerEnabled.checked : true,
      };
      try {
        if (ollamaServersStatus) ollamaServersStatus.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€â€¦';
        const resp = await fetch('/api/v1/admin/ollama/servers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          const text = await resp.text();
          let message = text || `HTTP ${resp.status}`;
          try {
            const json = JSON.parse(text);
            if (json?.detail) message = json.detail;
          } catch (_) {}
          throw new Error(message);
        }
        ollamaServerName.value = '';
        if (ollamaServerEnabled) ollamaServerEnabled.checked = true;
        await refreshOllamaServers();
        if (ollamaServersStatus) ollamaServersStatus.textContent = 'Ð¡ÐµÑ€Ð²ÐµÑ€ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½';
      } catch (error) {
        console.error('Failed to upsert Ollama server', error);
        if (ollamaServersStatus) {
          const msg = error?.message || 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€';
          ollamaServersStatus.textContent = msg;
        }
      }
    }

    async function toggleOllamaServer(name, enabled) {
      const server = OLLAMA_SERVERS.find((item) => item.name === name);
      if (!server) return;
      try {
        if (ollamaServersStatus) {
          ollamaServersStatus.textContent = enabled ? 'Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€â€¦' : 'ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€â€¦';
        }
        const resp = await fetch('/api/v1/admin/ollama/servers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: server.name, base_url: server.base_url, enabled }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          let message = text || `HTTP ${resp.status}`;
          try {
            const json = JSON.parse(text);
            if (json?.detail) message = json.detail;
          } catch (_) {}
          throw new Error(message);
        }
        await refreshOllamaServers();
        if (ollamaServersStatus) {
          ollamaServersStatus.textContent = enabled ? 'Ð¡ÐµÑ€Ð²ÐµÑ€ Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½' : 'Ð¡ÐµÑ€Ð²ÐµÑ€ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ñ‘Ð½';
        }
      } catch (error) {
        console.error('Failed to toggle Ollama server', error);
        if (ollamaServersStatus) {
          const msg = error?.message || 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²ÐµÑ€Ð°';
          ollamaServersStatus.textContent = msg;
        }
      }
    }

    async function deleteOllamaServer(name) {
      if (!name) return;
      if (!window.confirm(`Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€ ${name}?`)) return;
      try {
        if (ollamaServersStatus) ollamaServersStatus.textContent = 'Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€â€¦';
        const resp = await fetch(`/api/v1/admin/ollama/servers/${encodeURIComponent(name)}`, {
          method: 'DELETE',
        });
        if (!resp.ok) {
          const text = await resp.text();
          let message = text || `HTTP ${resp.status}`;
          try {
            const json = JSON.parse(text);
            if (json?.detail) message = json.detail;
          } catch (_) {}
          throw new Error(message);
        }
        await refreshOllamaServers();
        if (ollamaServersStatus) ollamaServersStatus.textContent = 'Ð¡ÐµÑ€Ð²ÐµÑ€ ÑƒÐ´Ð°Ð»Ñ‘Ð½';
      } catch (error) {
        console.error('Failed to delete Ollama server', error);
        if (ollamaServersStatus) {
          const msg = error?.message || 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€';
          ollamaServersStatus.textContent = msg;
        }
      }
    }

    async function refreshOllamaCatalog(force = false) {
      if (!adminSession.is_super || !ollamaCatalog) return;
      try {
        const resp = await fetch('/api/v1/admin/ollama/catalog', { cache: force ? 'no-store' : 'default' });
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        OLLAMA_CATALOG = {
          available: Boolean(data.available),
          installed: Array.isArray(data.installed) ? data.installed : [],
          popular: Array.isArray(data.popular) ? data.popular : [],
          jobs: data.jobs || {},
          default_model: data.default_model || null,
        };
        OLLAMA_INSTALLED_SET = new Set(OLLAMA_CATALOG.installed.map((item) => item.name).filter(Boolean));
        if (ollamaAvailability) {
          ollamaAvailability.textContent = OLLAMA_CATALOG.available
            ? 'Ollama Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹'
            : 'Ollama Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ runtime.';
        }
        renderOllamaInstalledList(OLLAMA_CATALOG.installed);
        renderOllamaPopularList(OLLAMA_CATALOG.popular, OLLAMA_CATALOG.jobs);
        const hasRunning = renderOllamaJobs(OLLAMA_CATALOG.jobs);
        await loadLlmModels();
        if (ollamaPollTimer) {
          clearTimeout(ollamaPollTimer);
          ollamaPollTimer = null;
        }
        if (hasRunning) {
          ollamaPollTimer = setTimeout(() => refreshOllamaCatalog(true), 4000);
        }
      } catch (error) {
        console.error('ollama_catalog_failed', error);
        if (ollamaAvailability) {
          ollamaAvailability.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹';
        }
      }
    }

    async function startOllamaInstall(model) {
      if (!model || !adminSession.is_super) return;
      try {
        const resp = await fetch('/api/v1/admin/ollama/install', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
      } catch (error) {
        console.error('ollama_install_failed', error);
        if (ollamaJobsList) {
          const row = document.createElement('div');
          row.className = 'ollama-job error';
          row.textContent = `ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ: ${error?.message || 'Ð¾ÑˆÐ¸Ð±ÐºÐ°'}`;
          ollamaJobsList.prepend(row);
        }
      }
      await refreshOllamaCatalog(true);
    }

    function updateProjectInputs(){
      const projectField = document.getElementById('kbProject');
      const project = projectsCache[currentProject] || null;
      projectField.value = project ? project.name : (currentProject || '');
    }

    function resetCrawlerProgress() {
      if (crawlerProgressFill) crawlerProgressFill.style.width = '0%';
      if (crawlerProgressStatus) crawlerProgressStatus.textContent = 'ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°';
      if (crawlerProgressCounters) crawlerProgressCounters.textContent = '0 / 0 ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†';
      if (crawlerProgressNote) {
        crawlerProgressNote.textContent = '';
        crawlerProgressNote.style.display = 'none';
      }
    }

    function setCrawlerProgressError(message = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ðµ') {
      if (crawlerProgressFill) crawlerProgressFill.style.width = '0%';
      if (crawlerProgressStatus) crawlerProgressStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°';
      if (crawlerProgressCounters) crawlerProgressCounters.textContent = 'â€”';
      if (crawlerProgressNote) {
        crawlerProgressNote.textContent = message;
        crawlerProgressNote.style.display = 'block';
      }
    }

    function updateCrawlerProgress(active, queued, done, failed, note, lastUrl) {
      if (crawlerProgressFill) {
        const total = Math.max(active + queued + done + failed, 0);
        const completed = Math.max(done, 0);
        const percent = total > 0 ? Math.min(100, Math.round((completed / total) * 100)) : 0;
        crawlerProgressFill.style.width = `${percent}%`;
      }
      if (crawlerProgressStatus) {
        let statusText = 'ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°';
        if (active > 0) statusText = `Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (${active})`;
        else if (queued > 0) statusText = `Ð’ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸ (${queued})`;
        else if (failed > 0) statusText = 'ÐžÑˆÐ¸Ð±ÐºÐ¸';
        else if (done > 0) statusText = 'Ð“Ð¾Ñ‚Ð¾Ð²Ð¾';
        crawlerProgressStatus.textContent = statusText;
      }
      if (crawlerProgressCounters) {
        const total = Math.max(active + queued + done + failed, 0);
        const completed = Math.max(done, 0);
        const base = total > 0 ? `${completed} / ${total} ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†` : '0 / 0 ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†';
        crawlerProgressCounters.textContent = failed > 0 ? `${base} Â· Ð¾ÑˆÐ¸Ð±Ð¾Ðº: ${failed}` : base;
      }
      if (crawlerProgressNote) {
        const bits = [];
        if (note) bits.push(String(note));
        if (lastUrl) bits.push(`ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ URL: ${lastUrl}`);
        crawlerProgressNote.textContent = bits.join('\n');
        crawlerProgressNote.style.display = bits.length ? 'block' : 'none';
      }
    }

    let crawlerActionTimer = null;
    const setCrawlerActionStatus = (message = '', timeout = 3000) => {
      if (!crawlerActionStatus) return;
      if (crawlerActionTimer) {
        clearTimeout(crawlerActionTimer);
        crawlerActionTimer = null;
      }
      crawlerActionStatus.textContent = message || '';
      if (timeout > 0 && message) {
        crawlerActionTimer = setTimeout(() => {
          crawlerActionStatus.textContent = '';
          crawlerActionTimer = null;
        }, timeout);
      }
    };

    async function refreshCrawlerLogs(force = false) {
      if (!crawlerLogsOutput) return;
      const now = Date.now();
      if (!force && !crawlerLogsPanel?.classList.contains('visible')) return;
      if (!force && now - lastCrawlerLogFetch < CRAWLER_LOG_REFRESH_INTERVAL) return;
      if (crawlerLogsLoading) return;
      crawlerLogsLoading = true;
      crawlerLogsOutput.textContent = 'Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼â€¦';
      try {
        const resp = await fetch('/api/v1/admin/logs?limit=400');
        if (!resp.ok) throw new Error('logs request failed');
        const data = await resp.json();
        const lines = Array.isArray(data.lines) ? data.lines : [];
        const filtered = lines.filter((line) => /crawler/i.test(line));
        crawlerLogsOutput.textContent = filtered.length ? filtered.join('\n') : 'Ð›Ð¾Ð³Ð¸ ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð° Ð¿Ð¾ÐºÐ° Ð¿ÑƒÑÑ‚Ñ‹.';
      } catch (error) {
        console.error('crawler logs fetch failed', error);
        crawlerLogsOutput.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð°';
      } finally {
        crawlerLogsLoading = false;
        lastCrawlerLogFetch = Date.now();
      }
    }

    const buildCrawlerActionUrl = (path) => {
      const base = `/api/v1/crawler${path}`;
      if (currentProject) {
        return `${base}?project=${encodeURIComponent(currentProject)}`;
      }
      return base;
    };

    async function performCrawlerAction(path, successMessage) {
      if (!currentProject) {
        setCrawlerActionStatus(t('crawlerSelectProject'), 2500);
        return;
      }
      setCrawlerActionStatus(t('crawlerActionProcessing'), 0);
      try {
        const resp = await fetch(buildCrawlerActionUrl(path), { method: 'POST' });
        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          throw new Error(text || `HTTP ${resp.status}`);
        }
        setCrawlerActionStatus(successMessage, 2000);
        await pollStatus();
        await refreshCrawlerLogs(true);
      } catch (error) {
        console.error('crawler_action_failed', error);
        setCrawlerActionStatus(t('crawlerActionExecuteError'), 3000);
      }
    }

    function showCrawlerLogs() {
      if (!crawlerLogsPanel) return;
      crawlerLogsPanel.classList.add('visible');
      refreshCrawlerLogs(true);
    }

    function hideCrawlerLogs() {
      if (!crawlerLogsPanel) return;
      crawlerLogsPanel.classList.remove('visible');
    }
    async function pollStatus() {
      if (!currentProject) {
        document.getElementById('queued').textContent = '0';
        document.getElementById('in_progress').textContent = '0';
        document.getElementById('done').textContent = '0';
        document.getElementById('failed').textContent = '0';
        document.getElementById('last_crawl').textContent = 'Last: â€“';
        document.getElementById('recent_urls').innerHTML = '';
        setSummaryCrawler('ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…', 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚ ÑÐ»ÐµÐ²Ð°');
        resetCrawlerProgress();
        return;
      }
      try {
        const url = currentProject ? `/api/v1/crawler/status?project=${encodeURIComponent(currentProject)}` : '/api/v1/crawler/status';
        const resp = await fetch(url);
        if (resp.ok) {
          const data = await resp.json();
          const crawlerData = data.crawler || {};
          document.getElementById('queued').textContent = data.queued ?? 0;
          document.getElementById('in_progress').textContent = data.in_progress ?? 0;
          document.getElementById('done').textContent = data.done ?? 0;
          document.getElementById('failed').textContent = data.failed ?? 0;
          const iso = data.last_crawl_iso || 'â€“';
          document.getElementById('last_crawl').textContent = 'Last: ' + iso;
          const list = document.getElementById('recent_urls');
          list.innerHTML = '';
          const arr = (data.crawler && data.crawler.recent_urls) || data.recent_urls || [];
          const uniqueUrls = [];
          const seenUrls = new Set();
          for (const candidate of arr) {
            const trimmed = (candidate || '').trim();
            if (!trimmed || seenUrls.has(trimmed)) continue;
            seenUrls.add(trimmed);
            uniqueUrls.push(trimmed);
          }
          for (const u of uniqueUrls) {
            const li = document.createElement('li');
            const a = document.createElement('a'); a.href = u; a.textContent = u; a.target = '_blank';
            li.appendChild(a); list.appendChild(li);
          }
          const active = Number(data.in_progress ?? 0);
          const queued = Number(data.queued ?? 0);
          const done = Number(data.done ?? 0);
          const failed = Number(data.failed ?? 0);
          const summaryMain = `${active} Ð² Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Â· ${queued} Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸`;
          const metaLines = [`Ð“Ð¾Ñ‚Ð¾Ð²Ð¾: ${done}`, `ÐžÑˆÐ¸Ð±ÐºÐ¸: ${failed}`];
          if (data.last_url) metaLines.push(`ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹: ${data.last_url}`);
          if (iso && iso !== 'â€“') metaLines.push(`ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº: ${iso}`);
          setSummaryCrawler(summaryMain, metaLines.join('\n'));
          updateCrawlerProgress(
            active,
            queued,
            done,
            failed,
            data.notes || crawlerData.notes || '',
            data.last_url || crawlerData.last_url || ''
          );
          if (crawlerLogsPanel?.classList.contains('visible')) {
            refreshCrawlerLogs();
          }
        } else {
          setCrawlerProgressError('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð°');
        }
      } catch (err) {
        console.error(err);
        setSummaryCrawler('ÐžÑˆÐ¸Ð±ÐºÐ°', 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÑ€Ð°ÑƒÐ»ÐµÑ€Ð°');
        setCrawlerProgressError();
      }
    }

    async function pollHealth() {
      try {
        const r = await fetch('/health');
        if (!r.ok) return;
        const h = await r.json();
        const details = h.details || {};
        const set = (id, ok) => {
          const el = document.getElementById(id);
          const error = details[id] && details[id].error ? details[id].error : '';
          el.textContent = ok ? 'up' : 'down';
          el.className = ok ? 'ok' : 'bad';
          el.title = error;
        };
        set('mongo', !!h.mongo);
        set('redis', !!h.redis);
        set('qdrant', !!h.qdrant);
        document.getElementById('overall').textContent = h.status || 'unknown';
      } catch (error) {
        console.error(error);
      }
    }

    async function pollLLM() {
      try {
        const r = await fetch('/api/v1/llm/info');
        if (!r.ok) return;
        const j = await r.json();
        document.getElementById('model').textContent = j.model || 'â€“';
        document.getElementById('backend').textContent = j.backend || 'â€“';
        document.getElementById('device').textContent = j.device || 'â€“';
        document.getElementById('ollamaBase').value = j.ollama_base || '';
        if (j.model) {
          document.getElementById('ollamaModel').value = j.model;
        }
      } catch (error) {
        console.error(error);
        setSummaryPerf('ÐžÑˆÐ¸Ð±ÐºÐ°', 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ /sysinfo');
      }
    }

    function formatBytes(n){ if(!n && n!==0) return 'â€“'; const u=['B','KB','MB','GB','TB']; let i=0; while(n>=1024 && i<u.length-1){ n/=1024; i++; } return n.toFixed(1)+' '+u[i]; }
    function formatPercent(v){ return (typeof v === 'number' && !Number.isNaN(v)) ? v.toFixed(1) + '%' : 'â€“'; }
    async function pollSys() {
      try {
        const r = await fetch('/sysinfo');
        if (!r.ok) return;
        const j = await r.json();
        document.getElementById('cpu').textContent = formatPercent(j.cpu_percent);
        document.getElementById('cpuSys').textContent = formatPercent(j.system_cpu_percent);
        const rss = typeof j.rss_bytes === 'number' ? formatBytes(j.rss_bytes) : 'â€“';
        document.getElementById('rss').textContent = rss;
        const ram = (typeof j.memory_used_bytes === 'number' && typeof j.memory_total_bytes === 'number')
          ? `${formatBytes(j.memory_used_bytes)} / ${formatBytes(j.memory_total_bytes)}${typeof j.memory_percent === 'number' ? ' (' + j.memory_percent.toFixed(1) + '%)' : ''}`
          : 'â€“';
        document.getElementById('ram').textContent = ram;
        const gpuEl = document.getElementById('gpu');
        if (Array.isArray(j.gpus) && j.gpus.length) {
          const lines = j.gpus.map((g, idx) => {
            const label = g.name || `GPU ${idx}`;
            const util = formatPercent(g.util_percent);
            let memInfo = '';
            if (typeof g.memory_used_bytes === 'number' && typeof g.memory_total_bytes === 'number') {
              memInfo = `${formatBytes(g.memory_used_bytes)} / ${formatBytes(g.memory_total_bytes)}`;
            }
            return `${label}: ${util}${memInfo ? ' Â· ' + memInfo : ''}`;
          });
          gpuEl.textContent = lines.join('\n');
        } else {
          gpuEl.textContent = 'â€”';
        }
        document.getElementById('pyver').textContent = j.python || '';
        const cpuDisplay = formatPercent(j.cpu_percent);
        const sysDisplay = formatPercent(j.system_cpu_percent);
        const gpuDisplay = gpuEl.textContent || '';
        const perfLines = [
          sysDisplay && sysDisplay !== 'â€“' ? `Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°: ${sysDisplay}` : '',
          ram !== 'â€“' ? `RAM: ${ram}` : '',
          rss !== 'â€“' ? `RSS: ${rss}` : '',
          gpuDisplay && gpuDisplay !== 'â€”' ? `GPU: ${gpuDisplay.split('\n')[0]}` : '',
        ].filter(Boolean);
        setSummaryPerf(cpuDisplay, perfLines.join('\n'));

        const build = j.build || {};
        const rawVersion = build.version && build.version !== 'unknown' ? String(build.version) : '';
        let buildTitle = rawVersion ? `v${rawVersion}` : 'â€”';
        const shortRev = build.revision ? String(build.revision).slice(0, 8) : '';
        if (shortRev) {
          buildTitle = buildTitle !== 'â€”' ? `${buildTitle} Â· ${shortRev}` : shortRev;
        }

        let builtAtSeconds = null;
        if (typeof build.built_at === 'number' && Number.isFinite(build.built_at)) {
          builtAtSeconds = build.built_at;
        } else if (typeof build.built_at_iso === 'string') {
          const parsedIso = Date.parse(build.built_at_iso);
          if (!Number.isNaN(parsedIso)) {
            builtAtSeconds = parsedIso / 1000;
          }
        }

        const buildMetaLines = [];
        if (builtAtSeconds !== null) {
          const formatted = formatTimestamp(builtAtSeconds);
          if (formatted && formatted !== 'â€”') {
            buildMetaLines.push(`Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð¾: ${formatted}`);
          }
        }

        if (build.components && typeof build.components === 'object') {
          const componentEntries = Object.entries(build.components).slice(0, 3);
          for (const [name, payload] of componentEntries) {
            if (!payload || typeof payload !== 'object') continue;
            const compVersion = payload.version ? `v${payload.version}` : '';
            const compRevision = payload.revision ? String(payload.revision).slice(0, 8) : '';
            const parts = [compVersion, compRevision].filter(Boolean);
            if (parts.length) {
              buildMetaLines.push(`${name}: ${parts.join(' Â· ')}`);
            }
          }
        }

        setSummaryBuild(buildTitle, buildMetaLines.join('\n') || 'â€”');
      } catch {}
    }

    async function pollLogs(){
      const lim = Number(document.getElementById('logLimit').value || 200);
      try{
        const r = await fetch(`/api/v1/admin/logs?limit=${lim}`);
        if(!r.ok) return;
        const j = await r.json();
        const lines = filterRecentLines((j && j.lines) || []);
        const pre = document.getElementById('logs');
        pre.textContent = lines.join('\n');
        document.getElementById('logInfo').textContent = `${lines.length} lines Â· 7 Ð´Ð½ÐµÐ¹`;
        // auto-scroll to bottom
        pre.scrollTop = pre.scrollHeight;
        const promptEl = document.getElementById('promptLogs');
        if (promptEl) {
          const prompts = [];
          let latestMatch = null;
          for (const line of lines) {
            if (!line.includes('llm_prompt_compiled')) continue;
            let formatted = line;
            let parsed = null;
            try {
              parsed = JSON.parse(line);
              const preview = parsed.prompt_preview || parsed.prompt_base || '';
              const project = parsed.project || parsed.mode || '';
              const knowledge = parsed.knowledge || [];
              const docs = knowledge.map((item) => item.name || item.url || item.id).filter(Boolean).join(', ');
              formatted = `[${project}] ${preview}${docs ? `\n  docs: ${docs}` : ''}`;
            } catch (err) {
              // keep raw line if parsing fails
            }
            if (parsed) {
              const projectKey = (parsed.project || parsed.mode || '').toLowerCase();
              if (!currentProject || !projectKey || projectKey === currentProject) {
                const previewText = (parsed.prompt_preview || parsed.prompt_base || '').trim();
                const clipped = previewText.length > 280 ? `${previewText.slice(0, 277)}â€¦` : previewText || formatted;
                const knowledgeDocs = Array.isArray(parsed.knowledge) ? parsed.knowledge : [];
                const docNames = knowledgeDocs
                  .map((item) => item.name || item.url || item.id)
                  .filter(Boolean)
                  .map(String)
                  .slice(0, 6);
                const metaParts = [];
                if (parsed.prompt_length) metaParts.push(`Ð”Ð»Ð¸Ð½Ð°: ${parsed.prompt_length}`);
                if (parsed.session) metaParts.push(`Ð¡ÐµÑÑÐ¸Ñ: ${parsed.session}`);
                latestMatch = { text: clipped, docs: docNames, meta: metaParts.join(' Â· ') };
              }
            }
            prompts.push(formatted);
          }
          promptEl.textContent = prompts.join('\n\n');
          promptEl.scrollTop = promptEl.scrollHeight;
          if (latestMatch) {
            setSummaryPrompt(latestMatch.text, latestMatch.docs, latestMatch.meta);
          }
        }
      }catch(e){}
    }

    function tick(){
      pollStatus();
      pollHealth();
      pollLLM();
      pollSys();
      pollLogs();
    }
    tick();
    setInterval(tick, 3000);

    async function loadKnowledge(){
      if (kbDedupStatus) kbDedupStatus.textContent = '';
      if (!currentProject) {
        Object.values(kbTables).forEach(({ body, counter, empty }) => {
          body.innerHTML = '';
          renderEmptyRow(body, 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚');
          if (counter) counter.textContent = 'â€”';
        });
        document.getElementById('kbInfo').textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      const limitField = document.getElementById('kbLimit');
      const qField = document.getElementById('kbSearch');
      const params = new URLSearchParams();
      const limit = Number(limitField.value || 1000);
      if (Number.isFinite(limit)) params.set('limit', Math.min(Math.max(limit, 10), 1000));
      const query = qField.value.trim();
      if (query) params.set('q', query);
      if (currentProject) {
        const projectId = currentProject.trim().toLowerCase();
        params.set('project', projectId);
      }
      if (kbPriorityList) {
        await loadKnowledgePriority(currentProject);
      }
      try {
        const resp = await fetch(`/api/v1/admin/knowledge?${params.toString()}`);
        if (!resp.ok) throw new Error('knowledge request failed');
        const data = await resp.json();
        const docs = data.documents || [];
        const grouped = { text: [], docs: [], images: [] };
        docs.forEach((doc) => {
          const category = getDocCategory(doc);
          grouped[category].push(doc);
        });

        Object.entries(kbTables).forEach(([key, cfg]) => {
          if (!cfg.body) return;
          cfg.body.innerHTML = '';
          const items = grouped[key] || [];
          if (cfg.counter) cfg.counter.textContent = items.length ? String(items.length) : 'â€”';
          if (!items.length) {
            const emptyMessage = query ? 'ÐÐ¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾' : cfg.empty;
            renderEmptyRow(cfg.body, emptyMessage);
            return;
          }
          for (const doc of items) {
            cfg.body.appendChild(renderKnowledgeRow(doc, key));
          }
        });

        const matched = data.matched ?? docs.length;
        const total = data.total ?? matched;
        const infoParts = [
          `Ð’ÑÐµÐ³Ð¾: ${docs.length} / ${matched}${total ? ` (Ð²ÑÐµÐ³Ð¾ ${total})` : ''}`,
          `Ð¢ÐµÐºÑÑ‚: ${grouped.text.length}`,
          `Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹: ${grouped.docs.length}`,
          `Ð¤Ð¾Ñ‚Ð¾: ${grouped.images.length}`,
        ];
        if (currentProject) infoParts.push(`ÐŸÑ€Ð¾ÐµÐºÑ‚: ${currentProject}`);
        if (query) infoParts.push(`Ð¤Ð¸Ð»ÑŒÑ‚Ñ€: "${query}"`);
        document.getElementById('kbInfo').textContent = infoParts.join(' Â· ');
        await loadKnowledgeQa();
        await loadUnansweredQuestions();
      } catch (error) {
        document.getElementById('kbInfo').textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹';
        console.error(error);
      }
    }

    function renderQaEmpty(text) {
      if (!kbTableQa) return;
      kbTableQa.innerHTML = '';
      const row = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 4;
      cell.textContent = text;
      cell.className = 'muted';
      row.appendChild(cell);
      kbTableQa.appendChild(row);
    }

    function renderQaTable(items) {
      if (!kbTableQa) return;
      kbTableQa.innerHTML = '';
      if (!Array.isArray(items) || !items.length) {
        renderQaEmpty(currentProject ? 'Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð»Ð¸ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»' : 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚');
        return;
      }
      items.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.dataset.qaId = item.id || '';
        tr.dataset.qaPriority = String(item.priority ?? 0);
        const questionTd = document.createElement('td');
        const questionInput = document.createElement('textarea');
        questionInput.value = item.question || '';
        questionInput.dataset.qaField = 'question';
        questionInput.rows = 3;
        questionTd.appendChild(questionInput);
        const answerTd = document.createElement('td');
        const answerInput = document.createElement('textarea');
        answerInput.value = item.answer || '';
        answerInput.dataset.qaField = 'answer';
        answerInput.rows = 3;
        answerTd.appendChild(answerInput);
        const priorityTd = document.createElement('td');
        priorityTd.className = 'qa-priority-cell';
        const priorityInput = document.createElement('input');
        priorityInput.type = 'number';
        priorityInput.dataset.qaField = 'priority';
        priorityInput.value = Number.isFinite(item.priority) ? String(item.priority) : String(items.length - index);
        priorityTd.appendChild(priorityInput);
        const actionsTd = document.createElement('td');
        actionsTd.className = 'qa-actions-cell';
        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ';
        saveBtn.dataset.action = 'save';
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ';
        deleteBtn.dataset.action = 'delete';
        const upBtn = document.createElement('button');
        upBtn.type = 'button';
        upBtn.textContent = 'â†‘';
        upBtn.dataset.action = 'move-up';
        if (index === 0) upBtn.disabled = true;
        const downBtn = document.createElement('button');
        downBtn.type = 'button';
        downBtn.textContent = 'â†“';
        downBtn.dataset.action = 'move-down';
        if (index === items.length - 1) downBtn.disabled = true;
        actionsTd.append(saveBtn, deleteBtn, upBtn, downBtn);
        tr.append(questionTd, answerTd, priorityTd, actionsTd);
        kbTableQa.appendChild(tr);
      });
    }

    function addQaDraftRow() {
      if (!kbTableQa) return;
      if (!currentProject) {
        if (kbQaStatus) kbQaStatus.textContent = 'Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        setTimeout(() => { if (kbQaStatus) kbQaStatus.textContent = ''; }, 3000);
        return;
      }
      const tr = document.createElement('tr');
      tr.dataset.qaId = `new-${Date.now()}`;
      tr.dataset.qaNew = '1';
      const questionTd = document.createElement('td');
      const questionInput = document.createElement('textarea');
      questionInput.dataset.qaField = 'question';
      questionInput.placeholder = 'Ð’Ð¾Ð¿Ñ€Ð¾Ñ';
      questionTd.appendChild(questionInput);
      const answerTd = document.createElement('td');
      const answerInput = document.createElement('textarea');
      answerInput.dataset.qaField = 'answer';
      answerInput.placeholder = 'ÐžÑ‚Ð²ÐµÑ‚';
      answerTd.appendChild(answerInput);
      const priorityTd = document.createElement('td');
      const priorityInput = document.createElement('input');
      priorityInput.type = 'number';
      priorityInput.dataset.qaField = 'priority';
      priorityInput.value = qaPairsCache.length ? String(qaPairsCache[0].priority + 1) : '1';
      priorityTd.appendChild(priorityInput);
      const actionsTd = document.createElement('td');
      actionsTd.className = 'qa-actions-cell';
      const saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ';
      saveBtn.dataset.action = 'save';
      const cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.textContent = 'ÐžÑ‚Ð¼ÐµÐ½Ð°';
      cancelBtn.dataset.action = 'cancel';
      actionsTd.append(saveBtn, cancelBtn);
      tr.append(questionTd, answerTd, priorityTd, actionsTd);
      const firstRow = kbTableQa.querySelector('tr');
      if (firstRow && firstRow.querySelector('.muted')) {
        kbTableQa.innerHTML = '';
      }
      kbTableQa.insertBefore(tr, kbTableQa.firstChild);
      questionInput.focus();
    }

    async function loadKnowledgeQa() {
      if (!kbTableQa) return;
      if (!currentProject) {
        renderQaEmpty('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚');
        if (kbCountQa) kbCountQa.textContent = 'â€”';
        qaPairsCache = [];
        return;
      }
      try {
        const params = new URLSearchParams();
        params.set('project', currentProject);
        params.set('limit', '500');
        const resp = await fetch(`/api/v1/admin/knowledge/qa?${params.toString()}`);
        if (!resp.ok) throw new Error('qa_load_failed');
        const data = await resp.json();
        qaPairsCache = Array.isArray(data.items) ? data.items.slice() : [];
        if (Array.isArray(data.priority) && data.priority.length) {
          renderKnowledgePriority(data.priority);
        }
        renderQaTable(qaPairsCache);
        if (kbCountQa) kbCountQa.textContent = qaPairsCache.length ? String(qaPairsCache.length) : '0';
      } catch (error) {
        console.error('knowledge_qa_load_failed', error);
        renderQaEmpty('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹');
        if (kbQaStatus) {
          kbQaStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸';
          setTimeout(() => { kbQaStatus.textContent = ''; }, 3000);
        }
      }
    }

    async function saveQaRow(row) {
      if (!row) return;
      const question = row.querySelector('[data-qa-field="question"]').value.trim();
      const answer = row.querySelector('[data-qa-field="answer"]').value.trim();
      const priority = parseInt(row.querySelector('[data-qa-field="priority"]').value || '0', 10) || 0;
      if (!question || !answer) {
        if (kbQaStatus) {
          kbQaStatus.textContent = 'Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚';
          setTimeout(() => { kbQaStatus.textContent = ''; }, 3000);
        }
        return;
      }
      const isNew = row.dataset.qaNew === '1' || !(row.dataset.qaId || '').trim();
      const payload = { question, answer, priority };
      if (kbQaStatus) kbQaStatus.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼...';
      try {
        if (isNew) {
          const params = new URLSearchParams();
          if (currentProject) params.set('project', currentProject);
          const query = params.toString();
          const url = query ? `/api/v1/admin/knowledge/qa?${query}` : '/api/v1/admin/knowledge/qa';
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) throw new Error(await resp.text());
        } else {
          const id = row.dataset.qaId;
          const resp = await fetch(`/api/v1/admin/knowledge/qa/${encodeURIComponent(id)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) throw new Error(await resp.text());
        }
        if (kbQaStatus) kbQaStatus.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾';
        await loadKnowledgeQa();
      } catch (error) {
        console.error('knowledge_qa_save_failed', error);
        if (kbQaStatus) kbQaStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ';
      } finally {
        setTimeout(() => { if (kbQaStatus) kbQaStatus.textContent = ''; }, 4000);
      }
    }

    async function deleteQaRow(row) {
      if (!row) return;
      const id = (row.dataset.qaId || '').trim();
      if (!id || row.dataset.qaNew === '1') {
        row.remove();
        if (!kbTableQa.querySelector('tr')) {
          renderQaEmpty('Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð»Ð¸ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»');
        }
        return;
      }
      if (!confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ñƒ Ð¿Ð°Ñ€Ñƒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ-Ð¾Ñ‚Ð²ÐµÑ‚?')) return;
      if (kbQaStatus) kbQaStatus.textContent = 'Ð£Ð´Ð°Ð»ÑÐµÐ¼...';
      try {
        const resp = await fetch(`/api/v1/admin/knowledge/qa/${encodeURIComponent(id)}`, { method: 'DELETE' });
        if (!resp.ok) throw new Error(await resp.text());
        await loadKnowledgeQa();
        if (kbQaStatus) kbQaStatus.textContent = 'Ð£Ð´Ð°Ð»ÐµÐ½Ð¾';
      } catch (error) {
        console.error('knowledge_qa_delete_failed', error);
        if (kbQaStatus) kbQaStatus.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ';
      } finally {
        setTimeout(() => { if (kbQaStatus) kbQaStatus.textContent = ''; }, 4000);
      }
    }

    async function reorderQaPair(id, direction) {
      if (!id) return;
      const index = qaPairsCache.findIndex((item) => item.id === id);
      if (index === -1) return;
      const targetIndex = index + direction;
      if (targetIndex < 0 || targetIndex >= qaPairsCache.length) return;
      const [moved] = qaPairsCache.splice(index, 1);
      qaPairsCache.splice(targetIndex, 0, moved);
      const order = qaPairsCache.map((item) => item.id).filter(Boolean);
      if (!order.length) return;
      if (kbQaStatus) kbQaStatus.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº...';
      try {
      const params = new URLSearchParams();
      if (currentProject) params.set('project', currentProject);
      const query = params.toString();
      const url = query ? `/api/v1/admin/knowledge/qa/reorder?${query}` : '/api/v1/admin/knowledge/qa/reorder';
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order }),
      });
        if (!resp.ok) throw new Error(await resp.text());
        await loadKnowledgeQa();
        if (kbQaStatus) kbQaStatus.textContent = 'ÐŸÐ¾Ñ€ÑÐ´Ð¾Ðº Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½';
      } catch (error) {
        console.error('knowledge_qa_reorder_failed', error);
        if (kbQaStatus) kbQaStatus.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº';
      } finally {
        setTimeout(() => { if (kbQaStatus) kbQaStatus.textContent = ''; }, 4000);
      }
    }

    function renderUnansweredTable(items) {
      if (!kbTableUnanswered) return;
      kbTableUnanswered.innerHTML = '';
      if (!Array.isArray(items) || !items.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 3;
        cell.className = 'muted';
        cell.textContent = currentProject ? 'ÐŸÐ¾ÐºÐ° Ð¿ÑƒÑÑ‚Ð¾ â€” Ð²ÑÐµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ð¼Ð¸' : 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        row.appendChild(cell);
        kbTableUnanswered.appendChild(row);
        if (kbCountUnanswered) kbCountUnanswered.textContent = '0';
        return;
      }
      items.forEach((item) => {
        const row = document.createElement('tr');
        const questionTd = document.createElement('td');
        questionTd.textContent = item.question || '';
        const hitsTd = document.createElement('td');
        hitsTd.textContent = String(item.hits || 1);
        const updatedTd = document.createElement('td');
        updatedTd.textContent = formatTimestamp(item.updated_at);
        row.append(questionTd, hitsTd, updatedTd);
        kbTableUnanswered.appendChild(row);
      });
      if (kbCountUnanswered) kbCountUnanswered.textContent = String(items.length);
    }

    async function loadUnansweredQuestions() {
      if (!kbTableUnanswered) return;
      if (!currentProject) {
        renderUnansweredTable([]);
        return;
      }
      try {
        const params = new URLSearchParams();
        params.set('project', currentProject);
        const resp = await fetch(`/api/v1/admin/knowledge/unanswered?${params.toString()}`);
        if (!resp.ok) throw new Error('unanswered_load_failed');
        const data = await resp.json();
        renderUnansweredTable(data.items || []);
      } catch (error) {
        console.error('knowledge_unanswered_load_failed', error);
        renderUnansweredTable([]);
        if (kbUnansweredStatus) {
          kbUnansweredStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸';
          setTimeout(() => { kbUnansweredStatus.textContent = ''; }, 4000);
        }
      }
    }

    function resetKnowledgeModal(){
      kbModalId.value = '';
      kbModalName.value = '';
      kbModalUrl.value = '';
      kbModalDesc.value = '';
      kbModalProject.value = currentProject || '';
      kbModalContent.value = '';
      kbModalContent.disabled = false;
      kbModalContent.dataset.binary = '';
      kbModalContent.placeholder = 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°';
      kbModalStatus.textContent = '';
      kbModalCompile.disabled = false;
    }

    function showKnowledgeModal(){
      kbModalBackdrop.classList.add('show');
    }

    function hideKnowledgeModal(){
      kbModalBackdrop.classList.remove('show');
      resetKnowledgeModal();
    }

    async function openKnowledgeModal(fileId){
      resetKnowledgeModal();
      kbModalStatus.textContent = 'Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼...';
      try {
        const resp = await fetch(`/api/v1/admin/knowledge/${encodeURIComponent(fileId)}`);
        if (!resp.ok) throw new Error('failed to fetch document');
        const doc = await resp.json();
        kbModalId.value = doc.fileId || fileId;
        kbModalTitle.textContent = doc.name || 'Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚';
        kbModalName.value = doc.name || '';
        kbModalUrl.value = doc.url || '';
        kbModalDesc.value = doc.description || '';
        const projectName = (doc.project || doc.domain || '').toLowerCase();
        kbModalProject.value = projectName;
        if (projectName && currentProject !== projectName) {
          currentProject = projectName;
          projectSelect.value = currentProject;
          updateProjectInputs();
        }
        const contentType = (doc.content_type || '').toLowerCase();
        const isBinary = contentType && !contentType.startsWith('text/');
        kbModalContent.value = isBinary ? '' : (doc.content || '');
        kbModalContent.disabled = !!isBinary;
        kbModalContent.placeholder = isBinary ? 'Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð´Ð»Ñ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð². Ð˜Ð·Ð¼ÐµÐ½ÑÐ¹Ñ‚Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸ URL.' : 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°';
        kbModalContent.dataset.binary = isBinary ? '1' : '';
        kbModalCompile.disabled = !!isBinary;
        const status = doc.status || 'Ð½Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾';
        const message = doc.statusMessage || '';
        kbModalStatus.dataset.fileId = doc.fileId || fileId;
        kbModalStatus.textContent = message ? `${status}: ${message}` : `Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: ${status}`;
        showKnowledgeModal();
      } catch (error) {
        console.error(error);
        kbModalStatus.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚';
        setTimeout(() => { kbModalStatus.textContent = ''; }, 3000);
      }
    }

    async function saveKnowledgeModal(){
      const fileId = kbModalId.value;
      if (!fileId) return;
      if (kbModalContent.dataset.binary === '1' && !kbModalDesc.value.trim()) {
        kbModalStatus.textContent = 'ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð° Ð¸Ð»Ð¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ';
        return;
      }
      kbModalStatus.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼...';
      const payload = {
        name: kbModalName.value,
        url: kbModalUrl.value,
        description: kbModalDesc.value,
        project: kbModalProject.value,
        status: 'edited',
        status_message: 'Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¾ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ',
      };
      if (kbModalContent.dataset.binary !== '1') {
        payload.content = kbModalContent.value;
      }
      try {
        const resp = await fetch(`/api/v1/admin/knowledge/${encodeURIComponent(fileId)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        const result = await resp.json();
        if (result.file_id) {
          kbModalId.value = result.file_id;
        }
        if (result.project) {
          currentProject = (result.project || '').toLowerCase();
        }
        kbModalStatus.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾';
        await loadProjectsList();
        await loadKnowledge();
        setTimeout(() => { hideKnowledgeModal(); }, 800);
      } catch (error) {
        console.error(error);
        kbModalStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ';
      }
    }

    async function compileKnowledge(){
      kbModalStatus.textContent = 'Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸ÑŽ...';
      try {
        const resp = await fetch('/api/v1/admin/knowledge/reindex', { method: 'POST' });
        if (!resp.ok) throw new Error('compile failed');
        kbModalStatus.textContent = 'ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°';
        setTimeout(() => { kbModalStatus.textContent = ''; }, 2000);
      } catch (error) {
        console.error(error);
        kbModalStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸';
      }
    }

    async function loadProjectsList(){
      try {
        const resp = await fetch('/api/v1/admin/projects/names');
        if (!resp.ok) return;
        const data = await resp.json();
        const list = document.getElementById('kbProjectList');
        list.innerHTML = '';
        const names = data.projects || [];
        names.forEach((name) => {
          const normalized = (name || '').toLowerCase();
          const option = document.createElement('option');
          option.value = normalized;
          list.appendChild(option);
        });
        document.getElementById('kbProjectsSummary').textContent = names.length ? `${names.length} Ð¿Ñ€Ð¾ÐµÐºÑ‚(Ð¾Ð²)` : 'â€”';
        if (!currentProject && names.length) {
          currentProject = (names[0] || '').toLowerCase();
          populateProjectForm(currentProject);
          loadKnowledge();
          pollStatus();
        }
      } catch (error) {
        console.error(error);
      }
    }

    async function saveKnowledge(e){
      e.preventDefault();
      const projectName = currentProject.trim().toLowerCase();
      if (!projectName) {
        document.getElementById('kbAddStatus').textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      const name = document.getElementById('kbNewName').value.trim();
      const url = document.getElementById('kbNewUrl').value.trim();
      const description = document.getElementById('kbNewDescription').value.trim();
      const content = document.getElementById('kbNewContent').value;
      const fileInput = document.getElementById('kbNewFile');
      const files = Array.from(fileInput?.files || []);
      const statusLabel = document.getElementById('kbAddStatus');
      let overlayVisible = false;
      let lastGeneratedDescription = '';

      const ensureOverlayHidden = () => {
        if (overlayVisible) {
          hideKnowledgeThinking();
          overlayVisible = false;
        }
      };

      try {
        if (files.length) {
          lastGeneratedDescription = '';
          let uploaded = 0;
          let queuedAutoDescriptions = 0;
          overlayVisible = true;
          showKnowledgeThinking(`Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ 1/${files.length}â€¦`);
          for (let idx = 0; idx < files.length; idx += 1) {
            const file = files[idx];
            const fd = new FormData();
            fd.append('project', projectName);
            if (files.length === 1 && name) fd.append('name', name);
            if (files.length === 1 && url) fd.append('url', url);
            if (files.length === 1 && description) fd.append('description', description);
            fd.append('file', file);
            statusLabel.textContent = `Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ${idx + 1}/${files.length}: ${file.name}`;
            updateKnowledgeThinking(`ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Â«${file.name}Â»â€¦`);
            const resp = await fetch('/api/v1/admin/knowledge/upload', { method: 'POST', body: fd });
            if (!resp.ok) {
              const reason = await resp.text();
              console.error('upload failed', reason);
              statusLabel.textContent = `ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ ${file.name}`;
              continue;
            }
            const result = await resp.json().catch(() => ({}));
            const generatedDescription = typeof result?.description === 'string' ? result.description : '';
            const pendingAuto = result?.auto_description_pending === true;
            if (pendingAuto) {
              queuedAutoDescriptions += 1;
              renderAutoDescription('ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸');
              updateKnowledgeThinking('Ð¤Ð°Ð¹Ð» Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½, Ð°Ð²Ñ‚Ð¾Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸');
            } else if (generatedDescription) {
              lastGeneratedDescription = generatedDescription;
              showKnowledgeDescriptionPreview(generatedDescription);
              renderAutoDescription(generatedDescription);
              if (files.length === 1) {
                document.getElementById('kbNewDescription').value = generatedDescription;
              }
              updateKnowledgeThinking('ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾! ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº...');
            } else {
              updateKnowledgeThinking('Ð¤Ð°Ð¹Ð» ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº...');
            }
            uploaded += 1;
            if (idx + 1 < files.length) {
              updateKnowledgeThinking(`ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ${idx + 2}/${files.length}â€¦`);
            }
          }
          ensureOverlayHidden();
          await loadKnowledge();
          await loadProjectsList();
          await fetchProjectStorage();
          document.getElementById('kbNewName').value = '';
          document.getElementById('kbNewUrl').value = '';
          if (!lastGeneratedDescription) {
            document.getElementById('kbNewDescription').value = '';
          }
          document.getElementById('kbNewContent').value = '';
          if (fileInput) {
            fileInput.value = '';
            updateDropZonePreview(fileInput.files);
          } else {
            updateDropZonePreview();
          }
          if (lastGeneratedDescription) {
            document.getElementById('kbNewDescription').value = lastGeneratedDescription;
            renderAutoDescription(lastGeneratedDescription);
          }
          let resultMsg = `Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ ${uploaded}/${files.length}`;
          if (queuedAutoDescriptions) {
            resultMsg += ` Â· Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸ AI: ${queuedAutoDescriptions}`;
          }
          statusLabel.textContent = resultMsg;
          populateProjectForm(currentProject);
          return;
        }

        if (!content.trim()) {
          statusLabel.textContent = 'Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð¸Ð»Ð¸ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð»';
          return;
        }

        lastGeneratedDescription = '';
        overlayVisible = true;
        showKnowledgeThinking('Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚â€¦');
        statusLabel.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼...';
        const resp = await fetch('/api/v1/admin/knowledge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name || null,
            content,
            project: projectName || null,
            description: description || null,
            url: url || null,
          }),
        });
        if (!resp.ok) {
          statusLabel.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ';
          return;
        }
        const result = await resp.json().catch(() => ({}));
        const pendingAuto = result?.auto_description_pending === true;
        const generatedDescription = typeof result?.description === 'string' ? result.description : '';
        if (pendingAuto) {
          showKnowledgeDescriptionPreview('ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð±ÑƒÐ´ÐµÑ‚ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¿Ð¾Ð·Ð¶Ðµ');
          renderAutoDescription('ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸');
          statusLabel.textContent = 'Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½, Ð°Ð²Ñ‚Ð¾Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸';
          updateKnowledgeThinking('Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½. ÐÐ²Ñ‚Ð¾Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾.');
        } else if (generatedDescription) {
          lastGeneratedDescription = generatedDescription;
          showKnowledgeDescriptionPreview(generatedDescription);
          renderAutoDescription(generatedDescription);
          document.getElementById('kbNewDescription').value = generatedDescription;
          statusLabel.textContent = 'ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾';
          updateKnowledgeThinking('ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾! ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº...');
        } else {
          statusLabel.textContent = 'Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½';
          updateKnowledgeThinking('Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº...');
        }
        document.getElementById('kbNewName').value = '';
        document.getElementById('kbNewUrl').value = '';
        if (!lastGeneratedDescription) {
          document.getElementById('kbNewDescription').value = '';
        }
        document.getElementById('kbNewContent').value = '';
        if (fileInput) {
          fileInput.value = '';
          updateDropZonePreview(fileInput.files);
        } else {
          updateDropZonePreview();
        }
        if (lastGeneratedDescription) {
          document.getElementById('kbNewDescription').value = lastGeneratedDescription;
          renderAutoDescription(lastGeneratedDescription);
        }
        await loadKnowledge();
        await loadProjectsList();
        await fetchProjectStorage();
        populateProjectForm(currentProject);
      } catch (error) {
        console.error(error);
        statusLabel.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ';
      } finally {
        ensureOverlayHidden();
      }
    }

    async function deduplicateKnowledge(){
      if (!kbDedupStatus) return;
      const payload = { project: currentProject || null };
      kbDedupStatus.textContent = currentProject ? 'Ð˜Ñ‰ÐµÐ¼ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹...' : 'Ð˜Ñ‰ÐµÐ¼ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ Ð²Ð¾ Ð²ÑÐµÑ… Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°Ñ…...';
      try {
        const resp = await fetch('/api/v1/admin/knowledge/deduplicate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        const result = await resp.json();
        const removed = result.removed ?? 0;
        const kept = result.kept ?? 0;
        kbDedupStatus.textContent = `Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ ${removed}, Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ ${kept}`;
        await loadKnowledge();
        await fetchProjectStorage();
        populateProjectForm(currentProject);
        setTimeout(() => { kbDedupStatus.textContent = ''; }, 3000);
      } catch (error) {
        console.error(error);
        kbDedupStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹';
        setTimeout(() => { kbDedupStatus.textContent = ''; }, 4000);
      }
    }
    async function clearKnowledge(){
      if (!kbClearStatus) return;
      const confirmed = confirm(currentProject ? `ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð°Ð·Ñƒ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ${currentProject}?` : 'ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÑŽ Ð±Ð°Ð·Ñƒ Ð·Ð½Ð°Ð½Ð¸Ð¹?');
      if (!confirmed) return;
      kbClearStatus.textContent = 'Ð£Ð´Ð°Ð»ÑÐµÐ¼â€¦';
      try {
        const params = new URLSearchParams();
        if (currentProject) params.set('project', currentProject);
        const resp = await fetch(`/api/v1/admin/knowledge?${params.toString()}`, { method: 'DELETE' });
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        kbClearStatus.textContent = `Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²: ${data.documents_removed || 0}`;
        await fetchKnowledge();
        await fetchProjectStorage();
        populateProjectForm(currentProject);
        setTimeout(() => { kbClearStatus.textContent = ''; }, 3000);
      } catch (error) {
        console.error('knowledge_clear_failed', error);
        kbClearStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸';
        setTimeout(() => { kbClearStatus.textContent = ''; }, 4000);
      }
    }


    async function clearKnowledge(){
      if (!kbClearStatus) return;
      const confirmed = confirm(currentProject ? `ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð°Ð·Ñƒ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ${currentProject}?` : 'ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÑŽ Ð±Ð°Ð·Ñƒ Ð·Ð½Ð°Ð½Ð¸Ð¹?');
      if (!confirmed) return;
      kbClearStatus.textContent = 'Ð£Ð´Ð°Ð»ÑÐµÐ¼â€¦';
      try {
        const params = new URLSearchParams();
        if (currentProject) params.set('project', currentProject);
        const resp = await fetch(`/api/v1/admin/knowledge?${params.toString()}`, { method: 'DELETE' });
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        kbClearStatus.textContent = `Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²: ${data.documents_removed || 0}`;
        await fetchKnowledge();
        await fetchProjectStorage();
        populateProjectForm(currentProject);
        setTimeout(() => { kbClearStatus.textContent = ''; }, 3000);
      } catch (error) {
        console.error('knowledge_clear_failed', error);
        kbClearStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸';
        setTimeout(() => { kbClearStatus.textContent = ''; }, 4000);
      }
    }

    document.getElementById('kbForm').addEventListener('submit', (e)=>{ e.preventDefault(); loadKnowledge(); });
    document.getElementById('kbClear').addEventListener('click', ()=>{ document.getElementById('kbSearch').value=''; loadKnowledge(); });
    document.getElementById('kbReloadProjects').addEventListener('click', async ()=>{
      try {
        await loadProjectsList();
        await fetchProjects();
        await fetchProjectStorage();
        await loadKnowledge();
        populateProjectForm(currentProject);
      } catch (error) {
        console.error('kb_reload_projects_failed', error);
        document.getElementById('kbInfo').textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð²';
      }
    });
    document.getElementById('kbAddForm').addEventListener('submit', saveKnowledge);
    document.getElementById('kbResetForm').addEventListener('click', () => {
      document.getElementById('kbNewName').value = '';
      document.getElementById('kbNewUrl').value = '';
      document.getElementById('kbNewDescription').value = '';
      document.getElementById('kbNewContent').value = '';
      const fileInput = document.getElementById('kbNewFile');
      if (fileInput) {
        fileInput.value = '';
        updateDropZonePreview(fileInput.files);
      } else {
        updateDropZonePreview();
      }
      renderAutoDescription('');
      document.getElementById('kbAddStatus').textContent = '';
    });
    if (kbDedupBtn) {
      kbDedupBtn.addEventListener('click', deduplicateKnowledge);
    }
    if (kbClearBtn) {
      kbClearBtn.addEventListener('click', clearKnowledge);
    }
    if (kbDropZone && kbNewFileInput) {
      const highlight = () => kbDropZone.classList.add('drag-over');
      const unhighlight = () => kbDropZone.classList.remove('drag-over');
      kbDropZone.addEventListener('click', () => kbNewFileInput.click());
      ['dragenter', 'dragover'].forEach((evt) => {
        kbDropZone.addEventListener(evt, (event) => {
          event.preventDefault();
          event.stopPropagation();
          highlight();
        });
      });
      ['dragleave', 'dragend'].forEach((evt) => {
        kbDropZone.addEventListener(evt, (event) => {
          event.preventDefault();
          event.stopPropagation();
          unhighlight();
        });
      });
      kbDropZone.addEventListener('drop', (event) => {
        event.preventDefault();
        event.stopPropagation();
        unhighlight();
        const files = event.dataTransfer?.files;
        if (!files || !files.length) return;
        const dt = new DataTransfer();
        Array.from(files).forEach((file) => dt.items.add(file));
        kbNewFileInput.files = dt.files;
        updateDropZonePreview(kbNewFileInput.files);
      });
      kbNewFileInput.addEventListener('change', () => updateDropZonePreview(kbNewFileInput.files));
      updateDropZonePreview(kbNewFileInput.files);
    }

    if (kbPrioritySave) {
      kbPrioritySave.addEventListener('click', () => {
        saveKnowledgePriority();
      });
    }

    if (kbQaImportForm) {
      kbQaImportForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!currentProject) {
          if (kbQaStatus) {
            kbQaStatus.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
            setTimeout(() => { kbQaStatus.textContent = ''; }, 3000);
          }
          return;
        }
        const file = kbQaFileInput?.files?.[0];
        if (!file) {
          if (kbQaStatus) {
            kbQaStatus.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð»';
            setTimeout(() => { kbQaStatus.textContent = ''; }, 3000);
          }
          return;
        }
        const fd = new FormData();
        fd.append('file', file);
        fd.append('project', currentProject);
        if (kbQaStatus) kbQaStatus.textContent = 'Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼...';
        try {
          const resp = await fetch('/api/v1/admin/knowledge/qa/upload', {
            method: 'POST',
            body: fd,
          });
          if (!resp.ok) throw new Error(await resp.text());
          kbQaFileInput.value = '';
          await loadKnowledgeQa();
          if (kbQaStatus) kbQaStatus.textContent = 'Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½';
        } catch (error) {
          console.error('knowledge_qa_import_failed', error);
          if (kbQaStatus) kbQaStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð°';
        } finally {
          setTimeout(() => { if (kbQaStatus) kbQaStatus.textContent = ''; }, 4000);
        }
      });
    }

    if (kbQaAddRowBtn) {
      kbQaAddRowBtn.addEventListener('click', () => addQaDraftRow());
    }

    if (kbTableQa) {
      kbTableQa.addEventListener('click', (event) => {
        const actionButton = event.target.closest('button[data-action]');
        if (!actionButton) return;
        const row = actionButton.closest('tr');
        const action = actionButton.dataset.action;
        if (action === 'save') {
          saveQaRow(row);
        } else if (action === 'delete') {
          deleteQaRow(row);
        } else if (action === 'cancel') {
          row.remove();
          if (!kbTableQa.querySelector('tr')) {
            renderQaEmpty('Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð»Ð¸ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»');
          }
        } else if (action === 'move-up') {
          reorderQaPair(row?.dataset.qaId || '', -1);
        } else if (action === 'move-down') {
          reorderQaPair(row?.dataset.qaId || '', 1);
        }
      });
    }

    if (kbUnansweredExportBtn) {
      kbUnansweredExportBtn.addEventListener('click', () => {
        const params = new URLSearchParams();
        if (currentProject) params.set('project', currentProject);
        const query = params.toString();
        const url = query ? `/api/v1/admin/knowledge/unanswered/export?${query}` : '/api/v1/admin/knowledge/unanswered/export';
        window.open(url, '_blank');
      });
    }

    if (kbUnansweredClearBtn) {
      kbUnansweredClearBtn.addEventListener('click', async () => {
        if (!confirm('ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð±ÐµÐ· Ð¾Ñ‚Ð²ÐµÑ‚Ð°?')) return;
        if (kbUnansweredStatus) kbUnansweredStatus.textContent = 'ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼...';
        try {
          const resp = await fetch('/api/v1/admin/knowledge/unanswered/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ project: currentProject || null }),
          });
          if (!resp.ok) throw new Error(await resp.text());
          await loadUnansweredQuestions();
          if (kbUnansweredStatus) kbUnansweredStatus.textContent = 'Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½';
        } catch (error) {
          console.error('knowledge_unanswered_clear_failed', error);
          if (kbUnansweredStatus) kbUnansweredStatus.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ';
        } finally {
          setTimeout(() => { if (kbUnansweredStatus) kbUnansweredStatus.textContent = ''; }, 4000);
        }
      });
    }

    kbModalClose.addEventListener('click', hideKnowledgeModal);
    kbModalCancel.addEventListener('click', hideKnowledgeModal);
    kbModalSave.addEventListener('click', saveKnowledgeModal);
    kbModalCompile.addEventListener('click', compileKnowledge);
    kbModalBackdrop.addEventListener('click', (event) => {
      if (event.target === kbModalBackdrop) {
        hideKnowledgeModal();
      }
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && kbModalBackdrop.classList.contains('show')) {
        hideKnowledgeModal();
      }
    });

    function applyProjectTelegramState(data, projectName) {
      if (!projectTelegramStatus) return;
      const running = !!(data && data.running);
      projectTelegramStatus.textContent = running ? 'Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚' : 'Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½';
      if (projectTelegramInfo) {
        if (data && data.token_set) {
          projectTelegramInfo.textContent = `Ð¢Ð¾ÐºÐµÐ½ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ (${data.token_preview || '***'})`;
        } else if (projectName) {
          projectTelegramInfo.textContent = 'Ð¢Ð¾ÐºÐµÐ½ Ð½Ðµ Ð·Ð°Ð´Ð°Ð½';
        } else {
          projectTelegramInfo.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        }
        if (data && data.last_error) {
          projectTelegramInfo.textContent += ` â€¢ ÐžÑˆÐ¸Ð±ÐºÐ°: ${data.last_error}`;
        }
      }
      if (projectTelegramAutoStart && data) {
        projectTelegramAutoStart.checked = !!data.auto_start;
      } else if (projectTelegramAutoStart && !projectName) {
        projectTelegramAutoStart.checked = false;
      }
      if (projectTelegramStartBtn) projectTelegramStartBtn.disabled = !projectName || running;
      if (projectTelegramStopBtn) projectTelegramStopBtn.disabled = !projectName || !running;
      if (projectTelegramSaveBtn) projectTelegramSaveBtn.disabled = !projectName;
      if (projectTelegramTokenInput) projectTelegramTokenInput.disabled = !projectName;
      if (projectTelegramAutoStart) projectTelegramAutoStart.disabled = !projectName;
    }

    function resetProjectTelegramUI() {
      applyProjectTelegramState(null, '');
      if (projectTelegramStatus) projectTelegramStatus.textContent = 'â€”';
      if (projectTelegramInfo) projectTelegramInfo.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
      if (projectTelegramMessage) projectTelegramMessage.textContent = '';
      if (projectTelegramTokenInput) projectTelegramTokenInput.value = '';
    }

    async function loadProjectTelegramStatus(projectName) {
      if (!projectName) {
        resetProjectTelegramUI();
        return;
      }
      if (projectTelegramMessage) projectTelegramMessage.textContent = 'ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼...';
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(projectName)}/telegram`);
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        applyProjectTelegramState(data, projectName);
        if (projectTelegramMessage) projectTelegramMessage.textContent = '';
      } catch (error) {
        console.error(error);
        if (projectTelegramStatus) projectTelegramStatus.textContent = 'Ð¾ÑˆÐ¸Ð±ÐºÐ°';
        if (projectTelegramMessage) projectTelegramMessage.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ';
        applyProjectTelegramState(null, projectName);
        if (projectTelegramStartBtn) projectTelegramStartBtn.disabled = !projectName;
      }
    }

    async function saveProjectTelegramConfig() {
      if (!currentProject) {
        if (projectTelegramMessage) projectTelegramMessage.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      if (projectTelegramMessage) projectTelegramMessage.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼...';
      const payload = {
        token: projectTelegramTokenInput && projectTelegramTokenInput.value ? projectTelegramTokenInput.value : null,
        auto_start: projectTelegramAutoStart ? projectTelegramAutoStart.checked : false,
      };
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(currentProject)}/telegram/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        if (projectTelegramTokenInput) projectTelegramTokenInput.value = '';
        if (projectTelegramMessage) projectTelegramMessage.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾';
        await loadProjectTelegramStatus(currentProject);
      } catch (error) {
        console.error(error);
        if (projectTelegramMessage) projectTelegramMessage.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ';
      }
    }

    async function startProjectTelegram() {
      if (!currentProject) {
        if (projectTelegramMessage) projectTelegramMessage.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      if (projectTelegramMessage) projectTelegramMessage.textContent = 'Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼...';
      const payload = {};
      if (projectTelegramTokenInput && projectTelegramTokenInput.value) {
        payload.token = projectTelegramTokenInput.value;
      }
      if (projectTelegramAutoStart) {
        payload.auto_start = projectTelegramAutoStart.checked;
      }
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(currentProject)}/telegram/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          const msg = await resp.text();
          throw new Error(msg || 'start failed');
        }
        if (projectTelegramTokenInput) projectTelegramTokenInput.value = '';
        if (projectTelegramMessage) projectTelegramMessage.textContent = 'Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½';
        await loadProjectTelegramStatus(currentProject);
      } catch (error) {
        console.error(error);
        if (projectTelegramMessage) projectTelegramMessage.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ°';
      }
    }

    async function stopProjectTelegram() {
      if (!currentProject) {
        if (projectTelegramMessage) projectTelegramMessage.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      if (projectTelegramMessage) projectTelegramMessage.textContent = 'ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼...';
      const payload = {};
      if (projectTelegramAutoStart) {
        payload.auto_start = projectTelegramAutoStart.checked;
      }
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(currentProject)}/telegram/stop`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        if (projectTelegramMessage) projectTelegramMessage.textContent = 'Ð‘Ð¾Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½';
        await loadProjectTelegramStatus(currentProject);
      } catch (error) {
        console.error(error);
        if (projectTelegramMessage) projectTelegramMessage.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸';
      }
    }

    if (projectTelegramSaveBtn) projectTelegramSaveBtn.addEventListener('click', saveProjectTelegramConfig);
    if (projectTelegramStartBtn) projectTelegramStartBtn.addEventListener('click', startProjectTelegram);
    if (projectTelegramStopBtn) projectTelegramStopBtn.addEventListener('click', stopProjectTelegram);

    function applyProjectMaxState(data, projectName) {
      const running = data ? !!data.running : false;
      if (projectMaxStatus) projectMaxStatus.textContent = data ? (running ? 'Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚' : 'Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½') : 'â€”';
      if (projectMaxInfo) {
        if (!projectName) {
          projectMaxInfo.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        } else if (data) {
          const bits = [];
          bits.push(data.token_set ? 'Ð¢Ð¾ÐºÐµÐ½ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½' : 'Ð¢Ð¾ÐºÐµÐ½ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½');
          if (data.token_preview) bits.push(`ID: ${data.token_preview}`);
          if (running) bits.push('Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½');
          if (data.last_error) bits.push(`ÐžÑˆÐ¸Ð±ÐºÐ°: ${data.last_error}`);
          projectMaxInfo.textContent = bits.join(' â€¢ ');
        } else {
          projectMaxInfo.textContent = 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…';
        }
      }
      if (projectMaxAutoStart && data) {
        projectMaxAutoStart.checked = !!data.auto_start;
      } else if (projectMaxAutoStart && !projectName) {
        projectMaxAutoStart.checked = false;
      }
      if (projectMaxStartBtn) projectMaxStartBtn.disabled = !projectName || running;
      if (projectMaxStopBtn) projectMaxStopBtn.disabled = !projectName || !running;
      if (projectMaxSaveBtn) projectMaxSaveBtn.disabled = !projectName;
      if (projectMaxTokenInput) projectMaxTokenInput.disabled = !projectName;
      if (projectMaxAutoStart) projectMaxAutoStart.disabled = !projectName;
    }

    function resetProjectMaxUI() {
      applyProjectMaxState(null, '');
      if (projectMaxStatus) projectMaxStatus.textContent = 'â€”';
      if (projectMaxInfo) projectMaxInfo.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
      if (projectMaxMessage) projectMaxMessage.textContent = '';
      if (projectMaxTokenInput) projectMaxTokenInput.value = '';
    }

    async function loadProjectMaxStatus(projectName) {
      if (!projectName) {
        resetProjectMaxUI();
        return;
      }
      if (projectMaxMessage) projectMaxMessage.textContent = 'ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼...';
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(projectName)}/max`);
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        applyProjectMaxState(data, projectName);
        if (projectMaxMessage) projectMaxMessage.textContent = '';
      } catch (error) {
        console.error(error);
        if (projectMaxStatus) projectMaxStatus.textContent = 'Ð¾ÑˆÐ¸Ð±ÐºÐ°';
        if (projectMaxMessage) projectMaxMessage.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ';
        applyProjectMaxState(null, projectName);
        if (projectMaxStartBtn) projectMaxStartBtn.disabled = !projectName;
      }
    }

    async function saveProjectMaxConfig() {
      if (!currentProject) {
        if (projectMaxMessage) projectMaxMessage.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      if (projectMaxMessage) projectMaxMessage.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼...';
      const payload = {
        token: projectMaxTokenInput && projectMaxTokenInput.value ? projectMaxTokenInput.value : null,
        auto_start: projectMaxAutoStart ? projectMaxAutoStart.checked : false,
      };
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(currentProject)}/max/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        if (projectMaxTokenInput) projectMaxTokenInput.value = '';
        if (projectMaxMessage) projectMaxMessage.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾';
        await loadProjectMaxStatus(currentProject);
      } catch (error) {
        console.error(error);
        if (projectMaxMessage) projectMaxMessage.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ';
      }
    }

    async function startProjectMax() {
      if (!currentProject) {
        if (projectMaxMessage) projectMaxMessage.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      if (projectMaxMessage) projectMaxMessage.textContent = 'Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼...';
      const payload = {};
      if (projectMaxTokenInput && projectMaxTokenInput.value) {
        payload.token = projectMaxTokenInput.value;
      }
      if (projectMaxAutoStart) {
        payload.auto_start = projectMaxAutoStart.checked;
      }
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(currentProject)}/max/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        if (projectMaxTokenInput) projectMaxTokenInput.value = '';
        if (projectMaxMessage) projectMaxMessage.textContent = 'Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½';
        await loadProjectMaxStatus(currentProject);
      } catch (error) {
        console.error(error);
        if (projectMaxMessage) projectMaxMessage.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ°';
      }
    }

    async function stopProjectMax() {
      if (!currentProject) {
        if (projectMaxMessage) projectMaxMessage.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      if (projectMaxMessage) projectMaxMessage.textContent = 'ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼...';
      const payload = {};
      if (projectMaxAutoStart) {
        payload.auto_start = projectMaxAutoStart.checked;
      }
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(currentProject)}/max/stop`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        if (projectMaxMessage) projectMaxMessage.textContent = 'Ð‘Ð¾Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½';
        await loadProjectMaxStatus(currentProject);
      } catch (error) {
        console.error(error);
        if (projectMaxMessage) projectMaxMessage.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸';
      }
    }

    if (projectMaxSaveBtn) projectMaxSaveBtn.addEventListener('click', saveProjectMaxConfig);
    if (projectMaxStartBtn) projectMaxStartBtn.addEventListener('click', startProjectMax);
    if (projectMaxStopBtn) projectMaxStopBtn.addEventListener('click', stopProjectMax);

    function applyProjectVkState(data, projectName) {
      const running = data ? !!data.running : false;
      if (projectVkStatus) projectVkStatus.textContent = data ? (running ? 'Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚' : 'Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½') : 'â€”';
      if (projectVkInfo) {
        if (!projectName) {
          projectVkInfo.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        } else if (data) {
          const bits = [];
          bits.push(data.token_set ? 'Ð¢Ð¾ÐºÐµÐ½ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½' : 'Ð¢Ð¾ÐºÐµÐ½ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½');
          if (data.token_preview) bits.push(`ID: ${data.token_preview}`);
          if (running) bits.push('Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½');
          if (data.last_error) bits.push(`ÐžÑˆÐ¸Ð±ÐºÐ°: ${data.last_error}`);
          projectVkInfo.textContent = bits.join(' â€¢ ');
        } else {
          projectVkInfo.textContent = 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…';
        }
      }
      if (projectVkAutoStart && data) {
        projectVkAutoStart.checked = !!data.auto_start;
      } else if (projectVkAutoStart && !projectName) {
        projectVkAutoStart.checked = false;
      }
      if (projectVkStartBtn) projectVkStartBtn.disabled = !projectName || running;
      if (projectVkStopBtn) projectVkStopBtn.disabled = !projectName || !running;
      if (projectVkSaveBtn) projectVkSaveBtn.disabled = !projectName;
      if (projectVkTokenInput) projectVkTokenInput.disabled = !projectName;
      if (projectVkAutoStart) projectVkAutoStart.disabled = !projectName;
    }

    function resetProjectVkUI() {
      applyProjectVkState(null, '');
      if (projectVkStatus) projectVkStatus.textContent = 'â€”';
      if (projectVkInfo) projectVkInfo.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
      if (projectVkMessage) projectVkMessage.textContent = '';
      if (projectVkTokenInput) projectVkTokenInput.value = '';
    }

    async function loadProjectVkStatus(projectName) {
      if (!projectName) {
        resetProjectVkUI();
        return;
      }
      if (projectVkMessage) projectVkMessage.textContent = 'ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼...';
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(projectName)}/vk`);
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        applyProjectVkState(data, projectName);
        if (projectVkMessage) projectVkMessage.textContent = '';
      } catch (error) {
        console.error(error);
        if (projectVkStatus) projectVkStatus.textContent = 'Ð¾ÑˆÐ¸Ð±ÐºÐ°';
        if (projectVkMessage) projectVkMessage.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ';
        applyProjectVkState(null, projectName);
        if (projectVkStartBtn) projectVkStartBtn.disabled = !projectName;
      }
    }

    async function saveProjectVkConfig() {
      if (!currentProject) {
        if (projectVkMessage) projectVkMessage.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      if (projectVkMessage) projectVkMessage.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼...';
      const payload = {
        token: projectVkTokenInput && projectVkTokenInput.value ? projectVkTokenInput.value : null,
        auto_start: projectVkAutoStart ? projectVkAutoStart.checked : false,
      };
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(currentProject)}/vk/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        if (projectVkTokenInput) projectVkTokenInput.value = '';
        if (projectVkMessage) projectVkMessage.textContent = 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾';
        await loadProjectVkStatus(currentProject);
      } catch (error) {
        console.error(error);
        if (projectVkMessage) projectVkMessage.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ';
      }
    }

    async function startProjectVk() {
      if (!currentProject) {
        if (projectVkMessage) projectVkMessage.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      if (projectVkMessage) projectVkMessage.textContent = 'Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼...';
      const payload = {};
      if (projectVkTokenInput && projectVkTokenInput.value) {
        payload.token = projectVkTokenInput.value;
      }
      if (projectVkAutoStart) {
        payload.auto_start = projectVkAutoStart.checked;
      }
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(currentProject)}/vk/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        if (projectVkTokenInput) projectVkTokenInput.value = '';
        if (projectVkMessage) projectVkMessage.textContent = 'Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½';
        await loadProjectVkStatus(currentProject);
      } catch (error) {
        console.error(error);
        if (projectVkMessage) projectVkMessage.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ°';
      }
    }

    async function stopProjectVk() {
      if (!currentProject) {
        if (projectVkMessage) projectVkMessage.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚';
        return;
      }
      if (projectVkMessage) projectVkMessage.textContent = 'ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼...';
      const payload = {};
      if (projectVkAutoStart) {
        payload.auto_start = projectVkAutoStart.checked;
      }
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(currentProject)}/vk/stop`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        if (projectVkMessage) projectVkMessage.textContent = 'Ð‘Ð¾Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½';
        await loadProjectVkStatus(currentProject);
      } catch (error) {
        console.error(error);
        if (projectVkMessage) projectVkMessage.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸';
      }
    }

    if (projectVkSaveBtn) projectVkSaveBtn.addEventListener('click', saveProjectVkConfig);
    if (projectVkStartBtn) projectVkStartBtn.addEventListener('click', startProjectVk);
    if (projectVkStopBtn) projectVkStopBtn.addEventListener('click', stopProjectVk);

    if (statsRefreshBtn) statsRefreshBtn.addEventListener('click', loadRequestStats);
    if (statsExportBtn) statsExportBtn.addEventListener('click', exportRequestStats);

    function getDefaultWidgetPath(projectName) {
      const normalized = (projectName || '').trim().toLowerCase();
      if (!normalized) return '';
      return `/widget?project=${encodeURIComponent(normalized)}`;
    }

    function resolveWidgetHref(path) {
      if (!path) return '';
      if (/^https?:\/\//i.test(path)) return path;
      if (path.startsWith('/')) {
        return `${window.location.origin}${path}`;
      }
      return `${window.location.origin}/${path}`;
    }

    function refreshProjectWidgetUI() {
      if (!projectWidgetUrl || !projectWidgetLink || !projectWidgetHint || !projectWidgetCopyBtn) return;
      const normalized = (currentProject || '').trim().toLowerCase();
      const customValue = projectWidgetUrl.value.trim();
      const defaultPath = getDefaultWidgetPath(normalized);
      const effectivePath = customValue || defaultPath;
      if (!normalized) {
        projectWidgetLink.href = '#';
        projectWidgetLink.textContent = 'ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð²Ð¸Ð´Ð¶ÐµÑ‚';
        projectWidgetLink.style.pointerEvents = 'none';
        projectWidgetLink.style.opacity = '0.6';
        projectWidgetCopyBtn.disabled = true;
        projectWidgetHint.textContent = 'Ð¡ÑÑ‹Ð»ÐºÐ° Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°';
        return;
      }
      const href = resolveWidgetHref(effectivePath);
      projectWidgetLink.href = href || '#';
      projectWidgetLink.textContent = effectivePath || defaultPath || 'â€”';
      const hasLink = Boolean(effectivePath);
      projectWidgetLink.style.pointerEvents = hasLink ? 'auto' : 'none';
      projectWidgetLink.style.opacity = hasLink ? '1' : '0.6';
      projectWidgetCopyBtn.disabled = !hasLink;
      if (projectWidgetHint) {
        projectWidgetHint.textContent = customValue ? 'Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½Ð½Ð°Ñ ÑÑÑ‹Ð»ÐºÐ°' : `ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: ${defaultPath || '/widget'}`;
      }
    }

    if (projectWidgetUrl) {
      projectWidgetUrl.addEventListener('input', () => {
        if (projectWidgetMessage) projectWidgetMessage.textContent = '';
        refreshProjectWidgetUI();
      });
    }

    if (projectWidgetCopyBtn) {
      projectWidgetCopyBtn.addEventListener('click', async () => {
        const defaultPath = getDefaultWidgetPath(currentProject);
        const customValue = projectWidgetUrl ? projectWidgetUrl.value.trim() : '';
        const effectivePath = customValue || defaultPath;
        if (!effectivePath) return;
        const href = resolveWidgetHref(effectivePath);
        try {
          await navigator.clipboard.writeText(href);
          if (projectWidgetMessage) projectWidgetMessage.textContent = 'Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾';
        } catch (error) {
          console.error(error);
          if (projectWidgetMessage) projectWidgetMessage.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ';
        }
        if (projectWidgetMessage) {
          setTimeout(() => { projectWidgetMessage.textContent = ''; }, 2000);
        }
      });
    }

    const refreshEmotionsHint = (enabled) => {
      if (!projectEmotionsHint) return;
      projectEmotionsHint.textContent = enabled
        ? 'ÐžÑ‚Ð²ÐµÑ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¼Ð¸ Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒ ÑÐ¼Ð¾Ð´Ð·Ð¸.'
        : 'ÐžÑ‚Ð²ÐµÑ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð±ÐµÐ· ÑÐ¼Ð¾Ð´Ð·Ð¸.';
    };

    const refreshVoiceHint = (enabled) => {
      if (!projectVoiceHint) return;
      projectVoiceHint.textContent = enabled
        ? 'Ð’Ð¸Ð´Ð¶ÐµÑ‚ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð°Ð½Ð¸Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð°.'
        : 'Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð¹ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚ Ð½Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð² Ð²Ð¸Ð´Ð¶ÐµÑ‚Ðµ.';
      if (projectVoiceModelInput) {
        projectVoiceModelInput.disabled = !enabled;
      }
    };

    const refreshImageCaptionsHint = (enabled) => {
      if (!projectImageCaptionsHint) return;
      projectImageCaptionsHint.textContent = enabled
        ? 'LLM ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð¿Ñ€Ð¸ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ð¸.'
        : 'ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ¸ Ð½Ðµ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ, Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ Ð±ÐµÐ· Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ.';
    };

    const refreshSourcesHint = (enabled) => {
      if (!projectSourcesHint) return;
      projectSourcesHint.textContent = enabled
        ? 'ÐŸÐ¾ÑÐ»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð±Ð¾Ñ‚ Ð¿Ð¾ÐºÐ°Ð¶ÐµÑ‚ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ñ‹.'
        : 'Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð² Ð±ÑƒÐ´ÐµÑ‚ ÑÐºÑ€Ñ‹Ñ‚, ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ²Ð½Ð¾ Ð½Ðµ Ð¿Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ Ð¾ Ð½Ñ‘Ð¼.';
    };

    const refreshDebugInfoHint = (enabled) => {
      if (!projectDebugInfoHint) return;
      projectDebugInfoHint.textContent = enabled
        ? 'ÐŸÐµÑ€ÐµÐ´ ÐºÐ°Ð¶Ð´Ñ‹Ð¼ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼ Ð±Ð¾Ñ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ ÑÐ»ÑƒÐ¶ÐµÐ±Ð½ÑƒÑŽ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ.'
        : 'Ð¡Ð»ÑƒÐ¶ÐµÐ±Ð½Ð°Ñ ÑÐ¿Ñ€Ð°Ð²ÐºÐ° Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°.';
    };

    const refreshDebugHint = (enabled) => {
      if (!projectDebugHint) return;
      projectDebugHint.textContent = enabled
        ? 'ÐŸÐ¾ÑÐ»Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ ÑÐ²Ð¾Ð´ÐºÐ° (ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹, Ð·Ð½Ð°Ð½Ð¸Ñ, ÑÐµÑÑÐ¸Ñ).'
        : 'Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¾Ñ‚Ð»Ð°Ð´Ð¾Ñ‡Ð½Ð°Ñ ÑÐ²Ð¾Ð´ÐºÐ° Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°.';
    };

    const submitProjectForm = () => {
      if (projectForm) {
        projectForm.requestSubmit();
      }
    };

    if (projectEmotionsInput) {
      projectEmotionsInput.addEventListener('change', () => {
        refreshEmotionsHint(projectEmotionsInput.checked);
        submitProjectForm();
      });
      refreshEmotionsHint(projectEmotionsInput.checked);
    }
    if (projectVoiceInput) {
      projectVoiceInput.addEventListener('change', () => {
        refreshVoiceHint(projectVoiceInput.checked);
        submitProjectForm();
      });
      refreshVoiceHint(projectVoiceInput.checked);
    }
    if (projectImageCaptionsInput) {
      projectImageCaptionsInput.addEventListener('change', () => {
        refreshImageCaptionsHint(projectImageCaptionsInput.checked);
        submitProjectForm();
      });
      refreshImageCaptionsHint(projectImageCaptionsInput.checked);
    }
    if (projectSourcesInput) {
      projectSourcesInput.addEventListener('change', () => {
        refreshSourcesHint(projectSourcesInput.checked);
        submitProjectForm();
      });
      refreshSourcesHint(projectSourcesInput.checked);
    }
    if (projectDebugInfoInput) {
      projectDebugInfoInput.addEventListener('change', () => {
        refreshDebugInfoHint(projectDebugInfoInput.checked);
        submitProjectForm();
      });
      refreshDebugInfoHint(projectDebugInfoInput.checked);
    }
    if (projectDebugInput) {
      projectDebugInput.addEventListener('change', () => {
        refreshDebugHint(projectDebugInput.checked);
        submitProjectForm();
      });
      refreshDebugHint(projectDebugInput.checked);
    }

    refreshProjectWidgetUI();
    resetProjectTelegramUI();
    resetProjectMaxUI();
    resetProjectVkUI();

    function refreshMailIntegrationHint() {
      if (!projectMailHint) return;
      const enabled = projectMailEnabled ? projectMailEnabled.checked : false;
      const hasImap = projectMailImapHostInput && projectMailImapHostInput.value.trim().length > 0;
      const hasSmtp = projectMailSmtpHostInput && projectMailSmtpHostInput.value.trim().length > 0;
      if (!hasImap && !hasSmtp) {
        projectMailHint.textContent = 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ IMAP/SMTP, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð¼Ð¾Ð³ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ñ Ð¿Ð¾Ñ‡Ñ‚Ð¾Ð¹.';
      } else if (enabled) {
        projectMailHint.textContent = 'Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°. ÐÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¸ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¿Ð¾Ñ‡Ñ‚Ñƒ.';
      } else {
        projectMailHint.textContent = 'ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹, Ð½Ð¾ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°. Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÐµÐ»ÑŒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ñ‡Ñ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ð½ÐµÐºÑ‚Ð¾Ñ€.';
      }
    }

    function resetVoiceTrainingUi(message) {
      if (voiceUploadStatus) voiceUploadStatus.textContent = 'â€”';
      if (voiceTrainStatus) voiceTrainStatus.textContent = 'â€”';
      if (voiceTrainingSummary) {
        voiceTrainingSummary.textContent = message || 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð¾Ñ€Ð¾Ð¶ÐºÐ¸.';
      }
      voiceSamplesCache = [];
      voiceJobsCache = [];
      if (voiceSamplesContainer) {
        voiceSamplesContainer.innerHTML = '';
        if (voiceSamplesEmpty) {
          voiceSamplesEmpty.textContent = 'Ð”Ð¾Ñ€Ð¾Ð¶ÐºÐ¸ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹.';
          voiceSamplesContainer.appendChild(voiceSamplesEmpty);
        }
      }
      if (voiceTrainButton) voiceTrainButton.disabled = true;
      if (voiceSampleUploadBtn) voiceSampleUploadBtn.disabled = true;
      if (voiceSampleInput) voiceSampleInput.disabled = true;
      if (voiceJobsContainer) voiceJobsContainer.innerHTML = '';
    }

    function renderVoiceSamples(samples) {
      voiceSamplesCache = samples;
      if (!voiceSamplesContainer) return;
      voiceSamplesContainer.innerHTML = '';
      if (voiceTrainingSummary) {
        const total = samples.length;
        const remaining = Math.max(0, VOICE_MIN_SAMPLE_COUNT - total);
        voiceTrainingSummary.textContent = remaining > 0
          ? `Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ ÐºÐ°Ðº Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ ${VOICE_MIN_SAMPLE_COUNT} Ð´Ð¾Ñ€Ð¾Ð¶ÐºÐ¸. ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ${remaining}.`
          : 'Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð¾ Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð¾Ñ€Ð¾Ð¶ÐµÐº. ÐœÐ¾Ð¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ.';
      }
      if (!samples.length) {
        if (voiceSamplesEmpty) {
          voiceSamplesEmpty.textContent = 'Ð”Ð¾Ñ€Ð¾Ð¶ÐºÐ¸ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹.';
          voiceSamplesContainer.appendChild(voiceSamplesEmpty);
        }
        if (voiceTrainButton) voiceTrainButton.disabled = true;
        return;
      }
      const list = document.createElement('div');
      list.className = 'voice-samples-list';
      samples.forEach((sample) => {
        const row = document.createElement('div');
        row.className = 'voice-sample-row';
        const label = document.createElement('div');
        label.style.display = 'flex';
        label.style.flexDirection = 'column';
        label.style.gap = '2px';
        label.innerHTML = `<strong>${sample.filename}</strong><span class="muted">${formatBytesOptional(sample.sizeBytes || 0)}</span>`;
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ';
        removeBtn.addEventListener('click', () => deleteVoiceSample(sample.id));
        row.appendChild(label);
        row.appendChild(removeBtn);
        list.appendChild(row);
      });
      voiceSamplesContainer.appendChild(list);
      if (voiceTrainButton) voiceTrainButton.disabled = samples.length < VOICE_MIN_SAMPLE_COUNT;
    }

    function renderVoiceJobs(jobs) {
      voiceJobsCache = jobs;
      if (!voiceJobsContainer) return;
      voiceJobsContainer.innerHTML = '';
      if (!jobs.length) {
        const placeholder = document.createElement('div');
        placeholder.className = 'muted';
        placeholder.textContent = 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð² Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ.';
        voiceJobsContainer.appendChild(placeholder);
        return;
      }
      jobs.forEach((job) => {
        const row = document.createElement('div');
        row.className = 'voice-job-entry';
        const statusLabel = document.createElement('div');
        statusLabel.textContent = `${job.status} Â· ${(job.progress != null ? Math.round(job.progress * 100) : 0)}%`;
        if (job.message) {
          const hint = document.createElement('div');
          hint.className = 'muted';
          hint.textContent = job.message;
          statusLabel.appendChild(document.createElement('br'));
          statusLabel.appendChild(hint);
        }
        const progressContainer = document.createElement('div');
        progressContainer.className = 'voice-progress-bar';
        const progressFill = document.createElement('div');
        progressFill.className = 'voice-progress-fill';
        const pct = job.progress != null ? Math.max(0, Math.min(1, job.progress)) * 100 : 0;
        progressFill.style.width = `${pct}%`;
        progressContainer.appendChild(progressFill);
        row.appendChild(statusLabel);
        row.appendChild(progressContainer);
        voiceJobsContainer.appendChild(row);
      });
    }

    function clearVoiceJobsPoll() {
      if (voiceJobsPollTimer) {
        clearInterval(voiceJobsPollTimer);
        voiceJobsPollTimer = null;
      }
    }

    async function refreshVoiceTraining(projectName) {
      clearVoiceJobsPoll();
      if (!projectName) {
        resetVoiceTrainingUi('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð¾Ñ€Ð¾Ð¶ÐºÐ¸.');
        return;
      }
      if (voiceSampleUploadBtn) voiceSampleUploadBtn.disabled = false;
      if (voiceSampleInput) voiceSampleInput.disabled = false;
      try {
        const [samplesRes, jobsRes] = await Promise.all([
          fetch(`/api/v1/voice/samples?project=${encodeURIComponent(projectName)}`),
          fetch(`/api/v1/voice/jobs?project=${encodeURIComponent(projectName)}&limit=5`),
        ]);
        if (!samplesRes.ok) throw new Error('samples_fetch_failed');
        if (!jobsRes.ok) throw new Error('jobs_fetch_failed');
        const samplesData = await samplesRes.json();
        const jobsData = await jobsRes.json();
        renderVoiceSamples(samplesData.samples || []);
        renderVoiceJobs(jobsData.jobs || []);
        const shouldPoll = jobsData.jobs?.length && ['queued', 'preparing', 'training', 'validating'].includes((jobsData.jobs[0]?.status || '').toLowerCase());
        if (shouldPoll) {
          voiceJobsPollTimer = setInterval(() => refreshVoiceTraining(projectName), 5000);
        }
      } catch (error) {
        console.error('voice_training_refresh_failed', error);
        resetVoiceTrainingUi('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð¼Ñƒ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸ÑŽ.');
      }
    }

    async function uploadVoiceSamples(projectName) {
      if (!voiceSampleInput || !voiceSampleInput.files?.length) {
        if (voiceUploadStatus) voiceUploadStatus.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸.';
        return;
      }
      const formData = new FormData();
      formData.append('project', projectName);
      Array.from(voiceSampleInput.files).forEach((file) => formData.append('files', file));
      if (voiceUploadStatus) voiceUploadStatus.textContent = 'Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°â€¦';
      try {
        const response = await fetch('/api/v1/voice/samples', {
          method: 'POST',
          body: formData,
        });
        if (!response.ok) {
          const detail = await response.text();
          throw new Error(detail || 'upload_failed');
        }
        const data = await response.json();
        renderVoiceSamples(data.samples || []);
        voiceSampleInput.value = '';
        if (voiceUploadStatus) voiceUploadStatus.textContent = 'Ð“Ð¾Ñ‚Ð¾Ð²Ð¾';
      } catch (error) {
        console.error('voice_upload_failed', error);
        if (voiceUploadStatus) voiceUploadStatus.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð´Ð¾Ñ€Ð¾Ð¶ÐµÐº';
      }
    }

    async function deleteVoiceSample(sampleId) {
      if (!currentProject) return;
      try {
        const res = await fetch(`/api/v1/voice/samples/${sampleId}?project=${encodeURIComponent(currentProject)}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('delete_failed');
        const data = await res.json();
        renderVoiceSamples(data.samples || []);
      } catch (error) {
        console.error('voice_sample_delete_failed', error);
      }
    }

    async function triggerVoiceTraining(projectName) {
      if (voiceTrainStatus) voiceTrainStatus.textContent = 'ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ°â€¦';
      try {
        const formData = new FormData();
        formData.append('project', projectName);
        const res = await fetch('/api/v1/voice/train', {
          method: 'POST',
          body: formData,
        });
        if (!res.ok) {
          const detail = await res.text();
          throw new Error(detail || 'train_failed');
        }
        if (voiceTrainStatus) voiceTrainStatus.textContent = 'ÐžÐ±ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾';
        await refreshVoiceTraining(projectName);
      } catch (error) {
        console.error('voice_train_failed', error);
        if (voiceTrainStatus) voiceTrainStatus.textContent = 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ';
      }
    }
    function populateProjectForm(projectName){
      if (mainPromptAiHandler && typeof mainPromptAiHandler.abort === 'function') {
        mainPromptAiHandler.abort();
      }
      const normalized = (projectName || '').trim().toLowerCase();
      const project = projectsCache[normalized] || null;
      if (startUrlInput) {
        startUrlManual = false;
      }
      if (projectWidgetMessage) projectWidgetMessage.textContent = '';
      if (projectTelegramMessage) projectTelegramMessage.textContent = '';
      if (projectTelegramTokenInput) projectTelegramTokenInput.value = '';
      if (projectMaxMessage) projectMaxMessage.textContent = '';
      if (projectMaxTokenInput) projectMaxTokenInput.value = '';
      if (projectVkMessage) projectVkMessage.textContent = '';
      if (projectVkTokenInput) projectVkTokenInput.value = '';
      projectNameInput.value = project ? project.name : normalized;
      projectNameInput.readOnly = !adminSession.is_super;
      projectTitleInput.value = project?.title || '';
      projectDomainInput.value = project?.domain || '';
      populateModelOptions(project?.llm_model || '');
      projectPromptInput.value = project?.llm_prompt || '';
      if (projectPromptRoleSelect) ensurePromptRoleOptions(projectPromptRoleSelect);
      if (projectPromptAiStatus) projectPromptAiStatus.textContent = 'â€”';
      if (mainPromptAiHandler && typeof mainPromptAiHandler.reset === 'function') {
        mainPromptAiHandler.reset();
      }
      if (projectEmotionsInput) {
        const enabled = project?.llm_emotions_enabled !== false;
        projectEmotionsInput.checked = enabled;
        refreshEmotionsHint(enabled);
      }
      if (projectVoiceInput) {
        const voiceEnabled = project?.llm_voice_enabled !== false;
        projectVoiceInput.checked = voiceEnabled;
        refreshVoiceHint(voiceEnabled);
      }
      if (projectVoiceModelInput) {
        projectVoiceModelInput.value = project?.llm_voice_model || '';
        if (projectVoiceInput) {
          projectVoiceModelInput.disabled = !projectVoiceInput.checked;
        }
      }
      if (projectImageCaptionsInput) {
        const captionsEnabled = project?.knowledge_image_caption_enabled !== false;
        projectImageCaptionsInput.checked = captionsEnabled;
        refreshImageCaptionsHint(captionsEnabled);
      }
      if (projectSourcesInput) {
        const sourcesEnabled = project?.llm_sources_enabled ? true : false;
        projectSourcesInput.checked = sourcesEnabled;
        refreshSourcesHint(sourcesEnabled);
      }
      if (projectDebugInfoInput) {
        const infoEnabled = project?.debug_info_enabled !== false;
        projectDebugInfoInput.checked = infoEnabled;
        refreshDebugInfoHint(infoEnabled);
      }
      if (projectDebugInput) {
        const debugEnabled = !!project?.debug_enabled;
        projectDebugInput.checked = debugEnabled;
        refreshDebugHint(debugEnabled);
      }
      const storage = projectStorageCache[normalized] || projectStorageCache.__default__ || null;
      const textBytes = storage ? storage.text_bytes || storage.documents_bytes || 0 : 0;
      const fileBytes = storage ? storage.binary_bytes || 0 : 0;
      const ctxBytes = storage ? storage.context_bytes || 0 : 0;
      const redisBytes = storage ? storage.redis_bytes || 0 : 0;
      if (projectStorageText) projectStorageText.textContent = storage ? formatBytesOptional(textBytes) : 'â€”';
      if (projectStorageFiles) projectStorageFiles.textContent = storage ? formatBytesOptional(fileBytes) : 'â€”';
      if (projectStorageContexts) projectStorageContexts.textContent = storage ? formatBytesOptional(ctxBytes) : 'â€”';
      if (projectStorageRedis) projectStorageRedis.textContent = storage ? formatBytesOptional(redisBytes) : 'â€”';
      if (projectWidgetUrl) {
        projectWidgetUrl.value = project?.widget_url || '';
      }
      if (projectTelegramAutoStart) {
        projectTelegramAutoStart.checked = !!project?.telegram_auto_start;
      }
      if (projectMaxAutoStart) {
        projectMaxAutoStart.checked = !!project?.max_auto_start;
      }
      if (projectVkAutoStart) {
        projectVkAutoStart.checked = !!project?.vk_auto_start;
      }
      if (projectBitrixEnabled) {
        projectBitrixEnabled.checked = !!project?.bitrix_enabled;
      }
      if (projectBitrixWebhookInput) {
        projectBitrixWebhookInput.value = project?.bitrix_webhook_url || '';
      }
      if (projectBitrixHint) {
        if (!project) {
          projectBitrixHint.textContent = 'Webhook Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð¸ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ.';
        } else if (project?.bitrix_webhook_url) {
          projectBitrixHint.textContent = project?.bitrix_enabled
            ? 'Webhook ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½. Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÐµÐ³Ð¾ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸.'
            : 'Webhook ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½, Ð½Ð¾ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°. Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»Ðµ Ð¸Ð»Ð¸ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÑŽ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Bitrix.';
        } else {
          projectBitrixHint.textContent = 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ URL Ð²ÐµÐ±Ñ…ÑƒÐºÐ° Bitrix24, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÑŽ.';
        }
      }
      refreshVoiceTraining(project ? project.name : null);
      if (projectMailEnabled) {
        projectMailEnabled.checked = !!project?.mail_enabled;
      }
      if (projectMailImapHostInput) {
        projectMailImapHostInput.value = project?.mail_imap_host || '';
      }
      if (projectMailImapPortInput) {
        projectMailImapPortInput.value = project?.mail_imap_port != null ? project.mail_imap_port : '';
      }
      if (projectMailImapSslInput) {
        projectMailImapSslInput.checked = project?.mail_imap_ssl !== false;
      }
      if (projectMailSmtpHostInput) {
        projectMailSmtpHostInput.value = project?.mail_smtp_host || '';
      }
      if (projectMailSmtpPortInput) {
        projectMailSmtpPortInput.value = project?.mail_smtp_port != null ? project.mail_smtp_port : '';
      }
      if (projectMailSmtpTlsInput) {
        projectMailSmtpTlsInput.checked = project?.mail_smtp_tls !== false;
      }
      if (projectMailUsernameInput) {
        projectMailUsernameInput.value = project?.mail_username || '';
      }
      if (projectMailPasswordInput) {
        projectMailPasswordInput.value = '';
        projectMailPasswordInput.placeholder = project?.mail_password_set ? 'ÐŸÐ°Ñ€Ð¾Ð»ÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½' : 'ÐŸÐ°Ñ€Ð¾Ð»ÑŒ';
      }
      if (projectMailFromInput) {
        projectMailFromInput.value = project?.mail_from || '';
      }
      if (projectMailSignatureInput) {
        projectMailSignatureInput.value = project?.mail_signature || '';
      }
      if (projectMailHint) {
        if (!project) {
          projectMailHint.textContent = 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ IMAP/SMTP, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð¼Ð¾Ð³ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ñ Ð¿Ð¾Ñ‡Ñ‚Ð¾Ð¹.';
        } else if (project.mail_enabled) {
          projectMailHint.textContent = 'Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°. ÐÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¸ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¿Ð¾Ñ‡Ñ‚Ñƒ.';
        } else if (project.mail_imap_host || project.mail_smtp_host) {
          projectMailHint.textContent = 'ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹, Ð½Ð¾ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°. Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÐµÐ»ÑŒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ñ‡Ñ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ð½ÐµÐºÑ‚Ð¾Ñ€.';
        } else {
          projectMailHint.textContent = 'Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð¸ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÑŽ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ñ‡Ñ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ð½ÐµÐºÑ‚Ð¾Ñ€.';
        }
      }
      if (projectAdminSection) {
        projectAdminSection.style.display = project ? 'flex' : 'none';
      }
      if (projectAdminUsernameInput) {
        projectAdminUsernameInput.value = project?.admin_username || '';
        projectAdminUsernameInput.disabled = false;
        projectAdminUsernameInput.readOnly = !adminSession.is_super;
      }
      if (projectAdminPasswordInput) {
        projectAdminPasswordInput.value = '';
        projectAdminPasswordInput.disabled = !project;
        projectAdminPasswordInput.placeholder = adminSession.is_super
          ? 'ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ð¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¼ÐµÐ½ÑÑ‚ÑŒ'
          : 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ';
      }
      if (projectAdminHint) {
        if (!project) {
          projectAdminHint.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ ÑƒÑ‡Ñ‘Ñ‚Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸.';
        } else if (adminSession.is_super) {
          projectAdminHint.textContent = project?.admin_password_set
            ? 'ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½. ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¿Ð¾Ð»Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ð¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¼ÐµÐ½ÑÑ‚ÑŒ.'
            : 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð»Ð¾Ð³Ð¸Ð½ Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.';
        } else {
          projectAdminHint.textContent = project?.admin_password_set
            ? 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹.'
            : 'Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð°Ð´Ð¼Ð¸Ð½ÐºÐµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.';
        }
      }
      if (crawlerProjectLabel) {
        crawlerProjectLabel.textContent = project ? project.name || normalized || 'â€”' : (normalized || 'â€”');
      }
      const metaBits = [];
      if (project?.domain) metaBits.push(`Ð”Ð¾Ð¼ÐµÐ½: ${project.domain}`);
      if (project?.llm_model) metaBits.push(`ÐœÐ¾Ð´ÐµÐ»ÑŒ: ${project.llm_model}`);
      if (project) {
        const emoText = project.llm_emotions_enabled === false ? 'Ð­Ð¼Ð¾Ñ†Ð¸Ð¸: Ð²Ñ‹ÐºÐ»' : 'Ð­Ð¼Ð¾Ñ†Ð¸Ð¸: Ð²ÐºÐ»';
        metaBits.push(emoText);
        metaBits.push(project.debug_info_enabled ? 'Ð¡Ð¿Ñ€Ð°Ð²ÐºÐ°: Ð²ÐºÐ»' : 'Ð¡Ð¿Ñ€Ð°Ð²ÐºÐ°: Ð²Ñ‹ÐºÐ»');
        metaBits.push(project.debug_enabled ? 'ÐžÑ‚Ð»Ð°Ð´ÐºÐ°: Ð²ÐºÐ»' : 'ÐžÑ‚Ð»Ð°Ð´ÐºÐ°: Ð²Ñ‹ÐºÐ»');
        metaBits.push(project.llm_sources_enabled ? 'Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸: Ð²ÐºÐ»' : 'Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸: Ð²Ñ‹ÐºÐ»');
        metaBits.push(
          project.knowledge_image_caption_enabled === false
            ? 'ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹: Ð²Ñ‹ÐºÐ»'
            : 'ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹: Ð²ÐºÐ»'
        );
        const voiceEnabledBit = project.llm_voice_enabled === false ? 'Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼: Ð²Ñ‹ÐºÐ»' : 'Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼: Ð²ÐºÐ»';
        if (project.llm_voice_enabled !== false && project.llm_voice_model) {
          metaBits.push(`Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ: ${project.llm_voice_model}`);
        } else {
          metaBits.push(voiceEnabledBit);
        }
      }
      if (storage && (textBytes || fileBytes || ctxBytes || redisBytes)) {
        metaBits.push(
          `Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ: Ñ‚ÐµÐºÑÑ‚Ñ‹ ${formatBytesOptional(textBytes)} Â· Ñ„Ð°Ð¹Ð»Ñ‹ ${formatBytesOptional(fileBytes)} Â· ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ñ‹ ${formatBytesOptional(ctxBytes)} Â· Redis ${formatBytesOptional(redisBytes)}`
        );
      }
      setSummaryProject(project?.title || project?.name || normalized || 'â€”', metaBits.join('\n') || 'ÐÐµÑ‚ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°');
      setSummaryPrompt('', [], project ? 'ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸ Ð¼Ð¾Ð´ÐµÐ»Ð¸' : 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ');
      if (project && project.domain && startUrlInput && !startUrlManual) {
        const normalizedDomain = project.domain.startsWith('http') ? project.domain : `https://${project.domain}`;
        startUrlInput.value = normalizedDomain;
      }
      if (project && startUrlInput && startUrlManual && project.domain && startUrlInput.value === '') {
        startUrlManual = false;
        const normalizedDomain = project.domain.startsWith('http') ? project.domain : `https://${project.domain}`;
        startUrlInput.value = normalizedDomain;
      }
      currentProject = normalized;
      projectSelect.value = currentProject;
      updateProjectInputs();
      projectPromptSaveBtn.disabled = !project;
      if (projectDeleteBtn) {
        projectDeleteBtn.disabled = !project;
      }
      updateProjectDeleteInfo(currentProject);
      refreshProjectWidgetUI();
      loadProjectTelegramStatus(currentProject);
      loadProjectMaxStatus(currentProject);
      loadProjectVkStatus(currentProject);
      loadRequestStats();
      if (currentProject) {
        localStorage.setItem('admin_project', currentProject);
      } else {
        localStorage.removeItem('admin_project');
      }
    }

    async function fetchProjects(){
      try {
        const resp = await fetch('/api/v1/admin/projects');
        if (!resp.ok) {
          setProjectStatus('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹', 3000);
          return;
        }
        const data = await resp.json();
        const projects = Array.isArray(data.projects) ? data.projects : [];
        projectSelect.innerHTML = '';
        projectsCache = {};
        lastProjectCount = projects.length;

        if (!projects.length) {
          projectSelect.appendChild(new Option('â€” Ð½ÐµÑ‚ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð² â€”', '', true, true));
          projectSelect.disabled = true;
          currentProject = '';
          populateProjectForm('');
          updateProjectSummary();
          projectPromptSaveBtn.disabled = true;
          return;
        }

        const normalizedNames = projects
          .map((project) => normalizeProjectName(project.name))
          .filter(Boolean);
        const uniqueNames = [...new Set(normalizedNames)];

        let selectedKey = '';
        if (currentProject && uniqueNames.includes(currentProject)) {
          selectedKey = currentProject;
        } else if (adminSession.primary_project && uniqueNames.includes(adminSession.primary_project)) {
          selectedKey = adminSession.primary_project;
        } else if (uniqueNames.length) {
          selectedKey = uniqueNames[0];
        }

        projectSelect.disabled = false;
        if (adminSession.is_super) {
          projectSelect.appendChild(new Option('â€” Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚ â€”', '', false, !selectedKey));
        }

        projects.forEach((p, index) => {
          const key = normalizeProjectName(p.name);
          if (!key) {
            return;
          }
          const cleaned = {
            ...p,
            name: key,
            llm_model: typeof p.llm_model === 'string' ? p.llm_model.trim() : p.llm_model,
            widget_url: typeof p.widget_url === 'string' ? p.widget_url.trim() : p.widget_url,
            telegram_auto_start: typeof p.telegram_auto_start === 'boolean' ? p.telegram_auto_start : !!p.telegram_auto_start,
            max_auto_start: typeof p.max_auto_start === 'boolean' ? p.max_auto_start : !!p.max_auto_start,
            llm_emotions_enabled: p.llm_emotions_enabled !== false,
            llm_voice_enabled: p.llm_voice_enabled === undefined ? true : !!p.llm_voice_enabled,
            llm_voice_model: typeof p.llm_voice_model === 'string' ? p.llm_voice_model.trim() : p.llm_voice_model,
            debug_enabled: !!p.debug_enabled,
            debug_info_enabled: p.debug_info_enabled === undefined ? true : !!p.debug_info_enabled,
            knowledge_image_caption_enabled: p.knowledge_image_caption_enabled === undefined ? true : !!p.knowledge_image_caption_enabled,
            admin_username: typeof p.admin_username === 'string' ? p.admin_username.trim() : '',
            admin_password_set: Boolean(p.admin_password_set),
            bitrix_enabled: p.bitrix_enabled === undefined ? false : !!p.bitrix_enabled,
            bitrix_webhook_url: typeof p.bitrix_webhook_url === 'string' ? p.bitrix_webhook_url.trim() : p.bitrix_webhook_url,
            mail_enabled: p.mail_enabled === undefined ? false : !!p.mail_enabled,
            mail_imap_host: typeof p.mail_imap_host === 'string' ? p.mail_imap_host.trim() : '',
            mail_imap_port: typeof p.mail_imap_port === 'number' ? p.mail_imap_port : null,
            mail_imap_ssl: p.mail_imap_ssl === undefined ? true : !!p.mail_imap_ssl,
            mail_smtp_host: typeof p.mail_smtp_host === 'string' ? p.mail_smtp_host.trim() : '',
            mail_smtp_port: typeof p.mail_smtp_port === 'number' ? p.mail_smtp_port : null,
            mail_smtp_tls: p.mail_smtp_tls === undefined ? true : !!p.mail_smtp_tls,
            mail_username: typeof p.mail_username === 'string' ? p.mail_username.trim() : '',
            mail_from: typeof p.mail_from === 'string' ? p.mail_from.trim() : '',
            mail_signature: typeof p.mail_signature === 'string' ? p.mail_signature : '',
            mail_password_set: Boolean(p.mail_password_set),
          };
          delete cleaned.telegram_token;
          projectsCache[key] = cleaned;

          const shouldSelect = key === selectedKey || (!selectedKey && index === 0 && !adminSession.is_super);
          const optionLabel = p.title || p.name || key;
          const option = new Option(optionLabel, key, false, shouldSelect);
          projectSelect.appendChild(option);
          if (shouldSelect) {
            selectedKey = key;
          }
        });

        currentProject = selectedKey;
        populateProjectForm(currentProject);
        updateProjectSummary();
        projectPromptSaveBtn.disabled = !currentProject;
      } catch (error) {
        console.error(error);
        setProjectStatus('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð²', 3000);
      }
    }

    projectSelect.addEventListener('change', () => {
      currentProject = projectSelect.value.trim().toLowerCase();
      populateProjectForm(currentProject);
      loadKnowledge();
      pollStatus();
    });

    projectPromptSaveBtn.addEventListener('click', () => {
      if (projectPromptSaveBtn.disabled) return;
      projectForm.requestSubmit();
    });

    if (projectBitrixEnabled && projectBitrixHint) {
      projectBitrixEnabled.addEventListener('change', () => {
        const hasWebhook = projectBitrixWebhookInput && projectBitrixWebhookInput.value.trim().length > 0;
        if (projectBitrixEnabled.checked) {
          projectBitrixHint.textContent = hasWebhook
            ? 'Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°. ÐœÐ¾Ð´ÐµÐ»ÑŒ ÑÐ¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°Ñ‚ÑŒ Bitrix24.'
            : 'Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°. Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ webhook, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐ»Ð¸ÑÑŒ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾.';
        } else {
          projectBitrixHint.textContent = hasWebhook
            ? 'Webhook ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½, Ð½Ð¾ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°. Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÐµÐ»ÑŒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Bitrix.'
            : 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ URL Ð²ÐµÐ±Ñ…ÑƒÐºÐ° Bitrix24, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÑŽ.';
        }
      });
    }

    if (projectBitrixWebhookInput && projectBitrixHint) {
      projectBitrixWebhookInput.addEventListener('input', () => {
        const hasWebhook = projectBitrixWebhookInput.value.trim().length > 0;
        if (projectBitrixEnabled && projectBitrixEnabled.checked) {
          projectBitrixHint.textContent = hasWebhook
            ? 'Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°. ÐœÐ¾Ð´ÐµÐ»ÑŒ ÑÐ¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°Ñ‚ÑŒ Bitrix24.'
            : 'Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°. Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ webhook, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐ»Ð¸ÑÑŒ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾.';
        } else {
          projectBitrixHint.textContent = hasWebhook
            ? 'Webhook ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½, Ð½Ð¾ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°. Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÐµÐ»ÑŒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Bitrix.'
            : 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ URL Ð²ÐµÐ±Ñ…ÑƒÐºÐ° Bitrix24, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÑŽ.';
        }
      });
    }

    if (projectMailEnabled && projectMailHint) {
      projectMailEnabled.addEventListener('change', () => {
        refreshMailIntegrationHint();
      });
    }
    [projectMailImapHostInput, projectMailSmtpHostInput].forEach((input) => {
      if (!input || !projectMailHint) return;
      input.addEventListener('input', () => {
        refreshMailIntegrationHint();
      });
    });

    if (voiceSampleUploadBtn) {
      voiceSampleUploadBtn.addEventListener('click', () => {
        if (!currentProject) {
          if (voiceUploadStatus) voiceUploadStatus.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð¾Ñ€Ð¾Ð¶ÐºÐ¸.';
          return;
        }
        uploadVoiceSamples(currentProject);
      });
    }

    if (voiceTrainButton) {
      voiceTrainButton.addEventListener('click', () => {
        if (!currentProject) {
          if (voiceTrainStatus) voiceTrainStatus.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð´Ð»Ñ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ.';
          return;
        }
        triggerVoiceTraining(currentProject);
      });
    }

    refreshMailIntegrationHint();

    projectForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = projectNameInput.value.trim().toLowerCase();
      if (!name) {
        setProjectStatus('Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€', 3000);
        return;
      }
      const payload = {
        name,
        title: projectTitleInput.value.trim() || null,
        domain: projectDomainInput.value.trim() || null,
        llm_model: projectModelInput.value || null,
        llm_prompt: projectPromptInput.value.trim() || null,
        llm_emotions_enabled: projectEmotionsInput ? projectEmotionsInput.checked : true,
        llm_voice_enabled: projectVoiceInput ? projectVoiceInput.checked : true,
        llm_voice_model: null,
        knowledge_image_caption_enabled: projectImageCaptionsInput ? projectImageCaptionsInput.checked : true,
        llm_sources_enabled: projectSourcesInput ? projectSourcesInput.checked : false,
        debug_info_enabled: projectDebugInfoInput ? projectDebugInfoInput.checked : true,
        debug_enabled: projectDebugInput ? projectDebugInput.checked : false,
        widget_url: projectWidgetUrl && projectWidgetUrl.value.trim() ? projectWidgetUrl.value.trim() : null,
      };
      if (projectBitrixEnabled) {
        payload.bitrix_enabled = projectBitrixEnabled.checked;
      }
      if (projectBitrixWebhookInput) {
        const webhook = projectBitrixWebhookInput.value.trim();
        payload.bitrix_webhook_url = webhook ? webhook : null;
      }
      if (projectMailEnabled) {
        payload.mail_enabled = projectMailEnabled.checked;
      }
      if (projectMailImapHostInput) {
        const imapHost = projectMailImapHostInput.value.trim();
        payload.mail_imap_host = imapHost || null;
      }
      if (projectMailImapPortInput) {
        const portValue = parseInt(projectMailImapPortInput.value, 10);
        payload.mail_imap_port = Number.isFinite(portValue) ? portValue : null;
      }
      if (projectMailImapSslInput) {
        payload.mail_imap_ssl = projectMailImapSslInput.checked;
      }
      if (projectMailSmtpHostInput) {
        const smtpHost = projectMailSmtpHostInput.value.trim();
        payload.mail_smtp_host = smtpHost || null;
      }
      if (projectMailSmtpPortInput) {
        const smtpPort = parseInt(projectMailSmtpPortInput.value, 10);
        payload.mail_smtp_port = Number.isFinite(smtpPort) ? smtpPort : null;
      }
      if (projectMailSmtpTlsInput) {
        payload.mail_smtp_tls = projectMailSmtpTlsInput.checked;
      }
      if (projectMailUsernameInput) {
        const userValue = projectMailUsernameInput.value.trim();
        payload.mail_username = userValue || null;
      }
      if (projectMailFromInput) {
        const fromValue = projectMailFromInput.value.trim();
        payload.mail_from = fromValue || null;
      }
      if (projectMailSignatureInput) {
        const signatureValue = projectMailSignatureInput.value;
        payload.mail_signature = signatureValue ? signatureValue : null;
      }
      if (projectMailPasswordInput) {
        const rawPass = projectMailPasswordInput.value;
        if (rawPass && rawPass.trim()) {
          payload.mail_password = rawPass;
        }
      }
      if (projectVoiceInput && !projectVoiceInput.checked) {
        payload.llm_voice_model = null;
      } else if (projectVoiceModelInput) {
        const voiceModel = projectVoiceModelInput.value.trim();
        payload.llm_voice_model = voiceModel ? voiceModel : null;
      }
      if (adminSession.is_super && projectAdminUsernameInput) {
        const adminUsername = projectAdminUsernameInput.value.trim();
        payload.admin_username = adminUsername || null;
      }
      if (projectAdminPasswordInput) {
        const adminPasswordRaw = projectAdminPasswordInput.value;
        if (adminPasswordRaw && adminPasswordRaw.trim()) {
          payload.admin_password = adminPasswordRaw;
        }
      }
      setProjectStatus('Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚...');
      try {
        const resp = await fetch('/api/v1/admin/projects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          setProjectStatus('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚', 4000);
          return;
        }
        currentProject = name;
        await fetchProjects();
        await loadProjectsList();
        await fetchProjectStorage();
        await loadKnowledge();
        pollStatus();
        setProjectStatus('Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾', 2000);
        populateProjectForm(currentProject);
      } catch (error) {
        console.error(error);
        setProjectStatus('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ', 4000);
      }
    });

    if (projectDeleteBtn) projectDeleteBtn.addEventListener('click', async () => {
      if (!currentProject) return;
      if (!confirm(`Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚ ${currentProject}?`)) return;
      const toDelete = currentProject;
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(toDelete)}`, { method: 'DELETE' });
        if (!resp.ok) {
          setProjectStatus('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ', 4000);
          return;
        }
        const payload = await resp.json().catch(() => ({}));
        delete projectsCache[toDelete];
        currentProject = '';
        await fetchProjects();
        await loadProjectsList();
        await fetchProjectStorage();
        document.getElementById('kbTable').innerHTML = '';
        document.getElementById('kbInfo').textContent = '';
        const removed = payload?.removed || {};
        const parts = [];
        if (typeof removed.documents === 'number') parts.push(`Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²: ${removed.documents}`);
        if (typeof removed.files === 'number') parts.push(`Ñ„Ð°Ð¹Ð»Ð¾Ð²: ${removed.files}`);
        if (typeof removed.contexts === 'number') parts.push(`ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð¾Ð²: ${removed.contexts}`);
        if (typeof removed.stats === 'number') parts.push(`Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸: ${removed.stats}`);
        setProjectStatus(parts.length ? `Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ (${parts.join(', ')})` : 'Ð£Ð´Ð°Ð»ÐµÐ½Ð¾', 4000);
        applySessionPermissions();
        updateProjectDeleteInfo(currentProject);
      } catch (error) {
        console.error(error);
        setProjectStatus('ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ', 4000);
      }
    });

    projectTestBtn.addEventListener('click', async () => {
      if (!currentProject) {
        setProjectStatus('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚', 3000);
        return;
      }
      setProjectStatus('Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑÐµÑ€Ð²Ð¸ÑÑ‹...');
      try {
        const resp = await fetch(`/api/v1/admin/projects/${encodeURIComponent(currentProject)}/test`);
        if (!resp.ok) {
          setProjectStatus('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‚ÐµÑÑ‚Ð°', 4000);
          return;
        }
        const data = await resp.json();
        const parts = ['mongo', 'redis', 'qdrant'].map((key) => {
          const result = data[key];
          return `${key}: ${result.ok ? 'ok' : 'fail'}${result.error ? ` (${result.error})` : ''}`;
        });
        setProjectStatus(parts.join(' Â· '), 4000);
      } catch (error) {
        console.error(error);
        setProjectStatus('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‚ÐµÑÑ‚Ð°', 4000);
      }
    });

    if (knowledgeServiceApply) {
      knowledgeServiceApply.addEventListener('click', saveKnowledgeServiceState);
    }
    if (knowledgeServiceRefresh) {
      knowledgeServiceRefresh.addEventListener('click', () => fetchKnowledgeServiceStatus(true));
    }
    if (crawlerResetBtn) {
      crawlerResetBtn.addEventListener('click', () => performCrawlerAction('/reset', 'Ð¡Ñ‡Ñ‘Ñ‚Ñ‡Ð¸ÐºÐ¸ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹'));
    }
    if (crawlerDedupBtn) {
      crawlerDedupBtn.addEventListener('click', () => performCrawlerAction('/deduplicate', 'Ð”ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹'));
    }
    if (ollamaRefreshBtn) {
      ollamaRefreshBtn.addEventListener('click', () => {
        refreshOllamaCatalog(true);
        refreshOllamaServers();
      });
    }
    if (ollamaServersRefreshBtn) {
      ollamaServersRefreshBtn.addEventListener('click', () => refreshOllamaServers());
    }
    if (ollamaServerForm) {
      ollamaServerForm.addEventListener('submit', submitOllamaServerForm);
    }
    if (feedbackRefreshBtn) {
      feedbackRefreshBtn.addEventListener('click', () => fetchFeedbackTasks());
    }

    ensureBackupTimezones();
    setBackupControlsDisabled(true);
    updateBackupActionButtons();

    const promptAiHandlers = [];
    const mainPromptAiHandler = initPromptAiControls({
      textarea: projectPromptInput,
      domainInput: projectDomainInput,
      roleSelect: projectPromptRoleSelect,
      button: projectPromptAiBtn,
      status: projectPromptAiStatus,
    });
    if (mainPromptAiHandler) promptAiHandlers.push(mainPromptAiHandler);

    const modalPromptAiHandler = initPromptAiControls({
      textarea: projectModalPrompt,
      domainInput: projectModalDomain,
      roleSelect: projectModalPromptRole,
      button: projectModalPromptAiBtn,
      status: projectModalPromptAiStatus,
    });
    if (modalPromptAiHandler) promptAiHandlers.push(modalPromptAiHandler);

    window.addEventListener('beforeunload', () => {
      promptAiHandlers.forEach((handler) => {
        if (handler && typeof handler.abort === 'function') {
          handler.abort();
        }
      });
      if (clusterAvailabilityTimer) {
        clearInterval(clusterAvailabilityTimer);
        clusterAvailabilityTimer = null;
      }
    });

    initLayoutReordering();

    (async () => {
      await fetchSession();
      await refreshClusterAvailability();
      if (!currentProject && adminSession.primary_project) {
        currentProject = adminSession.primary_project;
      }
      if (adminSession.is_super) {
        await refreshOllamaCatalog(true);
        await refreshOllamaServers();
      } else {
        await loadLlmModels();
      }
      await fetchProjectStorage();
      await fetchProjects();
      await loadProjectsList();
      await fetchProjectStorage();
      await loadRequestStats();
      if (adminSession.is_super) {
        await fetchKnowledgeServiceStatus();
        await fetchFeedbackTasks();
      }
      if (currentProject) {
        populateProjectForm(currentProject);
        await loadKnowledge();
        pollStatus();
      } else {
        updateProjectSummary();
      }
      if (!clusterAvailabilityTimer) {
        clusterAvailabilityTimer = setInterval(() => {
          refreshClusterAvailability();
        }, 20000);
      }
    })();

    // Controls for LLM config
    document.getElementById('saveLLM').addEventListener('click', async () => {
      const base = document.getElementById('ollamaBase').value.trim();
      const model = document.getElementById('ollamaModel').value.trim();
      const payload = { ollama_base: base || null, model: model || null };
      try {
        const r = await fetch('/api/v1/llm/config', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        document.getElementById('pingRes').textContent = r.ok ? 'Saved' : 'Save failed';
      } catch (error) {
        console.error('llm_config_save_failed', error);
        document.getElementById('pingRes').textContent = 'Save failed';
      }
      pollLLM();
    });
    document.getElementById('pingLLM').addEventListener('click', async () => {
      try {
        const r = await fetch('/api/v1/llm/ping');
        if (!r.ok) {
          document.getElementById('pingRes').textContent = 'Ping failed';
          return;
        }
        const j = await r.json();
        if (!j.enabled) document.getElementById('pingRes').textContent = 'Disabled';
        else document.getElementById('pingRes').textContent = j.reachable ? 'Reachable' : ('Unreachable' + (j.error ? `: ${j.error}` : ''));
      } catch (error) {
        console.error('llm_ping_failed', error);
        document.getElementById('pingRes').textContent = 'Ping failed';
      }
    });

    document.getElementById('copyLogs').addEventListener('click', async () => {
      const t = document.getElementById('logs').textContent;
      try{ await navigator.clipboard.writeText(t); document.getElementById('logInfo').textContent = 'Copied'; }
      catch{ document.getElementById('logInfo').textContent = 'Copy failed'; }
    });
  </script>
  </div>
  </body>
  </html>
