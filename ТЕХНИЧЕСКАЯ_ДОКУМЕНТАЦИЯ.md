# Техническая документация SiteLLM Vertebro

## Содержание

1. [Обзор системы](#обзор-системы)
   - [Ключевые возможности](#ключевые-возможности)
   - [Целевая аудитория](#целевая-аудитория)
2. [Архитектура системы](#архитектура-системы)
   - [Поток данных при запросе к чату](#поток-данных-при-запросе-к-чату)
3. [Технологический стек](#технологический-стек)
   - [Backend](#backend)
   - [LLM и эмбеддинги](#llm-и-эмбеддинги)
   - [Хранилище](#хранилище)
   - [Краулинг и обработка](#краулинг-и-обработка)
   - [Frontend](#frontend)
   - [DevOps](#devops)
4. [Основные компоненты](#основные-компоненты)
   - [app.py (6,876 строк)](#apppy-6876-строк)
   - [api.py (3,588 строк)](#apipy-3588-строк)
   - [mongo.py (2,796 строк)](#mongopy-2796-строк)
   - [models.py (370 строк)](#modelspy-370-строк)
   - [Система краулинга](#система-краулинга)
   - [Векторный поиск](#векторный-поиск)
   - [Фоновые задачи (worker.py)](#фоновые-задачи-workerpy)
5. [База данных MongoDB](#база-данных-mongodb)
   - [Коллекции](#коллекции)
6. [Конфигурация](#конфигурация)
   - [Переменные окружения (.env)](#переменные-окружения-env)
   - [settings.py](#settingspy)
7. [Разработка](#разработка)
   - [Требования](#требования)
   - [Локальная установка](#локальная-установка)
   - [Запуск тестов](#запуск-тестов)
   - [Бенчмарки](#бенчмарки)
8. [Развертывание](#развертывание)
   - [Docker Compose](#docker-compose)
   - [Сервисы в docker-compose.yml](#сервисы-в-docker-composeyml)
   - [Production соображения](#production-соображения)
9. [API Reference (основные эндпоинты)](#api-reference-основные-эндпоинты)
   - [POST /api/v1/llm/ask](#post-apiv1llmask)
   - [POST /api/v1/crawler/start](#post-apiv1crawlerstart)
   - [GET /api/v1/crawler/status](#get-apiv1crawlerstatus)
   - [GET /api/v1/admin/knowledge](#get-apiv1adminknowledge)
   - [POST /api/v1/admin/knowledge/qa/upload](#post-apiv1adminknowledgeqaupload)
10. [Расширенные темы](#расширенные-темы)
    - [Кластер Ollama](#кластер-ollama)
    - [Оптимизация векторного поиска](#оптимизация-векторного-поиска)
    - [Расширение функционала](#расширение-функционала)
11. [Безопасность](#безопасность)
    - [Аутентификация](#аутентификация)
    - [Защита от атак](#защита-от-атак)
12. [Решение проблем](#решение-проблем)
    - [Частые ошибки](#частые-ошибки)
    - [Логи и отладка](#логи-и-отладка)
13. [Дополнительные ресурсы](#дополнительные-ресурсы)
    - [Документация](#документация)
    - [Полезные команды](#полезные-команды)
    - [Поддержка](#поддержка)
14. [Глоссарий](#глоссарий)

---

## Обзор системы

**SiteLLM Vertebro** — это платформа для создания AI-ассистентов на основе собственной базы знаний. Система использует технологию RAG (Retrieval-Augmented Generation) для предоставления точных ответов, основанных на загруженных документах и проиндексированных веб-страницах.

### Ключевые возможности

- **Автоматический краулинг** — индексация веб-сайтов и документов
- **Векторный поиск** — семантический поиск по базе знаний
- **LLM-чат** — ответы с использованием Ollama, YaLLM
- **Мульти-проекты** — изолированные базы знаний для разных проектов
- **Боты** — интеграция с Telegram, VK, Max
- **Веб-виджет** — встраиваемый чат для сайтов
- **10 языков интерфейса** — EN, ES, DE, FR, IT, PT, RU, ZH, JA, AR

### Целевая аудитория

- Компании для автоматизации клиентской поддержки
- Организации для создания внутренних AI-помощников
- Разработчики для интеграции LLM в существующие системы

---

## Архитектура системы

```
┌─────────────────────────────────────────┐
│          Клиенты                         │
│  Admin Panel | Widget | Telegram | VK   │
└──────────────┬──────────────────────────┘
               │
    ┌──────────▼────────────────────┐
    │   FastAPI Application          │
    │   app.py (6,876 строк)         │
    │   api.py (3,588 строк)         │
    │   - REST API                   │
    │   - SSE streaming              │
    │   - BasicAuth                  │
    └──┬─────┬──────┬────────┬───────┘
       │     │      │        │
   ┌───▼──┐  │  ┌───▼────┐  │
   │MongoDB│  │  │ Redis  │  │
   │+GridFS│  │  │ Cache  │  │
   └───────┘  │  └────────┘  │
              │               │
       ┌──────▼──────┐   ┌───▼──────┐
       │  Crawler    │   │  Celery  │
       │  (async)    │   │  Worker  │
       └──────┬──────┘   └───┬──────┘
              │              │
          ┌───▼──────────────▼───┐
          │    Qdrant + Ollama   │
          │  (Vectors + LLM)     │
          └──────────────────────┘
```

### Поток данных при запросе к чату

1. Пользователь отправляет сообщение через widget/bot
2. `POST /api/v1/llm/ask` принимает запрос
3. Загружается история разговора из MongoDB
4. Выполняется гибридный поиск (векторы + BM25) в базе знаний
5. Формируется промпт с контекстом
6. LLM генерирует ответ (streaming через SSE)
7. Ответ сохраняется в MongoDB
8. Статистика обновляется

---

## Технологический стек

### Backend

- **FastAPI 0.115+** — веб-фреймворк с поддержкой async/await
- **Python 3.10-3.12** — основной язык
- **Pydantic** — валидация данных и настроек
- **Motor 3.7+** — асинхронный драйвер MongoDB
- **Celery 5.5+** — очередь фоновых задач
- **Structlog** — структурированное логирование

### LLM и эмбеддинги

- **Ollama** — основной LLM runtime (поддержка кластера)
- **YaLLM** — альтернативный LLM backend
- **Sentence Transformers 2.7+** — текстовые эмбеддинги
- **LangChain 0.3+** — оркестрация LLM
- **Hugging Face models** — модели эмбеддингов (deepvk/USER-bge-m3)

### Хранилище

- **MongoDB 5+** — основная БД (проекты, документы, разговоры)
- **GridFS** — хранение файлов (PDF, документы, медиа)
- **Redis 5+** — кеширование, векторы, брокер задач
- **Qdrant 1.9+** — векторная БД для ANN поиска

### Краулинг и обработка

- **aiohttp 3.9+** — асинхронный HTTP клиент
- **BeautifulSoup4 4.12+** — парсинг HTML
- **PyPDF 5.7+** — извлечение текста из PDF
- **Playwright** — рендеринг JS для SPA
- **NLTK 3.8+** — нормализация текста

### Frontend

- **Vanilla JavaScript** — без фреймворков
- **HTML5/CSS3** — статический админ-дашборд
- **SSE (Server-Sent Events)** — потоковые ответы в реальном времени

### DevOps

- **Docker & Docker Compose** — контейнеризация
- **Uvicorn 0.35+** — ASGI сервер
- **Prometheus** — метрики (prometheus-client 0.20+)
- **Pytest 8.4+** — тестирование

---

## Основные компоненты

### app.py (6,876 строк)

Главное приложение FastAPI с административными эндпоинтами.

**Основные функции:**
- Фабрика приложения FastAPI
- Lifespan management (запуск/остановка)
- Middleware (CORS, метрики, BasicAuth)
- Монтирование статических файлов
- Админ эндпоинты:
  - Управление проектами
  - Управление базой знаний
  - Резервное копирование
  - Статистика

**Ключевые эндпоинты:**

```python
# Проекты
GET    /api/v1/admin/projects          # Список проектов
POST   /api/v1/admin/projects          # Создать/обновить проект
DELETE /api/v1/admin/projects/{name}   # Удалить проект

# База знаний
GET    /api/v1/admin/knowledge          # Список документов
POST   /api/v1/admin/knowledge          # Загрузить документ
PUT    /api/v1/admin/knowledge/{id}     # Обновить документ
DELETE /api/v1/admin/knowledge/{id}     # Удалить документ

# Q&A пары
GET    /api/v1/admin/knowledge/qa                    # Список Q&A
POST   /api/v1/admin/knowledge/qa                    # Создать Q&A
POST   /api/v1/admin/knowledge/qa/upload             # Импорт из CSV/Excel
PUT    /api/v1/admin/knowledge/qa/{id}               # Обновить Q&A
DELETE /api/v1/admin/knowledge/qa/{id}               # Удалить Q&A

# Резервное копирование (только super admin)
GET    /api/v1/backup/status           # Статус резервных копий
POST   /api/v1/backup/settings         # Настройки бэкапа
POST   /api/v1/backup/run              # Создать бэкап
POST   /api/v1/backup/restore          # Восстановить из бэкапа

# Статистика
GET    /api/v1/admin/stats             # Статистика запросов
GET    /api/v1/admin/logs              # Логи (последние 7 дней)
```

### api.py (3,588 строк)

Публичные API роутеры для пользовательских функций.

**LLM Router** (`/api/v1/llm/*`):
```python
POST /api/v1/llm/ask          # Главный чат эндпоинт (SSE streaming)
POST /api/v1/llm/chat         # Альтернативный streaming
GET  /api/v1/llm/sources      # Получить источники для цитат
```

**Crawler Router** (`/api/v1/crawler/*`):
```python
POST /api/v1/crawler/start    # Запустить краулинг
GET  /api/v1/crawler/status   # Прогресс и статистика
POST /api/v1/crawler/stop     # Остановить краулинг
POST /api/v1/crawler/clear    # Очистить состояние
```

**Reading Mode Router** (`/api/v1/reading/*`):
```python
GET /api/v1/reading/pages         # Постраничный контент книги
GET /api/v1/reading/pages/preview # Предпросмотр первых страниц
```

**Voice Router** (`/api/v1/voice/*`):
```python
POST   /api/v1/voice/samples/upload   # Загрузить аудио для обучения
GET    /api/v1/voice/samples          # Список сэмплов
DELETE /api/v1/voice/samples/{id}     # Удалить сэмпл
POST   /api/v1/voice/train            # Запустить обучение
GET    /api/v1/voice/jobs             # Список заданий обучения
```

### mongo.py (2,796 строк)

Обертка над MongoDB с CRUD операциями.

**Основные функции:**
- Подключение к MongoDB через Motor (async)
- CRUD операции для всех коллекций
- GridFS для работы с файлами
- Хелперы запросов
- Управление индексами

**Пример использования:**

```python
from mongo import MongoClient

# Получить проект
project = await MongoClient.get_project_by_name("my-project")

# Добавить документ
doc_id = await MongoClient.insert_document({
    "name": "FAQ",
    "content": "...",
    "project": "my-project"
})

# Загрузить файл в GridFS
file_id = await MongoClient.upload_file(
    file_content,
    filename="document.pdf",
    content_type="application/pdf"
)
```

### models.py (370 строк)

Pydantic модели для валидации данных.

**Основные модели:**

```python
class LLMRequest(BaseModel):
    """Запрос к LLM"""
    text: str
    project: str
    session_id: str | None = None

class Project(BaseModel):
    """Конфигурация проекта"""
    name: str
    title: str | None = None
    domain: str | None = None
    llm_model: str | None = None
    llm_prompt: str | None = None
    llm_sources_enabled: bool | None = None
    knowledge_image_caption_enabled: bool | None = None
    # ... другие поля

class Document(BaseModel):
    """Запись в базе знаний"""
    _id: str
    name: str
    project: str
    content: str | None = None
    url: str | None = None
    fileId: str | None = None
    ts: int
```

### Система краулинга

**crawler/run_crawl.py** — асинхронный BFS краулер

Функции:
- Обход сайта в ширину (BFS)
- Извлечение текста из HTML/PDF
- Рендеринг SPA через Playwright (опционально)
- Дедупликация URL
- Очистка текста (удаление навигации, футера)
- Сохранение в MongoDB + GridFS
- Отчет о прогрессе в Redis
- Сегментация для режима чтения книг

**Пример запуска:**

```python
from crawler.run_crawl import run_crawl

await run_crawl(
    project_name="my-project",
    start_url="https://example.com",
    max_depth=3,
    max_pages=100
)
```

### Векторный поиск

**retrieval/search.py** — гибридный поиск

```python
from retrieval.search import hybrid_search

results = await hybrid_search(
    query="Как настроить проект?",
    project="my-project",
    top_k=5
)
# Результаты: список документов с релевантностью
```

**Алгоритм:**
1. Генерация эмбеддинга запроса
2. Поиск по векторам (Qdrant/Redis)
3. BM25 текстовый поиск
4. Reciprocal Rank Fusion (RRF) для объединения
5. Reranking (cross-encoder)
6. Возврат топ-K результатов

### Фоновые задачи (worker.py)

Celery воркер для асинхронных задач.

**Задачи:**
- Обновление векторного хранилища
- Резервное копирование/восстановление
- Обучение голосовых моделей
- Периодические задания (beat)
- Управление кластером Ollama

**Пример:**

```python
from worker import update_vector_store

# Запустить обновление векторов
task = update_vector_store.delay(project_name="my-project")
```

---

## База данных MongoDB

### Коллекции

#### projects
Конфигурация проектов (мульти-тенантность).

```javascript
{
  "_id": ObjectId,
  "name": "my-project",          // уникальный slug
  "title": "Мой проект",
  "domain": "example.com",
  "llm_model": "llama3.2",
  "llm_prompt": "Ты - помощник...",
  "llm_sources_enabled": true,
  "knowledge_image_caption_enabled": false,
  "telegram_token": "bot123:ABC...",
  "admin_username": "admin",
  "admin_password": "hashed_password"
}
```

#### documents
Записи базы знаний.

```javascript
{
  "_id": ObjectId,
  "name": "FAQ",
  "description": "Часто задаваемые вопросы",
  "project": "my-project",
  "url": "https://example.com/faq",
  "content": "текст документа...",
  "fileId": ObjectId,            // ссылка на GridFS
  "ts": 1699999999,              // timestamp
  "content_type": "text/html",
  "reading_mode": false
}
```

**Индексы:**
- `{project: 1, ts: -1}` — сортировка по времени
- `{project: 1, url: 1}` — уникальность URL

#### contexts
История разговоров.

```javascript
{
  "_id": ObjectId,
  "session_id": "user-123",
  "project": "my-project",
  "role": "user",              // "user" или "assistant"
  "text": "Как настроить проект?",
  "ts": 1699999999,
  "sources": [...]             // источники для assistant
}
```

**Индексы:**
- `{session_id: 1, ts: 1}` — получение истории
- `{project: 1}` — фильтрация по проекту

#### knowledge_qa
Пары вопрос-ответ.

```javascript
{
  "_id": ObjectId,
  "project": "my-project",
  "question": "Как создать проект?",
  "answer": "Нажмите кнопку...",
  "ts": 1699999999
}
```

#### knowledge_unanswered
Вопросы без ответов.

```javascript
{
  "_id": ObjectId,
  "project": "my-project",
  "text": "Что такое RAG?",
  "count": 5,                  // сколько раз задавали
  "last_ts": 1699999999
}
```

#### request_stats
Аналитика запросов.

```javascript
{
  "_id": ObjectId,
  "project": "my-project",
  "ts": 1699999999,
  "date": "2024-11-14",
  "count": 1
}
```

**TTL индекс:** `{ts: 1}` с expireAfterSeconds (3 дня)

#### backup_jobs
Задания резервного копирования.

```javascript
{
  "_id": ObjectId,
  "operation": "backup",       // "backup" или "restore"
  "status": "completed",       // "queued" | "running" | "completed" | "failed"
  "started_at": 1699999999,
  "completed_at": 1700000000,
  "error": null,
  "file_path": "/backups/backup-2024-11-14.gz"
}
```

#### GridFS
Хранение файлов (PDF, изображения, документы).

**Коллекции:**
- `fs.files` — метаданные файлов
- `fs.chunks` — чанки данных (по 255 КБ)

---

## Конфигурация

### Переменные окружения (.env)

```bash
# MongoDB
MONGO_HOST=localhost
MONGO_PORT=27017
MONGO_USERNAME=admin
MONGO_PASSWORD=password
MONGO_DB=sitellm

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# Celery
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/1

# Qdrant (векторная БД)
QDRANT_URL=http://localhost:6333

# Проект по умолчанию
PROJECT_NAME=default
DOMAIN=localhost:3000

# LLM
LLM_MODEL=llama3.2
OLLAMA_BASE_URL=http://localhost:11434

# Краулинг
CRAWL_START_URL=https://example.com

# CORS
CORS_ORIGINS=http://localhost:3000,https://example.com

# Сервер
APP_HOST=0.0.0.0
APP_PORT=8000
```

### settings.py

```python
from pydantic_settings import BaseSettings

class MongoSettings(BaseSettings):
    host: str = "localhost"
    port: int = 27017
    username: str = "admin"
    password: str = "password"
    db: str = "sitellm"

class Settings(BaseSettings):
    mongo: MongoSettings = MongoSettings()
    redis_host: str = "localhost"
    redis_port: int = 6379
    celery_broker_url: str = "redis://localhost:6379/0"
    # ...

settings = Settings()
```

---

## Разработка

### Требования

- Python 3.10-3.12
- MongoDB 5+
- Redis 5+
- Node.js (для frontend тестов, опционально)
- Docker & Docker Compose

### Локальная установка

```bash
# Клонировать репозиторий
git clone <repo-url>
cd sitellm_vertebro

# Создать виртуальное окружение
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate     # Windows

# Установить зависимости
pip install -r requirements.txt

# Создать .env файл
cp .env.example .env
# Отредактировать .env

# Запустить MongoDB и Redis (Docker)
docker-compose up -d mongo redis

# Применить индексы БД
python scripts/init_db.py

# Запустить приложение
uvicorn app:app --reload --port 8000

# В другом терминале - запустить Celery worker
celery -A worker worker --loglevel=info

# В третьем терминале - запустить Celery beat
celery -A worker beat --loglevel=info
```

### Запуск тестов

```bash
# Все тесты
pytest

# С покрытием
pytest --cov=. --cov-report=html

# Конкретный тест
pytest tests/test_crawler.py -v

# Быстрые тесты (без медленных)
pytest -m "not slow"
```

### Бенчмарки

```bash
python scripts/benchmark.py --requests 200 --concurrency 8
```

---

## Развертывание

### Docker Compose

```bash
# Запустить все сервисы
docker-compose up -d

# Проверить логи
docker-compose logs -f app

# Перезапустить сервис
docker-compose restart app

# Остановить все
docker-compose down
```

### Сервисы в docker-compose.yml

- `mongo` — MongoDB 8.0 с persistence
- `redis` — Redis с AOF
- `qdrant` — векторная БД
- `ollama` — LLM runtime (опционально)
- `app` — FastAPI backend
- `celery_worker` — обработчик задач
- `celery_beat` — планировщик
- `telegram_bot` — Telegram интеграция

### Production соображения

**Безопасность:**
- Использовать HTTPS (nginx reverse proxy)
- Настроить firewall (закрыть порты БД)
- Сильные пароли для MongoDB/Redis
- JWT токены для API (вместо BasicAuth)
- Rate limiting

**Производительность:**
- Масштабирование Celery workers (несколько реплик)
- Redis cluster для кеширования
- MongoDB replica set для отказоустойчивости
- Ollama cluster для балансировки LLM запросов
- CDN для статики

**Мониторинг:**
- Prometheus + Grafana для метрик
- ELK stack для логов
- Sentry для ошибок
- Uptime monitoring

**Резервное копирование:**
- Автоматические бэкапы (cron)
- Яндекс.Диск / S3 для хранения
- Тестирование восстановления

---

## API Reference (основные эндпоинты)

### POST /api/v1/llm/ask

Отправить сообщение в LLM чат (с SSE streaming).

**Запрос:**
```json
{
  "text": "Как создать проект?",
  "project": "my-project",
  "session_id": "user-123"
}
```

**Ответ (SSE stream):**
```
data: {"chunk": "Чтобы"}
data: {"chunk": " создать"}
data: {"chunk": " проект"}
data: {"done": true, "sources": [...]}
```

**Curl пример:**
```bash
curl -X POST http://localhost:8000/api/v1/llm/ask \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Привет",
    "project": "default",
    "session_id": "test-123"
  }'
```

### POST /api/v1/crawler/start

Запустить краулинг сайта.

**Запрос:**
```json
{
  "project": "my-project",
  "start_url": "https://example.com",
  "max_depth": 3,
  "max_pages": 100
}
```

**Ответ:**
```json
{
  "status": "started",
  "task_id": "abc123"
}
```

### GET /api/v1/crawler/status

Получить статус краулинга.

**Параметры:**
- `project` (query) — имя проекта

**Ответ:**
```json
{
  "running": true,
  "processed": 50,
  "total": 100,
  "current_url": "https://example.com/page",
  "errors": 2
}
```

### GET /api/v1/admin/knowledge

Получить список документов (требуется BasicAuth).

**Параметры:**
- `project` (query) — имя проекта

**Заголовки:**
```
Authorization: Basic base64(username:password)
```

**Ответ:**
```json
{
  "documents": [
    {
      "_id": "507f1f77bcf86cd799439011",
      "name": "FAQ",
      "project": "my-project",
      "ts": 1699999999
    }
  ]
}
```

### POST /api/v1/admin/knowledge/qa/upload

Импортировать Q&A пары из CSV/Excel.

**Формат файла CSV:**
```csv
question,answer
Как создать проект?,Нажмите кнопку...
Что такое RAG?,RAG - это...
```

**Запрос (multipart/form-data):**
```
POST /api/v1/admin/knowledge/qa/upload
Content-Type: multipart/form-data

project=my-project
file=@qa_pairs.csv
```

**Ответ:**
```json
{
  "inserted": 10,
  "updated": 2,
  "skipped": 1,
  "total": 13
}
```

---

## Расширенные темы

### Кластер Ollama

Настройка нескольких Ollama серверов для балансировки нагрузки.

**Конфигурация в БД (коллекция ollama_servers):**

```javascript
{
  "url": "http://ollama1:11434",
  "enabled": true,
  "priority": 1
}
{
  "url": "http://ollama2:11434",
  "enabled": true,
  "priority": 2
}
```

**Алгоритм выбора:**
1. Фильтрация по `enabled=true`
2. Сортировка по `priority`
3. Health check (GET /api/tags)
4. Выбор первого доступного

### Оптимизация векторного поиска

**Стратегии:**

1. **Кеширование в Redis:**
```python
# Кеш эмбеддингов запросов
embedding = cache.get(f"emb:{query_hash}")
if not embedding:
    embedding = generate_embedding(query)
    cache.set(f"emb:{query_hash}", embedding, ttl=3600)
```

2. **Batch обработка:**
```python
# Генерация эмбеддингов пакетами
embeddings = model.encode(texts, batch_size=32)
```

3. **Оптимизация Qdrant:**
```python
# Создание коллекции с HNSW индексом
client.create_collection(
    collection_name="documents",
    vectors_config={
        "size": 768,
        "distance": "Cosine"
    },
    hnsw_config={
        "m": 16,              # связей на элемент
        "ef_construct": 100   # качество индекса
    }
)
```

### Расширение функционала

**Добавление нового бота:**

1. Создать директорию `new_bot/`
2. Реализовать `bot.py` с обработчиками
3. Добавить конфиг в `settings.py`
4. Добавить поля в модель `Project`
5. Обновить админ-панель

**Пример структуры:**
```python
# new_bot/bot.py
from aiogram import Bot, Dispatcher

async def handle_message(message):
    response = await llm_client.ask(
        text=message.text,
        project=get_project()
    )
    await message.answer(response)
```

---

## Безопасность

### Аутентификация

**BasicAuth для админ-панели:**
```python
from fastapi import Depends
from fastapi.security import HTTPBasic, HTTPBasicCredentials

security = HTTPBasic()

def verify_admin(credentials: HTTPBasicCredentials = Depends(security)):
    # Проверка username/password
    if not verify_credentials(credentials):
        raise HTTPException(401, "Неверные учетные данные")
```

**Уровни доступа:**
- **Super Admin** — полный доступ + резервное копирование
- **Admin** — управление проектами и базой знаний
- **User** — только чтение

### Защита от атак

**XSS Prevention:**
- Санитизация HTML в admin/js
- CSP заголовки

**SQL/NoSQL Injection:**
- Параметризованные запросы
- Валидация Pydantic

**Rate Limiting:**
```python
from slowapi import Limiter

limiter = Limiter(key_func=get_remote_address)

@app.post("/api/v1/llm/ask")
@limiter.limit("10/minute")
async def ask(request: LLMRequest):
    ...
```

---

## Решение проблем

### Частые ошибки

**1. MongoDB connection failed**
```
Причина: MongoDB не запущен или неверные credentials
Решение:
- Проверить docker-compose up -d mongo
- Проверить MONGO_* переменные в .env
```

**2. Ollama model not found**
```
Причина: Модель не загружена в Ollama
Решение: ollama pull llama3.2
```

**3. Celery tasks not processing**
```
Причина: Worker не запущен
Решение: celery -A worker worker --loglevel=info
```

**4. Widget not loading**
```
Причина: CORS ошибка
Решение: Добавить домен в CORS_ORIGINS
```

### Логи и отладка

**Просмотр логов:**
```bash
# FastAPI
docker-compose logs -f app

# Celery worker
docker-compose logs -f celery_worker

# MongoDB
docker-compose logs -f mongo
```

**Уровни логирования:**
```python
# settings.py
LOG_LEVEL = "DEBUG"  # DEBUG | INFO | WARNING | ERROR
```

**Админ-панель → Logs:**
- Последние 7 дней логов
- Фильтрация по уровню
- Поиск по тексту
- Копирование в буфер обмена

---

## Дополнительные ресурсы

### Документация

- **README.md** — быстрый старт
- **docs/architecture.rst** — детальная архитектура
- **docs/components.rst** — описание компонентов
- **docs/workflows.rst** — рабочие процессы

### Полезные команды

```bash
# Очистка БД
python scripts/clear_db.py --project my-project

# Миграция данных
python scripts/migrate.py --from old_db --to new_db

# Генерация эмбеддингов
python scripts/generate_embeddings.py --project my-project

# Экспорт статистики
curl -u admin:password http://localhost:8000/api/v1/admin/stats/export > stats.csv
```

### Поддержка

- GitHub Issues: https://github.com/your-repo/issues
- Email: support@example.com
- Документация: https://docs.example.com

---

## Глоссарий

- **RAG** — Retrieval-Augmented Generation, генерация с извлечением знаний
- **LLM** — Large Language Model, большая языковая модель
- **Embedding** — векторное представление текста
- **SSE** — Server-Sent Events, потоковая передача данных
- **BFS** — Breadth-First Search, обход в ширину
- **GridFS** — файловая система MongoDB для больших файлов
- **HNSW** — Hierarchical Navigable Small World, алгоритм ANN поиска
- **RRF** — Reciprocal Rank Fusion, метод объединения результатов поиска

---

**Версия документа:** 1.0
**Дата обновления:** 2024-11-14
