# Безопасность резервного копирования - Контроль доступа

**Дата создания:** 14 ноября 2024
**Последнее обновление:** 14 ноября 2024
**Версия:** 1.0
**Статус:** Актуально

---

## Содержание

1. [Обзор](#обзор)
2. [Требование безопасности: Доступ только для супер-администраторов](#требование-безопасности-доступ-только-для-супер-администраторов)
   - [Обоснование](#обоснование)
3. [Реализация](#реализация)
   - [Защита на бэкенде (Defense in Depth)](#защита-на-бэкенде-defense-in-depth)
   - [Защита на фронтенде (UX и безопасность)](#защита-на-фронтенде-ux-и-безопасность)
   - [Почему полное скрытие, а не отключение контролов?](#почему-полное-скрытие-а-не-отключение-контролов)
4. [Свойства безопасности](#свойства-безопасности)
   - [Поток аутентификации](#поток-аутентификации)
   - [Проверка авторизации](#проверка-авторизации)
   - [Проверка на фронтенде](#проверка-на-фронтенде)
5. [Модель угроз](#модель-угроз)
   - [Предотвращенные угрозы](#предотвращенные-угрозы)
   - [Угрозы НЕ предотвращенные (вне области)](#угрозы-не-предотвращенные-вне-области)
6. [Тестирование контроля доступа](#тестирование-контроля-доступа)
7. [Применяемые лучшие практики безопасности](#применяемые-лучшие-практики-безопасности)
8. [Связанные меры безопасности](#связанные-меры-безопасности)
9. [Примечания по поддержке](#примечания-по-поддержке)
10. [Соображения соответствия](#соображения-соответствия)

---

## Обзор

Этот документ объясняет обоснование безопасности и реализацию контроля доступа к функционалу резервного копирования в приложении sitellm_vertebro.

---

## Требование безопасности: Доступ только для супер-администраторов

### Обоснование

Операции резервного копирования должны быть ограничены только супер-администраторами по следующим причинам:

1. **Полный доступ к базе данных**: Резервные копии содержат ВСЕ данные базы данных по ВСЕМ проектам, а не только данные, принадлежащие конкретному администратору проекта.

2. **Чувствительные учетные данные**: Файлы резервных копий включают:
   - Пароли пользователей и токены аутентификации
   - API ключи и учетные данные сервисов
   - Токены доступа к Яндекс.Диску
   - Учетные данные администраторов проектов
   - Строки подключения к базе данных

3. **Раскрытие данных между проектами**: Обычные администраторы проектов должны иметь доступ только к своим назначенным проектам. Резервные копии раскрывают данные из ВСЕХ проектов.

4. **Катастрофический риск восстановления**: Операции восстановления базы данных могут:
   - Полностью перезаписать production базу данных
   - Вызвать полную потерю данных при выборе неправильной резервной копии
   - Обеспечить повышение привилегий путем восстановления старых учетных данных
   - Повредить всю систему при невалидной резервной копии

5. **Хранение учетных данных**: Токен Яндекс.Диска, сохраненный в настройках резервного копирования, предоставляет доступ ко ВСЕМ историческим резервным копиям в облачном хранилище.

---

## Реализация

### Защита на бэкенде (Defense in Depth)

Все эндпоинты резервного копирования защищены декоратором `_require_super_admin()`:

```python
@app.get("/api/v1/backup/status")
async def backup_status(request: Request, limit: int = 10) -> ORJSONResponse:
    _require_super_admin(request)  # Возвращает 403 для не-супер админов
    # ...

@app.post("/api/v1/backup/settings")
async def backup_update_settings(request: Request, payload: BackupSettingsPayload) -> ORJSONResponse:
    _require_super_admin(request)  # Возвращает 403 для не-супер админов
    # ...

@app.post("/api/v1/backup/run")
async def backup_run(request: Request, payload: BackupRunRequest | None = None) -> ORJSONResponse:
    _require_super_admin(request)  # Возвращает 403 для не-супер админов
    # ...

@app.post("/api/v1/backup/restore")
async def backup_restore(request: Request, payload: BackupRestoreRequest) -> ORJSONResponse:
    _require_super_admin(request)  # Возвращает 403 для не-супер админов
    # ...
```

### Защита на фронтенде (UX и безопасность)

Секция UI резервного копирования полностью скрыта для не-супер администраторов:

```javascript
// В init() - скрываем сразу при загрузке страницы
const init = () => {
  if (!global.adminSession?.is_super) {
    if (backupCard) backupCard.style.display = 'none';
    return;
  }
  // ... остальная инициализация только для супер-админов
};

// В refreshBackupStatus() - скрываем при динамических проверках
const refreshBackupStatus = async (clearMessage = false) => {
  if (!global.adminSession?.is_super) {
    if (backupCard) backupCard.style.display = 'none';
    scheduleBackupRefresh(false);
    return;
  }
  // ... остальная логика обновления
};
```

### Почему полное скрытие, а не отключение контролов?

Мы выбрали полное скрытие секции резервного копирования вместо показа отключенных контролов по следующим причинам:

1. **Принцип наименьших привилегий**: Пользователи не должны видеть функции, которые они не могут использовать
2. **Лучший UX**: Нет путаницы относительно того, почему кнопки отключены
3. **Уменьшенная поверхность атаки**: Нет элементов UI, которые могли бы быть манипулированы на стороне клиента
4. **Четкая граница безопасности**: Если вы не видите это, вы явно не имеете доступа
5. **Defense in Depth**: Бэкенд все равно применяет контроль доступа, даже если фронтенд обойден

---

## Свойства безопасности

### Поток аутентификации

1. Пользователь аутентифицируется с username/password (Basic Auth)
2. Бэкенд валидирует учетные данные и создает объект `AdminIdentity`
3. Флаг `AdminIdentity.is_super` устанавливается на основе роли пользователя
4. Флаг сохраняется в `request.state.admin` для каждого запроса

### Проверка авторизации

1. `_require_super_admin()` вызывается в начале каждого эндпоинта резервного копирования
2. Проверяет флаг `request.state.admin.is_super`
3. Возвращает HTTP 403 Forbidden, если не супер-админ
4. Продолжает выполнение только для супер-админов

### Проверка на фронтенде

1. JavaScript проверяет `global.adminSession?.is_super` при загрузке страницы
2. Секция резервного копирования скрывается с `display: 'none'`, если не супер-админ
3. Все обработчики событий пропускают выполнение, если не супер-админ
4. Функции периодического обновления завершаются рано, если не супер-админ

---

## Модель угроз

### Предотвращенные угрозы

- **Несанкционированный доступ к данным**: Обычные админы не могут читать файлы резервных копий, содержащие данные других проектов
- **Кража учетных данных**: Токены Яндекс.Диска и другие учетные данные не раскрываются не-супер админам
- **Повышение привилегий**: Обычные админы не могут восстанавливать старые резервные копии с повышенными привилегиями
- **Потеря данных**: Только доверенные супер-админы могут выполнять разрушительные операции восстановления
- **Обход на стороне клиента**: Бэкенд применяет контроль доступа, даже если фронтенд изменен

### Угрозы НЕ предотвращенные (вне области)

- **Компрометация супер-админа**: Если учетная запись супер-админа скомпрометирована, атакующий имеет полный доступ к резервным копиям
- **Уязвимости на стороне сервера**: SQL инъекции, выполнение кода и т.д. (отдельные проблемы безопасности)
- **Сетевые атаки**: MITM, перехват сессии (следует использовать HTTPS и безопасные cookies)

---

## Тестирование контроля доступа

### Тест как обычный администратор

1. Войти с учетными данными не-супер админа
2. Перейти в админ-панель
3. Убедиться, что секция резервного копирования НЕ видна
4. Попытаться прямой доступ к API: `GET /api/v1/backup/status`
5. Ожидается: HTTP 403 Forbidden

### Тест как супер-администратор

1. Войти с учетными данными супер-админа
2. Перейти в админ-панель
3. Убедиться, что секция резервного копирования ВИДНА
4. Убедиться, что все контролы резервного копирования функциональны
5. Вызовы API возвращают успешные ответы

---

## Применяемые лучшие практики безопасности

- **Defense in Depth**: Несколько уровней (скрытие фронтенда + авторизация бэкенда)
- **Принцип наименьших привилегий**: Только супер-админы имеют доступ к резервным копиям
- **Fail Secure**: Поведение по умолчанию - отказать в доступе
- **Четкие границы безопасности**: Явный контроль доступа на основе ролей
- **Комплексная документация**: Обоснование безопасности четко задокументировано
- **Валидация ввода**: Параметр limit ограничен безопасным диапазоном (1-50)
- **Журнал аудита**: Задания резервного копирования записывают `triggered_by` с именем админа

---

## Связанные меры безопасности

- Аутентификация админа (Basic Auth)
- Система ролей админа (супер-админ vs админ проекта)
- Контроль доступа на уровне проекта для обычных админов
- Управление сессиями
- HTTPS/TLS для учетных данных в транзите (рекомендуемое развертывание)

---

## Примечания по поддержке

При модификации функционала резервного копирования:

1. **Никогда** не удаляйте проверки `_require_super_admin()` из эндпоинтов
2. **Всегда** проверяйте, что новые эндпоинты защищены
3. **Сохраняйте** синхронизацию проверок фронтенда с бэкендом
4. **Документируйте** любые изменения, связанные с безопасностью
5. **Тестируйте** с обеими ролями: супер-админ и обычный админ

---

## Соображения соответствия

Данные резервных копий могут содержать:
- Персональные идентифицируемые данные (PII)
- Платежные данные
- Учетные данные аутентификации
- Конфиденциальную бизнес-информацию

Убедитесь, что хранилище резервных копий (Яндекс.Диск) соответствует требованиям:
- GDPR (если пользователи из ЕС)
- PCI DSS (если платежные данные)
- Местные законы о защите данных
- Отраслевые регуляции

Доступ к резервным копиям должен логироваться для целей аудита.

---

## Связанные документы

**Документация по безопасности резервного копирования:**
- `SECURITY_BACKUP_ACCESS_CONTROL.md` - Контроль доступа (этот документ)
- `SECURITY_BACKUP_SUMMARY.md` - Краткая сводка по безопасности
- `SECURITY_BACKUP_ANALYSIS.md` - Детальный анализ безопасности
- `SECURITY_BACKUP_ATTACK_SCENARIOS.md` - Сценарии атак
- `SECURITY_BACKUP_CHECKLIST.md` - Чеклист исправлений

**Дата анализа:** 14 ноября 2024
**Автор:** Backend Security Coding Expert
**Следующая проверка:** 21 ноября 2024
