FROM python:3.10-slim

# bump to invalidate stale BuildKit cache if needed
ARG BOT_BUILD_REV=2
ENV BOT_BUILD_REV=${BOT_BUILD_REV}

WORKDIR /app

# Копируем зависимости
COPY pyproject.toml ./

# Устанавливаем только необходимые системные библиотеки и Python-зависимости (без CUDA/torch)
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked,id=apt-cache \
    --mount=type=cache,target=/root/.cache/uv,sharing=locked,id=uv-cache \
    bash -euxo pipefail -c '\
      export DEBIAN_FRONTEND=noninteractive; \
      for i in 1 2 3 4 5; do \
        apt-get -o Acquire::Retries=5 update && \
        apt-get -y -o Dpkg::Use-Pty=0 --no-install-recommends install \
          curl ca-certificates && break || sleep 3; \
      done; \
      pip install --no-cache-dir -i https://pypi.org/simple "uv>=0.8"; \
      uv pip install --system --no-cache --requirements pyproject.toml; \
      apt-get clean; rm -rf /var/lib/apt/lists/* \
    '

# Минимальные ENV, без индексов CUDA и без cmake-флагов
ENV PYTHONPATH=/app

# Копируем код бота
COPY safety ./safety
COPY observability ./observability
COPY tg_bot ./tg_bot

# Запускаем
CMD ["python", "-m", "tg_bot.run"]
