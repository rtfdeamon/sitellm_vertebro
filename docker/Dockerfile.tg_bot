FROM python:3.10-slim

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY pyproject.toml uv.lock ./

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä—ã
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        build-essential \
        git \
        cmake \
        ninja-build \
        pkg-config \
        curl \
        libopenblas-dev \
        python3-dev

# –ó–∞–¥–∞—ë–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è pip –∏ CMake
ENV PIP_EXTRA_INDEX_URL=https://abetlen.github.io/llama-cpp-python/whl/cpu \
    FORCE_CMAKE=1 \
    CMAKE_ARGS="-DLLAMA_ARM_DOTPROD=OFF -DLLAMA_ARM_FMA=OFF -DLLAMA_ARM_FP16=OFF"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ llama-cpp-python
# llama-cpp-python —Å—Ç—Ä–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–∏–º –≤–µ—Ä—Å–∏–µ–π 0.3.2
RUN pip install --no-cache-dir "llama-cpp-python==0.3.2" && \
    pip install --no-cache-dir uv && \
    # –û—Ç–∫–ª—é—á–∞–µ–º uv sync, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
    echo "üü° –ü—Ä–æ–ø—É—â–µ–Ω uv sync ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç pyproject.toml" && \
    apt-get purge -y --auto-remove git cmake build-essential python3-dev ninja-build && \
    rm -rf /var/lib/apt/lists/*


# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ –±–æ—Ç–∞
COPY tg_bot ./tg_bot

# –ó–∞–ø—É—Å–∫–∞–µ–º
CMD ["python", "-m", "tg_bot.run"]
