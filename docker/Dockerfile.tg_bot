FROM python:3.10-slim
WORKDIR /app
COPY pyproject.toml uv.lock ./

# Install build tools first
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        build-essential \
        git \
        cmake \
        pkg-config \
        curl \
        libopenblas-dev \
        python3-dev

# Use a portable CPU build of llama-cpp-python
ENV PIP_EXTRA_INDEX_URL=https://abetlen.github.io/llama-cpp-python/whl/cpu
# Disable all GPU/metal/BLAS back-ends and SIMD so that build falls back to pure C
ENV CMAKE_ARGS="-DLLAMA_CUBLAS=OFF -DLLAMA_METAL=OFF -DLLAMA_BLAS=OFF -DGGML_NO_SIMD=ON"

RUN pip install --no-cache-dir --prefer-binary "llama-cpp-python>=0.3.14,<0.4" && \
    pip install --no-cache-dir uv && \
    uv sync && \
    apt-get purge -y --auto-remove git cmake build-essential python3-dev && \
    rm -rf /var/lib/apt/lists/*
ENV CC=/usr/bin/gcc
ENV CXX=/usr/bin/g++
COPY tg_bot ./tg_bot
CMD ["python", "-m", "tg_bot.run"]
