# Сценарии атак на систему резервного копирования

**Дата создания:** 14 ноября 2024
**Последнее обновление:** 14 ноября 2024
**Версия:** 1.0
**Статус:** Актуально

---

## Содержание

1. [Визуализация уязвимостей](#визуализация-уязвимостей)
2. [Сценарий 1: CSRF атака на восстановление БД](#сценарий-1-csrf-атака-на-восстановление-бд)
3. [Сценарий 2: Незаметная компрометация обычного админа](#сценарий-2-незаметная-компрометация-обычного-админа)
4. [Сценарий 3: Path Traversal для доступа к чужим бэкапам](#сценарий-3-path-traversal-для-доступа-к-чужим-бэкапам)
5. [Сценарий 4: Случайное восстановление (Human Error)](#сценарий-4-случайное-восстановление-human-error)
6. [Сценарий 5: DoS через спам запросов](#сценарий-5-dos-через-спам-запросов)
7. [Матрица вероятности vs последствий](#матрица-вероятности-vs-последствий)
8. [Приоритизация исправлений (Risk Score)](#приоритизация-исправлений-risk-score)
9. [Defense in Depth (Глубокая оборона)](#defense-in-depth-глубокая-оборона)
10. [Заключение](#заключение)

---

## Визуализация уязвимостей

```
┌─────────────────────────────────────────────────────────────────┐
│                    СИСТЕМА РЕЗЕРВНОГО КОПИРОВАНИЯ                │
│                                                                   │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐  │
│  │   Frontend   │─────▶│   Backend    │─────▶│ Yandex.Disk  │  │
│  │  (backup.js) │      │   (app.py)   │      │   (cloud)    │  │
│  └──────────────┘      └──────────────┘      └──────────────┘  │
│         │                      │                      │          │
│         │                      │                      │          │
│    [UI Hiding]          [is_super check]      [Token Auth]     │
│    ✅ Defense           ✅ Strong            ✅ Strong         │
│                                                                   │
│         ⚠️                    ⚠️                    ⚠️            │
│    [No confirm]          [No CSRF]           [No path check]    │
│    VULNERABLE            VULNERABLE          VULNERABLE          │
└─────────────────────────────────────────────────────────────────┘
```

---

## Сценарий 1: CSRF атака на восстановление БД

### Уровень риска: 🔴 КРИТИЧЕСКИЙ

### Цепочка атаки

```
1. ПОДГОТОВКА
   ┌──────────────────────────────────────┐
   │ Злоумышленник создает evil.com       │
   │ Размещает вредоносный HTML/JS        │
   └──────────────────────────────────────┘
                    │
                    ▼
2. SOCIAL ENGINEERING
   ┌──────────────────────────────────────┐
   │ Отправляет email супер-админу:       │
   │ "Новая функция админ-панели!"        │
   │ Link: https://evil.com/new-feature   │
   └──────────────────────────────────────┘
                    │
                    ▼
3. ВРЕДОНОСНЫЙ КОД
   ┌──────────────────────────────────────┐
   │ <script>                              │
   │   fetch('https://target.com/api/v1/  │
   │          backup/restore', {          │
   │     method: 'POST',                   │
   │     credentials: 'include', // !!!   │
   │     body: JSON.stringify({           │
   │       remotePath: 'evil.archive.gz'  │
   │     })                                │
   │   });                                 │
   │ </script>                             │
   └──────────────────────────────────────┘
                    │
                    ▼
4. БРАУЗЕР ВЫПОЛНЯЕТ
   ┌──────────────────────────────────────┐
   │ Browser автоматически:               │
   │ - Включает Basic Auth заголовки      │
   │ - Отправляет credentials супер-админа│
   │ - Выполняет POST запрос              │
   └──────────────────────────────────────┘
                    │
                    ▼
5. BACKEND ПРИНИМАЕТ
   ┌──────────────────────────────────────┐
   │ ✅ Authorization: Basic <super_creds>│
   │ ✅ is_super = True                   │
   │ ❌ NO CSRF Check                     │
   │ → Восстановление запущено!           │
   └──────────────────────────────────────┘
                    │
                    ▼
6. ПОСЛЕДСТВИЯ
   ┌──────────────────────────────────────┐
   │ 💀 ВСЯ БД ПЕРЕЗАПИСАНА               │
   │ 💀 Потеря всех данных                │
   │ 💀 Возможно внедрение backdoor       │
   │ 💀 Супер-админ даже не заметил       │
   └──────────────────────────────────────┘
```

### Почему это работает?

```
┌─────────────────────────────────────────────────────────┐
│ Basic Authentication + credentials: 'include'           │
│ = Браузер автоматически отправляет креды на любой запрос│
├─────────────────────────────────────────────────────────┤
│ НЕТ проверки Origin/Referer                             │
│ = Сервер не знает, откуда пришел запрос                 │
├─────────────────────────────────────────────────────────┤
│ НЕТ CSRF токена                                         │
│ = Невозможно отличить легитимный запрос от CSRF         │
└─────────────────────────────────────────────────────────┘
```

### Как защититься? (PATCH 1)

```python
# Проверка Origin header
origin = request.headers.get("Origin")
if origin not in ALLOWED_ORIGINS:
    raise HTTPException(403, "Invalid origin")

# ИЛИ требование специального заголовка
if request.headers.get("X-Requested-With") != "XMLHttpRequest":
    raise HTTPException(403, "Missing CSRF header")
```

---

## Сценарий 2: Незаметная компрометация обычного админа

### Уровень риска: 🟠 ВЫСОКИЙ

### Цепочка атаки

```
1. КОМПРОМЕТАЦИЯ
   ┌──────────────────────────────────────┐
   │ Обычный админ (не super):            │
   │ - Phishing email                      │
   │ - Украден пароль                      │
   │ - Или инсайдер                        │
   └──────────────────────────────────────┘
                    │
                    ▼
2. РАЗВЕДКА
   ┌──────────────────────────────────────┐
   │ for i in {1..1000}; do               │
   │   curl -u "admin:stolen_pwd"         │
   │        /api/v1/backup/status         │
   │ done                                  │
   └──────────────────────────────────────┘
                    │
                    ▼
3. BACKEND ОТВЕЧАЕТ
   ┌──────────────────────────────────────┐
   │ HTTP 403 Forbidden (каждый раз)      │
   │ ❌ NO LOGGING                        │
   │ ❌ NO ALERTS                         │
   │ ❌ NO RATE LIMITING                  │
   └──────────────────────────────────────┘
                    │
                    ▼
4. ЗЛОУМЫШЛЕННИК
   ┌──────────────────────────────────────┐
   │ "Хм, нет доступа к бэкапам"          │
   │ "Попробую другие уязвимости..."      │
   │ - XSS для кражи супер-админ сессии   │
   │ - SQL injection                       │
   │ - Privilege escalation                │
   └──────────────────────────────────────┘
                    │
                    ▼
5. РЕЗУЛЬТАТ
   ┌──────────────────────────────────────┐
   │ ⚠️  1000 попыток НЕ ОБНАРУЖЕНЫ       │
   │ ⚠️  Нет алертов в SOC                │
   │ ⚠️  Компрометация продолжается       │
   │ ⚠️  Возможно найдет другой путь      │
   └──────────────────────────────────────┘
```

### Временная шкала необнаружения

```
День 1:  [1000 попыток доступа] → Нет логов
День 2:  [Поиск других уязвимостей] → Нет алертов
День 3:  [Найдена XSS уязвимость] → Нет мониторинга
День 4:  [Кража супер-админ сессии] → Слишком поздно!
День 5:  [Доступ к бэкапам получен] → 💀
         [Утечка всех данных] → 💀💀💀
```

### Как защититься? (PATCH 2)

```python
# Логирование КАЖДОЙ попытки
logger.warning(
    "unauthorized_super_admin_access_attempt",
    username=identity.username,
    ip=request.client.host,
    path=request.url.path,
)

# Alert после 3+ попыток
if attempts >= 3:
    send_security_alert("Brute-force detected!")
```

---

## Сценарий 3: Path Traversal для доступа к чужим бэкапам

### Уровень риска: 🟡 СРЕДНИЙ

### Цепочка атаки

```
1. РАЗВЕДКА
   ┌──────────────────────────────────────┐
   │ Супер-админ компании A знает:        │
   │ - Яндекс.Диск используется для всех  │
   │ - Токен дает доступ к корню диска    │
   │ - Возможно другие компании на диске  │
   └──────────────────────────────────────┘
                    │
                    ▼
2. АТАКА
   ┌──────────────────────────────────────┐
   │ POST /api/v1/backup/restore          │
   │ {                                     │
   │   "remotePath": "company-b-backups/  │
   │                  their-db.archive.gz"│
   │ }                                     │
   └──────────────────────────────────────┘
                    │
                    ▼
3. BACKEND ПРОВЕРЯЕТ
   ┌──────────────────────────────────────┐
   │ ✅ is_super = True                   │
   │ ❌ NO path validation                │
   │ ❌ NO folder restriction             │
   │ → Отправляет запрос к Yandex.Disk    │
   └──────────────────────────────────────┘
                    │
                    ▼
4. YANDEX.DISK
   ┌──────────────────────────────────────┐
   │ Токен валидный ✅                    │
   │ Путь существует ✅                   │
   │ → Скачивает чужой бэкап              │
   └──────────────────────────────────────┘
                    │
                    ▼
5. MONGORESTORE
   ┌──────────────────────────────────────┐
   │ 💀 БД компании A перезаписана        │
   │ 💀 Данными компании B                │
   │ 💀 Утечка данных компании B          │
   └──────────────────────────────────────┘
```

### Другие варианты path traversal

```python
# 1. Относительные пути
"../../other-company/backup.archive.gz"

# 2. Абсолютные пути
"/disk/other-company/backup.archive.gz"

# 3. Вложенные пути
"allowed-folder/../../other-company/backup.archive.gz"

# 4. Null byte injection (если бы использовался C)
"allowed-folder/backup.archive.gz\x00../../etc/passwd"

# 5. Long path DoS
"a/" * 10000 + "backup.archive.gz"  # Переполнение буфера
```

### Как защититься? (PATCH 3)

```python
# Валидация пути
def validate_path(path, allowed_folder):
    # Проверка ".."
    if ".." in path:
        raise ValueError("Path traversal detected")

    # Проверка начала пути
    if not path.startswith(f"{allowed_folder}/"):
        raise ValueError("Must be in allowed folder")

    # Проверка расширения
    if not path.endswith(".archive.gz"):
        raise ValueError("Invalid file type")
```

---

## Сценарий 4: Случайное восстановление (Human Error)

### Уровень риска: 🟡 СРЕДНИЙ (но последствия катастрофические)

### Цепочка событий

```
1. НАМЕРЕНИЕ
   ┌──────────────────────────────────────┐
   │ Супер-админ хочет:                   │
   │ "Посмотреть содержимое старого бэкапа│
   │  для восстановления одного документа"│
   └──────────────────────────────────────┘
                    │
                    ▼
2. UI
   ┌──────────────────────────────────────┐
   │ [Backup: db-20241201.archive.gz    ] │
   │ [Copy Path]  [Restore]   ← ОПАСНО!  │
   │                    ▲                  │
   │                    │                  │
   │            Нет подтверждения         │
   └──────────────────────────────────────┘
                    │
                    ▼
3. ОШИБКА
   ┌──────────────────────────────────────┐
   │ Админ случайно кликает [Restore]     │
   │ Вместо [Copy Path]                   │
   │                                       │
   │ Причины:                              │
   │ - Усталость (3 AM, incident)         │
   │ - Стресс                              │
   │ - Похожие кнопки рядом               │
   │ - Нет подтверждения                  │
   └──────────────────────────────────────┘
                    │
                    ▼
4. BACKEND
   ┌──────────────────────────────────────┐
   │ Получил запрос restore               │
   │ ✅ is_super = True                   │
   │ ✅ Path valid                        │
   │ ❌ NO confirmation required          │
   │ → Запускает восстановление           │
   └──────────────────────────────────────┘
                    │
                    ▼
5. ОСОЗНАНИЕ
   ┌──────────────────────────────────────┐
   │ T+0s:  Кликнул Restore                │
   │ T+1s:  "О нет..."                     │
   │ T+2s:  Пытается отменить             │
   │ T+3s:  Слишком поздно, mongorestore  │
   │        уже запущен                    │
   │ T+30s: БД перезаписана                │
   └──────────────────────────────────────┘
                    │
                    ▼
6. ПОСЛЕДСТВИЯ
   ┌──────────────────────────────────────┐
   │ 💀 Потеря всех данных за 6 месяцев   │
   │ 💀 Невозможно откатить               │
   │ 💀 Бизнес остановлен                 │
   │ 💀 Админ уволен                       │
   │ 💀 Компания в суде                    │
   └──────────────────────────────────────┘
```

### Психология ошибки

```
┌─────────────────────────────────────────┐
│ ФАКТОРЫ, ПРИВОДЯЩИЕ К ОШИБКЕ            │
├─────────────────────────────────────────┤
│ 1. Усталость (3 AM incident response)   │
│ 2. Стресс (CEO орет: "Срочно!")        │
│ 3. Недостаток сна                        │
│ 4. Multitasking (5 окон открыто)        │
│ 5. Похожий UI (кнопки рядом)            │
│ 6. Отсутствие "скорости bump"           │
│    (нет подтверждения = нет паузы)      │
└─────────────────────────────────────────┘
```

### Как защититься? (PATCH 4)

```javascript
// Двойное подтверждение
if (!confirm("⚠️  DATABASE RESTORE ⚠️\n" +
             "ALL DATA WILL BE LOST!\n" +
             "Continue?")) return;

// Требование ввода текста
const input = prompt("Type 'RESTORE DATABASE' to confirm:");
if (input !== "RESTORE DATABASE") return;

// Backend проверка
headers: {
  "X-Confirmation": "restore-confirmed"
}
```

---

## Сценарий 5: DoS через спам запросов

### Уровень риска: 🟢 НИЗКИЙ

### Цепочка атаки

```
1. СКРИПТ
   ┌──────────────────────────────────────┐
   │ while true; do                        │
   │   curl -u "super:pwd"                 │
   │        /api/v1/backup/run             │
   │   sleep 0.1                           │
   │ done                                  │
   └──────────────────────────────────────┘
                    │
                    ▼
2. BACKEND
   ┌──────────────────────────────────────┐
   │ Запрос 1: Создает backup job         │
   │ Запрос 2: HTTP 409 (job in progress) │
   │ Запрос 3: HTTP 409                   │
   │ ...                                   │
   │ Запрос 1000: HTTP 409                │
   │                                       │
   │ ❌ NO rate limiting                  │
   │ → CPU usage 100%                     │
   └──────────────────────────────────────┘
                    │
                    ▼
3. ПОСЛЕДСТВИЯ
   ┌──────────────────────────────────────┐
   │ ⚠️  Сервер перегружен                 │
   │ ⚠️  Легитимные запросы медленные      │
   │ ⚠️  Но система не падает              │
   └──────────────────────────────────────┘
```

### Как защититься? (PATCH 5)

```python
@limiter.limit("5/hour")  # Только 5 бэкапов в час
@app.post("/api/v1/backup/run")
async def backup_run(...):
    ...
```

---

## Матрица вероятности vs последствий

```
Последствия
    ▲
    │
КРИТ│           ┌─────────┐
    │           │CSRF (1) │
    │           │Human(4) │
    │           └─────────┘
    │
ВЫС │  ┌─────────┐
    │  │Audit(2) │
    │  └─────────┘
    │                    ┌─────────┐
СР  │                    │Path (3) │
    │                    └─────────┘
    │
НИЗ │                              ┌─────────┐
    │                              │DoS  (5) │
    │                              └─────────┘
    └──────────────────────────────────────────▶
       НИЗКАЯ    СРЕДНЯЯ    ВЫСОКАЯ    Вероятность
```

---

## Приоритизация исправлений (Risk Score)

```
Risk Score = Вероятность × Последствия × Простота исправления

┌────────┬────────────┬──────────┬─────────┬──────────┬──────────┐
│ ID     │ Атака      │ Вероятн. │ Послед. │ Простота │ Priority │
├────────┼────────────┼──────────┼─────────┼──────────┼──────────┤
│ 1      │ CSRF       │    7     │   10    │    8     │   P0     │
│ 2      │ No Audit   │    9     │    7    │   10     │   P0     │
│ 3      │ Path Trav  │    4     │    8    │    7     │   P1     │
│ 4      │ Human Err  │    3     │   10    │    9     │   P1     │
│ 5      │ DoS        │    2     │    3    │    8     │   P2     │
└────────┴────────────┴──────────┴─────────┴──────────┴──────────┘

P0: Немедленно (1-2 дня)
P1: На этой неделе (3-5 дней)
P2: Следующий спринт
```

---

## Defense in Depth (Глубокая оборона)

### Текущее состояние

```
Слой 1: Frontend
┌─────────────────────────────────┐
│ ✅ UI hiding for non-super      │  Обходится через DevTools
│ ❌ No confirmation for restore  │  Одна ошибка = катастрофа
└─────────────────────────────────┘
                │
                ▼
Слой 2: Network
┌─────────────────────────────────┐
│ ❌ No CSRF protection           │  CSRF атака работает
│ ❌ No rate limiting             │  DoS возможен
└─────────────────────────────────┘
                │
                ▼
Слой 3: Backend Auth
┌─────────────────────────────────┐
│ ✅ _require_super_admin()       │  Работает идеально
│ ✅ Basic Auth every request     │  Без кеширования
└─────────────────────────────────┘
                │
                ▼
Слой 4: Business Logic
┌─────────────────────────────────┐
│ ❌ No path validation           │  Path traversal возможен
│ ❌ No audit logging             │  Слепы к атакам
└─────────────────────────────────┘
                │
                ▼
Слой 5: Data Access
┌─────────────────────────────────┐
│ ✅ Yandex.Disk token auth       │  Работает
│ ❌ No path restrictions         │  Весь диск доступен
└─────────────────────────────────┘

Оценка: 3/5 слоев защищены = 60%
```

### После применения патчей

```
Слой 1: Frontend
┌─────────────────────────────────┐
│ ✅ UI hiding for non-super      │
│ ✅ Double confirmation (PATCH 4)│  🆕
└─────────────────────────────────┘
                │
                ▼
Слой 2: Network
┌─────────────────────────────────┐
│ ✅ CSRF protection (PATCH 1)    │  🆕
│ ✅ Rate limiting (PATCH 5)      │  🆕
└─────────────────────────────────┘
                │
                ▼
Слой 3: Backend Auth
┌─────────────────────────────────┐
│ ✅ _require_super_admin()       │
│ ✅ Basic Auth every request     │
│ ✅ Audit logging (PATCH 2)      │  🆕
└─────────────────────────────────┘
                │
                ▼
Слой 4: Business Logic
┌─────────────────────────────────┐
│ ✅ Path validation (PATCH 3)    │  🆕
│ ✅ Error sanitization (PATCH 7) │  🆕
└─────────────────────────────────┘
                │
                ▼
Слой 5: Data Access
┌─────────────────────────────────┐
│ ✅ Yandex.Disk token auth       │
│ ✅ Path restrictions (PATCH 3)  │  🆕
└─────────────────────────────────┘

Оценка: 5/5 слоев защищены = 100% ✅
```

---

## Заключение

### Текущее состояние системы

```
┌─────────────────────────────────────────────────┐
│ Авторизация:    ████████████████░░  (9/10) ✅  │
│ CSRF защита:    ░░░░░░░░░░░░░░░░░░  (0/10) 🔴  │
│ Валидация:      ████░░░░░░░░░░░░░░  (3/10) ⚠️   │
│ Audit:          ░░░░░░░░░░░░░░░░░░  (0/10) 🔴  │
│ UX Safety:      ██░░░░░░░░░░░░░░░░  (2/10) 🔴  │
├─────────────────────────────────────────────────┤
│ ИТОГО:          ███████░░░░░░░░░░░  (5/10) ⚠️   │
└─────────────────────────────────────────────────┘
```

### После применения всех патчей

```
┌─────────────────────────────────────────────────┐
│ Авторизация:    ████████████████░░  (9/10) ✅  │
│ CSRF защита:    ████████████████░░  (9/10) ✅  │
│ Валидация:      ████████████████░░  (9/10) ✅  │
│ Audit:          ██████████████████  (10/10) ✅ │
│ UX Safety:      ████████████████░░  (9/10) ✅  │
├─────────────────────────────────────────────────┤
│ ИТОГО:          ████████████████░░  (9/10) ✅  │
└─────────────────────────────────────────────────┘
```

### Рекомендуемые действия

1. **СЕГОДНЯ**: PATCH 1, 2 (CSRF + Audit)
2. **НЕДЕЛЯ**: PATCH 3, 4, 7 (Валидация + UX + Errors)
3. **СПРИНТ**: PATCH 5, 6 (Rate Limit + Headers)

**Общее время: ~15 часов работы**
**Результат: Система production-ready с enterprise-grade security**

---

## Связанные документы

**Документация по безопасности резервного копирования:**
- `SECURITY_BACKUP_ACCESS_CONTROL.md` - Контроль доступа
- `SECURITY_BACKUP_SUMMARY.md` - Краткая сводка по безопасности
- `SECURITY_BACKUP_ANALYSIS.md` - Детальный анализ безопасности
- `SECURITY_BACKUP_ATTACK_SCENARIOS.md` - Сценарии атак (этот документ)
- `SECURITY_BACKUP_CHECKLIST.md` - Чеклист исправлений

**Дата анализа:** 14 ноября 2024
**Автор:** Backend Security Coding Expert
