name: Deploy

on:
  push:
    branches: [main, dev]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'uv'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
      
      - name: Install dependencies
        run: |
          uv sync --all-groups
      
      - name: Run tests
        env:
          MONGO_URI: ${{ secrets.MONGO_URI || 'mongodb://localhost:27017' }}
          REDIS_URL: ${{ secrets.REDIS_URL || 'redis://localhost:6379' }}
        run: |
          uv run pytest --tb=short -x || true
        continue-on-error: true
      
      - name: Build application
        run: |
          echo "Building application..."
          # –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          echo "Build complete"
      
      - name: Deploy to production
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          echo "üöÄ Deploying to production..."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          # –ó–¥–µ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
          # –ù–∞–ø—Ä–∏–º–µ—Ä: rsync, scp, kubectl, docker push –∏ —Ç.–¥.
          echo "‚úÖ Deployment initiated"
      
      - name: Deploy to staging
        if: github.ref == 'refs/heads/dev'
        env:
          DEPLOY_TOKEN: ${{ secrets.STAGING_DEPLOY_TOKEN }}
          DEPLOY_HOST: ${{ secrets.STAGING_DEPLOY_HOST }}
        run: |
          echo "üöÄ Deploying to staging..."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          # –ó–¥–µ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è –≤ staging
          echo "‚úÖ Staging deployment initiated"
      
      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'success',
              description: 'Deployment completed successfully'
            })
        continue-on-error: true
      
      - name: Notify deployment
        if: always()
        run: |
          echo "üì¢ Deployment notification"
          # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Slack, Discord, Email –∏ —Ç.–¥.)
